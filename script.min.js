console.log("Rodando versão final com gráficos e filtros ativos");
const url="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
let dados=[],dadosFiltrados=[],chartGGR,chartFTD,chartDepositos;
function carregarCSV(){console.log("Iniciando carregamento do CSV...");const t0=performance.now();Papa.parse(url,{download:!0,header:!0,complete:function(e){dados=e.data;console.log("Linhas recebidas:",dados.length);console.log("Primeira linha recebida:",Object.keys(dados[0]));console.log("Primeiras 5 linhas normalizadas:",dados.slice(0,5));popularFiltros();aplicarFiltro();document.getElementById("ultimaAtualizacao").textContent="Última atualização: "+new Date().toLocaleString();document.getElementById("tempoProcessamento").textContent="Tempo de processamento: "+(performance.now()-t0).toFixed(2)+" ms"}})}
function popularFiltros(){const clubes=[...new Set(dados.map(e=>e["Usuário - Nome de usuário do principal"]))];const select=document.getElementById("clubeFiltro");select.innerHTML="<option value='Todos'>Todos</option>"+clubes.map(c=>`<option value="${c}">${c}</option>`).join("");document.getElementById("aplicarFiltro").onclick=aplicarFiltro;}
function aplicarFiltro(){const data=document.getElementById("dataFiltro").value;const clube=document.getElementById("clubeFiltro").value;dadosFiltrados=dados.filter(e=>(!data||e.DATA===data)&&("Todos"===clube||e["Usuário - Nome de usuário do principal"]===clube));atualizarDashboard();}
function atualizarDashboard(){let ftd=0,dep=0,ggr=0;const porDia={};dadosFiltrados.forEach(e=>{const d=e.DATA;const vFtd=parseFloat(e["Usuário - FTD-Montante"]||0);const vDep=parseFloat(e["Usuário - Depósitos"]||0);const vGgr=parseFloat(e["Cálculo - GGR"]||0);ftd+=vFtd;dep+=vDep;ggr+=vGgr;porDia[d]||(porDia[d]={ftd:0,dep:0,ggr:0});porDia[d].ftd+=vFtd;porDia[d].dep+=vDep;porDia[d].ggr+=vGgr;});document.getElementById("ftdTotal").textContent="R$ "+ftd.toLocaleString();document.getElementById("depositosTotal").textContent="R$ "+dep.toLocaleString();document.getElementById("ggrTotal").textContent="R$ "+ggr.toLocaleString();console.log(`Totais calculados -> FTD:${ftd} Depósitos:${dep} GGR:${ggr}`);atualizarGraficos(porDia);atualizarTabelas();}
function atualizarGraficos(porDia){const labels=Object.keys(porDia).sort();const ftdData=labels.map(d=>porDia[d].ftd);const depData=labels.map(d=>porDia[d].dep);const ggrData=labels.map(d=>porDia[d].ggr);if(chartGGR)chartGGR.destroy();if(chartFTD)chartFTD.destroy();if(chartDepositos)chartDepositos.destroy();chartGGR=new Chart(document.getElementById("graficoGGR"),{type:"line",data:{labels,datasets:[{label:"GGR Diário",data:ggrData,borderColor:"lime",fill:!1}]}});
chartFTD=new Chart(document.getElementById("graficoFTD"),{type:"line",data:{labels,datasets:[{label:"FTD Diário",data:ftdData,borderColor:"yellow",fill:!1}]}});
chartDepositos=new Chart(document.getElementById("graficoDepositos"),{type:"line",data:{labels,datasets:[{label:"Depósitos Diários",data:depData,borderColor:"blue",fill:!1}]}});
}
function atualizarTabelas(){const agrupar=(campo)=>{const res={};dadosFiltrados.forEach(e=>{const key=e["Usuário - Nome de usuário do principal"];const v=parseFloat(e[campo]||0);res[key]=(res[key]||0)+v;});return Object.entries(res).sort((a,b)=>b[1]-a[1]).slice(0,10)};const gerarTabela=(id,lista)=>{const tbl=document.getElementById(id);tbl.innerHTML="<tr><th>Clube</th><th>Valor</th></tr>"+lista.map(([c,v])=>`<tr><td>${c}</td><td>R$ ${v.toLocaleString()}</td></tr>`).join("")};gerarTabela("tabelaDepositos",agrupar("Usuário - Depósitos"));gerarTabela("tabelaFTD",agrupar("Usuário - FTD-Montante"));gerarTabela("tabelaGGR",agrupar("Cálculo - GGR"));}
window.onload=carregarCSV;
