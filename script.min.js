console.log("Rodando versão final ajustada");
const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";let dados=[];let ggrChart,ftdChart,depositosChart;function formatarMoeda(v){return"R$ "+v.toLocaleString("pt-BR");}function parseNumero(v){if(!v)return 0;return Number(String(v).replace(",",".").replace(/[^0-9.-]/g,""))||0;}function atualizarCards(filtrado){let tftd=0,tdep=0,tggr=0;filtrado.forEach(l=>{tftd+=l.ftd;tdep+=l.depositos;tggr+=l.ggr});document.getElementById("ftdValor").innerText=formatarMoeda(tftd);document.getElementById("depositosValor").innerText=formatarMoeda(tdep);document.getElementById("ggrValor").innerText=formatarMoeda(tggr);}function atualizarGraficos(filtrado){let d=filtrado.map(l=>l.data),ggr=filtrado.map(l=>l.ggr),ftd=filtrado.map(l=>l.ftd),dep=filtrado.map(l=>l.depositos);if(ggrChart)ggrChart.destroy();if(ftdChart)ftdChart.destroy();if(depositosChart)depositosChart.destroy();const opt={responsive:!0,plugins:{legend:{labels:{color:"white"}}},scales:{x:{ticks:{color:"white"}},y:{ticks:{color:"white"},beginAtZero:!0}}};ggrChart=new Chart(document.getElementById("graficoGGR"),{type:"line",data:{labels:d,datasets:[{label:"GGR Diário",data:ggr,borderColor:"lime",fill:!1}]},options:opt});ftdChart=new Chart(document.getElementById("graficoFTD"),{type:"line",data:{labels:d,datasets:[{label:"FTD Diário",data:ftd,borderColor:"yellow",fill:!1}]},options:opt});depositosChart=new Chart(document.getElementById("graficoDepositos"),{type:"line",data:{labels:d,datasets:[{label:"Depósitos Diários",data:dep,borderColor:"blue",fill:!1}]},options:opt});}function atualizarTabelas(filtrado){function top10(campo){return[...filtrado].sort((a,b)=>b[campo]-a[campo]).slice(0,10)}let td=top10("depositos"),tf=top10("ftd"),tg=top10("ggr");function tabela(id,lista,campo){let t="<tr><th>Clube</th><th>"+campo+"</th></tr>";lista.forEach(l=>{t+=`<tr><td>${l.clube}</td><td>${formatarMoeda(l[campo.toLowerCase()])}</td></tr>`});document.getElementById(id).innerHTML=t;}tabela("topDepositos",td,"Depósitos");tabela("topFTD",tf,"FTD");tabela("topGGR",tg,"GGR");}function aplicarFiltro(){let data=document.getElementById("dataFiltro").value,clube=document.getElementById("clubeFiltro").value,filtrado=dados.filter(l=>(!data||l.data===data)&&("Todos"===clube||l.clube===clube));atualizarCards(filtrado);atualizarGraficos(filtrado);atualizarTabelas(filtrado);}function carregarDados(){console.log("Iniciando carregamento do CSV...");const t0=performance.now();Papa.parse(csvUrl,{download:!0,header:!0,complete:function(r){dados=r.data.map(l=>({data:l["DATA"],clube:l["Usuário - Nome de usuário"],ftd:parseNumero(l["Usuário - FTD-Montante"]),depositos:parseNumero(l["Usuário - Depósitos"]),ggr:parseNumero(l["Cálculo - GGR"])}));console.log("Linhas recebidas:",dados.length);let clubes=[...new Set(dados.map(l=>l.clube))];document.getElementById("clubeFiltro").innerHTML='<option>Todos</option>'+clubes.map(c=>`<option>${c}</option>`).join("");document.getElementById("ultimaAtualizacao").innerText=new Date().toLocaleString("pt-BR");document.getElementById("tempoProcessamento").innerText=(performance.now()-t0).toFixed(2);aplicarFiltro();}});}document.getElementById("aplicarFiltro").addEventListener("click",aplicarFiltro);carregarDados();
