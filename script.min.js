console.log("Rodando versão minificada com filtros e gráficos animados");
const urlCSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
let dados=[],chartGGR,chartFTD,chartDepositos;
function carregarDados(){console.log("Iniciando carregamento do CSV...");Papa.parse(urlCSV,{download:!0,header:!0,complete:e=>{dados=e.data;console.log("Linhas recebidas:",dados.length);inicializarFiltros();atualizarDashboard();}})}
function inicializarFiltros(){const clubes=[...new Set(dados.map(e=>e["Usuário - Nome de usuário"]||e["Clube"]))];const select=document.getElementById("filtroClube");select.innerHTML="<option value='Todos'>Todos</option>"+clubes.map(e=>`<option value="${e}">${e}</option>`).join("")}
function atualizarDashboard(){const inicio=performance.now();const dataFiltro=document.getElementById("filtroData").value;const clubeFiltro=document.getElementById("filtroClube").value;let filtrados=dados.filter(e=>(!dataFiltro||e.DATA===dataFiltro)&&("Todos"===clubeFiltro||e["Usuário - Nome de usuário"]===clubeFiltro));console.log("Dados filtrados:",filtrados.length);let totalFTD=0,totalDepositos=0,totalGGR=0;const porDia={};filtrados.forEach(e=>{const ftd=parseFloat(e["Usuário - FTD-Montante"]||0),dep=parseFloat(e["Usuário - Depósitos"]||0),ggr=parseFloat(e.GGR||0);totalFTD+=ftd;totalDepositos+=dep;totalGGR+=ggr;const dia=e.DATA;porDia[dia]||(porDia[dia]={ftd:0,depositos:0,ggr:0}),porDia[dia].ftd+=ftd,porDia[dia].depositos+=dep,porDia[dia].ggr+=ggr});document.getElementById("ftdValor").innerText="R$ "+totalFTD.toLocaleString();document.getElementById("depositosValor").innerText="R$ "+totalDepositos.toLocaleString();document.getElementById("ggrValor").innerText="R$ "+totalGGR.toLocaleString();const dias=Object.keys(porDia).sort(),ggrVals=dias.map(d=>porDia[d].ggr),ftdVals=dias.map(d=>porDia[d].ftd),depVals=dias.map(d=>porDia[d].depositos);atualizarGraficos(dias,ggrVals,ftdVals,depVals);document.getElementById("ultimaAtualizacao").innerText="Última atualização: "+new Date().toLocaleString();document.getElementById("tempoProcessamento").innerText="Tempo de processamento: "+(performance.now()-inicio).toFixed(2)+" ms";}
function atualizarGraficos(labels,ggr,ftd,depositos){chartGGR&&chartGGR.destroy();chartFTD&&chartFTD.destroy();chartDepositos&&chartDepositos.destroy();chartGGR=new Chart(document.getElementById("graficoGGR"),{type:"line",data:{labels:labels,datasets:[{label:"GGR Diário",data:ggr,borderColor:"lime",tension:.3}]},options:{animation:{duration:1e3,easing:"easeOutQuart"},responsive:!0,plugins:{legend:{labels:{color:"#fff"}}},scales:{x:{ticks:{color:"#fff"}},y:{ticks:{color:"#fff"}}}}});chartFTD=new Chart(document.getElementById("graficoFTD"),{type:"line",data:{labels:labels,datasets:[{label:"FTD Diário",data:ftd,borderColor:"yellow",tension:.3}]},options:{animation:{duration:1e3,easing:"easeOutQuart"},responsive:!0,plugins:{legend:{labels:{color:"#fff"}}},scales:{x:{ticks:{color:"#fff"}},y:{ticks:{color:"#fff"}}}}});chartDepositos=new Chart(document.getElementById("graficoDepositos"),{type:"line",data:{labels:labels,datasets:[{label:"Depósitos Diários",data:depositos,borderColor:"blue",tension:.3}]},options:{animation:{duration:1e3,easing:"easeOutQuart"},responsive:!0,plugins:{legend:{labels:{color:"#fff"}}},scales:{x:{ticks:{color:"#fff"}},y:{ticks:{color:"#fff"}}}}})}
document.getElementById("aplicarFiltro").addEventListener("click",atualizarDashboard);carregarDados();
