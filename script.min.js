console.log("Rodando versão animada com filtros e gráficos");
const urlCSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
let chartGGR,chartFTD,chartDepositos;
document.addEventListener("DOMContentLoaded",()=>{carregarDados();document.getElementById("btnAplicar").addEventListener("click",aplicarFiltros);});
function carregarDados(){Papa.parse(urlCSV,{download:!0,header:!0,complete:function(r){const dados=r.data.filter(e=>e.DATA);atualizarDashboard(dados);}});}
function aplicarFiltros(){const dt=document.getElementById("dataFiltro").value,clube=document.getElementById("clubeFiltro").value;carregarDados(dt,clube);}
function atualizarDashboard(dados){const ftd=dados.reduce((s,e)=>s+(parseFloat(e["Usuário - FTD-Montante"])||0),0),dep=dados.reduce((s,e)=>s+(parseFloat(e["Usuário - Depósitos"])||0),0),ggr=dados.reduce((s,e)=>s+(parseFloat(e["GGR"])||0),0);document.getElementById("valorFTD").textContent="R$ "+ftd.toLocaleString("pt-BR");document.getElementById("valorDepositos").textContent="R$ "+dep.toLocaleString("pt-BR");document.getElementById("valorGGR").textContent="R$ "+ggr.toLocaleString("pt-BR");atualizarGraficos(dados);}
function atualizarGraficos(dados){const datas=[...new Set(dados.map(e=>e.DATA))],soma=(campo)=>datas.map(d=>dados.filter(x=>x.DATA==d).reduce((s,v)=>s+(parseFloat(v[campo])||0),0)),ggr=soma("GGR"),ftd=soma("Usuário - FTD-Montante"),dep=soma("Usuário - Depósitos"),maxVal=Math.max(...ggr,...ftd,...dep)*1.2;
const opt={responsive:!0,animation:{duration:1000,easing:"easeOutQuart"},interaction:{mode:"nearest",intersect:!1},scales:{y:{min:0,max:maxVal}}};
chartGGR&&chartGGR.destroy();chartFTD&&chartFTD.destroy();chartDepositos&&chartDepositos.destroy();
chartGGR=new Chart(document.getElementById("graficoGGR"),{type:"line",data:{labels:datas,datasets:[{label:"GGR Diário",data:ggr,borderColor:"#00ff00",fill:!1,tension:.3}]},options:opt});
chartFTD=new Chart(document.getElementById("graficoFTD"),{type:"line",data:{labels:datas,datasets:[{label:"FTD Diário",data:ftd,borderColor:"#ffff00",fill:!1,tension:.3}]},options:opt});
chartDepositos=new Chart(document.getElementById("graficoDepositos"),{type:"line",data:{labels:datas,datasets:[{label:"Depósitos Diários",data:dep,borderColor:"#0066ff",fill:!1,tension:.3}]},options:opt});
}
