console.log("Rodando versão final com gráficos de linha...");
const url="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";

let chartGGR,chartFTD,chartDepositos;

function formatarMoeda(v){return (v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});}

function atualizarGraficos(dados){
    const porData={};
    dados.forEach(l=>{
        if(!porData[l.data]) porData[l.data]={FTD:0,Depositos:0,GGR:0};
        porData[l.data].FTD+=l.ftd||0;
        porData[l.data].Depositos+=l.depositos||0;
        porData[l.data].GGR+=l.ggr||0;
    });
    const labels=Object.keys(porData);
    const ftd=labels.map(d=>porData[d].FTD);
    const dep=labels.map(d=>porData[d].Depositos);
    const ggr=labels.map(d=>porData[d].GGR);

    const opt={responsive:true,plugins:{legend:{labels:{color:"white"}}},scales:{x:{ticks:{color:"white"}},y:{ticks:{color:"white"}}}};
    if(chartGGR)chartGGR.destroy();
    if(chartFTD)chartFTD.destroy();
    if(chartDepositos)chartDepositos.destroy();

    chartGGR=new Chart(document.getElementById("graficoGGR"),{type:"line",data:{labels,datasets:[{label:"GGR Diário",data:ggr,borderColor:"lime",fill:false}]},options:opt});
    chartFTD=new Chart(document.getElementById("graficoFTD"),{type:"line",data:{labels,datasets:[{label:"FTD Diário",data:ftd,borderColor:"yellow",fill:false}]},options:opt});
    chartDepositos=new Chart(document.getElementById("graficoDepositos"),{type:"line",data:{labels,datasets:[{label:"Depósitos Diários",data:dep,borderColor:"blue",fill:false}]},options:opt});
}

function atualizarTabelas(dados){
    const top=(campo)=>[...dados].sort((a,b)=>(b[campo]||0)-(a[campo]||0)).slice(0,10);
    const criarTabela=(id,campo)=>
        document.getElementById(id).innerHTML=top(campo).map(l=>`<tr><td>${l.clube}</td><td>${formatarMoeda(l[campo])}</td></tr>`).join("");

    criarTabela("topDepositos","depositos");
    criarTabela("topFTD","ftd");
    criarTabela("topGGR","ggr");
}

function carregarDados(){
    console.log("Iniciando carregamento do CSV...");
    Papa.parse(url,{download:true,header:true,complete:(res)=>{
        const dados=res.data.map(l=>({
            data:l["DATA"],
            clube:l["Usuário - Nome de usuário"]||"",
            ftd:parseFloat(l["Usuário - FTD-Montante"]||0),
            depositos:parseFloat(l["Usuário - Depósitos"]||0),
            ggr:parseFloat(l["Cálculo - GGR"]||0)
        }));
        document.getElementById("totalFTD").textContent=formatarMoeda(dados.reduce((s,v)=>s+v.ftd,0));
        document.getElementById("totalDepositos").textContent=formatarMoeda(dados.reduce((s,v)=>s+v.depositos,0));
        document.getElementById("totalGGR").textContent=formatarMoeda(dados.reduce((s,v)=>s+v.ggr,0));
        atualizarGraficos(dados);
        atualizarTabelas(dados);
        console.log("Dados carregados com sucesso.");
    }});
}

document.getElementById("aplicarFiltro").addEventListener("click",()=>carregarDados());
carregarDados();
