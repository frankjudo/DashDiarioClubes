console.log("Rodando versão minificada com gráficos e rankings");
const URL_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
let dados=[];let chartGGR,chartFTD,chartDepositos;

function normalizarDados(linhas){
    return linhas.map(l=>({
        data:l[0],
        clube:l[2],
        ftd:parseFloat(l[5])||0,
        depositos:parseFloat(l[6])||0,
        ggr:parseFloat(l[26])||0
    }));
}

function atualizarGraficos(){
    const porData={};
    dados.forEach(l=>{
        if(!porData[l.data])porData[l.data]={ftd:0,depositos:0,ggr:0};
        porData[l.data].ftd+=l.ftd;
        porData[l.data].depositos+=l.depositos;
        porData[l.data].ggr+=l.ggr;
    });
    const labels=Object.keys(porData);
    const serieFTD=labels.map(d=>porData[d].ftd);
    const serieDepositos=labels.map(d=>porData[d].depositos);
    const serieGGR=labels.map(d=>porData[d].ggr);

    if(chartGGR)chartGGR.destroy();
    if(chartFTD)chartFTD.destroy();
    if(chartDepositos)chartDepositos.destroy();

    chartGGR=new Chart(document.getElementById("graficoGGR"),{
        type:"line",data:{labels,datasets:[{label:"GGR Diário",data:serieGGR,borderColor:"green",fill:false}]}
    });
    chartFTD=new Chart(document.getElementById("graficoFTD"),{
        type:"line",data:{labels,datasets:[{label:"FTD Diário",data:serieFTD,borderColor:"yellow",fill:false}]}
    });
    chartDepositos=new Chart(document.getElementById("graficoDepositos"),{
        type:"line",data:{labels,datasets:[{label:"Depósitos Diários",data:serieDepositos,borderColor:"blue",fill:false}]}
    });
}

function atualizarRankings(){
    const topDepositos=[...dados].sort((a,b)=>b.depositos-a.depositos).slice(0,10);
    const topFTD=[...dados].sort((a,b)=>b.ftd-a.ftd).slice(0,10);
    const topGGR=[...dados].sort((a,b)=>b.ggr-a.ggr).slice(0,10);

    const tabelaDepositos=document.getElementById("rankingDepositos");
    const tabelaFTD=document.getElementById("rankingFTD");
    const tabelaGGR=document.getElementById("rankingGGR");

    tabelaDepositos.innerHTML="<tr><th>Clube</th><th>Depósitos</th></tr>"+topDepositos.map(l=>`<tr><td>${l.clube}</td><td>R$ ${l.depositos.toLocaleString()}</td></tr>`).join("");
    tabelaFTD.innerHTML="<tr><th>Clube</th><th>FTD</th></tr>"+topFTD.map(l=>`<tr><td>${l.clube}</td><td>R$ ${l.ftd.toLocaleString()}</td></tr>`).join("");
    tabelaGGR.innerHTML="<tr><th>Clube</th><th>GGR</th></tr>"+topGGR.map(l=>`<tr><td>${l.clube}</td><td>R$ ${l.ggr.toLocaleString()}</td></tr>`).join("");
}

function atualizarDashboard(){
    const t0=performance.now();
    let tFTD=0,tDep=0,tGGR=0;
    dados.forEach(l=>{tFTD+=l.ftd;tDep+=l.depositos;tGGR+=l.ggr});
    document.getElementById("totalFTD").textContent=`R$ ${tFTD.toLocaleString()}`;
    document.getElementById("totalDepositos").textContent=`R$ ${tDep.toLocaleString()}`;
    document.getElementById("totalGGR").textContent=`R$ ${tGGR.toLocaleString()}`;
    document.getElementById("ultimaAtualizacao").textContent=new Date().toLocaleString();
    document.getElementById("tempoProcessamento").textContent=(performance.now()-t0).toFixed(2);

    console.log(`Totais calculados -> FTD: ${tFTD}, Depósitos: ${tDep}, GGR: ${tGGR}`);
    atualizarGraficos();
    atualizarRankings();
}

function carregarCSV(){
    console.log("Iniciando carregamento do CSV...");
    Papa.parse(URL_CSV,{
        download:true,
        complete:function(res){
            console.log(`Linhas recebidas: ${res.data.length}`);
            console.log("Colunas detectadas:",res.data[0]);
            dados=normalizarDados(res.data.slice(1));
            console.log("Primeiras 5 linhas normalizadas:",dados.slice(0,5));
            atualizarDashboard();
        }
    });
}

document.getElementById("btnAplicar").addEventListener("click",()=>atualizarDashboard());
carregarCSV();
