document.addEventListener("DOMContentLoaded",function(){
 let csvURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQKxxxxxx/pub?output=csv";
 let grafGGR,grafFTD,grafDepositos;
 function carregarCSV(){
  let inicio=performance.now();
  Papa.parse(csvURL,{download:true,header:true,complete:function(res){
    let dados=res.data.filter(l=>l["DATA"]);
    let colunas=Object.keys(res.data[0]);
    let idx={data:colunas.indexOf("DATA"),clube:colunas.indexOf("Usuário - Nome de usuário"),ftd:colunas.indexOf("Usuário - FTD-Montante"),dep:colunas.indexOf("Usuário - Depósitos"),ggr:colunas.indexOf("Cálculo - GGR")};
    let normalizado=dados.map(l=>({data:l[colunas[idx.data]],clube:l[colunas[idx.clube]],ftd:+l[colunas[idx.ftd]]||0,depositos:+l[colunas[idx.dep]]||0,ggr:+l[colunas[idx.ggr]]||0}));
    atualizarDashboard(normalizado);
    document.getElementById("tempoProcessamento").textContent=(performance.now()-inicio).toFixed(2)+" ms";
    document.getElementById("ultimaAtualizacao").textContent=new Date().toLocaleString();
  }});
 }
 function atualizarDashboard(dados){
  let totFTD=dados.reduce((a,b)=>a+b.ftd,0),totDep=dados.reduce((a,b)=>a+b.depositos,0),totGGR=dados.reduce((a,b)=>a+b.ggr,0);
  document.getElementById("ftdTotal").textContent="R$ "+totFTD.toLocaleString();
  document.getElementById("depositosTotal").textContent="R$ "+totDep.toLocaleString();
  document.getElementById("ggrTotal").textContent="R$ "+totGGR.toLocaleString();
  atualizarGraficos(dados);
  atualizarRankings(dados);
 }
 function atualizarGraficos(dados){
  let dias=[...new Set(dados.map(l=>l.data))].sort();
  let porDia=dias.map(d=>({d,ftd:dados.filter(l=>l.data===d).reduce((a,b)=>a+b.ftd,0),dep:dados.filter(l=>l.data===d).reduce((a,b)=>a+b.depositos,0),ggr:dados.filter(l=>l.data===d).reduce((a,b)=>a+b.ggr,0)}));
  let ctxGGR=document.getElementById("graficoGGR").getContext("2d");
  let ctxFTD=document.getElementById("graficoFTD").getContext("2d");
  let ctxDep=document.getElementById("graficoDepositos").getContext("2d");
  if(grafGGR) grafGGR.destroy(); if(grafFTD) grafFTD.destroy(); if(grafDepositos) grafDepositos.destroy();
  grafGGR=new Chart(ctxGGR,{type:"line",data:{labels:dias,datasets:[{label:"GGR Diário",data:porDia.map(e=>e.ggr),borderColor:"green"}]}});
  grafFTD=new Chart(ctxFTD,{type:"line",data:{labels:dias,datasets:[{label:"FTD Diário",data:porDia.map(e=>e.ftd),borderColor:"yellow"}]}});
  grafDepositos=new Chart(ctxDep,{type:"line",data:{labels:dias,datasets:[{label:"Depósitos Diários",data:porDia.map(e=>e.dep),borderColor:"blue"}]}});
 }
 function atualizarRankings(dados){
  function top10(arr,key){return [...arr.reduce((m,o)=>m.set(o.clube,(m.get(o.clube)||0)+o[key]),new Map())].map(([c,v])=>({clube:c,valor:v})).sort((a,b)=>b.valor-a.valor).slice(0,10);}
  preencherTabela("tabelaDepositos",top10(dados,"depositos"),"Depósitos");
  preencherTabela("tabelaFTD",top10(dados,"ftd"),"FTD");
  preencherTabela("tabelaGGR",top10(dados,"ggr"),"GGR");
 }
 function preencherTabela(id,dados,titulo){
  let html="<tr><th>Clube</th><th>"+titulo+"</th></tr>";
  dados.forEach(l=>html+=`<tr><td>${l.clube}</td><td>R$ ${l.valor.toLocaleString()}</td></tr>`);
  document.getElementById(id).innerHTML=html;
 }
 document.getElementById("filtros").addEventListener("submit",e=>{e.preventDefault();carregarCSV();});
 carregarCSV();
});
