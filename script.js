let dadosCSV=[],chartGGR,chartFTD,chartDepositos;function carregarCSV(){console.log("Iniciando carregamento do CSV...");let e=performance.now();Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv",{download:!0,header:!1,complete:function(t){console.log("CSV recebido com sucesso");let o=normalizarDados(t.data);console.log("Dados normalizados:",o.length,"linhas"),dadosCSV=o,preencherFiltros(),atualizarDashboard(o);let r=performance.now()-e;document.getElementById("tempoProcessamento").innerText=`Tempo de processamento: ${r.toFixed(2)} ms`,document.getElementById("loading").style.display="none"}})}function normalizarDados(e){let t=[];return e.slice(1).forEach((e=>{if(e.length>=27){let o=e[0],r=e[2],a=parseFloat(e[5].replace(/[^0-9.-]+/g,""))||0,n=parseFloat(e[6].replace(/[^0-9.-]+/g,""))||0,l=parseFloat(e[26].replace(/[^0-9.-]+/g,""))||0;t.push({data:o,clube:r,ftd:a,depositos:n,ggr:l})}})),t}function preencherFiltros(){console.log("Preenchendo filtros de clubes...");let e=[...new Set(dadosCSV.map((e=>e.clube)))],t=document.getElementById("clubeSelect");t.innerHTML='<option value="Todos">Todos</option>',e.forEach((e=>{let o=document.createElement("option");o.value=e,o.textContent=e,t.appendChild(o)}))}function aplicarFiltros(){console.log("Aplicando filtros...");let e=document.getElementById("dataFiltro").value,t=document.getElementById("clubeSelect").value,o=dadosCSV.filter((o=>{let r=!e||o.data===e,a="Todos"===t||o.clube===t;return r&&a}));atualizarDashboard(o)}function atualizarDashboard(e){console.log("Atualizando dashboard com",e.length,"linhas");let t=e.reduce(((e,t)=>(e.ftd+=t.ftd,e.depositos+=t.depositos,e.ggr+=t.ggr,e)),{ftd:0,depositos:0,ggr:0});document.getElementById("totalFTD").innerText=`R$ ${t.ftd.toLocaleString("pt-BR",{minimumFractionDigits:2})}`,document.getElementById("totalDepositos").innerText=`R$ ${t.depositos.toLocaleString("pt-BR",{minimumFractionDigits:2})}`,document.getElementById("totalGGR").innerText=`R$ ${t.ggr.toLocaleString("pt-BR",{minimumFractionDigits:2})}`,atualizarGraficos(e),atualizarRankings(e)}function atualizarGraficos(e){console.log("Atualizando gráficos...");let t=e.map((e=>e.data)),o=e.map((e=>e.ggr)),r=e.map((e=>e.ftd)),a=e.map((e=>e.depositos));chartGGR&&chartGGR.destroy(),chartFTD&&chartFTD.destroy(),chartDepositos&&chartDepositos.destroy(),chartGGR=new Chart(document.getElementById("graficoGGR"),{type:"line",data:{labels:t,datasets:[{label:"GGR Diário",data:o,borderColor:"lime",fill:!1}]}}),chartFTD=new Chart(document.getElementById("graficoFTD"),{type:"line",data:{labels:t,datasets:[{label:"FTD Diário",data:r,borderColor:"yellow",fill:!1}]}}),chartDepositos=new Chart(document.getElementById("graficoDepositos"),{type:"line",data:{labels:t,datasets:[{label:"Depósitos Diários",data:a,borderColor:"blue",fill:!1}]}})}function atualizarRankings(e){console.log("Atualizando rankings...");let t=agruparPorClube(e);atualizarTabela("rankingDepositos",ordenarTop(t,"depositos"),["Clube","Depósitos"]),atualizarTabela("rankingFTD",ordenarTop(t,"ftd"),["Clube","FTD"]),atualizarTabela("rankingGGR",ordenarTop(t,"ggr"),["Clube","GGR"])}function agruparPorClube(e){let t={};return e.forEach((e=>{t[e.clube]||(t[e.clube]={clube:e.clube,ftd:0,depositos:0,ggr:0}),t[e.clube].ftd+=e.ftd,t[e.clube].depositos+=e.depositos,t[e.clube].ggr+=e.ggr})),Object.values(t)}function ordenarTop(e,t){return[...e].sort(((e,o)=>o[t]-e[t])).slice(0,10)}function atualizarTabela(e,t,o){let r=document.getElementById(e);r.innerHTML=`<tr>${o.map((e=>`<th>${e.toUpperCase()}</th>`)).join("")}</tr>`;t.forEach((e=>{r.innerHTML+=`<tr><td>${e.clube}</td><td>R$ ${e[o[1].toLowerCase()].toLocaleString("pt-BR",{minimumFractionDigits:2})}</td></tr>`}))}window.onload=()=>{document.getElementById("ultimaAtualizacao").innerText=`Última atualização: ${new Date().toLocaleString()}`,carregarCSV()};
