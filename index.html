<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard Comparativo de Clubes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
      /* ... (o CSS permanece o mesmo) ... */
    </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-chart-line"></i> Dashboard Comparativo de Clubes</h1>
      <p>Analise e compare o desempenho de diferentes clubes em tempo real</p>
    </header>

    <div id="demoWarning">
      <i class="fas fa-exclamation-triangle"></i> Você está visualizando dados de demonstração.
    </div>

    <div class="controls">
      <!-- ... (controles permanecem os mesmos) ... -->
    </div>

    <div class="kpi-container">
      <!-- ... (KPIs permanecem os mesmos) ... -->
    </div>

    <div class="charts">
      <!-- ... (gráficos permanecem os mesmos) ... -->
    </div>

    <div class="tables">
      <div class="table-container">
        <h3><i class="fas fa-trophy"></i> Top 10 Depósitos</h3>
        <table id="topDepositos">
          <thead>
            <tr>
              <th>Clube</th>
              <th>Valor</th>
              <th>Variação</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="3">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-trophy"></i> Top 10 FTD</h3>
        <table id="topFTD">
          <thead>
            <tr>
              <th>Clube</th>
              <th>Valor</th>
              <th>Variação</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="3">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-trophy"></i> Top 10 GGR</h3>
        <table id="topGGR">
          <thead>
            <tr>
              <th>Clube</th>
              <th>Valor</th>
              <th>Variação</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="3">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      <p>Última atualização: <span id="ultimaAtualizacao"></span></p>
      <p>Dashboard desenvolvido para análise comparativa de clubes</p>
    </div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingMessage">Carregando dados...</div>
  </div>

  <script>
    const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
    let dados = [], charts = {}, usandoDemo = true;
    let valoresAnteriores = {};

    // Dados de demonstração para as tabelas
    const topDepositosData = [
      { clube: "Clube Alpha", valor: 245890, variacao: 112.5 },
      { clube: "Clube Beta", valor: 210430, variacao: 18.7 },
      { clube: "Clube Gamma", valor: 198650, variacao: 13.2 },
      { clube: "Clube Delta", valor: 185290, variacao: 113.3 },
      { clube: "Clube Epsilon", valor: 172340, variacao: 16.8 }
    ];

    const topFTDData = [
      { clube: "Clube Delta", valor: 32450, variacao: 128.7 },
      { clube: "Clube Gamma", valor: 28120, variacao: 114.9 },
      { clube: "Clube Alpha", valor: 25870, variacao: 12.4 },
      { clube: "Clube Beta", valor: 22340, variacao: 19.8 },
      { clube: "Clube Epsilon", valor: 18990, variacao: 15.1 }
    ];

    const topGGRData = [
      { clube: "Clube Gamma", valor: 67890, variacao: 122.5 },
      { clube: "Clube Delta", valor: 61430, variacao: 13.7 },
      { clube: "Clube Alpha", valor: 58230, variacao: 18.9 },
      { clube: "Clube Beta", valor: 52780, variacao: 11.4 },
      { clube: "Clube Epsilon", valor: 48120, variacao: 115.6 }
    ];

    function showLoading(on, msg="Carregando dados..."){
      $("#loadingMessage").text(msg);
      $("#loadingOverlay").css("display", on ? "flex" : "none");
    }

    function criarGrafico(ctx, labelA, labelB, colorA, colorB, type='line'){
      return new Chart(ctx, {
        type: type,
        data: {
          labels: [],
          datasets: [
            {
              label: labelA,
              data: [],
              borderColor: colorA,
              backgroundColor: type === 'bar' ? colorA + 'CC' : 'transparent',
              fill: type === 'line',
              tension: 0.3,
              borderWidth: 3,
              pointRadius: 4,
              pointBackgroundColor: colorA
            },
            {
              label: labelB,
              data: [],
              borderColor: colorB,
              backgroundColor: type === 'bar' ? colorB + 'CC' : 'transparent',
              fill: type === 'line',
              tension: 0.3,
              borderWidth: 3,
              pointRadius: 4,
              pointBackgroundColor: colorB
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top', labels: { color: '#ecf0f1', font: { size: 14 } } },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: R$ ${ctx.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`
              },
              backgroundColor: 'rgba(26, 37, 47, 0.9)',
              titleColor: '#3498db',
              bodyColor: '#ecf0f1',
              displayColors: false,
              padding: 12,
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: v => `R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits: 0})}`,
                color: '#bdc3c7'
              },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              ticks: { color: '#bdc3c7' },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            }
          }
        }
      });
    }

    function animarKPI(sel, novo, anterior){
      let el = $(sel + " .valor");
      let varEl = $(sel + " .variacao");
      
      // Calcular variação
      let variacao = 0;
      if (anterior !== undefined && anterior !== 0) {
        variacao = ((novo - anterior) / anterior) * 100;
      }
      
      // Atualizar elemento de variação
      let variacaoText = variacao >= 0 ? 
        `<span style="color: #2ecc71">↑${Math.abs(variacao).toFixed(1)}%</span>` : 
        `<span style="color: #e74c3c">↓${Math.abs(variacao).toFixed(1)}%</span>`;
      varEl.html(variacaoText);
      
      // Animar valor
      $(sel).removeClass("positive negative")
            .addClass(novo >= 0 ? "positive" : "negative");
            
      let ant = parseFloat(el.text().replace(/[^\d]/g, '')) || 0;
      let diff = (novo - ant) / 30;
      let cur = ant;
      let pass = 0;
      
      let h = setInterval(() => {
        cur += diff;
        pass++;
        if (pass >= 30) {
          clearInterval(h);
          cur = novo;
        }
        el.text("R$ " + cur.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
      }, 20);
      
      // Armazenar valor atual para próxima comparação
      valoresAnteriores[sel] = novo;
    }

    function carregar(){
      showLoading(true, "Conectando à fonte de dados...");
      
      Papa.parse(URL_CSV, {
        download: true,
        header: true,
        complete: function(r) {
          if (r.data && r.data.length > 0) {
            dados = r.data.filter(x => x.DATA);  
            usandoDemo = false;
            $("#demoWarning").hide();
          } else {  
            dados = [];
            usandoDemo = true;
            $("#demoWarning").show();
          }
          init();
        },
        error: function() {
          dados = [];
          usandoDemo = true;
          $("#demoWarning").show();
          init();
        }
      });
    }

    function init(){
      // Preencher selects
      let clubes = ["Clube Alpha", "Clube Beta", "Clube Gamma", "Clube Delta", "Clube Epsilon"];
      let opts = '<option value="Todos">Todos os Clubes</option>' +
                 clubes.map(c => `<option>${c}</option>`).join('');
      $("#filtroClubeA, #filtroClubeB").html(opts);
      
      // Configurar padrão: "Todos os Clubes" para ambos
      $("#filtroClubeA").val("Todos");
      $("#filtroClubeB").val("Todos");
      
      // Iniciar com últimos 7 dias
      let hoje = new Date();
      let ini = new Date();
      ini.setDate(hoje.getDate() - 7);
      $("#filtroInicio").val(ini.toISOString().slice(0,10));
      $("#filtroFim").val(hoje.toISOString().slice(0,10));
      
      // Inicializar gráficos
      charts.chartComparativo = criarGrafico($("#chartComparativo")[0], "Todos os Clubes", "Todos os Clubes", "#3498db", "#e74c3c", 'bar');
      charts.chartGGR = criarGrafico($("#chartGGR")[0], "Todos os Clubes", "Todos os Clubes", "#3498db", "#e74c3c");
      charts.chartDepositos = criarGrafico($("#chartDepositos")[0], "Todos os Clubes", "Todos os Clubes", "#3498db", "#e74c3c");
      charts.chartFTD = criarGrafico($("#chartFTD")[0], "Todos os Clubes", "Todos os Clubes", "#3498db", "#e74c3c");
      charts.chartSportsbook = criarGrafico($("#chartSportsbook")[0], "Todos os Clubes", "Todos os Clubes", "#3498db", "#e74c3c");
      charts.chartCassino = criarGrafico($("#chartCassino")[0], "Todos os Clubes", "Todos os Clubes", "#3498db", "#e74c3c");
      
      // Inicializar valores anteriores para KPIs
      const kpis = ['#kpi-ftd', '#kpi-depositos', '#kpi-ggr', '#kpi-sportsbook', '#kpi-cassino', '#kpi-bonus'];
      kpis.forEach(kpi => valoresAnteriores[kpi] = 0);
      
      atualizar();
      showLoading(false);
      
      // Atualizar automaticamente a cada 5 minutos
      setInterval(atualizarDados, 300000);
    }

    function aplicarFiltros(){ atualizar(); }
    
    function setPeriodo(d){
      let hoje = new Date();
      let ini = new Date();
      ini.setDate(hoje.getDate() - d);
      $("#filtroInicio").val(ini.toISOString().slice(0,10));
      $("#filtroFim").val(hoje.toISOString().slice(0,10));
      atualizar();
    }
    
    function atualizarDados(){
      showLoading(true, "Atualizando dados...");
      carregar();
    }

    function atualizar(){
      // Atualizar KPIs com valores de demonstração
      animarKPI("#kpi-ftd", 96423, 70800);
      animarKPI("#kpi-depositos", 1494091, 1278000);
      animarKPI("#kpi-ggr", 230142, 243500);
      animarKPI("#kpi-sportsbook", -58114, -95700);
      animarKPI("#kpi-cassino", 288240, 223700);
      animarKPI("#kpi-bonus", 122492, 226800);
      
      // Preencher as tabelas com dados de demonstração
      function preencherTabela(id, dados) {
        let html = dados.map(item => {
          let variacaoHtml = item.variacao >= 0 ? 
            `<td style="color:#2ecc70">↑${item.variacao.toFixed(1)}%</td>` : 
            `<td style="color:#e74c3c">↓${Math.abs(item.variacao).toFixed(1)}%</td>`;
          return `<tr>
            <td>${item.clube}</td>
            <td>R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            ${variacaoHtml}
          </tr>`;
        }).join('');
        $(id + " tbody").html(html);
      }
      
      preencherTabela("#topDepositos", topDepositosData);
      preencherTabela("#topFTD", topFTDData);
      preencherTabela("#topGGR", topGGRData);
      
      // Atualizar timestamp
      $("#ultimaAtualizacao").text(new Date().toLocaleString('pt-BR'));
    }

    function exportarCSV(){
      alert("Exportando dados para CSV...");
    }
    
    function toggleDarkMode(){
      alert("Modo escuro já está ativado!");
    }

    $(document).ready(function(){
      carregar();
    });
  </script>
</body>
</html>