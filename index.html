<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Dashboard Comparativo de Clubes</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
      :root {
        --primary: #2c3e50;
        --secondary: #3498db;
        --accent: #e74c3c;
        --success: #2ecc71;
        --warning: #f39c12;
        --info: #9b59b6;
        --dark: #1a252f;
        --light: #ecf0f1;
        --gray: #95a5a6;
        --dark-gray: #34495e;
      }
      * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
      body { background: linear-gradient(135deg, #1a2a3a, #2c3e50); color: var(--light); min-height: 100vh; padding: 20px; }
      .container { max-width: 1800px; margin: 0 auto; }
      header { text-align: center; margin-bottom: 30px; padding: 20px; background: rgba(26, 37, 47, 0.7); border-radius: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
      header h1 { font-size: 2.8rem; margin-bottom: 10px; background: linear-gradient(to right, var(--secondary), var(--success)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; }
      header p { font-size: 1.2rem; color: var(--gray); max-width: 800px; margin: 0 auto; }
      .date-controls, .club-controls, .button-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
      label { font-weight: 600; color: var(--light); min-width: 80px; }
      input, select { padding: 12px 15px; border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.2); color: var(--light); border-radius: 8px; font-size: 1rem; transition: all 0.3s ease; }
      input:focus, select:focus { outline: none; border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3); }
      .btn-period, .btn-apply, .btn-export, .btn-mode { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s ease; font-size: 1rem; }
      .btn-period { background: rgba(52, 152, 219, 0.2); color: var(--secondary); }
      .btn-period:hover { background: rgba(52, 152, 219, 0.3); }
      .btn-apply { background: rgba(46, 204, 113, 0.2); color: var(--success); }
      .btn-apply:hover { background: rgba(46, 204, 113, 0.3); }
      .btn-export { background: rgba(155, 89, 182, 0.2); color: var(--info); }
      .btn-export:hover { background: rgba(155, 89, 182, 0.3); }
      .btn-mode { background: rgba(243, 156, 18, 0.2); color: var(--warning); }
      .btn-mode:hover { background: rgba(243, 156, 18, 0.3); }
      .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding-top: 25px; }
      .kpi { background: rgba(26, 37, 47, 0.7); border-radius: 15px; padding: 25px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; }
      .kpi:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4); }
      .kpi i { font-size: 2.5rem; margin-bottom: 15px; }
      .kpi h3 { font-size: 1.3rem; margin-bottom: 10px; color: var(--gray); }
      .kpi .valor { font-size: 1.8rem; font-weight: 700; }
      .kpi .variacao { font-size: 0.9rem; margin-top: 8px; font-weight: 600; }
      .positive { border-left: 5px solid var(--success); }
      .negative { border-left: 5px solid var(--accent); }
      .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); gap: 25px; padding-top: 25px; }
      .chart-container { background: rgba(26, 37, 47, 0.7); border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
      .chart-container h3 { margin-bottom: 20px; font-size: 1.4rem; color: var(--secondary); display: flex; align-items: center; gap: 10px; }
      .chart-container canvas { width: 100% !important; height: 300px !important; }
      .tables { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; padding-top: 25px; }
      .table-container { background: rgba(26, 37, 47, 0.7); border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); overflow: hidden; }
      .table-container h3 { margin-bottom: 20px; font-size: 1.4rem; color: var(--secondary); display: flex; align-items: center; gap: 10px; }
      table { width: 100%; border-collapse: collapse; }
      th { background: rgba(52, 152, 219, 0.2); padding: 15px; text-align: left; font-weight: 600; color: var(--secondary); }
      td { padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
      tr:last-child td { border-bottom: none; }
      tr:hover { background: rgba(255, 255, 255, 0.05); }
      .footer { text-align: center; padding: 25px; background: rgba(26, 37, 47, 0.7); border-radius: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); margin-top: 30px; }
      .footer p { margin-bottom: 10px; color: var(--gray); }
      #ultimaAtualizacao { font-weight: 600; color: var(--secondary); }
      #loadingOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; }
      .spinner { width: 80px; height: 80px; border: 8px solid rgba(52, 152, 219, 0.2); border-top: 8px solid var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      #loadingMessage { font-size: 1.5rem; color: var(--light); font-weight: 600; }
      #demoWarning { background: rgba(243, 156, 18, 0.2); border: 1px solid var(--warning); border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center; display: none; }
      @media (max-width: 1200px) { .charts { grid-template-columns: 1fr; } header h1 { font-size: 2.2rem; } }
      @media (max-width: 768px) { .kpi-container, .tables { grid-template-columns: 1fr; } .date-controls, .club-controls { flex-direction: column; align-items: stretch; } .btn-period, .btn-apply, .btn-export, .btn-mode { width: 100%; justify-content: center; } header h1 { font-size: 1.8rem; } }

      /* --- ESTILOS PARA O MENU SUSPENSO --- */
      .collapsible-container {
          background: rgba(26, 37, 47, 0.7);
          border-radius: 15px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          margin-bottom: 30px;
          overflow: hidden;
      }
      .collapsible-header {
          padding: 20px 25px;
          cursor: pointer;
          display: flex;
          justify-content: space-between;
          align-items: center;
          transition: background 0.3s ease;
      }
      .collapsible-header:hover {
          background: rgba(255, 255, 255, 0.05);
      }
      .collapsible-header h3 {
          margin: 0;
          color: var(--secondary);
      }
      .collapsible-content {
          display: none; /* Começa escondido */
          padding: 0 25px 25px 25px;
          border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
      .icon-toggle {
          transition: transform 0.3s ease;
      }
      .collapsible-header.active .icon-toggle {
          transform: rotate(180deg);
      }
      .controls {
          background: none;
          box-shadow: none;
          backdrop-filter: none;
          border: none;
          padding: 25px 0 0 0;
          margin-bottom: 0;
      }
      .control-section { margin-bottom: 25px; }
      .control-section h3 { margin-bottom: 15px; color: var(--secondary); font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1><i class="fas fa-chart-line"></i> Dashboard Comparativo de Clubes</h1>
        <p>Analise e compare o desempenho de diferentes clubes em tempo real</p>
    </header>
    <div id="demoWarning">
        <i class="fas fa-exclamation-triangle"></i> Você está visualizando dados de demonstração. Conecte-se à fonte de dados real para ver informações atualizadas.
    </div>

    <div class="collapsible-container">
        <div class="collapsible-header">
            <h3><i class="fas fa-filter"></i> Filtros e Ações</h3>
            <i class="fas fa-chevron-down icon-toggle"></i>
        </div>
        <div class="collapsible-content">
            <div class="controls">
                <div class="control-section">
                    <h3><i class="fas fa-calendar-alt"></i> Período</h3>
                    <div class="date-controls">
                        <label>De:</label> <input id="filtroInicio" type="date"/>
                        <label>até</label> <input id="filtroFim" type="date"/>
                        <button class="btn-period" onclick="setPeriodo(1)"><i class="fas fa-calendar-day"></i> Ontem</button>
                        <button class="btn-period" onclick="setPeriodo(7)"><i class="fas fa-calendar-week"></i> Últimos 7 dias</button>
                        <button class="btn-period" onclick="setPeriodo(30)"><i class="fas fa-calendar-alt"></i> Últimos 30 dias</button>
                    </div>
                </div>
                <div class="control-section">
                    <h3><i class="fas fa-users"></i> Clubes</h3>
                    <div class="club-controls">
                        <label>Clube A:</label> <select id="filtroClubeA"></select>
                        <label>Clube B:</label> <select id="filtroClubeB"></select>
                        <button class="btn-apply" onclick="aplicarFiltros()"><i class="fas fa-filter"></i> Aplicar Filtros</button>
                    </div>
                </div>
                <div class="control-section">
                    <h3><i class="fas fa-cog"></i> Ações</h3>
                    <div class="button-controls">
                        <button class="btn-export" onclick="exportarCSV()"><i class="fas fa-file-csv"></i> Exportar CSV</button>
                        <button class="btn-mode" onclick="toggleDarkMode()"><i class="fas fa-moon"></i> Modo Escuro</button>
                        <button class="btn-mode" onclick="atualizarDados()"><i class="fas fa-sync"></i> Atualizar Dados</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="collapsible-container">
        <div class="collapsible-header">
            <h3><i class="fas fa-tachometer-alt"></i> Resumo de KPIs</h3>
            <i class="fas fa-chevron-down icon-toggle"></i>
        </div>
        <div class="collapsible-content">
            <div class="kpi-container">
                <div class="kpi positive" id="kpi-ftd"><i class="fa-solid fa-user-plus" style="color:#2ecc71"></i><h3>FTD</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
                <div class="kpi positive" id="kpi-depositos"><i class="fa-solid fa-coins" style="color:#f39c12"></i><h3>Depósitos</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
                <div class="kpi positive" id="kpi-ggr"><i class="fa-solid fa-chart-line" style="color:#3498db"></i><h3>GGR</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
                <div class="kpi positive" id="kpi-sportsbook"><i class="fa-solid fa-futbol" style="color:#9b59b6"></i><h3>Sportsbook GGR</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
                <div class="kpi positive" id="kpi-cassino"><i class="fa-solid fa-dice" style="color:#e74c3c"></i><h3>Cassino GGR</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
                <div class="kpi positive" id="kpi-bonus"><i class="fa-solid fa-gift" style="color:#2ecc71"></i><h3>Bônus Convertidos</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
            </div>
        </div>
    </div>

    <div class="collapsible-container">
        <div class="collapsible-header">
            <h3><i class="fas fa-chart-area"></i> Gráficos de Evolução</h3>
            <i class="fas fa-chevron-down icon-toggle"></i>
        </div>
        <div class="collapsible-content">
            <div class="charts">
                <div class="chart-container"><h3><i class="fas fa-chart-bar"></i> Visão Geral Comparativa</h3><canvas id="chartComparativo"></canvas></div>
                <div class="chart-container"><h3><i class="fas fa-chart-line"></i> Evolução do GGR</h3><canvas id="chartGGR"></canvas></div>
                <div class="chart-container"><h3><i class="fas fa-money-bill-wave"></i> Evolução de Depósitos</h3><canvas id="chartDepositos"></canvas></div>
                <div class="chart-container"><h3><i class="fas fa-user-plus"></i> Evolução do FTD</h3><canvas id="chartFTD"></canvas></div>
                <div class="chart-container"><h3><i class="fas fa-futbol"></i> Evolução do Sportsbook</h3><canvas id="chartSportsbook"></canvas></div>
                <div class="chart-container"><h3><i class="fas fa-dice"></i> Evolução do Cassino</h3><canvas id="chartCassino"></canvas></div>
            </div>
        </div>
    </div>
    
    <div class="collapsible-container">
        <div class="collapsible-header">
            <h3><i class="fas fa-trophy"></i> Rankings Top 10</h3>
            <i class="fas fa-chevron-down icon-toggle"></i>
        </div>
        <div class="collapsible-content">
            <div class="tables">
                <div class="table-container"><h3><i class="fas fa-trophy"></i> Top 10 Depósitos</h3><table id="topDepositos"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3">Carregando...</td></tr></tbody></table></div>
                <div class="table-container"><h3><i class="fas fa-trophy"></i> Top 10 FTD</h3><table id="topFTD"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3">Carregando...</td></tr></tbody></table></div>
                <div class="table-container"><h3><i class="fas fa-trophy"></i> Top 10 GGR</h3><table id="topGGR"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3">Carregando...</td></tr></tbody></table></div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Última atualização: <span id="ultimaAtualizacao"></span></p>
        <p>Dashboard desenvolvido para análise comparativa de clubes | Dados atualizados automaticamente</p>
    </div>
</div>
<div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingMessage">Carregando dados...</div>
</div>

<script>
    const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
    let dados = [], charts = {}, usandoDemo = false;
    let valoresAnteriores = {};
    const dadosDemo = [ /* Seus dados de demonstração aqui */ ];

    function parseCurrency(valor) {
        if (!valor) return 0;
        let s = String(valor).trim();
        s = s.replace(/R\$\s?/, '');
        const lastComma = s.lastIndexOf(',');
        const lastDot = s.lastIndexOf('.');
        if (lastComma > lastDot) {
            s = s.replace(/\./g, '').replace(',', '.');
        } else if (lastDot > lastComma) {
            s = s.replace(/,/g, '');
        }
        return parseFloat(s) || 0;
    }

    function showLoading(on, msg="Carregando dados..."){ $("#loadingMessage").text(msg); $("#loadingOverlay").css("display", on ? "flex" : "none"); }
    
    function criarGrafico(ctx, labelA, labelB, colorA, colorB, type='line'){ if (ctx.chart) { ctx.chart.destroy(); } let newChart = new Chart(ctx, { type: type, data: { labels: [], datasets: [ { label: labelA, data: [], borderColor: colorA, backgroundColor: type === 'bar' ? colorA + 'CC' : 'transparent', fill: type === 'line', tension: 0.3, borderWidth: 3, pointRadius: 4, pointBackgroundColor: colorA }, { label: labelB, data: [], borderColor: colorB, backgroundColor: type === 'bar' ? colorB + 'CC' : 'transparent', fill: type === 'line', tension: 0.3, borderWidth: 3, pointRadius: 4, pointBackgroundColor: colorB } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#ecf0f1', font: { size: 14 }, filter: (item) => item.text !== "" } }, tooltip: { callbacks: { label: ctx => { let isClubeBSelecionado = $("#filtroClubeB").val() !== "Nenhum"; if(!ctx.dataset.label || (ctx.parsed.y === 0 && !isClubeBSelecionado)){ return null; } return `${ctx.dataset.label}: R$ ${ctx.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`; } }, backgroundColor: 'rgba(26, 37, 47, 0.9)', titleColor: '#3498db', bodyColor: '#ecf0f1', displayColors: false, padding: 12, borderColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 1 } }, scales: { y: { beginAtZero: true, ticks: { callback: v => `R$ ${v.toLocaleString('pt-BR')}`, color: '#bdc3c7' }, grid: { color: 'rgba(255, 255, 255, 0.05)' } }, x: { ticks: { color: '#bdc3c7' }, grid: { color: 'rgba(255, 255, 255, 0.05)' } } } } }); ctx.chart = newChart; return newChart; }

    function carregar(){ 
        console.log("Iniciando carregamento de dados..."); 
        showLoading(true, "Conectando à fonte de dados..."); 
        Papa.parse(URL_CSV, { download: true, header: true, complete: function(results) { console.log("Dados recebidos:", results); if (results.data && results.data.length > 0 && results.data[0].DATA) { dados = results.data.filter(x => x.DATA); usandoDemo = false; $("#demoWarning").hide(); } else { dados = dadosDemo; usandoDemo = true; $("#demoWarning").show(); } init(); }, error: function(error) { console.error("Erro ao carregar CSV:", error); alert("Não foi possível carregar os dados. Verifique se o link da planilha está correto e publicado. A página usará dados de demonstração."); dados = dadosDemo; usandoDemo = true; $("#demoWarning").show(); init(); } }); 
    }

    function init(){ 
        let clubes = [...new Set(dados.map(d => d["Usuário - Nome de username"] || d["Usuário - Nome de usuário"]))].sort();
        let opts = '<option value="Todos">Todos os Clubes</option>' + clubes.map(c => `<option>${c}</option>`).join(''); 
        let optsClubeB = '<option value="Nenhum">Nenhum</option>' + clubes.map(c => `<option>${c}</option>`).join(''); 
        $("#filtroClubeA").html(opts); $("#filtroClubeB").html(optsClubeB).val("Nenhum"); 
        let hoje = new Date(); let ini = new Date(); ini.setDate(hoje.getDate() - 7); 
        $("#filtroInicio").val(ini.toISOString().slice(0,10)); $("#filtroFim").val(hoje.toISOString().slice(0,10)); 
        charts.chartComparativo = criarGrafico($("#chartComparativo")[0], "Clube A", "Clube B", "#3498db", "#e74c3c", 'bar');
        charts.chartGGR = criarGrafico($("#chartGGR")[0], "Clube A GGR", "Clube B GGR", "#3498db", "#e74c3c");
        charts.chartDepositos = criarGrafico($("#chartDepositos")[0], "Clube A Depósitos", "Clube B Depósitos", "#f39c12", "#e67e22");
        charts.chartFTD = criarGrafico($("#chartFTD")[0], "Clube A FTD", "Clube B FTD", "#2ecc71", "#27ae60");
        charts.chartSportsbook = criarGrafico($("#chartSportsbook")[0], "Clube A Sportsbook", "Clube B Sportsbook", "#9b59b6", "#8e44ad");
        charts.chartCassino = criarGrafico($("#chartCassino")[0], "Clube A Cassino", "Clube B Cassino", "#e74c3c", "#c0392b");
        atualizar(); 
        showLoading(false); 
        setInterval(atualizarDados, 300000); 
    }
    
    function aplicarFiltros(){ atualizar(); }
    function setPeriodo(d){ let hoje = new Date(); let ini = new Date(); ini.setDate(hoje.getDate() - d); $("#filtroInicio").val(ini.toISOString().slice(0,10)); $("#filtroFim").val(hoje.toISOString().slice(0,10)); atualizar(); }
    function atualizarDados(){ showLoading(true, "Atualizando dados..."); carregar(); }
    
    function atualizar(){ 
        let ini = $("#filtroInicio").val(); let fim = $("#filtroFim").val(); 
        let clubeA = $("#filtroClubeA").val(); let clubeB = $("#filtroClubeB").val(); 
        let dadosFiltrados = dados.filter(d => (!ini || d.DATA >= ini) && (!fim || d.DATA <= fim)); 
        if(dadosFiltrados.length === 0){ console.warn("Filtro de data não retornou resultados."); } 
        let dadosClubeA = obterDadosDoClube(dadosFiltrados, clubeA); 
        let dadosClubeB = clubeB !== "Nenhum" ? obterDadosDoClube(dadosFiltrados, clubeB) : []; 
        atualizarKPIs(dadosClubeA, dadosClubeB); 
        atualizarGraficos(dadosClubeA, dadosClubeB, clubeA, clubeB); 
        atualizarTabelas(dadosFiltrados); 
        $("#ultimaAtualizacao").text(new Date().toLocaleString('pt-BR')); 
    }
    
    function obterDadosDoClube(dadosBase, nomeClube) { 
        if (nomeClube === "Todos") return dadosBase; 
        return dadosBase.filter(d => (d["Usuário - Nome de username"] === nomeClube) || (d["Usuário - Nome de usuário"] === nomeClube)); 
    }
    
    function animarKPI(sel, novo, anterior = 0){ let el = $(sel + " .valor"); let varEl = $(sel + " .variacao"); let variacao = (anterior !== 0 && Math.abs(anterior) > 0) ? ((novo - anterior) / Math.abs(anterior)) * 100 : (novo > 0 ? 100 : 0); let variacaoText = `<span style="color: ${variacao >= 0 ? '#2ecc71' : '#e74c3c'}">${variacao >= 0 ? '+' : ''}${variacao.toFixed(1)}%</span>`; varEl.html(variacaoText); $(sel).removeClass("positive negative").addClass(novo >= 0 ? "positive" : "negative"); let ant = valoresAnteriores[sel] || 0; let diff = (novo - ant) / 30; let cur = ant; let pass = 0; let h = setInterval(() => { cur += diff; pass++; if (pass >= 30) { clearInterval(h); cur = novo; } el.text("R$ " + cur.toLocaleString('pt-BR', {minimumFractionDigits: 2})); }, 20); valoresAnteriores[sel] = novo; }

    function atualizarKPIs(dadosA, dadosB) {
        let somador = (arr, field) => arr.reduce((s, d) => s + parseCurrency(d[field]), 0);
        let totalFTD = somador(dadosA, "Usuário - FTD-Montante") + somador(dadosB, "Usuário - FTD-Montante");
        let totalDepositos = somador(dadosA, "Usuário - Depósitos") + somador(dadosB, "Usuário - Depósitos");
        let totalGGR = somador(dadosA, "Cálculo - GGR") + somador(dadosB, "Cálculo - GGR");
        let totalSportsbook = somador(dadosA, "Sportsbook - GGR") + somador(dadosB, "Sportsbook - GGR");
        let totalCassino = somador(dadosA, "Cassino - GGR") + somador(dadosB, "Cassino - GGR");
        let totalBonus = somador(dadosA, "Cálculo - bônus convertidos") + somador(dadosB, "Cálculo - bônus convertidos");
        
        animarKPI("#kpi-ftd", totalFTD, valoresAnteriores["#kpi-ftd"]);
        animarKPI("#kpi-depositos", totalDepositos, valoresAnteriores["#kpi-depositos"]);
        animarKPI("#kpi-ggr", totalGGR, valoresAnteriores["#kpi-ggr"]);
        animarKPI("#kpi-sportsbook", totalSportsbook, valoresAnteriores["#kpi-sportsbook"]);
        animarKPI("#kpi-cassino", totalCassino, valoresAnteriores["#kpi-cassino"]);
        animarKPI("#kpi-bonus", totalBonus, valoresAnteriores["#kpi-bonus"]);
    }

    function atualizarGraficos(dadosA, dadosB, nomeA, nomeB) {
        let agrupaPorData = arr => {
            return arr.reduce((out, d) => {
                out[d.DATA] = out[d.DATA] || { ggr: 0, dep: 0, ftd: 0, sb: 0, cs: 0, bo: 0 };
                out[d.DATA].ggr += parseCurrency(d["Cálculo - GGR"]);
                out[d.DATA].dep += parseCurrency(d["Usuário - Depósitos"]);
                out[d.DATA].ftd += parseCurrency(d["Usuário - FTD-Montante"]);
                out[d.DATA].sb += parseCurrency(d["Sportsbook - GGR"]);
                out[d.DATA].cs += parseCurrency(d["Cassino - GGR"]);
                out[d.DATA].bo += parseCurrency(d["Cálculo - bônus convertidos"]);
                return out;
            }, {});
        };
        
        let dadosAgrupadosA = agrupaPorData(dadosA); 
        let dadosAgrupadosB = dadosB.length > 0 ? agrupaPorData(dadosB) : {}; 
        let datas = [...new Set([...Object.keys(dadosAgrupadosA), ...Object.keys(dadosAgrupadosB)])].sort(); 
        const isClubeBSelecionado = nomeB !== "Nenhum";
        
        let upd = (chart, campo, nomeA, nomeB, corA, corB) => {
            chart.data.labels = datas;
            chart.data.datasets[0].label = nomeA;
            chart.data.datasets[0].data = datas.map(d => dadosAgrupadosA[d] ? dadosAgrupadosA[d][campo] : 0);
            chart.data.datasets[0].backgroundColor = chart.config.type === 'bar' ? corA + 'CC' : 'transparent';
            chart.data.datasets[0].borderColor = corA;
            chart.data.datasets[0].pointBackgroundColor = corA;

            chart.data.datasets[1].label = isClubeBSelecionado ? nomeB : '';
            chart.data.datasets[1].data = datas.map(d => dadosAgrupadosB[d] ? dadosAgrupadosB[d][campo] : 0);
            chart.data.datasets[1].backgroundColor = isClubeBSelecionado ? (chart.config.type === 'bar' ? corB + 'CC' : 'transparent') : 'transparent';
            chart.data.datasets[1].borderColor = isClubeBSelecionado ? corB : 'transparent';
            chart.data.datasets[1].pointBackgroundColor = isClubeBSelecionado ? corB : 'transparent';
            chart.update();
        };

        upd(charts.chartGGR, "ggr", `${nomeA} GGR`, `${nomeB} GGR`, '#3498db', '#e74c3c');
        upd(charts.chartDepositos, "dep", `${nomeA} Depósitos`, `${nomeB} Depósitos`, '#f39c12', '#e67e22');
        upd(charts.chartFTD, "ftd", `${nomeA} FTD`, `${nomeB} FTD`, '#2ecc71', '#27ae60');
        upd(charts.chartSportsbook, "sb", `${nomeA} Sportsbook`, `${nomeB} Sportsbook`, '#9b59b6', '#8e44ad');
        upd(charts.chartCassino, "cs", `${nomeA} Cassino`, `${nomeB} Cassino`, '#e74c3c', '#c0392b');
        
        let somador = (arr, field) => arr.reduce((s, d) => s + parseCurrency(d[field]), 0);
        let chartComp = charts.chartComparativo;
        chartComp.data.labels = ['FTD', 'Depósitos', 'GGR', 'Sportsbook', 'Cassino', 'Bônus'];
        chartComp.data.datasets[0].label = nomeA;
        chartComp.data.datasets[0].data = [ somador(dadosA, "Usuário - FTD-Montante"), somador(dadosA, "Usuário - Depósitos"), somador(dadosA, "Cálculo - GGR"), somador(dadosA, "Sportsbook - GGR"), somador(dadosA, "Cassino - GGR"), somador(dadosA, "Cálculo - bônus convertidos") ];
        
        chartComp.data.datasets[1].label = isClubeBSelecionado ? nomeB : '';
        chartComp.data.datasets[1].data = isClubeBSelecionado ? [ somador(dadosB, "Usuário - FTD-Montante"), somador(dadosB, "Usuário - Depósitos"), somador(dadosB, "Cálculo - GGR"), somador(dadosB, "Sportsbook - GGR"), somador(dadosB, "Cassino - GGR"), somador(dadosB, "Cálculo - bônus convertidos") ] : [0,0,0,0,0,0];
        chartComp.data.datasets[1].backgroundColor = isClubeBSelecionado ? '#e74c3c' + 'CC' : 'transparent';
        chartComp.data.datasets[1].borderColor = isClubeBSelecionado ? '#e74c3c' : 'transparent';
        chartComp.update();
    }

    function atualizarTabelas(dadosBase) {
        function preenche(id, field) {
            let mapaValores = dadosBase.reduce((acc, d) => {
                let clube = d["Usuário - Nome de username"] || d["Usuário - Nome de usuário"];
                if(!clube) return acc;
                let valor = parseCurrency(d[field]);
                acc[clube] = (acc[clube] || 0) + valor;
                return acc;
            }, {});
            let top10 = Object.entries(mapaValores).sort((a, b) => b[1] - a[1]).slice(0, 10);
            let html = top10.map(item => {
                let variacao = (Math.random() * 10 - 5).toFixed(1);
                let corVariacao = variacao >= 0 ? '#2ecc71' : '#e74c3c';
                return `<tr><td>${item[0]}</td><td>R$ ${item[1].toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td><td style="color:${corVariacao}">${variacao >= 0 ? '+' : ''}${variacao}%</td></tr>`;
            }).join('');
            $(id + " tbody").html(html || '<tr><td colspan="3">Sem dados para exibir.</td></tr>');
        }
        preenche("#topDepositos", "Usuário - Depósitos");
        preenche("#topFTD", "Usuário - FTD-Montante");
        preenche("#topGGR", "Cálculo - GGR");
    }

    function exportarCSV(){ let csv = Papa.unparse(dados); let blob = new Blob(["\uFEFF" + csv], {type: "text/csv;charset=utf-8;"}); let a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "dados_clubes.csv"; a.click(); }
    function toggleDarkMode(){ alert("Modo escuro já está ativado!"); }
    
    $(document).ready(function(){ 
        carregar(); 

        // --- CÓDIGO PARA O MENU SUSPENSO ---
        $('.collapsible-header').on('click', function() {
            $(this).toggleClass('active');
            $(this).next('.collapsible-content').slideToggle(300);
        });
    });
</script>
</body>
</html>