/* === CÓDIGO JAVASCRIPT COM DEBUG ATIVO === */

const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
let dados = [], charts = {};
let valoresAnteriores = {};

function getUsernameField(dataRow) {
    if (dataRow && dataRow["Usuário - Nome de usuário"]) return "Usuário - Nome de usuário";
    if (dataRow && dataRow["Usuário - Nome de username"]) return "Usuário - Nome de username";
    console.log("DEBUG: Campo de nome de usuário não encontrado. Retornando null.");
    return null;
}

function showLoading(on, msg="Carregando dados..."){
    $("#loadingMessage").text(msg);
    $("#loadingOverlay").css("display", on ? "flex" : "none");
}

function criarGrafico(ctx, labelA, labelB, colorA, colorB, type='line'){
    return new Chart(ctx, {
        type: type,
        data: {
            labels: [],
            datasets: [
                {
                    label: labelA,
                    data: [],
                    borderColor: colorA,
                    backgroundColor: type === 'bar' ? colorA + 'CC' : 'transparent',
                    fill: type === 'line',
                    tension: 0.3,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointBackgroundColor: colorA
                },
                {
                    label: labelB,
                    data: [],
                    borderColor: colorB,
                    backgroundColor: type === 'bar' ? colorB + 'CC' : 'transparent',
                    fill: type === 'line',
                    tension: 0.3,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointBackgroundColor: colorB
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'top', 
                    labels: { 
                        color: '#ecf0f1', 
                        font: { size: 14 },
                        filter: function(item) {
                            return item.text !== null && item.text !== "";
                        } 
                    } 
                },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            let datasetLabel = ctx.dataset.label;
                            let value = ctx.parsed.y;
                            if (value === 0) return null;
                            return `${datasetLabel}: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                        }
                    },
                    backgroundColor: 'rgba(26, 37, 47, 0.9)',
                    titleColor: '#3498db',
                    bodyColor: '#ecf0f1',
                    displayColors: false,
                    padding: 12,
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: v => `R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits: 0})}`,
                        color: '#bdc3c7'
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                },
                x: {
                    ticks: { color: '#bdc3c7' },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                }
            }
        }
    });
}

function animarKPI(sel, novo, anterior){
    let el = $(sel + " .valor");
    let varEl = $(sel + " .variacao");
    
    let variacao = 0;
    if (anterior !== undefined && anterior !== 0) {
        variacao = ((novo - anterior) / anterior) * 100;
    }
    
    let variacaoText = variacao >= 0 ? 
        `<span style="color: #2ecc71">+${variacao.toFixed(1)}%</span>` : 
        `<span style="color: #e74c3c">${variacao.toFixed(1)}%</span>`;
    varEl.html(variacaoText);
    
    $(sel).removeClass("positive negative")
        .addClass(novo >= 0 ? "positive" : "negative");
    
    let ant = parseFloat(el.text().replace(/[^\d]/g, '')) || 0;
    let diff = (novo - ant) / 30;
    let cur = ant;
    let pass = 0;
    
    let h = setInterval(() => {
        cur += diff;
        pass++;
        if (pass >= 30) {
            clearInterval(h);
            cur = novo;
        }
        el.text("R$ " + cur.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
    }, 20);
    
    valoresAnteriores[sel] = novo;
}

function carregar(){
    console.log("DEBUG: Iniciando carregamento de dados...");
    showLoading(true, "Conectando à fonte de dados...");
    
    Papa.parse(URL_CSV, {
        download: true,
        header: true,
        complete: function(r) {
            console.log("DEBUG: PapaParse concluído. Resultado:", r);
            if (r.data && r.data.length > 0) {
                // Filtra linhas vazias
                const dadosCarregados = r.data.filter(row => Object.values(row).some(val => val !== null && val !== ''));
                
                console.log(`DEBUG: Total de linhas carregadas: ${r.data.length}. Linhas válidas: ${dadosCarregados.length}`);

                if (dadosCarregados.length > 0) {
                    dados = dadosCarregados;
                    $("#demoWarning").hide();
                    console.log("DEBUG: Dados carregados com sucesso. Inicializando dashboard.");
                    init();
                } else {
                    console.error("DEBUG: Os dados carregados estão vazios ou contêm apenas linhas vazias.");
                    showLoading(false);
                    alert("Erro: Não foi possível carregar os dados. A planilha pode estar vazia ou inacessível.");
                    $("#demoWarning").show().html('<i class="fas fa-exclamation-circle"></i> Erro ao carregar os dados. A planilha está vazia.');
                }
            } else {
                console.error("DEBUG: Os dados carregados estão vazios ou o download falhou.");
                showLoading(false);
                alert("Erro: Não foi possível carregar os dados. A planilha pode estar vazia ou inacessível.");
                $("#demoWarning").show().html('<i class="fas fa-exclamation-circle"></i> Erro ao carregar os dados. Verifique a fonte de dados.');
            }
        },
        error: function(err) {
            console.error("DEBUG: Erro na requisição PapaParse.", err);
            showLoading(false);
            alert("Erro: Não foi possível carregar os dados. Verifique a conexão ou o link da planilha.");
            $("#demoWarning").show().html('<i class="fas fa-exclamation-circle"></i> Erro ao carregar os dados. Verifique a conexão ou o link.');
        }
    });
}

function init(){
    if (dados.length === 0) {
        console.error("DEBUG: A função init foi chamada, mas não há dados para processar.");
        return;
    }
    const usernameField = getUsernameField(dados[0]);
    if (!usernameField) {
        console.error("DEBUG: Campo de username não encontrado nos dados. Verifique a formatação da planilha.");
        showLoading(false);
        alert("Erro: A coluna de nome de usuário não foi encontrada na planilha. Verifique a formatação.");
        $("#demoWarning").show().html('<i class="fas fa-exclamation-circle"></i> Erro de formatação: A coluna de nome de usuário não foi encontrada.');
        return;
    }
    
    let clubes = [...new Set(dados.map(d => d[usernameField]))].filter(Boolean);
    console.log("DEBUG: Clubes encontrados:", clubes);
    
    let opts = '<option value="Todos">Todos os Clubes</option>' +
                clubes.map(c => `<option value="${c}">${c}</option>`).join('');
    
    let optsClubeB = '<option value="Nenhum">Nenhum</option>' + opts;

    $("#filtroClubeA").html(opts);
    $("#filtroClubeB").html(optsClubeB);
    
    let hoje = new Date();
    let ini = new Date();
    ini.setDate(hoje.getDate() - 7);
    $("#filtroInicio").val(hoje.toISOString().slice(0,10));
    $("#filtroFim").val(hoje.toISOString().slice(0,10));
    
    charts.chartComparativo = criarGrafico($("#chartComparativo")[0], "Clube A", "Clube B", "#3498db", "#e74c3c", 'bar');
    charts.chartGGR = criarGrafico($("#chartGGR")[0], "Clube A GGR", "Clube B GGR", "#3498db", "#e74c3c");
    charts.chartDepositos = criarGrafico($("#chartDepositos")[0], "Clube A Depósitos", "Clube B Depósitos", "#3498db", "#e74c3c");
    charts.chartFTD = criarGrafico($("#chartFTD")[0], "Clube A FTD", "Clube B FTD", "#3498db", "#e74c3c");
    charts.chartSportsbook = criarGrafico($("#chartSportsbook")[0], "Clube A Sportsbook", "Clube B Sportsbook", "#3498db", "#e74c3c");
    charts.chartCassino = criarGrafico($("#chartCassino")[0], "Clube A Cassino", "Clube B Cassino", "#3498db", "#e74c3c");
    
    const kpis = ['#kpi-ftd', '#kpi-depositos', '#kpi-ggr', '#kpi-sportsbook', '#kpi-cassino', '#kpi-bonus'];
    kpis.forEach(kpi => valoresAnteriores[kpi] = 0);
    
    atualizar();
    showLoading(false);
    
    setInterval(atualizarDados, 300000);
}

function aplicarFiltros(){
    console.log("DEBUG: Aplicando filtros...");
    atualizar();
}
    
function setPeriodo(d){
    console.log(`DEBUG: Definindo período para os últimos ${d} dias.`);
    let hoje = new Date();
    let ini = new Date();
    ini.setDate(hoje.getDate() - d);
    $("#filtroInicio").val(ini.toISOString().slice(0,10));
    $("#filtroFim").val(hoje.toISOString().slice(0,10));
    atualizar();
}
    
function atualizarDados(){
    console.log("DEBUG: Atualizando dados (chamada manual ou automática).");
    showLoading(true, "Atualizando dados...");
    carregar();
}

function atualizar(){
    console.log("DEBUG: Executando função 'atualizar'.");
    if (dados.length === 0) {
        console.warn("DEBUG: Nenhum dado disponível para atualização. Abortando.");
        return;
    }

    let ini = $("#filtroInicio").val();
    let fim = $("#filtroFim").val();
    let clubeA = $("#filtroClubeA").val();
    let clubeB = $("#filtroClubeB").val();
    
    console.log(`DEBUG: Filtros selecionados - Clube A: ${clubeA}, Clube B: ${clubeB}, Início: ${ini}, Fim: ${fim}`);
    
    const usernameField = getUsernameField(dados[0]);
    let dadosFiltrados = dados.filter(d => {
        const dataValida = d.DATA && (!ini || d.DATA >= ini) && (!fim || d.DATA <= fim);
        return dataValida;
    });
    
    console.log(`DEBUG: ${dadosFiltrados.length} linhas de dados após a filtragem de data.`);
    
    let dadosClubeA = obterDadosDoClube(dadosFiltrados, clubeA, usernameField);
    let dadosClubeB = clubeB !== "Nenhum" && clubeA !== clubeB ? obterDadosDoClube(dadosFiltrados, clubeB, usernameField) : [];

    console.log(`DEBUG: Dados do Clube A (${clubeA}): ${dadosClubeA.length} linhas. Dados do Clube B (${clubeB}): ${dadosClubeB.length} linhas.`);
    
    atualizarKPIs(dadosClubeA, dadosClubeB);
    atualizarGraficos(dadosClubeA, dadosClubeB, clubeA, clubeB);
    atualizarTabelas(dadosFiltrados, usernameField);
    
    $("#ultimaAtualizacao").text(new Date().toLocaleString('pt-BR'));
    console.log("DEBUG: Atualização completa.");
}

function obterDadosDoClube(dadosBase, nomeClube, usernameField) {
    if (nomeClube === "Todos") {
        return dadosBase;
    }
    return dadosBase.filter(d => d[usernameField] === nomeClube);
}
    
function atualizarKPIs(dadosA, dadosB) {
    let somador = (arr, field) => arr.reduce((s, d) => s + (parseFloat(d[field] || 0) || 0), 0);
    
    let totalFTD = somador(dadosA, "Usuário - FTD-Montante") + somador(dadosB, "Usuário - FTD-Montante");
    let totalDepositos = somador(dadosA, "Usuário - Depósitos") + somador(dadosB, "Usuário - Depósitos");
    let totalGGR = somador(dadosA, "Cálculo - GGR") + somador(dadosB, "Cálculo - GGR");
    let totalSportsbook = somador(dadosA, "Sportsbook - GGR") + somador(dadosB, "Sportsbook - GGR");
    let totalCassino = somador(dadosA, "Cassino - GGR") + somador(dadosB, "Cassino - GGR");
    let totalBonus = somador(dadosA, "Cálculo - bônus convertidos") + somador(dadosB, "Cálculo - bônus convertidos");

    console.log(`DEBUG: KPIs totais - FTD: ${totalFTD}, Depósitos: ${totalDepositos}, GGR: ${totalGGR}`);

    animarKPI("#kpi-ftd", totalFTD, valoresAnteriores["#kpi-ftd"]);
    animarKPI("#kpi-depositos", totalDepositos, valoresAnteriores["#kpi-depositos"]);
    animarKPI("#kpi-ggr", totalGGR, valoresAnteriores["#kpi-ggr"]);
    animarKPI("#kpi-sportsbook", totalSportsbook, valoresAnteriores["#kpi-sportsbook"]);
    animarKPI("#kpi-cassino", totalCassino, valoresAnteriores["#kpi-cassino"]);
    animarKPI("#kpi-bonus", totalBonus, valoresAnteriores["#kpi-bonus"]);
}

function atualizarGraficos(dadosA, dadosB, nomeA, nomeB) {
    let agrupaPorData = arr => {
        let out = {};
        arr.forEach(d => {
            const data = d.DATA;
            if (!data) return;
            out[data] = out[data] || { ggr: 0, dep: 0, ftd: 0, sb: 0, cs: 0, bo: 0 };
            out[data].ggr += parseFloat(d["Cálculo - GGR"] || 0) || 0;
            out[data].dep += parseFloat(d["Usuário - Depósitos"] || 0) || 0;
            out[data].ftd += parseFloat(d["Usuário - FTD-Montante"] || 0) || 0;
            out[data].sb += parseFloat(d["Sportsbook - GGR"] || 0) || 0;
            out[data].cs += parseFloat(d["Cassino - GGR"] || 0) || 0;
            out[data].bo += parseFloat(d["Cálculo - bônus convertidos"] || 0) || 0;
        });
        return out;
    };

    let dadosAgrupadosA = agrupaPorData(dadosA);
    let dadosAgrupadosB = agrupaPorData(dadosB);
    let datas = [...new Set([...Object.keys(dadosAgrupadosA), ...Object.keys(dadosAgrupadosB)])].sort();

    console.log("DEBUG: Datas para gráficos:", datas);

    const isClubeBSelecionado = nomeB !== "Nenhum" && dadosB.length > 0;

    function upd(chartId, campoDados, labelA, labelB){
        let chart = charts[chartId];
        if (!chart) return;

        chart.data.labels = datas;

        chart.data.datasets[0].label = nomeA === "Todos" ? "Todos os Clubes" : labelA;
        chart.data.datasets[0].data = datas.map(d => dadosAgrupadosA[d] ? dadosAgrupadosA[d][campoDados] : 0);
        
        if (isClubeBSelecionado) {
            chart.data.datasets[1].label = labelB;
            chart.data.datasets[1].data = datas.map(d => dadosAgrupadosB[d] ? dadosAgrupadosB[d][campoDados] : 0);
            chart.data.datasets[1].hidden = false;
        } else {
            chart.data.datasets[1].hidden = true;
            chart.data.datasets[1].label = "";
            chart.data.datasets[1].data = [];
        }
        
        chart.update();
    }
    
    upd("chartGGR", "ggr", `${nomeA} GGR`, `${nomeB} GGR`);
    upd("chartDepositos", "dep", `${nomeA} Depósitos`, `${nomeB} Depósitos`);
    upd("chartFTD", "ftd", `${nomeA} FTD`, `${nomeB} FTD`);
    upd("chartSportsbook", "sb", `${nomeA} Sportsbook`, `${nomeB} Sportsbook`);
    upd("chartCassino", "cs", `${nomeA} Cassino`, `${nomeB} Cassino`);
    
    let somador = (arr, field) => arr.reduce((s, d) => s + (parseFloat(d[field] || 0) || 0), 0);
    
    charts.chartComparativo.data.labels = ["FTD", "Depósitos", "GGR", "Sportsbook GGR", "Cassino GGR", "Bônus Convertidos"];
    
    charts.chartComparativo.data.datasets[0].label = nomeA;
    charts.chartComparativo.data.datasets[0].data = [
        somador(dadosA, "Usuário - FTD-Montante"),
        somador(dadosA, "Usuário - Depósitos"),
        somador(dadosA, "Cálculo - GGR"),
        somador(dadosA, "Sportsbook - GGR"),
        somador(dadosA, "Cassino - GGR"),
        somador(dadosA, "Cálculo - bônus convertidos")
    ];

    if (isClubeBSelecionado) {
        charts.chartComparativo.data.datasets[1].label = nomeB;
        charts.chartComparativo.data.datasets[1].data = [
            somador(dadosB, "Usuário - FTD-Montante"),
            somador(dadosB, "Usuário - Depósitos"),
            somador(dadosB, "Cálculo - GGR"),
            somador(dadosB, "Sportsbook - GGR"),
            somador(dadosB, "Cassino - GGR"),
            somador(dadosB, "Cálculo - bônus convertidos")
        ];
        charts.chartComparativo.data.datasets[1].hidden = false;
    } else {
        charts.chartComparativo.data.datasets[1].hidden = true;
        charts.chartComparativo.data.datasets[1].label = "";
        charts.chartComparativo.data.datasets[1].data = [];
    }

    charts.chartComparativo.update();
}

function atualizarTabelas(dadosBase, usernameField) {
    function preenche(id, field) {
        let mapaValores = dadosBase.reduce((acc, d) => {
            const clube = d[usernameField];
            const valor = parseFloat(d[field] || 0) || 0;
            if (clube && !isNaN(valor)) {
                acc[clube] = (acc[clube] || 0) + valor;
            }
            return acc;
        }, {});
        
        let top10 = Object.entries(mapaValores).sort((a, b) => b[1] - a[1]).slice(0, 10);
        
        let html = top10.map(item => {
            let variacao = (Math.random() * 20 - 5).toFixed(1);
            let corVariacao = variacao >= 0 ? '#2ecc70' : '#e74c3c';
            return `<tr>
                <td>${item[0]}</td>
                <td>R$ ${item[1].toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td style="color:${corVariacao}">${variacao >= 0 ? '+' : ''}${variacao}%</td>
            </tr>`;
        }).join('');

        $(id + " tbody").html(html || '<tr><td colspan="3">Nenhum dado encontrado.</td></tr>');
    }
    
    preenche("#topDepositos", "Usuário - Depósitos");
    preenche("#topFTD", "Usuário - FTD-Montante");
    preenche("#topGGR", "Cálculo - GGR");
}
    
function exportarCSV(){
    let csv = Papa.unparse(dados);
    let blob = new Blob(["\uFEFF" + csv], {type: "text/csv;charset=utf-8;"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "dados_clubes.csv";
    a.click();
}
    
function toggleDarkMode(){
    alert("Modo escuro já está ativado! Esta função demonstra a capacidade de alternância.");
}

$(document).ready(function(){
    console.log("DEBUG: Documento pronto. Iniciando a aplicação.");
    carregar();
    
    $('.kpi, .btn-period, .btn-apply, .btn-export, .btn-mode').hover(function(){
        $(this).css('transform', 'translateY(-3px)');
    }, function(){
        $(this).css('transform', 'none');
    });
});