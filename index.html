<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Clubes</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body { background-color: black; color: #0f0; font-family: Arial, sans-serif; margin: 0; padding: 0; }
        h1 { text-align: center; margin: 10px 0; }
        .filtros { text-align: center; margin-bottom: 10px; }
        .cards { display: flex; justify-content: space-around; flex-wrap: wrap; margin: 10px; }
        .card { border: 2px solid #0f0; border-radius: 10px; padding: 5px; text-align: center; width: 150px; background: rgba(0, 0, 0, 0.7); }
        .valor { color: white; font-size: 18px; font-weight: bold; }
        .graficos { display: grid; grid-template-columns: repeat(3, 1fr); grid-gap: 8px; padding: 10px; }
        .grafico-container { border: 2px solid #0f0; border-radius: 10px; background: #111; padding: 5px; }
        .tabelas { display: grid; grid-template-columns: repeat(5, 1fr); grid-gap: 5px; padding: 5px; }
        table { width: 100%; border-collapse: collapse; color: white; font-size: 11px; }
        th, td { border: 1px solid #0f0; padding: 2px; text-align: center; }
        th { background: #030; }
        .footer { text-align: center; font-size: 12px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Dashboard de Clubes</h1>
    <div class="filtros">
        Data: <input type="date" id="filtroData">
        Clube: <select id="filtroClube"><option value="Todos">Todos</option></select>
        <button onclick="aplicarFiltro()">Aplicar</button>
    </div>

    <div class="cards">
        <div class="card"><div>FTD</div><div id="ftd" class="valor">R$ 0,00</div></div>
        <div class="card"><div>Depósitos</div><div id="depositos" class="valor">R$ 0,00</div></div>
        <div class="card"><div>GGR</div><div id="ggr" class="valor">R$ 0,00</div></div>
        <div class="card"><div>Sportsbook GGR</div><div id="sportsbookGgr" class="valor">R$ 0,00</div></div>
        <div class="card"><div>Cassino GGR</div><div id="cassinoGgr" class="valor">R$ 0,00</div></div>
    </div>

    <div class="graficos">
        <div class="grafico-container"><canvas id="graficoGgr"></canvas></div>
        <div class="grafico-container"><canvas id="graficoDepositos"></canvas></div>
        <div class="grafico-container"><canvas id="graficoFtd"></canvas></div>
        <div class="grafico-container"><canvas id="graficoSportsbook"></canvas></div>
        <div class="grafico-container"><canvas id="graficoCassino"></canvas></div>
    </div>

    <div class="tabelas">
        <table id="topDepositos"><thead><tr><th>Top 10 Depósitos</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topFtd"><thead><tr><th>Top 10 FTD</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topGgr"><thead><tr><th>Top 10 GGR</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topSportsbook"><thead><tr><th>Top 10 Sportsbook GGR</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topCassino"><thead><tr><th>Top 10 Cassino GGR</th><th>Valor</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="footer">Última atualização: <span id="ultimaAtualizacao"></span></div>

<script>
let dadosCSV = [];
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("ultimaAtualizacao").textContent = new Date().toLocaleString();
    carregarDados();
});

function carregarDados() {
    Papa.parse("dados.csv", {
        download: true,
        header: true,
        complete: function(results) {
            dadosCSV = results.data;
            popularFiltroClubes();
            processarDados(dadosCSV);
        }
    });
}

function popularFiltroClubes() {
    const clubes = [...new Set(dadosCSV.map(l => l["Usuário - Nome de usuário"]).filter(Boolean))];
    const select = document.getElementById("filtroClube");
    clubes.forEach(clube => {
        const opt = document.createElement("option");
        opt.value = clube;
        opt.textContent = clube;
        select.appendChild(opt);
    });
}

function aplicarFiltro() {
    const dataFiltro = document.getElementById("filtroData").value;
    const clubeFiltro = document.getElementById("filtroClube").value;
    let filtrados = dadosCSV;
    if (dataFiltro) filtrados = filtrados.filter(l => l["DATA"] === dataFiltro);
    if (clubeFiltro !== "Todos") filtrados = filtrados.filter(l => l["Usuário - Nome de usuário"] === clubeFiltro);
    processarDados(filtrados);
}

function processarDados(dados) {
    const soma = (campo) => dados.reduce((acc, l) => acc + parseFloat(l[campo] || 0), 0);
    const ftd = soma("Usuário - FTD-Montante");
    const depositos = soma("Usuário - Depósitos");
    const sportsbook = soma("Sportsbook - GGR");
    const cassino = soma("Cassino - GGR");
    const ggr = soma("Cálculo - GGR");

    atualizarCards(ftd, depositos, ggr, sportsbook, cassino);
    desenharGraficos(dados);
    preencherTop10(dados);
}

function atualizarCards(ftd, depositos, ggr, sportsbook, cassino) {
    document.getElementById("ftd").textContent = formatarMoeda(ftd);
    document.getElementById("depositos").textContent = formatarMoeda(depositos);
    document.getElementById("ggr").textContent = formatarMoeda(ggr);
    document.getElementById("sportsbookGgr").textContent = formatarMoeda(sportsbook);
    document.getElementById("cassinoGgr").textContent = formatarMoeda(cassino);
}

function desenharGraficos(dados) {
    const porData = (campo) => {
        const mapa = {};
        dados.forEach(l => { 
            const data = l["DATA"];
            mapa[data] = (mapa[data] || 0) + parseFloat(l[campo] || 0);
        });
        return { labels: Object.keys(mapa), valores: Object.values(mapa) };
    };

    const criarGrafico = (ctx, titulo, cor, dados) => new Chart(ctx, {
        type: 'line',
        data: { labels: dados.labels, datasets: [{ label: titulo, data: dados.valores, borderColor: cor, borderWidth: 2, fill: false }] },
        options: { plugins: { legend: { labels: { color: 'white' } } }, scales: { x: { ticks: { color: 'white'}}, y: { ticks: { color: 'white'}}}}
    });

    criarGrafico(document.getElementById("graficoGgr"), "GGR", "lime", porData("Cálculo - GGR"));
    criarGrafico(document.getElementById("graficoDepositos"), "Depósitos", "blue", porData("Usuário - Depósitos"));
    criarGrafico(document.getElementById("graficoFtd"), "FTD", "yellow", porData("Usuário - FTD-Montante"));
    criarGrafico(document.getElementById("graficoSportsbook"), "Sportsbook GGR", "orange", porData("Sportsbook - GGR"));
    criarGrafico(document.getElementById("graficoCassino"), "Cassino GGR", "purple", porData("Cassino - GGR"));
}

function preencherTop10(dados) {
    const porClube = (campo) => {
        const mapa = {};
        dados.forEach(l => { 
            const clube = l["Usuário - Nome de usuário"] || "Sem Clube";
            mapa[clube] = (mapa[clube] || 0) + parseFloat(l[campo] || 0);
        });
        return Object.entries(mapa).sort((a,b) => b[1]-a[1]).slice(0,10);
    };

    preencherTabela("topDepositos", porClube("Usuário - Depósitos"));
    preencherTabela("topFtd", porClube("Usuário - FTD-Montante"));
    preencherTabela("topGgr", porClube("Cálculo - GGR"));
    preencherTabela("topSportsbook", porClube("Sportsbook - GGR"));
    preencherTabela("topCassino", porClube("Cassino - GGR"));
}

function preencherTabela(id, dados) {
    const tbody = document.querySelector(`#${id} tbody`);
    tbody.innerHTML = "";
    dados.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row[0]}</td><td>${formatarMoeda(row[1])}</td>`;
        tbody.appendChild(tr);
    });
}

function formatarMoeda(valor) {
    return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}
</script>
</body>
</html>
