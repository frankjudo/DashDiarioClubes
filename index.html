<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Clubes</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; margin: 0; }
        header { background: #fff; padding: 10px; text-align: center; font-size: 1.6em; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .filtros { display: flex; justify-content: center; gap: 10px; padding: 10px; background: #fff; flex-wrap: wrap; }
        .cards { display: flex; justify-content: space-around; flex-wrap: wrap; padding: 10px; background: #fff; }
        .card { background: #fafafa; padding: 15px; border-radius: 8px; text-align: center; width: 180px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s ease-in-out, background-color 0.5s; }
        .card i { font-size: 2em; margin-bottom: 5px; }
        .card h3 { margin: 0; font-size: 1em; color: #666; }
        .card p { font-size: 1.4em; font-weight: bold; margin: 5px 0 0; color: #222; transition: color 0.5s; }
        .card.fade-change { background-color: #d4ffd4; }
        .card.negative-change { background-color: #ffd4d4; }
        .graficos { display: grid; grid-template-columns: repeat(3, 1fr); grid-gap: 10px; padding: 10px; }
        .grafico-container { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); opacity: 1; transition: opacity 0.5s; }
        .fade-out { opacity: 0; }
        .tabelas { display: grid; grid-template-columns: repeat(3, 1fr); grid-gap: 10px; padding: 10px; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.9em; text-align: left; transition: background 0.5s; }
        th { background: #f0f0f0; font-weight: bold; }
        .update-green { background: #d4ffd4 !important; }
        .update-red { background: #ffd4d4 !important; }
        .kpi-ftd i { color: #4CAF50; }
        .kpi-depositos i { color: #ff9800; }
        .kpi-ggr i { color: #2196F3; }
        .kpi-sports i { color: #9c27b0; }
        .kpi-cassino i { color: #f44336; }
        .kpi-bonus i { color: #009688; }
    </style>
</head>
<body>
    <header>Dashboard de Clubes</header>
    <div class="filtros">
        <label>Data: <input type="date" id="dataFiltro"></label>
        <label>Clube: <select id="clubeFiltro"></select></label>
        <button onclick="aplicarFiltro()">Aplicar</button>
    </div>

    <div class="cards">
        <div class="card kpi-ftd"><i class="fas fa-user-plus"></i><h3>FTD</h3><p id="kpi-ftd">R$ 0,00</p></div>
        <div class="card kpi-depositos"><i class="fas fa-piggy-bank"></i><h3>Depósitos</h3><p id="kpi-depositos">R$ 0,00</p></div>
        <div class="card kpi-ggr"><i class="fas fa-chart-line"></i><h3>GGR</h3><p id="kpi-ggr">R$ 0,00</p></div>
        <div class="card kpi-sports"><i class="fas fa-football-ball"></i><h3>Sportsbook GGR</h3><p id="kpi-sports">R$ 0,00</p></div>
        <div class="card kpi-cassino"><i class="fas fa-dice"></i><h3>Cassino GGR</h3><p id="kpi-cassino">R$ 0,00</p></div>
        <div class="card kpi-bonus"><i class="fas fa-gift"></i><h3>Bônus Convertidos</h3><p id="kpi-bonus">R$ 0,00</p></div>
    </div>

    <div class="graficos">
        <div class="grafico-container"><canvas id="graficoGGR"></canvas></div>
        <div class="grafico-container"><canvas id="graficoDepositos"></canvas></div>
        <div class="grafico-container"><canvas id="graficoFTD"></canvas></div>
        <div class="grafico-container"><canvas id="graficoSports"></canvas></div>
        <div class="grafico-container"><canvas id="graficoCassino"></canvas></div>
        <div class="grafico-container"><canvas id="graficoBonus"></canvas></div>
    </div>

    <div class="tabelas">
        <table id="topDepositos"><thead><tr><th>Top 10 Depósitos</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topFTD"><thead><tr><th>Top 10 FTD</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topGGR"><thead><tr><th>Top 10 GGR</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topSports"><thead><tr><th>Top 10 Sportsbook</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topCassino"><thead><tr><th>Top 10 Cassino</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topBonus"><thead><tr><th>Top 10 Bônus</th><th>Valor</th></tr></thead><tbody></tbody></table>
    </div>

    <script>
        const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
        let dados = [];
        let charts = {};

        document.addEventListener("DOMContentLoaded", carregarDados);

        function carregarDados() {
            Papa.parse(urlCSV, {
                download: true,
                header: true,
                complete: function(result) {
                    dados = result.data;
                    preencherFiltroClubes();
                    aplicarFiltro();
                }
            });
        }

        function preencherFiltroClubes() {
            let clubes = [...new Set(dados.map(d => d["Usuário - Nome de usuário"]))];
            let select = document.getElementById("clubeFiltro");
            select.innerHTML = "<option value='Todos'>Todos</option>";
            clubes.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
        }

        function aplicarFiltro() {
            const data = document.getElementById("dataFiltro").value;
            const clube = document.getElementById("clubeFiltro").value;
            let filtrado = dados;
            if(data) filtrado = filtrado.filter(d => d.DATA === data);
            if(clube !== "Todos") filtrado = filtrado.filter(d => d["Usuário - Nome de usuário"] === clube);

            atualizarKPIs(filtrado);
            atualizarTop10(filtrado);
            atualizarGraficos(filtrado);
        }

        function atualizarKPIs(dados) {
            const soma = campo => dados.reduce((acc, d) => acc + parseFloat(d[campo] || 0), 0);
            atualizarElemento("kpi-ftd", soma("Usuário - FTD-Montante"));
            atualizarElemento("kpi-depositos", soma("Usuário - Depósitos"));
            atualizarElemento("kpi-ggr", soma("Cálculo - GGR"));
            atualizarElemento("kpi-sports", soma("Sportsbook - GGR"));
            atualizarElemento("kpi-cassino", soma("Cassino - GGR"));
            atualizarElemento("kpi-bonus", soma("Cálculo - bônus convertidos"));
        }

        function atualizarElemento(id, valor) {
            const el = document.getElementById(id);
            const valorAnterior = parseFloat(el.dataset.valor || 0);
            el.dataset.valor = valor;
            el.textContent = valor.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            const card = el.closest(".card");
            if(valor > valorAnterior) card.classList.add("fade-change");
            else if(valor < valorAnterior) card.classList.add("negative-change");
            setTimeout(()=>card.classList.remove("fade-change","negative-change"),800);
        }

        function consolidar(dados, campo) {
            let mapa = {};
            dados.forEach(d => mapa[d["Usuário - Nome de usuário"]] = (mapa[d["Usuário - Nome de usuário"]] || 0) + parseFloat(d[campo] || 0));
            return Object.entries(mapa).map(([clube, valor]) => ({clube, valor}))
                .sort((a,b) => b.valor - a.valor).slice(0,10);
        }

        function preencherTabela(id, lista) {
            const tbody = document.querySelector(`#${id} tbody`);
            tbody.innerHTML = "";
            lista.forEach(l => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${l.clube}</td><td>${l.valor.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>`;
                tr.classList.add(l.valor >= 0 ? "update-green" : "update-red");
                tbody.appendChild(tr);
                setTimeout(()=>tr.classList.remove("update-green","update-red"),800);
            });
        }

        function atualizarTop10(dados) {
            preencherTabela("topDepositos", consolidar(dados,"Usuário - Depósitos"));
            preencherTabela("topFTD", consolidar(dados,"Usuário - FTD-Montante"));
            preencherTabela("topGGR", consolidar(dados,"Cálculo - GGR"));
            preencherTabela("topSports", consolidar(dados,"Sportsbook - GGR"));
            preencherTabela("topCassino", consolidar(dados,"Cassino - GGR"));
            preencherTabela("topBonus", consolidar(dados,"Cálculo - bônus convertidos"));
        }

        function atualizarGraficos(dados) {
            const dataUnica = [...new Set(dados.map(d => d.DATA))].sort();
            const serie = campo => dataUnica.map(data => dados.filter(d => d.DATA === data)
                .reduce((acc, d) => acc + parseFloat(d[campo] || 0), 0));

            const graficos = {
                graficoGGR: {label: "Cálculo - GGR", cor: "green", dados: serie("Cálculo - GGR")},
                graficoDepositos: {label: "Usuário - Depósitos", cor: "blue", dados: serie("Usuário - Depósitos")},
                graficoFTD: {label: "Usuário - FTD-Montante", cor: "gold", dados: serie("Usuário - FTD-Montante")},
                graficoSports: {label: "Sportsbook - GGR", cor: "orange", dados: serie("Sportsbook - GGR")},
                graficoCassino: {label: "Cassino - GGR", cor: "purple", dados: serie("Cassino - GGR")},
                graficoBonus: {label: "Cálculo - bônus convertidos", cor: "pink", dados: serie("Cálculo - bônus convertidos")}
            };

            for(const id in graficos) {
                const ctx = document.getElementById(id).getContext("2d");
                if(charts[id]) charts[id].destroy();
                charts[id] = new Chart(ctx, {
                    type: "line",
                    data: { labels: dataUnica, datasets: [{label: graficos[id].label, data: graficos[id].dados, borderColor: graficos[id].cor, fill: false}] },
                    options: { responsive: true, plugins: { legend: {display: true} } }
                });
            }
        }
    </script>
</body>
</html>
