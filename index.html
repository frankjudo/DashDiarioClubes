<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Comparativo de Clubes</title>

  <!-- (opcional) Font Awesome para ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Libs: carregam antes do seu script (ordem garantida com defer) -->
  <script defer src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;margin:0;padding:16px;background:#0f1b26;color:#ecf0f1}
    header, .controls, .kpi, .chart, .table, .footer{background:#1a252f;border-radius:12px;padding:16px;margin-bottom:16px}
    header h1{margin:0;font-size:22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{font-weight:600;margin-right:6px}
    input,select,button{padding:8px 10px;border-radius:8px;border:1px solid #2c3e50;background:#102030;color:#ecf0f1}
    button{cursor:pointer}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .kpi .valor{font-size:20px;font-weight:700;margin-top:6px}
    .kpi .variacao{opacity:.8;margin-top:4px}
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
    canvas{width:100%;height:260px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{color:#5dade2}
    #loadingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:9999;color:#fff;font-weight:700}
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-chart-line"></i> Dashboard Comparativo de Clubes</h1>
    <p style="margin:6px 0 0;opacity:.8">Analise e compare o desempenho de diferentes clubes</p>
  </header>

  <div class="controls">
    <div class="row" style="margin-bottom:10px">
      <h3 style="margin:0;color:#5dade2"><i class="fas fa-calendar-alt"></i> Período</h3>
    </div>
    <div class="row">
      <label for="filtroInicio">De:</label>
      <input type="date" id="filtroInicio" />
      <label for="filtroFim">até</label>
      <input type="date" id="filtroFim" />
      <button class="btn-period" onclick="setPeriodo(1)">Ontem</button>
      <button class="btn-period" onclick="setPeriodo(7)">Últimos 7 dias</button>
      <button class="btn-period" onclick="setPeriodo(30)">Últimos 30 dias</button>
    </div>

    <div class="row" style="margin-top:14px">
      <h3 style="margin:0;color:#5dade2"><i class="fas fa-users"></i> Clubes</h3>
    </div>
    <div class="row">
      <label for="filtroClubeA">Clube A:</label>
      <select id="filtroClubeA"></select>
      <label for="filtroClubeB">Clube B:</label>
      <select id="filtroClubeB"></select>
      <button onclick="aplicarFiltros()"><i class="fas fa-filter"></i> Aplicar Filtros</button>
    </div>

    <div class="row" style="margin-top:14px">
      <input type="checkbox" id="eliminarSuprema" onchange="atualizar()">
      <label for="eliminarSuprema">Eliminar Clubes Suprema</label>

      <input type="checkbox" id="eliminarToni" onchange="atualizar()">
      <label for="eliminarToni">Eliminar TONI</label>

      <button onclick="exportarCSV()"><i class="fas fa-file-csv"></i> Exportar CSV</button>
      <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i> Modo Escuro</button>
      <button onclick="atualizarDados()"><i class="fas fa-sync"></i> Atualizar Dados</button>
    </div>
  </div>

  <div class="kpis">
    <div class="kpi positive" id="kpi-ftd"><h3>FTD</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
    <div class="kpi positive" id="kpi-depositos"><h3>Depósitos</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
    <div class="kpi positive" id="kpi-ggr"><h3>GGR</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
    <div class="kpi positive" id="kpi-sportsbook"><h3>Sportsbook GGR</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
    <div class="kpi positive" id="kpi-cassino"><h3>Cassino GGR</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
    <div class="kpi positive" id="kpi-bonus"><h3>Bônus Convertidos</h3><div class="valor">R$ 0</div><div class="variacao">+0.0%</div></div>
  </div>

  <div class="charts">
    <div class="chart"><h3 style="color:#5dade2"><i class="fas fa-chart-bar"></i> Visão Geral</h3><canvas id="chartComparativo"></canvas></div>
    <div class="chart"><h3 style="color:#5dade2"><i class="fas fa-chart-line"></i> Evolução do GGR</h3><canvas id="chartGGR"></canvas></div>
    <div class="chart"><h3 style="color:#5dade2"><i class="fas fa-money-bill-wave"></i> Depósitos</h3><canvas id="chartDepositos"></canvas></div>
    <div class="chart"><h3 style="color:#5dade2"><i class="fas fa-user-plus"></i> FTD</h3><canvas id="chartFTD"></canvas></div>
    <div class="chart"><h3 style="color:#5dade2"><i class="fas fa-futbol"></i> Sportsbook</h3><canvas id="chartSportsbook"></canvas></div>
    <div class="chart"><h3 style="color:#5dade2"><i class="fas fa-dice"></i> Cassino</h3><canvas id="chartCassino"></canvas></div>
  </div>

  <div class="tables" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px">
    <div class="table"><h3 style="color:#5dade2"><i class="fas fa-trophy"></i> Top 10 Depósitos</h3>
      <table id="topDepositos"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3">Carregando...</td></tr></tbody></table>
    </div>
    <div class="table"><h3 style="color:#5dade2"><i class="fas fa-trophy"></i> Top 10 FTD</h3>
      <table id="topFTD"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3">Carregando...</td></tr></tbody></table>
    </div>
    <div class="table"><h3 style="color:#5dade2"><i class="fas fa-trophy"></i> Top 10 GGR</h3>
      <table id="topGGR"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3">Carregando...</td></tr></tbody></table>
    </div>
    <div class="table"><h3 style="color:#5dade2"><i class="fas fa-futbol"></i> Top 10 GGR Sportsbook</h3>
      <table id="topSportsbook"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3">Carregando...</td></tr></tbody></table>
    </div>
    <div class="table"><h3 style="color:#5dade2"><i class="fas fa-dice"></i> Top 10 GGR Cassino</h3>
      <table id="topCassino"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3">Carregando...</td></tr></tbody></table>
    </div>
    <div class="table"><h3 style="color:#5dade2"><i class="fas fa-gift"></i> Top 10 Bônus Convertidos</h3>
      <table id="topBonus"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3">Carregando...</td></tr></tbody></table>
    </div>
  </div>

  <div class="footer">
    <p>Última atualização: <span id="ultimaAtualizacao"></span></p>
  </div>

  <div id="loadingOverlay">Carregando dados…</div>

  <!-- SEU SCRIPT (corrigido) -->
  <script>
    const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
    let dados = [], charts = {};

    // parser robusto para números pt-BR/en-US
    const N = (v) => {
      if (v === null || v === undefined) return 0;
      let s = String(v).trim(); if (!s) return 0;
      s = s.replace(/\s+/g,'').replace(/\./g,'').replace(/,/g,'.');
      const n = Number(s); return Number.isFinite(n) ? n : 0;
    };

    const dadosDemo = [
      {"DATA":"2025-08-07","Usuário - Nome de usuário":"romub@programa.bet","Usuário - FTD-Montante":"21291,00","Usuário - Depósitos":"213.976,00","Cálculo - GGR":"77.521,00","Sportsbook - GGR":"-3.871,00","Cassino - GGR":"81.392,00","Cálculo - bônus convertidos":"4.407,00"},
      {"DATA":"2025-08-06","Usuário - Nome de usuário":"ciseleiot123@gmail.com","Usuário - FTD-Montante":"20.719,40","Usuário - Depósitos":"217.346,00","Cálculo - GGR":"59.884,00","Sportsbook - GGR":"10.946,00","Cassino - GGR":"48.941,00","Cálculo - bônus convertidos":"5.092,00"},
      {"DATA":"2025-08-05","Usuário - Nome de usuário":"betextraok@gmail.com","Usuário - FTD-Montante":"15.000","Usuário - Depósitos":"150.000","Cálculo - GGR":"60.000","Sportsbook - GGR":"30.000","Cassino - GGR":"30.000","Cálculo - bônus convertidos":"5.000"}
    ];

    const CLUBES_SUPREMA_LIST = ['romulo@xpgames.bet','lucasfarinha@maximabet.net','superodds@gmail.com','clubedokw@gmail.com','tropadogg@gmail.com','galeradoinsta@gmail.com'];
    const CLUBE_TONI = 'crisslots123@gmail.com';

    function showLoading(on, msg="Carregando dados..."){
      $("#loadingMessage").text?.(msg);
      $("#loadingOverlay").css("display", on ? "flex" : "none");
    }

    function criarGrafico(ctx, labelA, labelB, colorA, colorB, type='line'){
      return new Chart(ctx,{
        type, data:{labels:[], datasets:[
          {label:labelA,data:[],borderColor:colorA,backgroundColor:type==='bar'?colorA+'CC':'transparent',fill:type==='line',tension:.3,borderWidth:3,pointRadius:4,pointBackgroundColor:colorA},
          {label:labelB,data:[],borderColor:colorB,backgroundColor:type==='bar'?colorB+'CC':'transparent',fill:type==='line',tension:.3,borderWidth:3,pointRadius:4,pointBackgroundColor:colorB}
        ]},
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{legend:{position:'top',labels:{color:'#ecf0f1',font:{size:14},filter:i=>i.text!==""}},
                   tooltip:{callbacks:{label:ctx=>ctx.dataset.label?`${ctx.dataset.label}: R$ ${ctx.parsed.y.toLocaleString('pt-BR',{minimumFractionDigits:2})}`:null},
                            backgroundColor:'rgba(26,37,47,.9)',titleColor:'#3498db',bodyColor:'#ecf0f1',displayColors:false,padding:12,borderColor:'rgba(255,255,255,.1)',borderWidth:1}},
          scales:{y:{beginAtZero:true,ticks:{callback:v=>`R$ ${v.toLocaleString('pt-BR',{minimumFractionDigits:0})}`,color:'#bdc3c7'},grid:{color:'rgba(255,255,255,.05)'}},
                  x:{ticks:{color:'#bdc3c7'},grid:{color:'rgba(255,255,255,.05)'}}}
        }
      });
    }

    function animarKPI(sel, novo, anterior){
      const el = $(sel+" .valor"), varEl = $(sel+" .variacao");
      let variacao = 0;
      if (Number.isFinite(anterior) && anterior !== 0) variacao = ((novo-anterior)/anterior)*100;
      else if (novo>0) variacao = 100;
      varEl.html(variacao>=0?`<span style="color:#2ecc71">+${variacao.toFixed(1)}%</span>`:`<span style="color:#e74c3c">${variacao.toFixed(1)}%</span>`);
      $(sel).removeClass("positive negative").addClass(novo >= (anterior??0) ? "positive":"negative");
      let ant = N(el.text().replace(/[^\d,.-]/g,'')); let diff=(novo-ant)/30, cur=ant, pass=0;
      const h=setInterval(()=>{cur+=diff;pass++; if(pass>=30){clearInterval(h);cur=novo} el.text("R$ "+cur.toLocaleString('pt-BR',{minimumFractionDigits:2}))},20);
    }

    function carregar(){
      showLoading(true,"Conectando à fonte de dados...");
      const url = URL_CSV + '&' + Date.now();
      Papa.parse(url,{download:true,header:true,complete:(r)=>{dados=(r.data&&r.data.length)?r.data.filter(x=>x.DATA):dadosDemo; init();},error:()=>{dados=dadosDemo; init();}});
    }

    function init(){
      const clubes=[...new Set(dados.map(d=>d["Usuário - Nome de username"]||d["Usuário - Nome de usuário"]))];
      const opts='<option value="Todos">Todos os Clubes</option>'+clubes.map(c=>`<option>${c}</option>`).join('');
      const optsB='<option value="Nenhum">Nenhum</option>'+opts;
      $("#filtroClubeA").html(opts).val("Todos");
      $("#filtroClubeB").html(optsB).val("Nenhum");

      const hoje=new Date(), ontem=new Date(hoje); ontem.setDate(hoje.getDate()-1);
      const anteontem=new Date(hoje); anteontem.setDate(hoje.getDate()-2);
      $("#filtroInicio").val(anteontem.toISOString().slice(0,10));
      $("#filtroFim").val(ontem.toISOString().slice(0,10));

      charts.chartComparativo = criarGrafico($("#chartComparativo")[0],"Clube A","Clube B","#3498db","#e74c3c","bar");
      charts.chartGGR         = criarGrafico($("#chartGGR")[0],"Clube A GGR","Clube B GGR","#3498db","#e74c3c");
      charts.chartDepositos   = criarGrafico($("#chartDepositos")[0],"Clube A Depósitos","Clube B Depósitos","#3498db","#e74c3c");
      charts.chartFTD         = criarGrafico($("#chartFTD")[0],"Clube A FTD","Clube B FTD","#3498db","#e74c3c");
      charts.chartSportsbook  = criarGrafico($("#chartSportsbook")[0],"Clube A Sportsbook","Clube B Sportsbook","#3498db","#e74c3c");
      charts.chartCassino     = criarGrafico($("#chartCassino")[0],"Clube A Cassino","Clube B Cassino","#3498db","#e74c3c");

      atualizar();
      showLoading(false);
      setInterval(atualizarDados,300000);
    }

    function aplicarFiltros(){ atualizar(); }
    function setPeriodo(d){
      const hoje=new Date(), ontem=new Date(hoje); ontem.setDate(hoje.getDate()-1);
      const ini=new Date(ontem); ini.setDate(ontem.getDate()-(d-1));
      $("#filtroInicio").val(ini.toISOString().slice(0,10));
      $("#filtroFim").val(ontem.toISOString().slice(0,10));
      atualizar();
    }
    function atualizarDados(){ showLoading(true,"Atualizando dados..."); carregar(); }

    function atualizar(){
      const ini=$("#filtroInicio").val(), fim=$("#filtroFim").val();
      let base=[...dados];

      if ($("#eliminarSuprema").is(":checked")) base = base.filter(d=>!CLUBES_SUPREMA_LIST.includes(d["Usuário - Nome de usuário"]||d["Usuário - Nome de username"]));
      if ($("#eliminarToni").is(":checked"))     base = base.filter(d=>(d["Usuário - Nome de usuário"]||d["Usuário - Nome de username"]) !== CLUBE_TONI);

      const atual=base.filter(d=>d.DATA>=ini && d.DATA<=fim);
      const primeiroDia=base.filter(d=>d.DATA===ini);

      const clubeA=$("#filtroClubeA").val(), clubeB=$("#filtroClubeB").val();
      const A = (clubeA==="Todos")? atual : atual.filter(d=>(d["Usuário - Nome de username"]===clubeA)||(d["Usuário - Nome de usuário"]===clubeA));
      const B = (clubeB!=="Nenhum" && clubeA!==clubeB)? atual.filter(d=>(d["Usuário - Nome de username"]===clubeB)||(d["Usuário - Nome de usuário"]===clubeB)) : [];

      atualizarKPIsPeriodo(A,B);
      atualizarGraficos(A,B,clubeA,clubeB);
      atualizarTabelas(atual,primeiroDia);

      $("#ultimaAtualizacao").text(new Date().toLocaleString('pt-BR'));
    }

    function atualizarKPIsPeriodo(A,B){
      const somar=(arr,campo)=>arr.reduce((s,d)=>s+N(d[campo]),0);
      const totalFTD = somar(A,"Usuário - FTD-Montante")+somar(B,"Usuário - FTD-Montante");
      const totalDep = somar(A,"Usuário - Depósitos")+somar(B,"Usuário - Depósitos");
      const totalGGR = somar(A,"Cálculo - GGR")+somar(B,"Cálculo - GGR");
      const totalSB  = somar(A,"Sportsbook - GGR")+somar(B,"Sportsbook - GGR");
      const totalCS  = somar(A,"Cassino - GGR")+somar(B,"Cassino - GGR");
      const totalBO  = somar(A,"Cálculo - bônus convertidos")+somar(B,"Cálculo - bônus convertidos");

      animarKPI("#kpi-ftd",totalFTD);
      animarKPI("#kpi-depositos",totalDep);
      animarKPI("#kpi-ggr",totalGGR);
      animarKPI("#kpi-sportsbook",totalSB);
      animarKPI("#kpi-cassino",totalCS);
      animarKPI("#kpi-bonus",totalBO);
    }

    function atualizarGraficos(A,B,nomeA,nomeB){
      const agrupa=(arr)=>{const o={}; arr.forEach(d=>{const k=d.DATA; o[k]=o[k]||{ggr:0,dep:0,ftd:0,sb:0,cs:0,bo:0};
        o[k].ggr+=N(d["Cálculo - GGR"]); o[k].dep+=N(d["Usuário - Depósitos"]); o[k].ftd+=N(d["Usuário - FTD-Montante"]);
        o[k].sb+=N(d["Sportsbook - GGR"]); o[k].cs+=N(d["Cassino - GGR"]); o[k].bo+=N(d["Cálculo - bônus convertidos"]);}); return o;};
      const a=agrupa(A), b=B.length?agrupa(B):{}; const datas=[...new Set([...Object.keys(a),...Object.keys(b)])].sort();
      const hasB = (nomeB!=="Nenhum"); const corB = hasB?"#e74c3c":"rgba(0,0,0,0)"; const labelB = hasB?nomeB:"";
      const upd=(id,c)=>{const ch=charts[id]; ch.data.labels=datas; ch.data.datasets[0].label=nomeA; ch.data.datasets[0].data=datas.map(d=>a[d]?.[c]||0);
        ch.data.datasets[1].label=labelB; ch.data.datasets[1].borderColor=corB;
        ch.data.datasets[1].backgroundColor=hasB?(ch.config.type==='bar'?corB+'CC':'transparent'):'rgba(0,0,0,0)';
        ch.data.datasets[1].pointBackgroundColor=corB; ch.data.datasets[1].pointRadius=hasB?4:0;
        ch.data.datasets[1].data=datas.map(d=>b[d]?.[c]||0); ch.update(); };
      upd("chartGGR","ggr"); upd("chartDepositos","dep"); upd("chartFTD","ftd"); upd("chartSportsbook","sb"); upd("chartCassino","cs");

      const somar=(arr,f)=>arr.reduce((s,d)=>s+N(d[f]),0);
      charts.chartComparativo.data.labels=['FTD','Depósitos','GGR','Sportsbook','Cassino','Bônus'];
      charts.chartComparativo.data.datasets[0].label=nomeA;
      charts.chartComparativo.data.datasets[1].label=labelB;
      charts.chartComparativo.data.datasets[1].backgroundColor=hasB?"#e74c3cCC":"rgba(0,0,0,0)";
      charts.chartComparativo.data.datasets[1].borderColor=corB;
      charts.chartComparativo.data.datasets[0].data=[
        somar(A,"Usuário - FTD-Montante"), somar(A,"Usuário - Depósitos"), somar(A,"Cálculo - GGR"),
        somar(A,"Sportsbook - GGR"), somar(A,"Cassino - GGR"), somar(A,"Cálculo - bônus convertidos")
      ];
      charts.chartComparativo.data.datasets[1].data=hasB?[
        somar(B,"Usuário - FTD-Montante"), somar(B,"Usuário - Depósitos"), somar(B,"Cálculo - GGR"),
        somar(B,"Sportsbook - GGR"), somar(B,"Cassino - GGR"), somar(B,"Cálculo - bônus convertidos")
      ]:[0,0,0,0,0,0];
      charts.chartComparativo.update();
    }

    function atualizarTabelas(atual,primeiroDia){
      const somaClube=(a,f)=>a.reduce((acc,d)=>{const c=d["Usuário - Nome de username"]||d["Usuário - Nome de usuário"]; const v=N(d[f]); acc[c]=(acc[c]||0)+v; return acc;}, {});
      const fill=(id,f)=>{const mA=somaClube(atual,f), mP=somaClube(primeiroDia,f);
        const top=Object.entries(mA).sort((x,y)=>y[1]-x[1]).slice(0,10);
        const html=top.map(([c,v])=>{const ant=mP[c]||0; let varp=0; if(ant)varp=((v-ant)/ant)*100; else if(v>0)varp=100;
          const cor=varp>=0?'#2ecc71':'#e74c3c';
          return `<tr><td>${c}</td><td>R$ ${v.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td style="color:${cor}">${varp>=0?'+':''}${varp.toFixed(1)}%</td></tr>`}).join('');
        $(id+" tbody").html(html);
      };
      fill("#topDepositos","Usuário - Depósitos");
      fill("#topFTD","Usuário - FTD-Montante");
      fill("#topGGR","Cálculo - GGR");
      fill("#topSportsbook","Sportsbook - GGR");
      fill("#topCassino","Cassino - GGR");
      fill("#topBonus","Cálculo - bônus convertidos");
    }

    function exportarCSV(){ const csv=Papa.unparse(dados); const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="dados_clubes.csv"; a.click(); }
    function toggleDarkMode(){ document.body.classList.toggle('light-mode'); }

    // start
    $(function(){
      carregar();
      $('.kpi, .btn-period, .btn-apply, .btn-export, .btn-mode').hover(
        function(){ $(this).css('transform','translateY(-3px)'); },
        function(){ $(this).css('transform','none'); }
      );
    });
  </script>
</body>
</html>
