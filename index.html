<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Comparativo de Clubes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 0; overflow-x: hidden; }
        h2 { text-align: center; margin: 20px 0; }
        .controls { text-align: center; margin-bottom: 15px; }
        .controls input, .controls select, .controls button { margin: 5px; padding: 6px 10px; }
        .kpi-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .kpi { background: white; border-radius: 8px; padding: 15px; width: 180px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: background 0.5s; font-size: 16px; }
        .kpi i { font-size: 28px; margin-bottom: 8px; display: block; }
        .kpi.positive { background: #e3f9e5; }
        .kpi.negative { background: #ffe0e0; }
        .charts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 20px; }
        .chart-container { background: white; padding: 10px; border-radius: 8px; height: 220px; }
        .tables { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 6px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f0f0f0; font-weight: bold; cursor: pointer; }
        .footer { text-align: right; font-size: 12px; padding: 10px 20px; color: gray; }
        button { cursor: pointer; }
        .btn-export { background: #28a745; color: white; border: none; border-radius: 4px; }
        .btn-apply { background: #007bff; color: white; border: none; border-radius: 4px; }
        /* Spinner overlay */
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 9999; justify-content: center; align-items: center; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #007bff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h2>Dashboard Comparativo de Clubes</h2>
    <div class="controls">
        <input type="date" id="filtroInicio"> até 
        <input type="date" id="filtroFim">
        <button class="btn-apply" onclick="setPeriodo(1)">Ontem</button>
        <button class="btn-apply" onclick="setPeriodo(7)">Últimos 7 dias</button>
        <button class="btn-apply" onclick="setPeriodo(30)">Últimos 30 dias</button>
        <br>
        Clube A: <select id="filtroClubeA"></select>
        Clube B: <select id="filtroClubeB"></select>
        <button class="btn-apply" onclick="aplicarFiltros()">Aplicar</button>
        <button class="btn-export" onclick="exportarCSV()"><i class="fa-solid fa-file-csv"></i> Exportar CSV</button>
    </div>

    <div class="kpi-container">
        <div class="kpi" id="kpi-ftd"><i class="fa-solid fa-user-plus" style="color:green"></i><span class="valor">0</span><br>FTD</div>
        <div class="kpi" id="kpi-depositos"><i class="fa-solid fa-coins" style="color:gold"></i><span class="valor">0</span><br>Depósitos</div>
        <div class="kpi" id="kpi-ggr"><i class="fa-solid fa-chart-line" style="color:blue"></i><span class="valor">0</span><br>GGR</div>
        <div class="kpi" id="kpi-sportsbook"><i class="fa-solid fa-futbol" style="color:purple"></i><span class="valor">0</span><br>Sportsbook GGR</div>
        <div class="kpi" id="kpi-cassino"><i class="fa-solid fa-dice" style="color:red"></i><span class="valor">0</span><br>Cassino GGR</div>
        <div class="kpi" id="kpi-bonus"><i class="fa-solid fa-gift" style="color:green"></i><span class="valor">0</span><br>Bônus Convertidos</div>
    </div>

    <div class="charts">
        <div class="chart-container"><canvas id="chartGGR"></canvas></div>
        <div class="chart-container"><canvas id="chartDepositos"></canvas></div>
        <div class="chart-container"><canvas id="chartFTD"></canvas></div>
        <div class="chart-container"><canvas id="chartSportsbook"></canvas></div>
        <div class="chart-container"><canvas id="chartCassino"></canvas></div>
        <div class="chart-container"><canvas id="chartBonus"></canvas></div>
    </div>

    <div class="tables">
        <table id="topDepositos"><thead><tr><th colspan="2">Top 10 Depósitos</th></tr><tr><th>Clube</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topFTD"><thead><tr><th colspan="2">Top 10 FTD</th></tr><tr><th>Clube</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topGGR"><thead><tr><th colspan="2">Top 10 GGR</th></tr><tr><th>Clube</th><th>Valor</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="footer">Última atualização: <span id="ultimaAtualizacao"></span></div>
    <div id="loadingOverlay"><div class="spinner"></div></div>

<script>
const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
let dadosFiltrados = [];
let charts = {};

function showLoading(show) { $("#loadingOverlay").css("display", show ? "flex" : "none"); }
function criarGrafico(ctx,labelA,labelB,colorA,colorB){
    return new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:labelA,data:[],borderColor:colorA,backgroundColor:colorA+'33',fill:false,tension:0.3},{label:labelB,data:[],borderColor:colorB,backgroundColor:colorB+'33',fill:false,tension:0.3}]},options:{responsive:true,plugins:{tooltip:{enabled:true}}}});
}
function animarKPI(id,valorNovo){
    const el=$(id+" .valor");const valorAntigo=parseFloat(el.text().replace(/[R$\.,]/g,''))||0;let atual=valorAntigo;const incremento=(valorNovo-valorAntigo)/20;
    const positivo=valorNovo>=0;$(id).removeClass("positive negative").addClass(positivo?"positive":"negative");
    let step=0;const intervalo=setInterval(()=>{atual+=incremento;step++;el.text("R$ "+atual.toLocaleString('pt-BR',{minimumFractionDigits:2}));if(step>=20){clearInterval(intervalo);el.text("R$ "+valorNovo.toLocaleString('pt-BR',{minimumFractionDigits:2}));}},30);
}
function carregarDados(){
    showLoading(true);
    Papa.parse(urlCSV,{download:true,header:true,complete:function(results){
        dadosFiltrados=results.data;preencherFiltros();atualizarDashboard();showLoading(false);
    }});
}
function preencherFiltros(){
    const clubes=[...new Set(dadosFiltrados.map(d=>d["Usuário - Nome de usuário"]))];
    $("#filtroClubeA,#filtroClubeB").html('<option value="Todos">Todos</option>'+clubes.map(c=>`<option value="${c}">${c}</option>`).join(''));
}
function aplicarFiltros(){atualizarDashboard();}
function setPeriodo(dias){
    const hoje=new Date();const inicio=new Date();
    inicio.setDate(hoje.getDate()-dias);
    $("#filtroInicio").val(inicio.toISOString().split('T')[0]);
    $("#filtroFim").val(hoje.toISOString().split('T')[0]);
    aplicarFiltros();
}
function atualizarDashboard(){
    const clubeA=$("#filtroClubeA").val(),clubeB=$("#filtroClubeB").val(),inicio=$("#filtroInicio").val(),fim=$("#filtroFim").val();
    let dados=dadosFiltrados;
    if(inicio) dados=dados.filter(d=>d["DATA"]>=inicio);
    if(fim) dados=dados.filter(d=>d["DATA"]<=fim);

    const filtrarPorClube=(clube)=>clube==="Todos"?dados:dados.filter(d=>d["Usuário - Nome de usuário"]===clube);

    let dadosA=[],dadosB=[];
    if(clubeA==="Todos" && clubeB==="Todos"){dadosA=dados;dadosB=[];}else{dadosA=filtrarPorClube(clubeA);dadosB=clubeB!==clubeA?filtrarPorClube(clubeB):[];}

    const sum=(arr,campo)=>arr.reduce((s,d)=>s+(parseFloat(d[campo])||0),0);
    animarKPI("#kpi-ftd",sum(dadosA,"Usuário - FTD-Montante")+sum(dadosB,"Usuário - FTD-Montante"));
    animarKPI("#kpi-depositos",sum(dadosA,"Usuário - Depósitos")+sum(dadosB,"Usuário - Depósitos"));
    animarKPI("#kpi-ggr",sum(dadosA,"Cálculo - GGR")+sum(dadosB,"Cálculo - GGR"));
    animarKPI("#kpi-sportsbook",sum(dadosA,"Sportsbook - GGR")+sum(dadosB,"Sportsbook - GGR"));
    animarKPI("#kpi-cassino",sum(dadosA,"Cassino - GGR")+sum(dadosB,"Cassino - GGR"));
    animarKPI("#kpi-bonus",sum(dadosA,"Cálculo - bônus convertidos")+sum(dadosB,"Cálculo - bônus convertidos"));

    const porData=(dados)=>{const out={};dados.forEach(d=>{if(!out[d.DATA]) out[d.DATA]={ggr:0,dep:0,ftd:0,sb:0,cs:0,bo:0};out[d.DATA].ggr+=parseFloat(d["Cálculo - GGR"])||0;out[d.DATA].dep+=parseFloat(d["Usuário - Depósitos"])||0;out[d.DATA].ftd+=parseFloat(d["Usuário - FTD-Montante"])||0;out[d.DATA].sb+=parseFloat(d["Sportsbook - GGR"])||0;out[d.DATA].cs+=parseFloat(d["Cassino - GGR"])||0;out[d.DATA].bo+=parseFloat(d["Cálculo - bônus convertidos"])||0;});return out;};
    const dadosPorDataA=porData(dadosA),dadosPorDataB=porData(dadosB);
    const labels=[...new Set([...Object.keys(dadosPorDataA),...Object.keys(dadosPorDataB)])].sort();
    function setChart(chart,campo){chart.data.labels=labels;chart.data.datasets[0].data=labels.map(l=>dadosPorDataA[l]?dadosPorDataA[l][campo]:0);chart.data.datasets[1].data=labels.map(l=>dadosPorDataB[l]?dadosPorDataB[l][campo]:0);chart.update();}
    setChart(charts.chartGGR,"ggr");setChart(charts.chartDepositos,"dep");setChart(charts.chartFTD,"ftd");setChart(charts.chartSportsbook,"sb");setChart(charts.chartCassino,"cs");setChart(charts.chartBonus,"bo");

    preencherTabela("#topDepositos",dados,"Usuário - Depósitos");
    preencherTabela("#topFTD",dados,"Usuário - FTD-Montante");
    preencherTabela("#topGGR",dados,"Cálculo - GGR");

    $("#ultimaAtualizacao").text(new Date().toLocaleString());
}
function preencherTabela(id,dados,campo){
    const agrupado={};dados.forEach(d=>{const c=d["Usuário - Nome de usuário"];agrupado[c]=(agrupado[c]||0)+(parseFloat(d[campo])||0);});
    const top10=Object.entries(agrupado).sort((a,b)=>b[1]-a[1]).slice(0,10);
    $(id+" tbody").html(top10.map(t=>`<tr><td>${t[0]}</td><td>R$ ${t[1].toLocaleString('pt-BR',{minimumFractionDigits:2})}</td></tr>`).join(''));
}
function exportarCSV(){
    const csv=Papa.unparse(dadosFiltrados);
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="dados_filtrados.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
$(document).ready(function(){
    charts.chartGGR=criarGrafico(document.getElementById('chartGGR'),"Clube A GGR","Clube B GGR","blue","orange");
    charts.chartDepositos=criarGrafico(document.getElementById('chartDepositos'),"Clube A Depósitos","Clube B Depósitos","blue","orange");
    charts.chartFTD=criarGrafico(document.getElementById('chartFTD'),"Clube A FTD","Clube B FTD","blue","orange");
    charts.chartSportsbook=criarGrafico(document.getElementById('chartSportsbook'),"Clube A Sportsbook","Clube B Sportsbook","blue","orange");
    charts.chartCassino=criarGrafico(document.getElementById('chartCassino'),"Clube A Cassino","Clube B Cassino","blue","orange");
    charts.chartBonus=criarGrafico(document.getElementById('chartBonus'),"Clube A Bônus","Clube B Bônus","blue","orange");
    carregarDados();
});
</script>
</body>
</html>
