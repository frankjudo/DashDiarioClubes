<!DOCTYPE html>
<html lang="pt-br">
<head>
    <!-- ... (cabeçalho mantido igual) ... -->
    <style>
        /* ... (estilos mantidos iguais) ... */
        /* Adicionado para melhor responsividade */
        @media (max-width: 768px) {
            .charts, .tables { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- ... (corpo mantido igual) ... -->

<script>
// ... (código anterior mantido) ...

function atualizarDashboard() {
    const clubeA = $("#filtroClubeA").val();
    const clubeB = $("#filtroClubeB").val();
    const inicio = $("#filtroInicio").val();
    const fim = $("#filtroFim").val();
    
    let dados = dadosFiltrados;
    if (inicio) dados = dados.filter(d => d["DATA"] >= inicio);
    if (fim) dados = dados.filter(d => d["DATA"] <= fim);

    // Correção principal: processamento independente para cada clube
    const processarClube = (clube) => {
        const dadosClube = (clube === "Todos") 
            ? dados 
            : dados.filter(d => d["Usuário - Nome de usuário"] === clube);
        
        const porData = {};
        dadosClube.forEach(d => {
            if (!porData[d.DATA]) porData[d.DATA] = {
                ggr: 0, dep: 0, ftd: 0, sb: 0, cs: 0, bo: 0
            };
            porData[d.DATA].ggr += parseFloat(d["Cálculo - GGR"]) || 0;
            porData[d.DATA].dep += parseFloat(d["Usuário - Depósitos"]) || 0;
            porData[d.DATA].ftd += parseFloat(d["Usuário - FTD-Montante"]) || 0;
            porData[d.DATA].sb += parseFloat(d["Sportsbook - GGR"]) || 0;
            porData[d.DATA].cs += parseFloat(d["Cassino - GGR"]) || 0;
            porData[d.DATA].bo += parseFloat(d["Cálculo - bônus convertidos"]) || 0;
        });
        return porData;
    };

    const dadosA = processarClube(clubeA);
    const dadosB = (clubeB !== "Nenhum" && clubeB !== clubeA) 
        ? processarClube(clubeB) 
        : {};

    // Juntar todas as datas únicas
    const todasDatas = [...new Set([
        ...Object.keys(dadosA),
        ...Object.keys(dadosB)
    ])].sort();

    // Preencher KPIs
    const sum = (obj, campo) => Object.values(obj).reduce((s, d) => s + d[campo], 0);
    animarKPI("#kpi-ftd", sum(dadosA, "ftd") + sum(dadosB, "ftd"));
    animarKPI("#kpi-depositos", sum(dadosA, "dep") + sum(dadosB, "dep"));
    animarKPI("#kpi-ggr", sum(dadosA, "ggr") + sum(dadosB, "ggr"));
    animarKPI("#kpi-sportsbook", sum(dadosA, "sb") + sum(dadosB, "sb"));
    animarKPI("#kpi-cassino", sum(dadosA, "cs") + sum(dadosB, "cs"));
    animarKPI("#kpi-bonus", sum(dadosA, "bo") + sum(dadosB, "bo"));

    // Atualizar gráficos
    function atualizarGrafico(chart, campo) {
        chart.data.labels = todasDatas;
        chart.data.datasets[0].data = todasDatas.map(d => dadosA[d] ? dadosA[d][campo] : 0);
        
        // Clube B só aparece se for selecionado e diferente de A
        if (Object.keys(dadosB).length > 0) {
            chart.data.datasets[1].data = todasDatas.map(d => dadosB[d] ? dadosB[d][campo] : 0);
            chart.data.datasets[1].hidden = false; // Garantir que está visível
        } else {
            chart.data.datasets[1].data = [];
            chart.data.datasets[1].hidden = true; // Ocultar se não houver dados
        }
        
        chart.update();
    }

    atualizarGrafico(charts.chartGGR, "ggr");
    atualizarGrafico(charts.chartDepositos, "dep");
    atualizarGrafico(charts.chartFTD, "ftd");
    atualizarGrafico(charts.chartSportsbook, "sb");
    atualizarGrafico(charts.chartCassino, "cs");
    atualizarGrafico(charts.chartBonus, "bo");

    // ... (código restante mantido) ...
}

// ... (código posterior mantido) ...
</script>
</body>
</html>