<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard Comparativo de Clubes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
      /* ... seu CSS permanece exatamente igual ... */
    </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-chart-line"></i> Dashboard Comparativo de Clubes</h1>
      <p>Analise e compare o desempenho de diferentes clubes</p>
    </header>

    <div class="controls">
      <!-- controles de data e filtros... -->
      <div class="date-controls">
        <label>De:</label><input type="date" id="filtroInicio"/>
        <label>até</label><input type="date" id="filtroFim"/>
        <button class="btn-period" onclick="setPeriodo(1)"><i class="fas fa-calendar-day"></i> Ontem</button>
        <button class="btn-period" onclick="setPeriodo(7)"><i class="fas fa-calendar-week"></i> Últimos 7 dias</button>
        <button class="btn-period" onclick="setPeriodo(30)"><i class="fas fa-calendar-alt"></i> Últimos 30 dias</button>
      </div>
      <div class="club-controls">
        <label>Clube A:</label>
        <select id="filtroClubeA"></select>
        <label>Clube B:</label>
        <select id="filtroClubeB"></select>
        <button class="btn-apply" onclick="aplicarFiltros()">
          <i class="fas fa-filter"></i> Aplicar Filtros
        </button>
      </div>
      <div class="button-controls">
        <button class="btn-export" onclick="exportarCSV()">
          <i class="fas fa-file-csv"></i> Exportar CSV
        </button>
      </div>
    </div>

    <div class="kpi-container">
      <div class="kpi positive" id="kpi-ftd">
        <i class="fa-solid fa-user-plus" style="color:#2ecc71"></i>
        <h3>FTD</h3>
        <div class="valor">R$ 0</div>
      </div>
      <div class="kpi positive" id="kpi-depositos">
        <i class="fa-solid fa-coins" style="color:#f39c12"></i>
        <h3>Depósitos</h3>
        <div class="valor">R$ 0</div>
      </div>
      <div class="kpi positive" id="kpi-ggr">
        <i class="fa-solid fa-chart-line" style="color:#3498db"></i>
        <h3>GGR</h3>
        <div class="valor">R$ 0</div>
      </div>
      <div class="kpi positive" id="kpi-sportsbook">
        <i class="fa-solid fa-futbol" style="color:#9b59b6"></i>
        <h3>Sportsbook GGR</h3>
        <div class="valor">R$ 0</div>
      </div>
      <div class="kpi positive" id="kpi-cassino">
        <i class="fa-solid fa-dice" style="color:#e74c3c"></i>
        <h3>Cassino GGR</h3>
        <div class="valor">R$ 0</div>
      </div>
      <div class="kpi positive" id="kpi-bonus">
        <i class="fa-solid fa-gift" style="color:#2ecc71"></i>
        <h3>Bônus Convertidos</h3>
        <div class="valor">R$ 0</div>
      </div>
    </div>

    <div class="charts">
      <div class="chart-container">
        <h3>Evolução do GGR</h3><canvas id="chartGGR"></canvas>
      </div>
      <div class="chart-container">
        <h3>Evolução de Depósitos</h3><canvas id="chartDepositos"></canvas>
      </div>
      <div class="chart-container">
        <h3>Evolução do FTD</h3><canvas id="chartFTD"></canvas>
      </div>
      <div class="chart-container">
        <h3>Evolução do Sportsbook</h3><canvas id="chartSportsbook"></canvas>
      </div>
      <div class="chart-container">
        <h3>Evolução do Cassino</h3><canvas id="chartCassino"></canvas>
      </div>
      <div class="chart-container">
        <h3>Evolução de Bônus</h3><canvas id="chartBonus"></canvas>
      </div>
    </div>

    <div class="tables">
      <div class="table-container">
        <h3>Top 10 Depósitos</h3>
        <table id="topDepositos">
          <thead><tr><th>Clube</th><th>Valor</th></tr></thead>
          <tbody><tr><td colspan="2">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3>Top 10 FTD</h3>
        <table id="topFTD">
          <thead><tr><th>Clube</th><th>Valor</th></tr></thead>
          <tbody><tr><td colspan="2">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3>Top 10 GGR</h3>
        <table id="topGGR">
          <thead><tr><th>Clube</th><th>Valor</th></tr></thead>
          <tbody><tr><td colspan="2">Carregando...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      <p>Última atualização: <span id="ultimaAtualizacao"></span></p>
      <p>Dashboard desenvolvido para análise comparativa de clubes</p>
    </div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingMessage">Carregando dados...</div>
  </div>

  <script>
    const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
    let dados = [], charts = {}, usandoDemo = false;

    function showLoading(on,msg="Carregando dados..."){
      $("#loadingMessage").text(msg);
      $("#loadingOverlay").css("display",on?"flex":"none");
    }

    function criarGrafico(ctx,labelA,labelB,colorA,colorB){
      return new Chart(ctx,{type:'line',data:{
        labels:[],datasets:[
          {label:labelA,data:[],borderColor:colorA,backgroundColor:colorA+'33',fill:false,tension:0.3},
          {label:labelB,data:[],borderColor:colorB,backgroundColor:colorB+'33',fill:false,tension:0.3},
        ]
      },options:{responsive:true,maintainAspectRatio:false,plugins:{
        legend:{position:'top'},
        tooltip:{callbacks:{
          label:ctx=>`${ctx.dataset.label}: R$ ${ctx.parsed.y.toLocaleString('pt-BR',{minimumFractionDigits:2})}`
        }}
      },scales:{
        y:{beginAtZero:true,ticks:{callback:v=>`R$ ${v.toLocaleString('pt-BR',{minimumFractionDigits:0})}`}}
      }}});}
    
    function animarKPI(sel,novo){
      let el=$(sel+" .valor"),ant=parseFloat(el.text().replace(/[^\d]/g,''))||0,
          diff=(novo-ant)/30,cur=ant,pass=0;
      $(sel).removeClass("positive negative")
        .addClass(novo>=0?"positive":"negative");
      let h=setInterval(()=>{
        cur+=diff; pass++;
        if(pass>=30){ clearInterval(h); cur=novo; }
        el.text("R$ "+cur.toLocaleString('pt-BR',{minimumFractionDigits:2}));
      },20);
    }

    function carregar(){
      showLoading(true);
      Papa.parse(URL_CSV,{download:true,header:true,complete(r){
        if(r.data.length){
          dados=r.data.filter(x=>x.DATA);  
          usandoDemo=false;
        } else {  
          alert("CSV vazio!"); usandoDemo=true;
        }
        init();
      },error(){
        alert("Erro no CSV!"); usandoDemo=true; dados=[];
        init();
      }});
    }

    function init(){
      // preencher selects
      let clubes=[...new Set(dados.map(d=>d["Usuário - Nome de usuário"]))];
      let opts='<option value="Todos">Todos</option>'+
               clubes.map(c=>`<option>${c}</option>`).join('');
      $("#filtroClubeA,#filtroClubeB").html(opts).val("Todos");

      // default último 7 dias
      let hoje=new Date(),ini=new Date();
      ini.setDate(hoje.getDate()-7);
      $("#filtroInicio").val(ini.toISOString().slice(0,10));
      $("#filtroFim").val(hoje.toISOString().slice(0,10));

      // gráficos
      charts.chartGGR       = criarGrafico($("#chartGGR")[0],"Clube A GGR","Clube B GGR","#3498db","#e74c3c");
      charts.chartDepositos = criarGrafico($("#chartDepositos")[0],"Clube A Depósitos","Clube B Depósitos","#3498db","#e74c3c");
      charts.chartFTD       = criarGrafico($("#chartFTD")[0],"Clube A FTD","Clube B FTD","#3498db","#e74c3c");
      charts.chartSportsbook= criarGrafico($("#chartSportsbook")[0],"Clube A Sportsbook","Clube B Sportsbook","#3498db","#e74c3c");
      charts.chartCassino   = criarGrafico($("#chartCassino")[0],"Clube A Cassino","Clube B Cassino","#3498db","#e74c3c");
      charts.chartBonus     = criarGrafico($("#chartBonus")[0],"Clube A Bônus","Clube B Bônus","#3498db","#e74c3c");

      atualizar();
      showLoading(false);
    }

    function aplicarFiltros(){ atualizar(); }
    function setPeriodo(d){
      let hoje=new Date(),ini=new Date();
      ini.setDate(hoje.getDate()-d);
      $("#filtroInicio").val(ini.toISOString().slice(0,10));
      $("#filtroFim").val(hoje.toISOString().slice(0,10));
      atualizar();
    }

    function atualizar(){
      let ini=$("#filtroInicio").val(),fim=$("#filtroFim").val(),
          ca=$("#filtroClubeA").val(), cb=$("#filtroClubeB").val();
      let base=dados.filter(x=>(!ini||x.DATA>=ini)&&(!fim||x.DATA<=fim));
      let filtra = c=>c==="Todos"? base : base.filter(x=>x["Usuário - Nome de usuário"]===c);
      let A=filtra(ca), B=cb!==ca?filtra(cb):[];

      let soma=(arr,field)=>arr.reduce((s,d)=>s+ (parseFloat(d[field])||0),0);
      animarKPI("#kpi-ftd", soma(A,"Usuário - FTD-Montante")+soma(B,"Usuário - FTD-Montante"));
      animarKPI("#kpi-depositos", soma(A,"Usuário - Depósitos")+soma(B,"Usuário - Depósitos"));
      animarKPI("#kpi-ggr", soma(A,"Cálculo - GGR")+soma(B,"Cálculo - GGR"));
      animarKPI("#kpi-sportsbook", soma(A,"Sportsbook - GGR")+soma(B,"Sportsbook - GGR"));
      animarKPI("#kpi-cassino", soma(A,"Cassino - GGR")+soma(B,"Cassino - GGR"));
      animarKPI("#kpi-bonus", soma(A,"Cálculo - bônus convertidos")+soma(B,"Cálculo - bônus convertidos"));

      // agrupa por data
      let agrupa=arr=>{let out={};arr.forEach(d=>{
        out[d.DATA]=out[d.DATA]||{ggr:0,dep:0,ftd:0,sb:0,cs:0,bo:0};
        out[d.DATA].ggr+= +d["Cálculo - GGR"]||0;
        out[d.DATA].dep+= +d["Usuário - Depósitos"]||0;
        out[d.DATA].ftd+= +d["Usuário - FTD-Montante"]||0;
        out[d.DATA].sb+= +d["Sportsbook - GGR"]||0;
        out[d.DATA].cs+= +d["Cassino - GGR"]||0;
        out[d.DATA].bo+= +d["Cálculo - bônus convertidos"]||0;
      }); return out;};
      let dA=agrupa(A), dB=agrupa(B);
      let datas=[...new Set([...Object.keys(dA),...Object.keys(dB)])].sort();

      function upd(ch,f){
        ch.data.labels=datas;
        ch.data.datasets[0].data=datas.map(d=>dA[d]?dA[d][f]:0);
        ch.data.datasets[1].data=datas.map(d=>dB[d]?dB[d][f]:0);
        ch.update();
      }
      upd(charts.chartGGR,"ggr"); upd(charts.chartDepositos,"dep");
      upd(charts.chartFTD,"ftd"); upd(charts.chartSportsbook,"sb");
      upd(charts.chartCassino,"cs"); upd(charts.chartBonus,"bo");

      // tabelas
      function preenche(id, arr, field){
        let m={};
        arr.forEach(d=>{ let c=d["Usuário - Nome de usuário"], v=+d[field]||0; m[c]=(m[c]||0)+v; });
        let top=Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,10);
        let html=top.map(r=>`<tr><td>${r[0]}</td><td>R$ ${r[1].toLocaleString('pt-BR',{minimumFractionDigits:2})}</td></tr>`).join('');
        $(id+" tbody").html(html);
      }
      preenche("#topDepositos", base, "Usuário - Depósitos");
      preenche("#topFTD",       base, "Usuário - FTD-Montante");
      preenche("#topGGR",       base, "Cálculo - GGR");

      $("#ultimaAtualizacao").text(new Date().toLocaleString('pt-BR'));
    }

    function exportarCSV(){
      let csv = Papa.unparse(dados);
      let blob = new Blob([csv],{type:"text/csv"});
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "dados_clubes.csv";
      a.click();
    }

    $(document).ready(carregar);
  </script>
</body>
</html>
