<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Clubes</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .header { padding: 15px; text-align: center; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filters { text-align: center; padding: 10px; }
        .kpis { display: flex; justify-content: space-around; flex-wrap: wrap; padding: 15px; }
        .kpi { background: #fff; border-radius: 8px; padding: 20px; text-align: center; width: 150px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: transform .2s; }
        .kpi:hover { transform: scale(1.05); }
        .kpi i { font-size: 24px; margin-bottom: 10px; }
        .charts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
        .chart-container { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 200px; }
        .tables { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background: #f1f1f1; font-weight: bold; }
        .footer { text-align: center; padding: 10px; font-size: 12px; color: #555; }
        .btn-csv { margin: 10px auto; display: block; padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-csv:hover { background: #45a049; }
        .changed-up { color: green !important; transition: color .5s ease; }
        .changed-down { color: red !important; transition: color .5s ease; }
        .fade-change { animation: fadeBg 0.5s ease-in-out; }
        @keyframes fadeBg { from { background-color: #dff0d8; } to { background-color: white; } }
    </style>
</head>
<body>

<div class="header">
    <h2>Dashboard de Clubes</h2>
</div>

<div class="filters">
    Data: <input type="date" id="dataFiltro">
    Clube: <select id="clubeFiltro"><option value="Todos">Todos</option></select>
    <button onclick="atualizarDashboard()">Aplicar</button>
    <button class="btn-csv" onclick="exportarCSV()">Exportar CSV</button>
</div>

<div class="kpis">
    <div class="kpi" id="kpi-ftd-box" title="Primeiros Depósitos (FTD)">
        <i class="fas fa-user-plus" style="color:#4CAF50"></i>
        <div>FTD</div>
        <div id="kpi-ftd">R$ 0,00</div>
    </div>
    <div class="kpi" id="kpi-depositos-box" title="Total de Depósitos">
        <i class="fas fa-coins" style="color:#FF9800"></i>
        <div>Depósitos</div>
        <div id="kpi-depositos">R$ 0,00</div>
    </div>
    <div class="kpi" id="kpi-ggr-box" title="Gross Gaming Revenue Total">
        <i class="fas fa-chart-line" style="color:#2196F3"></i>
        <div>GGR</div>
        <div id="kpi-ggr">R$ 0,00</div>
    </div>
    <div class="kpi" id="kpi-sportsbook-box" title="GGR Sportsbook">
        <i class="fas fa-football-ball" style="color:#9C27B0"></i>
        <div>Sportsbook GGR</div>
        <div id="kpi-sportsbook">R$ 0,00</div>
    </div>
    <div class="kpi" id="kpi-cassino-box" title="GGR Cassino">
        <i class="fas fa-dice" style="color:#F44336"></i>
        <div>Cassino GGR</div>
        <div id="kpi-cassino">R$ 0,00</div>
    </div>
    <div class="kpi" id="kpi-bonus-box" title="Bônus Convertidos">
        <i class="fas fa-gift" style="color:#009688"></i>
        <div>Bônus Convertidos</div>
        <div id="kpi-bonus">R$ 0,00</div>
    </div>
</div>

<div class="charts">
    <div class="chart-container"><canvas id="chartGGR"></canvas></div>
    <div class="chart-container"><canvas id="chartDepositos"></canvas></div>
    <div class="chart-container"><canvas id="chartFTD"></canvas></div>
    <div class="chart-container"><canvas id="chartSportsbook"></canvas></div>
    <div class="chart-container"><canvas id="chartCassino"></canvas></div>
    <div class="chart-container"><canvas id="chartBonus"></canvas></div>
</div>

<div class="tables">
    <table id="topDepositos"><thead><tr><th>Top 10 Depósitos</th><th>Valor</th></tr></thead><tbody></tbody></table>
    <table id="topFTD"><thead><tr><th>Top 10 FTD</th><th>Valor</th></tr></thead><tbody></tbody></table>
    <table id="topGGR"><thead><tr><th>Top 10 GGR</th><th>Valor</th></tr></thead><tbody></tbody></table>
    <table id="topSportsbook"><thead><tr><th>Top 10 Sportsbook</th><th>Valor</th></tr></thead><tbody></tbody></table>
    <table id="topCassino"><thead><tr><th>Top 10 Cassino</th><th>Valor</th></tr></thead><tbody></tbody></table>
    <table id="topBonus"><thead><tr><th>Top 10 Bônus Convertidos</th><th>Valor</th></tr></thead><tbody></tbody></table>
</div>

<div class="footer" id="ultimaAtualizacao">Última atualização: ...</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
let charts = {};
let valoresAnteriores = {};
let dadosFiltrados = [];

function formatarBRL(v){ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function animarNumero(el, inicio, fim, duracao=800){
    const delta = fim - inicio;
    let inicioTime;
    function step(timestamp){
        if(!inicioTime) inicioTime=timestamp;
        const progresso = Math.min((timestamp - inicioTime)/duracao, 1);
        const valor = inicio + delta * progresso;
        el.text(formatarBRL(valor));
        if(progresso<1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}
function animarKPI(id, valor){
    const el = $(id); const ant = valoresAnteriores[id] || 0; valoresAnteriores[id] = valor;
    el.parent().removeClass("changed-up changed-down");
    if(valor>ant){ el.parent().addClass("changed-up"); } 
    else if(valor<ant){ el.parent().addClass("changed-down"); }
    animarNumero(el, ant, valor);
}
function atualizarDashboard(){
    $.get(SHEET_URL, function(data){
        const linhas = data.split("\n").map(l=>l.split(","));
        const dados = linhas.slice(1);
        dadosFiltrados = dados;
        let porData = {}, top = {depositos:{},ftd:{},ggr:{},sports:{},cassino:{},bonus:{}};
        let total = {ftd:0,dep:0,ggr:0,sports:0,cassino:0,bonus:0};
        dados.forEach(l=>{
            const data=l[0], user=l[2];
            const ftd=+l[4]||0, dep=+l[5]||0, sports=+l[10]||0, cassino=+l[13]||0, ggr=+l[23]||0, bonus=+l[28]||0;
            total.ftd+=ftd; total.dep+=dep; total.ggr+=ggr; total.sports+=sports; total.cassino+=cassino; total.bonus+=bonus;
            if(!porData[data]) porData[data]={ftd:0,dep:0,sports:0,cassino:0,ggr:0,bonus:0};
            porData[data].ftd+=ftd; porData[data].dep+=dep; porData[data].sports+=sports; porData[data].cassino+=cassino; porData[data].ggr+=ggr; porData[data].bonus+=bonus;
            top.depositos[user]=(top.depositos[user]||0)+dep;
            top.ftd[user]=(top.ftd[user]||0)+ftd;
            top.ggr[user]=(top.ggr[user]||0)+ggr;
            top.sports[user]=(top.sports[user]||0)+sports;
            top.cassino[user]=(top.cassino[user]||0)+cassino;
            top.bonus[user]=(top.bonus[user]||0)+bonus;
        });
        animarKPI("#kpi-ftd", total.ftd);
        animarKPI("#kpi-depositos", total.dep);
        animarKPI("#kpi-ggr", total.ggr);
        animarKPI("#kpi-sportsbook", total.sports);
        animarKPI("#kpi-cassino", total.cassino);
        animarKPI("#kpi-bonus", total.bonus);
        atualizarGraficos(porData);
        preencherTabela("#topDepositos", top.depositos);
        preencherTabela("#topFTD", top.ftd);
        preencherTabela("#topGGR", top.ggr);
        preencherTabela("#topSportsbook", top.sports);
        preencherTabela("#topCassino", top.cassino);
        preencherTabela("#topBonus", top.bonus);
        $("#ultimaAtualizacao").text("Última atualização: "+new Date().toLocaleString());
    });
}
function atualizarGraficos(porData){
    const datas=Object.keys(porData).sort();
    const dados=e=>datas.map(d=>porData[d][e]);
    criarOuAtualizarChart("chartGGR","Cálculo - GGR","#4CAF50",datas,dados('ggr'));
    criarOuAtualizarChart("chartDepositos","Usuário - Depósitos","#FF9800",datas,dados('dep'));
    criarOuAtualizarChart("chartFTD","Usuário - FTD-Montante","#FFC107",datas,dados('ftd'));
    criarOuAtualizarChart("chartSportsbook","Sportsbook - GGR","#9C27B0",datas,dados('sports'));
    criarOuAtualizarChart("chartCassino","Cassino - GGR","#F44336",datas,dados('cassino'));
    criarOuAtualizarChart("chartBonus","Cálculo - Bônus Convertidos","#009688",datas,dados('bonus'));
}
function criarOuAtualizarChart(id,label,cor,labels,dados){
    if(charts[id]){ charts[id].data.labels=labels; charts[id].data.datasets[0].data=dados; charts[id].update(); }
    else{
        charts[id]=new Chart(document.getElementById(id),{
            type:'line',
            data:{labels:labels,datasets:[{label:label,data:dados,borderColor:cor,backgroundColor:cor+'55',fill:false}]},
            options:{responsive:true,maintainAspectRatio:false}
        });
    }
}
function preencherTabela(selector, obj){
    const corpo=$(selector+" tbody"); corpo.empty();
    Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,10)
        .forEach(([user,val])=>{
            const tr=$(`<tr class="fade-change"><td>${user}</td><td>${formatarBRL(val)}</td></tr>`);
            corpo.append(tr); setTimeout(()=>tr.removeClass('fade-change'),500);
        });
}
function exportarCSV(){
    let csv="DATA,Usuário - Nome de usuário,FTD,Depósitos,Sportsbook GGR,Cassino GGR,GGR,Bônus Convertidos\n";
    dadosFiltrados.forEach(l=>{
        csv+=`${l[0]},${l[2]},${l[4]},${l[5]},${l[10]},${l[13]},${l[23]},${l[28]}\n`;
    });
    const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
    saveAs(blob, "dados_filtrados.csv");
}
$(document).ready(()=>atualizarDashboard());
</script>
</body>
</html>
