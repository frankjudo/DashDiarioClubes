<!DOCTYPE html>
<html lang="pt-br" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Comparativo de Clubes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --success: #2ecc71;
      --warning: #f39c12;
      --info: #9b59b6;
      --dark: #1a252f;
      --light: #ecf0f1;
      --gray: #95a5a6;
      --dark-gray: #34495e;
    }
    [data-theme="light"] {
      --primary: #ecf0f1;
      --secondary: #2c3e50;
      --accent: #e74c3c;
      --success: #27ae60;
      --warning: #f39c12;
      --info: #8e44ad;
      --dark: #ffffff;
      --light: #2c3e50;
      --gray: #7f8c8d;
      --dark-gray: #bdc3c7;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Verdana, sans-serif; }
    body {
      background: linear-gradient(135deg, var(--dark), var(--primary));
      color: var(--light);
      min-height:100vh; padding:20px;
      transition: background .3s, color .3s;
    }
    .container { max-width:1800px; margin:0 auto; }
    header {
      text-align:center; margin-bottom:30px; padding:20px;
      background:rgba(26,37,47,0.7); border-radius:15px;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
      backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1);
    }
    header h1 {
      font-size:2.8rem; margin-bottom:10px;
      background:linear-gradient(to right, var(--secondary), var(--success));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      display:inline-block;
    }
    header p { font-size:1.2rem; color:var(--gray); max-width:800px; margin:0 auto; }
    main section { margin-bottom:30px; }
    #demoWarning {
      display:none; background:rgba(243,156,18,0.2);
      border:1px solid var(--warning); border-radius:8px;
      padding:15px; text-align:center;
    }
    .controls {
      background:rgba(26,37,47,0.7); border-radius:15px;
      padding:25px; box-shadow:0 8px 32px rgba(0,0,0,0.3);
      backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1);
    }
    .controls h2.visually-hidden { position:absolute; left:-9999px; }
    .control-section { margin-bottom:25px; }
    .control-section h3 {
      margin-bottom:15px; color:var(--secondary);
      font-size:1.4rem; display:flex; align-items:center; gap:10px;
    }
    .date-controls, .club-controls, .button-controls {
      display:flex; flex-wrap:wrap; gap:15px; align-items:center;
    }
    label { font-weight:600; color:var(--light); min-width:80px; }
    input, select {
      padding:12px 15px; border:1px solid rgba(255,255,255,0.1);
      background:rgba(0,0,0,0.2); color:var(--light); border-radius:8px;
      font-size:1rem; transition:all .3s;
    }
    input:focus, select:focus {
      outline:none; border-color:var(--secondary);
      box-shadow:0 0 0 3px rgba(52,152,219,0.3);
    }
    .btn-period, .btn-apply, .btn-export, .btn-mode {
      padding:12px 20px; border:none; border-radius:8px;
      font-weight:600; cursor:pointer; display:flex;
      align-items:center; gap:10px; transition:all .3s; font-size:1rem;
    }
    .btn-period { background:rgba(52,152,219,0.2); color:var(--secondary); }
    .btn-apply  { background:rgba(46,204,113,0.2); color:var(--success); }
    .btn-export { background:rgba(155,89,182,0.2); color:var(--info); }
    .btn-mode   { background:rgba(243,156,18,0.2); color:var(--warning); }
    .btn-period:hover { background:rgba(52,152,219,0.3); }
    .btn-apply:hover  { background:rgba(46,204,113,0.3); }
    .btn-export:hover { background:rgba(155,89,182,0.3); }
    .btn-mode:hover   { background:rgba(243,156,18,0.3); }
    .kpi-container {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:20px;
    }
    .kpi {
      background:rgba(26,37,47,0.7); border-radius:15px; padding:25px;
      display:flex; flex-direction:column; align-items:center; text-align:center;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
      backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1);
      transition:transform .3s,box-shadow .3s;
    }
    .kpi:hover { transform:translateY(-5px); box-shadow:0 12px 40px rgba(0,0,0,0.4); }
    .kpi i { font-size:2.5rem; margin-bottom:15px; }
    .kpi h3 { font-size:1.3rem; margin-bottom:10px; color:var(--gray); }
    .kpi .valor { font-size:1.8rem; font-weight:700; }
    .kpi .variacao { font-size:.9rem; margin-top:8px; font-weight:600; }
    .positive { border-left:5px solid var(--success); }
    .negative { border-left:5px solid var(--accent); }
    .charts, .tables { display:grid; gap:25px; }
    .charts { grid-template-columns:repeat(auto-fit,minmax(600px,1fr)); }
    .tables { grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); }
    .chart-container, .table-container {
      background:rgba(26,37,47,0.7); border-radius:15px; padding:25px;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
      backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1);
    }
    .chart-container h3, .table-container h3 {
      margin-bottom:20px; font-size:1.4rem; color:var(--secondary);
      display:flex; align-items:center; gap:10px;
    }
    .chart-container canvas { width:100% !important; height:300px !important; }
    table { width:100%; border-collapse:collapse; }
    th {
      background:rgba(52,152,219,0.2); padding:15px;
      text-align:left; font-weight:600; color:var(--secondary);
    }
    td { padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); }
    tr:last-child td { border-bottom:none; }
    tr:hover { background:rgba(255,255,255,0.05); }
    .footer {
      text-align:center; padding:25px; background:rgba(26,37,47,0.7);
      border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.3);
      backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1);
    }
    .footer p { margin-bottom:10px; color:var(--gray); }
    #ultimaAtualizacao { font-weight:600; color:var(--secondary); }
    @keyframes spin { 0%{transform:rotate(0deg)}100%{transform:rotate(360deg)} }
    @media (max-width:1200px){
      .charts { grid-template-columns:1fr; }
      header h1 { font-size:2.2rem; }
    }
    @media (max-width:768px){
      .kpi-container, .tables { grid-template-columns:1fr; }
      .date-controls, .club-controls { flex-direction:column; align-items:stretch; }
      .btn-period, .btn-apply, .btn-export, .btn-mode {
        width:100%; justify-content:center;
      }
      header h1 { font-size:1.8rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 aria-label="Dashboard Comparativo de Clubes">
        <i class="fas fa-chart-line"></i> Dashboard Comparativo de Clubes
      </h1>
      <p>Analise e compare o desempenho de diferentes clubes em tempo real</p>
    </header>

    <main>
      <section id="demoWarning" role="alert" aria-live="polite">
        <i class="fas fa-exclamation-triangle"></i>
        Você está visualizando dados de demonstração. Conecte-se à fonte de dados real para ver informações atualizadas.
      </section>

      <section class="controls" aria-labelledby="controlsTitle">
        <h2 id="controlsTitle" class="visually-hidden">Controles do Dashboard</h2>

        <div class="control-section" aria-labelledby="periodoTitle">
          <h3 id="periodoTitle"><i class="fas fa-calendar-alt"></i> Período</h3>
          <div class="date-controls">
            <label for="filtroInicio">De:</label>
            <input type="date" id="filtroInicio" name="filtroInicio" />
            <label for="filtroFim">Até:</label>
            <input type="date" id="filtroFim" name="filtroFim" />
            <button type="button" class="btn-period" onclick="setPeriodo(1)">
              <i class="fas fa-calendar-day"></i> Ontem
            </button>
            <button type="button" class="btn-period" onclick="setPeriodo(7)">
              <i class="fas fa-calendar-week"></i> Últimos 7 dias
            </button>
            <button type="button" class="btn-period" onclick="setPeriodo(30)">
              <i class="fas fa-calendar-alt"></i> Últimos 30 dias
            </button>
          </div>
        </div>

        <div class="control-section" aria-labelledby="clubesTitle">
          <h3 id="clubesTitle"><i class="fas fa-users"></i> Clubes</h3>
          <div class="club-controls">
            <label for="filtroClubeA">Clube A:</label>
            <select id="filtroClubeA" name="filtroClubeA">
              <option value="Todos">Todos os Clubes</option>
            </select>
            <label for="filtroClubeB">Clube B:</label>
            <select id="filtroClubeB" name="filtroClubeB">
              <option value="Todos">Todos os Clubes</option>
            </select>
            <button type="button" class="btn-apply" onclick="aplicarFiltros()">
              <i class="fas fa-filter"></i> Aplicar Filtros
            </button>
          </div>
        </div>

        <div class="control-section" aria-labelledby="acoesTitle">
          <h3 id="acoesTitle"><i class="fas fa-cog"></i> Ações</h3>
          <div class="button-controls">
            <button type="button" class="btn-export" onclick="exportarCSV()">
              <i class="fas fa-file-csv"></i> Exportar CSV
            </button>
            <button type="button" class="btn-mode" onclick="toggleDarkMode()">
              <i class="fas fa-adjust"></i> Alternar Tema
            </button>
            <button type="button" class="btn-mode" onclick="atualizarDados()">
              <i class="fas fa-sync"></i> Atualizar Dados
            </button>
          </div>
        </div>

        <div class="control-section" aria-labelledby="fonteTitle">
          <h3 id="fonteTitle"><i class="fas fa-database"></i> Fonte de Dados</h3>
          <p>
            <a
              href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv"
              id="linkFonteDados"
              target="_blank" rel="noopener noreferrer"
            >Documento CSV do Google Sheets</a>
          </p>
        </div>
      </section>

      <section class="kpi-container" aria-label="Indicadores-chave">
        <div class="kpi positive" id="kpi-ftd">
          <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
          <h3>FTD</h3>
          <div class="valor">R$ 0,00</div>
          <div class="variacao" aria-live="polite">—</div>
        </div>
        <div class="kpi positive" id="kpi-depositos">
          <i class="fa-solid fa-coins" aria-hidden="true"></i>
          <h3>Depósitos</h3>
          <div class="valor">R$ 0,00</div>
          <div class="variacao" aria-live="polite">—</div>
        </div>
        <div class="kpi positive" id="kpi-ggr">
          <i class="fa-solid fa-chart-line" aria-hidden="true"></i>
          <h3>GGR</h3>
          <div class="valor">R$ 0,00</div>
          <div class="variacao" aria-live="polite">—</div>
        </div>
        <div class="kpi negative" id="kpi-sportsbook">
          <i class="fa-solid fa-futbol" aria-hidden="true"></i>
          <h3>Sportsbook GGR</h3>
          <div class="valor">R$ 0,00</div>
          <div class="variacao" aria-live="polite">—</div>
        </div>
        <div class="kpi positive" id="kpi-cassino">
          <i class="fa-solid fa-dice" aria-hidden="true"></i>
          <h3>Cassino GGR</h3>
          <div class="valor">R$ 0,00</div>
          <div class="variacao" aria-live="polite">—</div>
        </div>
        <div class="kpi negative" id="kpi-bonus">
          <i class="fa-solid fa-gift" aria-hidden="true"></i>
          <h3>Bônus Convertidos</h3>
          <div class="valor">R$ 0,00</div>
          <div class="variacao" aria-live="polite">—</div>
        </div>
      </section>

      <section class="charts" aria-label="Gráficos comparativos">
        <div class="chart-container">
          <h3><i class="fas fa-chart-bar" aria-hidden="true"></i> Visão Geral Comparativa</h3>
          <canvas id="chartComparativo"></canvas>
        </div>
        <div class="chart-container">
          <h3><i class="fas fa-chart-line" aria-hidden="true"></i> Evolução do GGR</h3>
          <canvas id="chartGGR"></canvas>
        </div>
        <div class="chart-container">
          <h3><i class="fas fa-money-bill-wave" aria-hidden="true"></i> Evolução de Depósitos</h3>
          <canvas id="chartDepositos"></canvas>
        </div>
        <div class="chart-container">
          <h3><i class="fas fa-user-plus" aria-hidden="true"></i> Evolução do FTD</h3>
          <canvas id="chartFTD"></canvas>
        </div>
        <div class="chart-container">
          <h3><i class="fas fa-futbol" aria-hidden="true"></i> Evolução do Sportsbook</h3>
          <canvas id="chartSportsbook"></canvas>
        </div>
        <div class="chart-container">
          <h3><i class="fas fa-dice" aria-hidden="true"></i> Evolução do Cassino</h3>
          <canvas id="chartCassino"></canvas>
        </div>
      </section>

      <section class="tables" aria-label="Tabelas de ranking">
        <div class="table-container">
          <h3><i class="fas fa-trophy" aria-hidden="true"></i> Top 10 Depósitos</h3>
          <table id="topDepositos">
            <thead>
              <tr><th>Clube</th><th>Valor</th><th>Variação</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="table-container">
          <h3><i class="fas fa-trophy" aria-hidden="true"></i> Top 10 FTD</h3>
          <table id="topFTD">
            <thead>
              <tr><th>Clube</th><th>Valor</th><th>Variação</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="table-container">
          <h3><i class="fas fa-trophy" aria-hidden="true"></i> Top 10 GGR</h3>
          <table id="topGGR">
            <thead>
              <tr><th>Clube</th><th>Valor</th><th>Variação</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer class="footer" role="contentinfo">
      <p>Última atualização: <span id="ultimaAtualizacao" aria-live="polite">—</span></p>
      <p>Dashboard desenvolvido para análise comparativa de clubes | Dados atualizados automaticamente</p>
    </footer>
  </div>

  <div id="loadingOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;justify-content:center;align-items:center;flex-direction:column;">
    <div class="spinner" style="width:80px;height:80px;border:8px solid rgba(52,152,219,0.2);border-top:8px solid var(--secondary);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px;"></div>
    <div id="loadingMessage" style="font-size:1.5rem;color:var(--light);font-weight:600;">Carregando dados...</div>
  </div>

  <script>
    // Puxar variáveis CSS
    const css = getComputedStyle(document.documentElement);
    const COR_LIGHT     = css.getPropertyValue('--light').trim();
    const COR_SECONDARY = css.getPropertyValue('--secondary').trim();
    const COR_GRAY      = css.getPropertyValue('--gray').trim();

    const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
    let dados = [], charts = {}, usandoDemo = false, valoresAnteriores = {};

    // Mesmo array de dadosDemo que você já tinha
    const dadosDemo = [
      /* ... seu array de fallback ... */
    ];

    function showLoading(on, msg="Carregando dados...") {
      $("#loadingMessage").text(msg);
      $("#loadingOverlay").css("display", on ? "flex" : "none");
    }

    function criarGrafico(ctx, labelA, labelB, colorA, colorB, type = 'line') {
      return new Chart(ctx, {
        type,
        data: {
          labels: [],
          datasets: [{
            label: labelA,
            data: [],
            borderColor: colorA,
            backgroundColor: type === 'bar' ? colorA + 'CC' : 'transparent',
            fill: type === 'line',
            tension: 0.3,
            borderWidth: 3,
            pointRadius: 4,
            pointBackgroundColor: colorA
          }, {
            label: labelB,
            data: [],
            borderColor: colorB,
            backgroundColor: type === 'bar' ? colorB + 'CC' : 'transparent',
            fill: type === 'line',
            tension: 0.3,
            borderWidth: 3,
            pointRadius: 4,
            pointBackgroundColor: colorB
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: COR_LIGHT,
                font: { size: 14 }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26,37,47,0.9)',
              titleColor: COR_SECONDARY,
              bodyColor: COR_LIGHT,
              displayColors: false,
              padding: 12,
              borderColor: 'rgba(255,255,255,0.1)',
              borderWidth: 1,
              callbacks: {
                label: ctx => `${ctx.dataset.label}: R$ ${ctx.parsed.y.toLocaleString('pt-BR',{minimumFractionDigits:2})}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: v => `R$ ${v.toLocaleString('pt-BR',{minimumFractionDigits:0})}`,
                color: COR_GRAY
              },
              grid: { color: 'rgba(255,255,255,0.05)' }
            },
            x: {
              ticks: { color: COR_GRAY },
              grid: { color: 'rgba(255,255,255,0.05)' }
            }
          }
        }
      });
    }

    function animarKPI(sel, novo, anterior) {
      let el = $(sel + " .valor"), varEl = $(sel + " .variacao");
      let variacao = anterior !== 0 ? ((novo - anterior) / anterior) * 100 : 0;
      varEl.html(
        variacao >= 0
          ? `<span style="color:${css.getPropertyValue('--success')}">↑${variacao.toFixed(1)}%</span>`
          : `<span style="color:${css.getPropertyValue('--accent')}">↓${Math.abs(variacao).toFixed(1)}%</span>`
      );
      $(sel).removeClass("positive negative").addClass(novo >= 0 ? "positive" : "negative");
      let ant = parseFloat(el.text().replace(/[^\d]/g, '')) || 0;
      let diff = (novo - ant) / 30, cur = ant, pass = 0;
      let h = setInterval(() => {
        cur += diff; pass++;
        if (pass >= 30) { clearInterval(h); cur = novo; }
        el.text("R$ " + cur.toLocaleString('pt-BR',{minimumFractionDigits:2}));
      }, 20);
      valoresAnteriores[sel] = novo;
    }

    function carregar() {
      showLoading(true, "Conectando à fonte de dados...");
      Papa.parse(URL_CSV, {
        download: true,
        header: true,
        complete: r => {
          if (r.data && r.data.length > 0 && r.data[0].DATA) {
            dados = r.data.filter(x => x.DATA);
            usandoDemo = false; $("#demoWarning").hide();
          } else {
            dados = dadosDemo; usandoDemo = true; $("#demoWarning").show();
          }
          init();
        },
        error: () => {
          dados = dadosDemo; usandoDemo = true; $("#demoWarning").show();
          init();
        }
      });
    }

    function init() {
      // Preenche selects
      let clubes = [...new Set(dados.map(d => d["Usuário - Nome de username"] || d["Usuário - Nome de usuário"]))];
      let opts = '<option value="Todos">Todos os Clubes</option>' +
                 clubes.map(c => `<option value="${c}">${c}</option>`).join('');
      $("#filtroClubeA,#filtroClubeB").html(opts).val("Todos");

      // Datas padrão últimos 7 dias
      let hoje = new Date(), ini = new Date(); ini.setDate(hoje.getDate() - 7);
      $("#filtroInicio").val(ini.toISOString().slice(0,10));
      $("#filtroFim").val(hoje.toISOString().slice(0,10));

      // Cria gráficos
      charts.chartComparativo = criarGrafico($("#chartComparativo")[0], "A", "B", "#3498db", "#e74c3c", "bar");
      charts.chartGGR        = criarGrafico($("#chartGGR")[0], "A", "B", "#3498db", "#e74c3c");
      charts.chartDepositos  = criarGrafico($("#chartDepositos")[0], "A", "B", "#3498db", "#e74c3c");
      charts.chartFTD        = criarGrafico($("#chartFTD")[0], "A", "B", "#3498db", "#e74c3c");
      charts.chartSportsbook = criarGrafico($("#chartSportsbook")[0], "A", "B", "#3498db", "#e74c3c");
      charts.chartCassino    = criarGrafico($("#chartCassino")[0], "A", "B", "#3498db", "#e74c3c");

      // KPIs iniciais
      ['#kpi-ftd','#kpi-depositos','#kpi-ggr','#kpi-sportsbook','#kpi-cassino','#kpi-bonus']
        .forEach(k => valoresAnteriores[k] = 0);

      atualizar();
      showLoading(false);
      setInterval(atualizarDados, 300000);
    }

    function aplicarFiltros() { atualizar(); }
    function setPeriodo(d) {
      let hoje = new Date(), ini = new Date(); ini.setDate(hoje.getDate() - d);
      $("#filtroInicio").val(ini.toISOString().slice(0,10));
      $("#filtroFim").val(hoje.toISOString().slice(0,10));
      atualizar();
    }
    function atualizarDados() { showLoading(true, "Atualizando dados..."); carregar(); }

    function atualizar() {
      let ini = $("#filtroInicio").val(), fim = $("#filtroFim").val();
      let ca = $("#filtroClubeA").val(), cb = $("#filtroClubeB").val();
      let base = dados.filter(x => (!ini||x.DATA>=ini) && (!fim||x.DATA<=fim));
      let filtra = c => c==="Todos"?base: base.filter(x => (x["Usuário - Nome de username"]||x["Usuário - Nome de usuário"])===c);
      let A = filtra(ca), B = filtra(cb);
      let soma = (arr,field) => arr.reduce((s,d)=>s+(parseFloat(d[field])||0),0);

      animarKPI("#kpi-ftd", soma(A,"Usuário - FTD-Montante")+soma(B,"Usuário - FTD-Montante"), valoresAnteriores["#kpi-ftd"]);
      animarKPI("#kpi-depositos", soma(A,"Usuário - Depósitos")+soma(B,"Usuário - Depósitos"), valoresAnteriores["#kpi-depositos"]);
      animarKPI("#kpi-ggr", soma(A,"Cálculo - GGR")+soma(B,"Cálculo - GGR"), valoresAnteriores["#kpi-ggr"]);
      animarKPI("#kpi-sportsbook", soma(A,"Sportsbook - GGR")+soma(B,"Sportsbook - GGR"), valoresAnteriores["#kpi-sportsbook"]);
      animarKPI("#kpi-cassino", soma(A,"Cassino - GGR")+soma(B,"Cassino - GGR"), valoresAnteriores["#kpi-c
