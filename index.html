<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Clubes</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 0; }
        h1 { text-align: center; color: #00ff00; margin: 10px 0; }
        .filters { text-align: center; margin-bottom: 10px; }
        .cards { display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; margin-bottom: 10px; }
        .card { border: 2px solid #00ff00; border-radius: 8px; padding: 8px 20px; box-shadow: 0 0 10px #00ff00; text-align: center; min-width: 150px; }
        .card h2 { font-size: 16px; margin: 0 0 5px; color: #00ff00; }
        .card p { font-size: 18px; font-weight: bold; color: #fff; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 10px; }
        .chart-box, .table-box { border: 1px solid #00ff00; border-radius: 8px; padding: 10px; background: #111; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; color: #fff; font-size: 12px; }
        th, td { border: 1px solid #00ff00; padding: 4px; text-align: left; }
        th { background: #00ff00; color: #000; text-align: center; }
        .footer { text-align: right; font-size: 12px; color: #00ff00; margin: 5px 15px; }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <h1>Dashboard de Clubes</h1>
    <div class="filters">
        Data: <input type="date" id="filter-date"> 
        Clube: <select id="filter-club"><option value="Todos">Todos</option></select>
        <button onclick="applyFilters()">Aplicar</button>
    </div>

    <div class="cards">
        <div class="card"><h2>FTD</h2><p id="ftd-value">R$ 0,00</p></div>
        <div class="card"><h2>Depósitos</h2><p id="depositos-value">R$ 0,00</p></div>
        <div class="card"><h2>GGR</h2><p id="ggr-value">R$ 0,00</p></div>
        <div class="card"><h2>Sportsbook GGR</h2><p id="sportsbook-ggr-value">R$ 0,00</p></div>
        <div class="card"><h2>Cassino GGR</h2><p id="cassino-ggr-value">R$ 0,00</p></div>
    </div>

    <div class="grid">
        <div class="chart-box"><canvas id="chartGGR"></canvas></div>
        <div class="chart-box"><canvas id="chartDepositos"></canvas></div>
        <div class="chart-box"><canvas id="chartFTD"></canvas></div>
        <div class="chart-box"><canvas id="chartSportsbook"></canvas></div>
        <div class="chart-box"><canvas id="chartCassino"></canvas></div>
        <div class="table-box" id="top10-tables"></div>
    </div>

    <div class="footer" id="footer-update"></div>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
        let allData = [];

        const charts = {};
        const ctxs = {
            GGR: document.getElementById('chartGGR').getContext('2d'),
            Depositos: document.getElementById('chartDepositos').getContext('2d'),
            FTD: document.getElementById('chartFTD').getContext('2d'),
            Sportsbook: document.getElementById('chartSportsbook').getContext('2d'),
            Cassino: document.getElementById('chartCassino').getContext('2d')
        };

        async function loadCSV() {
            return new Promise((resolve, reject) => {
                Papa.parse(SHEET_CSV_URL, {
                    download: true,
                    header: true,
                    complete: (results) => resolve(results.data),
                    error: (error) => reject(error)
                });
            });
        }

        async function init() {
            try {
                allData = await loadCSV();
                populateClubFilter();
                updateDashboard(allData);
                document.getElementById('footer-update').innerText = "Última atualização: " + new Date().toLocaleString();
            } catch (e) {
                alert("Erro ao carregar dados: " + e.message);
            }
        }

        function populateClubFilter() {
            const select = document.getElementById('filter-club');
            const clubes = [...new Set(allData.map(r => r["Usuário - Nome de usuário"]))];
            clubes.forEach(clube => {
                let opt = document.createElement("option");
                opt.value = clube;
                opt.innerText = clube;
                select.appendChild(opt);
            });
        }

        function applyFilters() {
            const date = document.getElementById('filter-date').value;
            const clube = document.getElementById('filter-club').value;
            let filtered = allData;
            if (date) filtered = filtered.filter(r => r["DATA"] === date);
            if (clube !== "Todos") filtered = filtered.filter(r => r["Usuário - Nome de usuário"] === clube);
            updateDashboard(filtered);
        }

        function updateDashboard(data) {
            const sum = (key) => data.reduce((a, b) => a + (parseFloat(b[key].replace(',', '.')) || 0), 0);
            document.getElementById('ftd-value').innerText = formatCurrency(sum("Usuário - FTD-Montante"));
            document.getElementById('depositos-value').innerText = formatCurrency(sum("Usuário - Depósitos"));
            document.getElementById('ggr-value').innerText = formatCurrency(sum("Cálculo - GGR"));
            document.getElementById('sportsbook-ggr-value').innerText = formatCurrency(sum("Sportsbook - GGR"));
            document.getElementById('cassino-ggr-value').innerText = formatCurrency(sum("Cassino - GGR"));
            buildCharts(data);
            buildTop10(data);
        }

        function buildCharts(data) {
            const labels = [...new Set(data.map(d => d["DATA"]))].sort();
            const datasetBuilder = (key, color) => ({
                label: key,
                data: labels.map(date => {
                    return data.filter(d => d["DATA"] === date)
                               .reduce((sum, d) => sum + (parseFloat(d[key].replace(',', '.')) || 0), 0);
                }),
                borderColor: color,
                backgroundColor: color,
                fill: false,
                tension: 0.3
            });

            createOrUpdateChart('GGR', labels, [datasetBuilder("Cálculo - GGR", '#00ff00')]);
            createOrUpdateChart('Depositos', labels, [datasetBuilder("Usuário - Depósitos", '#0000ff')]);
            createOrUpdateChart('FTD', labels, [datasetBuilder("Usuário - FTD-Montante", '#ffff00')]);
            createOrUpdateChart('Sportsbook', labels, [datasetBuilder("Sportsbook - GGR", '#ff8000')]);
            createOrUpdateChart('Cassino', labels, [datasetBuilder("Cassino - GGR", '#ff00ff')]);
        }

        function createOrUpdateChart(name, labels, datasets) {
            if (charts[name]) {
                charts[name].data.labels = labels;
                charts[name].data.datasets = datasets;
                charts[name].update();
            } else {
                charts[name] = new Chart(ctxs[name], {
                    type: 'line',
                    data: { labels, datasets },
                    options: { responsive: true, animation: { duration: 800 } }
                });
            }
        }

        function buildTop10(data) {
            const metrics = [
                { key: "Usuário - Depósitos", label: "Top 10 Depósitos" },
                { key: "Usuário - FTD-Montante", label: "Top 10 FTD" },
                { key: "Cálculo - GGR", label: "Top 10 GGR" },
                { key: "Sportsbook - GGR", label: "Top 10 Sportsbook GGR" },
                { key: "Cassino - GGR", label: "Top 10 Cassino GGR" }
            ];
            const container = document.getElementById('top10-tables');
            container.innerHTML = '<div style="display:flex; gap:10px; justify-content:space-between;">' +
                metrics.map(m => buildSingleTable(data, m.key, m.label)).join('') + '</div>';
        }

        function buildSingleTable(data, key, label) {
            const aggregated = {};
            data.forEach(r => {
                const user = r["Usuário - Nome de usuário"] || "Sem Clube";
                aggregated[user] = (aggregated[user] || 0) + (parseFloat(r[key].replace(',', '.')) || 0);
            });
            const sorted = Object.entries(aggregated).sort((a,b) => b[1]-a[1]).slice(0,10);
            return `
                <table class="fade-in">
                    <thead><tr><th colspan="2">${label}</th></tr></thead>
                    <tbody>
                        ${sorted.map(([clube, valor]) => `<tr><td>${clube}</td><td>${formatCurrency(valor)}</td></tr>`).join('')}
                    </tbody>
                </table>
            `;
        }

        function formatCurrency(val) {
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        init();
    </script>
</body>
</html>
