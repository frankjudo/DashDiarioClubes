<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Clubes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        header { background: #fff; padding: 10px; text-align: center; font-size: 22px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .filtros { text-align: center; margin: 10px; }
        .kpis { display: flex; justify-content: space-around; flex-wrap: wrap; margin: 10px; }
        .kpi { background: #fff; padding: 15px; width: 150px; text-align: center; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: background-color 0.5s; cursor: pointer; }
        .kpi.positivo { background-color: #e0ffe0; }
        .kpi.negativo { background-color: #ffe0e0; }
        .graficos, .tabelas { display: grid; gap: 10px; margin: 10px; }
        .graficos { grid-template-columns: repeat(3, 1fr); }
        .tabelas { grid-template-columns: repeat(3, 1fr); }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 5px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { padding: 5px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #eee; }
        footer { text-align: right; font-size: 12px; padding: 10px; }
        canvas { background: #fff; border-radius: 5px; padding: 10px; }
        .export-btn { padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <header>Dashboard de Clubes</header>
    <div class="filtros">
        Data: <input type="date" id="filtroData"> 
        Clube: <select id="filtroClube"><option value="Todos">Todos</option></select>
        <button id="aplicarFiltro">Aplicar</button>
        <button class="export-btn" id="exportarCSV">Exportar CSV</button>
    </div>
    <div class="kpis">
        <div class="kpi" id="kpi-ftd" title="First Time Deposits"><i class="fas fa-user-plus"></i><div id="valor-ftd">R$ 0,00</div><div>FTD</div></div>
        <div class="kpi" id="kpi-depositos" title="Depósitos Totais"><i class="fas fa-coins"></i><div id="valor-depositos">R$ 0,00</div><div>Depósitos</div></div>
        <div class="kpi" id="kpi-ggr" title="Gross Gaming Revenue"><i class="fas fa-chart-line"></i><div id="valor-ggr">R$ 0,00</div><div>GGR</div></div>
        <div class="kpi" id="kpi-sportsbook" title="Sportsbook GGR"><i class="fas fa-football-ball"></i><div id="valor-sportsbook">R$ 0,00</div><div>Sportsbook GGR</div></div>
        <div class="kpi" id="kpi-cassino" title="Cassino GGR"><i class="fas fa-dice"></i><div id="valor-cassino">R$ 0,00</div><div>Cassino GGR</div></div>
        <div class="kpi" id="kpi-bonus" title="Bônus Convertidos"><i class="fas fa-gift"></i><div id="valor-bonus">R$ 0,00</div><div>Bônus Convertidos</div></div>
    </div>
    <div class="graficos">
        <canvas id="grafico-ggr"></canvas>
        <canvas id="grafico-depositos"></canvas>
        <canvas id="grafico-ftd"></canvas>
        <canvas id="grafico-sportsbook"></canvas>
        <canvas id="grafico-cassino"></canvas>
        <canvas id="grafico-bonus"></canvas>
    </div>
    <div class="tabelas">
        <table id="top-depositos"><thead><tr><th>Top 10 Depósitos</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="top-ftd"><thead><tr><th>Top 10 FTD</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="top-ggr"><thead><tr><th>Top 10 GGR</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="top-sportsbook"><thead><tr><th>Top 10 Sportsbook</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="top-cassino"><thead><tr><th>Top 10 Cassino</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="top-bonus"><thead><tr><th>Top 10 Bônus Convertidos</th><th>Valor</th></tr></thead><tbody></tbody></table>
    </div>
    <footer>Última atualização: <span id="ultimaAtualizacao"></span></footer>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
let dadosOriginais = [];
let graficos = {};

$(document).ready(function(){
    carregarDados();
    $("#aplicarFiltro").on("click", aplicarFiltro);
    $("#exportarCSV").on("click", exportarCSV);
});

function carregarDados(){
    Papa.parse(sheetUrl, {
        download: true,
        header: true,
        complete: function(results) {
            dadosOriginais = results.data.filter(r => r["DATA"]);
            console.log("Primeiras linhas CSV:", dadosOriginais.slice(0,5));
            preencherFiltroClubes();
            atualizarDashboard(dadosOriginais);
        }
    });
}

function preencherFiltroClubes(){
    let clubes = [...new Set(dadosOriginais.map(r => r["Usuário - Nome de usuário"]))];
    clubes.forEach(c => $("#filtroClube").append(`<option value="${c}">${c}</option>`));
}

function aplicarFiltro(){
    let data = $("#filtroData").val();
    let clube = $("#filtroClube").val();
    let filtrados = dadosOriginais;
    if(data) filtrados = filtrados.filter(r => r["DATA"] === data);
    if(clube !== "Todos") filtrados = filtrados.filter(r => r["Usuário - Nome de usuário"] === clube);
    atualizarDashboard(filtrados);
}

function atualizarDashboard(dados){
    $("#ultimaAtualizacao").text(new Date().toLocaleString());

    atualizarKPI("#valor-ftd", somar(dados,"Usuário - FTD-Montante"));
    atualizarKPI("#valor-depositos", somar(dados,"Usuário - Depósitos"));
    atualizarKPI("#valor-sportsbook", somar(dados,"Sportsbook - GGR"));
    atualizarKPI("#valor-cassino", somar(dados,"Cassino - GGR"));
    atualizarKPI("#valor-bonus", somar(dados,"Cálculo - bônus convertidos"));
    atualizarKPI("#valor-ggr", somar(dados,"Cálculo - GGR"));

    atualizarGraficos(dados);
    atualizarTop10(dados);
}

function somar(dados,campo){ return dados.reduce((acc,r) => acc + (parseFloat(r[campo]) || 0),0); }

function atualizarKPI(selector, valor){
    let antigo = parseFloat($(selector).data("valor")) || 0;
    $(selector).data("valor", valor);
    let diferenca = valor - antigo;
    let classe = diferenca > 0 ? "positivo" : diferenca < 0 ? "negativo" : "";
    $(selector).parent().removeClass("positivo negativo").addClass(classe);
    $({n:antigo}).animate({n:valor},{
        duration: 1000,
        step: function(now){ $(selector).text(now.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})); }
    });
}

function atualizarGraficos(dados){
    criarGrafico("grafico-ggr", dados, "Cálculo - GGR", "Cálculo - GGR","#28a745");
    criarGrafico("grafico-depositos", dados, "Usuário - Depósitos", "Usuário - Depósitos","#ff9800");
    criarGrafico("grafico-ftd", dados, "Usuário - FTD-Montante", "Usuário - FTD-Montante","#ffc107");
    criarGrafico("grafico-sportsbook", dados, "Sportsbook - GGR", "Sportsbook - GGR","#9c27b0");
    criarGrafico("grafico-cassino", dados, "Cassino - GGR", "Cassino - GGR","#f44336");
    criarGrafico("grafico-bonus", dados, "Cálculo - bônus convertidos", "Cálculo - bônus convertidos","#009688");
}

function criarGrafico(id, dados, campo, label, cor){
    let porData = {};
    dados.forEach(r => {
        let d = r["DATA"];
        porData[d] = (porData[d]||0)+(parseFloat(r[campo])||0);
    });
    let labels = Object.keys(porData);
    let valores = Object.values(porData);
    if(graficos[id]) graficos[id].destroy();
    graficos[id] = new Chart(document.getElementById(id),{
        type:'line',
        data:{labels:labels,datasets:[{label:label,data:valores,borderColor:cor,fill:false}]},
        options:{responsive:true,plugins:{legend:{display:true}}}
    });
}

function atualizarTop10(dados){
    preencherTabela(dados,"Usuário - Depósitos","#top-depositos tbody");
    preencherTabela(dados,"Usuário - FTD-Montante","#top-ftd tbody");
    preencherTabela(dados,"Cálculo - GGR","#top-ggr tbody");
    preencherTabela(dados,"Sportsbook - GGR","#top-sportsbook tbody");
    preencherTabela(dados,"Cassino - GGR","#top-cassino tbody");
    preencherTabela(dados,"Cálculo - bônus convertidos","#top-bonus tbody");
}

function preencherTabela(dados,campo,selector){
    let mapa = {};
    dados.forEach(r => {
        let clube = r["Usuário - Nome de usuário"];
        mapa[clube] = (mapa[clube]||0)+(parseFloat(r[campo])||0);
    });
    let top = Object.entries(mapa).sort((a,b)=>b[1]-a[1]).slice(0,10);
    $(selector).empty();
    top.forEach(([clube,valor])=>{
        $(selector).append(`<tr><td>${clube}</td><td>${valor.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td></tr>`);
    });
}

function exportarCSV(){
    let csv = Papa.unparse(dadosOriginais);
    let blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download","dados_filtrados.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
</body>
</html>
