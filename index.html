<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Clubes</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { background: #000; color: lime; font-family: Arial, sans-serif; text-align: center; }
        h1 { margin: 10px 0; }
        .filters { margin-bottom: 15px; }
        .cards { display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .card { padding: 15px; border: 2px solid lime; border-radius: 8px; width: 180px; background: #111; box-shadow: 0 0 10px lime; }
        .charts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 0 20px; }
        .chart-box { border: 2px solid lime; background: #111; box-shadow: 0 0 8px lime; padding: 8px; border-radius: 6px; }
        .tables { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        table, th, td { border: 1px solid lime; }
        th, td { padding: 4px; text-align: center; }
        .footer { font-size: 12px; margin-top: 10px; color: lime; }
    </style>
</head>
<body>
    <h1>Dashboard de Clubes</h1>
    <div class="filters">
        Data: <input type="date" id="filtroData">
        Clube: <select id="filtroClube"></select>
        <button onclick="aplicarFiltro()">Aplicar</button>
    </div>

    <div class="cards">
        <div class="card"><h3>FTD</h3><p id="ftdValor">R$ 0,00</p></div>
        <div class="card"><h3>Depósitos</h3><p id="depositosValor">R$ 0,00</p></div>
        <div class="card"><h3>GGR</h3><p id="ggrValor">R$ 0,00</p></div>
        <div class="card"><h3>Sportsbook GGR</h3><p id="sportsValor">R$ 0,00</p></div>
        <div class="card"><h3>Cassino GGR</h3><p id="cassinoValor">R$ 0,00</p></div>
    </div>

    <div class="charts">
        <div class="chart-box"><canvas id="chartGGR"></canvas></div>
        <div class="chart-box"><canvas id="chartDepositos"></canvas></div>
        <div class="chart-box"><canvas id="chartFTD"></canvas></div>
        <div class="chart-box"><canvas id="chartSports"></canvas></div>
        <div class="chart-box"><canvas id="chartCassino"></canvas></div>
    </div>

    <div class="tables">
        <div><h3>Top 10 - GGR</h3><table id="topGGR"></table></div>
        <div><h3>Top 10 - Depósitos</h3><table id="topDepositos"></table></div>
        <div><h3>Top 10 - FTD</h3><table id="topFTD"></table></div>
        <div><h3>Top 10 - Sportsbook</h3><table id="topSports"></table></div>
        <div><h3>Top 10 - Cassino</h3><table id="topCassino"></table></div>
    </div>

    <div class="footer">Última atualização: <span id="ultimaAtualizacao"></span></div>

<script>
const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
let dadosCSV = [], chartGGR, chartDepositos, chartFTD, chartSports, chartCassino;

document.addEventListener("DOMContentLoaded", carregarDados);

function carregarDados() {
    console.log("Carregando CSV...");
    Papa.parse(urlCSV, {
        download: true,
        header: true,
        complete: function(result) {
            dadosCSV = result.data.filter(r => r["DATA"]);
            console.log("Linhas carregadas:", dadosCSV.length);
            preencherClubes();
            aplicarFiltro();
        },
        error: function(err) { console.error("Erro ao carregar CSV", err); }
    });
}

function preencherClubes() {
    const clubes = [...new Set(dadosCSV.map(r => r["Usuário - Nome de usuário"]))];
    const select = document.getElementById("filtroClube");
    select.innerHTML = `<option value="">Todos</option>`;
    clubes.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
}

function aplicarFiltro() {
    const dataFiltro = document.getElementById("filtroData").value;
    const clubeFiltro = document.getElementById("filtroClube").value;

    let filtrados = dadosCSV.filter(linha => {
        return (!dataFiltro || linha["DATA"] === dataFiltro) && (!clubeFiltro || linha["Usuário - Nome de usuário"] === clubeFiltro);
    });

    console.log("Filtro aplicado:", { dataFiltro, clubeFiltro });
    console.log("Registros filtrados:", filtrados.length);

    atualizarDashboard(filtrados);
}

function atualizarDashboard(dados) {
    const ftd = soma(dados, "Usuário - FTD-Montante");
    const depositos = soma(dados, "Usuário - Depósitos");
    const sportsbook = soma(dados, "Sportsbook - GGR");
    const cassino = soma(dados, "Cassino - GGR");
    const ggr = sportsbook + cassino;

    document.getElementById("ftdValor").innerText = formatar(ftd);
    document.getElementById("depositosValor").innerText = formatar(depositos);
    document.getElementById("ggrValor").innerText = formatar(ggr);
    document.getElementById("sportsValor").innerText = formatar(sportsbook);
    document.getElementById("cassinoValor").innerText = formatar(cassino);

    montarGraficos(dados);
    montarTop10(dados);

    document.getElementById("ultimaAtualizacao").innerText = new Date().toLocaleString();
}

function soma(dados, campo) {
    return dados.reduce((acc, item) => acc + parseFloat(item[campo] || 0), 0);
}

function formatar(valor) {
    return valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

function montarGraficos(dados) {
    const porData = {};
    dados.forEach(l => {
        if (!porData[l.DATA]) porData[l.DATA] = { ftd:0, depositos:0, sportsbook:0, cassino:0 };
        porData[l.DATA].ftd += parseFloat(l["Usuário - FTD-Montante"]||0);
        porData[l.DATA].depositos += parseFloat(l["Usuário - Depósitos"]||0);
        porData[l.DATA].sportsbook += parseFloat(l["Sportsbook - GGR"]||0);
        porData[l.DATA].cassino += parseFloat(l["Cassino - GGR"]||0);
    });
    const labels = Object.keys(porData);
    const ftdData = labels.map(d => porData[d].ftd);
    const depData = labels.map(d => porData[d].depositos);
    const sportsData = labels.map(d => porData[d].sportsbook);
    const cassinoData = labels.map(d => porData[d].cassino);
    const ggrData = labels.map((d,i)=> sportsData[i]+cassinoData[i]);

    renderChart("chartGGR", "GGR", labels, ggrData, "lime", chartGGR);
    renderChart("chartDepositos", "Depósitos", labels, depData, "blue", chartDepositos);
    renderChart("chartFTD", "FTD", labels, ftdData, "yellow", chartFTD);
    renderChart("chartSports", "Sportsbook GGR", labels, sportsData, "orange", chartSports);
    renderChart("chartCassino", "Cassino GGR", labels, cassinoData, "purple", chartCassino);
}

function renderChart(id, label, labels, data, color, oldChart) {
    if (oldChart) oldChart.destroy();
    const ctx = document.getElementById(id).getContext("2d");
    return new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label, data, borderColor: color, fill:false }] },
        options: { responsive: true, plugins: { legend:{labels:{color:"lime"}} }, scales:{x:{ticks:{color:"lime"}},y:{ticks:{color:"lime"}}}}
    });
}

function montarTop10(dados) {
    const top = (campo) => {
        const clubes = {};
        dados.forEach(l => {
            const clube = l["Usuário - Nome de usuário"] || "Sem Clube";
            clubes[clube] = (clubes[clube]||0) + parseFloat(l[campo]||0);
        });
        return Object.entries(clubes).sort((a,b)=>b[1]-a[1]).slice(0,10);
    };

    preencherTabela("topGGR", top("Sportsbook - GGR").map(([c,v])=>[c, formatar(v)]));
    preencherTabela("topDepositos", top("Usuário - Depósitos").map(([c,v])=>[c, formatar(v)]));
    preencherTabela("topFTD", top("Usuário - FTD-Montante").map(([c,v])=>[c, formatar(v)]));
    preencherTabela("topSports", top("Sportsbook - GGR").map(([c,v])=>[c, formatar(v)]));
    preencherTabela("topCassino", top("Cassino - GGR").map(([c,v])=>[c, formatar(v)]));
}

function preencherTabela(id, linhas) {
    const tabela = document.getElementById(id);
    tabela.innerHTML = "<tr><th>Clube</th><th>Valor</th></tr>";
    linhas.forEach(l => tabela.innerHTML += `<tr><td>${l[0]}</td><td>${l[1]}</td></tr>`);
}
</script>
</body>
</html>
