<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Comparativo de Clubes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(90deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: white;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        
        .date-controls, .club-controls, .button-controls {
            margin-bottom: 15px;
        }
        
        .controls label {
            font-weight: 600;
            margin-right: 5px;
            color: #2c3e50;
        }
        
        .controls input, .controls select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            margin: 0 5px 10px;
            transition: all 0.3s;
            outline: none;
        }
        
        .controls input:focus, .controls select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 5px 10px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-period {
            background: #3498db;
            color: white;
        }
        
        .btn-period:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-apply {
            background: #2ecc71;
            color: white;
        }
        
        .btn-apply:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }
        
        .btn-export {
            background: #9b59b6;
            color: white;
        }
        
        .btn-export:hover {
            background: #8e44ad;
            transform: translateY(-2px);
        }
        
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            border-left: 4px solid;
        }
        
        .kpi:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .kpi.positive {
            border-left-color: #2ecc71;
        }
        
        .kpi.negative {
            border-left-color: #e74c3c;
        }
        
        .kpi i {
            font-size: 36px;
            margin-bottom: 15px;
            display: block;
        }
        
        .kpi h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #7f8c8d;
        }
        
        .kpi .valor {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            height: 300px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        
        .chart-container h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .tables {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        
        .table-container h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        
        th {
            background: #3498db;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
        }
        
        th:first-child {
            border-top-left-radius: 6px;
        }
        
        th:last-child {
            border-top-right-radius: 6px;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #f1f8ff;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 0.9rem;
            color: #7f8c8d;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        
        /* Spinner overlay */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        #loadingMessage {
            font-size: 1.2rem;
            color: #2c3e50;
            font-weight: 600;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .controls {
                padding: 15px;
            }
            
            .controls input, .controls select, .controls button {
                width: 100%;
                margin: 5px 0;
            }
            
            .charts, .tables {
                grid-template-columns: 1fr;
            }
            
            .kpi {
                padding: 15px;
            }
            
            .kpi .valor {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> Dashboard Comparativo de Clubes</h1>
            <p>Analise e compare o desempenho de diferentes clubes</p>
        </header>

        <div class="controls">
            <div class="date-controls">
                <label for="filtroInicio">Período:</label>
                <input type="date" id="filtroInicio">
                <span>até</span>
                <input type="date" id="filtroFim">
                
                <button class="btn-period" onclick="setPeriodo(1)"><i class="fas fa-calendar-day"></i> Ontem</button>
                <button class="btn-period" onclick="setPeriodo(7)"><i class="fas fa-calendar-week"></i> Últimos 7 dias</button>
                <button class="btn-period" onclick="setPeriodo(30)"><i class="fas fa-calendar-alt"></i> Últimos 30 dias</button>
            </div>
            
            <div class="club-controls">
                <label for="filtroClubeA">Clube A:</label>
                <select id="filtroClubeA"></select>
                
                <label for="filtroClubeB">Clube B:</label>
                <select id="filtroClubeB"></select>
                
                <button class="btn-apply" onclick="aplicarFiltros()"><i class="fas fa-filter"></i> Aplicar Filtros</button>
            </div>
            
            <div class="button-controls">
                <button class="btn-export" onclick="exportarCSV()"><i class="fas fa-file-csv"></i> Exportar CSV</button>
            </div>
        </div>

        <div class="kpi-container">
            <div class="kpi positive" id="kpi-ftd">
                <i class="fa-solid fa-user-plus" style="color:#2ecc71"></i>
                <h3>FTD</h3>
                <div class="valor">R$ 0</div>
            </div>
            <div class="kpi positive" id="kpi-depositos">
                <i class="fa-solid fa-coins" style="color:#f39c12"></i>
                <h3>Depósitos</h3>
                <div class="valor">R$ 0</div>
            </div>
            <div class="kpi positive" id="kpi-ggr">
                <i class="fa-solid fa-chart-line" style="color:#3498db"></i>
                <h3>GGR</h3>
                <div class="valor">R$ 0</div>
            </div>
            <div class="kpi positive" id="kpi-sportsbook">
                <i class="fa-solid fa-futbol" style="color:#9b59b6"></i>
                <h3>Sportsbook GGR</h3>
                <div class="valor">R$ 0</div>
            </div>
            <div class="kpi positive" id="kpi-cassino">
                <i class="fa-solid fa-dice" style="color:#e74c3c"></i>
                <h3>Cassino GGR</h3>
                <div class="valor">R$ 0</div>
            </div>
            <div class="kpi positive" id="kpi-bonus">
                <i class="fa-solid fa-gift" style="color:#2ecc71"></i>
                <h3>Bônus Convertidos</h3>
                <div class="valor">R$ 0</div>
            </div>
        </div>

        <div class="charts">
            <div class="chart-container">
                <h3>Evolução do GGR</h3>
                <canvas id="chartGGR"></canvas>
            </div>
            <div class="chart-container">
                <h3>Evolução de Depósitos</h3>
                <canvas id="chartDepositos"></canvas>
            </div>
            <div class="chart-container">
                <h3>Evolução do FTD</h3>
                <canvas id="chartFTD"></canvas>
            </div>
            <div class="chart-container">
                <h3>Evolução do Sportsbook</h3>
                <canvas id="chartSportsbook"></canvas>
            </div>
            <div class="chart-container">
                <h3>Evolução do Cassino</h3>
                <canvas id="chartCassino"></canvas>
            </div>
            <div class="chart-container">
                <h3>Evolução de Bônus</h3>
                <canvas id="chartBonus"></canvas>
            </div>
        </div>

        <div class="tables">
            <div class="table-container">
                <h3>Top 10 Depósitos</h3>
                <table id="topDepositos">
                    <thead>
                        <tr>
                            <th>Clube</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="2">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="table-container">
                <h3>Top 10 FTD</h3>
                <table id="topFTD">
                    <thead>
                        <tr>
                            <th>Clube</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="2">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="table-container">
                <h3>Top 10 GGR</h3>
                <table id="topGGR">
                    <thead>
                        <tr>
                            <th>Clube</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="2">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="footer">
            <p>Última atualização: <span id="ultimaAtualizacao"></span></p>
            <p>Dashboard desenvolvido para análise comparativa de clubes</p>
        </div>
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingMessage">Carregando dados...</div>
    </div>

<script>
// Configurações
const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
const DADOS_DEMONSTRACAO = [
    {"DATA": "2023-10-01", "Usuário - Nome de usuário": "Clube A", "Usuário - FTD-Montante": "1500", "Usuário - Depósitos": "5000", "Cálculo - GGR": "1200", "Sportsbook - GGR": "700", "Cassino - GGR": "500", "Cálculo - bônus convertidos": "300"},
    {"DATA": "2023-10-02", "Usuário - Nome de usuário": "Clube A", "Usuário - FTD-Montante": "1800", "Usuário - Depósitos": "5500", "Cálculo - GGR": "1400", "Sportsbook - GGR": "800", "Cassino - GGR": "600", "Cálculo - bônus convertidos": "350"},
    {"DATA": "2023-10-03", "Usuário - Nome de usuário": "Clube A", "Usuário - FTD-Montante": "2000", "Usuário - Depósitos": "6000", "Cálculo - GGR": "1600", "Sportsbook - GGR": "900", "Cassino - GGR": "700", "Cálculo - bônus convertidos": "400"},
    {"DATA": "2023-10-01", "Usuário - Nome de usuário": "Clube B", "Usuário - FTD-Montante": "1000", "Usuário - Depósitos": "3500", "Cálculo - GGR": "900", "Sportsbook - GGR": "500", "Cassino - GGR": "400", "Cálculo - bônus convertidos": "200"},
    {"DATA": "2023-10-02", "Usuário - Nome de usuário": "Clube B", "Usuário - FTD-Montante": "1200", "Usuário - Depósitos": "4000", "Cálculo - GGR": "1100", "Sportsbook - GGR": "600", "Cassino - GGR": "500", "Cálculo - bônus convertidos": "250"},
    {"DATA": "2023-10-03", "Usuário - Nome de usuário": "Clube B", "Usuário - FTD-Montante": "1400", "Usuário - Depósitos": "4500", "Cálculo - GGR": "1300", "Sportsbook - GGR": "700", "Cassino - GGR": "600", "Cálculo - bônus convertidos": "300"},
    {"DATA": "2023-10-01", "Usuário - Nome de usuário": "Clube C", "Usuário - FTD-Montante": "800", "Usuário - Depósitos": "2500", "Cálculo - GGR": "700", "Sportsbook - GGR": "400", "Cassino - GGR": "300", "Cálculo - bônus convertidos": "150"},
    {"DATA": "2023-10-02", "Usuário - Nome de usuário": "Clube C", "Usuário - FTD-Montante": "900", "Usuário - Depósitos": "3000", "Cálculo - GGR": "800", "Sportsbook - GGR": "450", "Cassino - GGR": "350", "Cálculo - bônus convertidos": "180"},
    {"DATA": "2023-10-03", "Usuário - Nome de usuário": "Clube C", "Usuário - FTD-Montante": "1100", "Usuário - Depósitos": "3500", "Cálculo - GGR": "1000", "Sportsbook - GGR": "550", "Cassino - GGR": "450", "Cálculo - bônus convertidos": "220"},
];

let dadosFiltrados = [];
let charts = {};
let usandoDadosDemonstracao = false;

function showLoading(show, message = "Carregando dados...") {
    $("#loadingMessage").text(message);
    $("#loadingOverlay").css("display", show ? "flex" : "none");
}

function criarGrafico(ctx, labelA, labelB, colorA, colorB) {
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: labelA,
                    data: [],
                    borderColor: colorA,
                    backgroundColor: colorA + '33',
                    borderWidth: 3,
                    pointRadius: 5,
                    pointBackgroundColor: colorA,
                    fill: false,
                    tension: 0.3
                },
                {
                    label: labelB,
                    data: [],
                    borderColor: colorB,
                    backgroundColor: colorB + '33',
                    borderWidth: 3,
                    pointRadius: 5,
                    pointBackgroundColor: colorB,
                    fill: false,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    enabled: true,
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 0});
                        }
                    }
                }
            }
        }
    });
}

function animarKPI(id, valorNovo) {
    const el = $(id + " .valor");
    const valorAntigo = parseFloat(el.text().replace(/[^\d.]/g, '')) || 0;
    let atual = valorAntigo;
    const incremento = (valorNovo - valorAntigo) / 30;
    
    $(id).removeClass("positive negative")
         .addClass(valorNovo >= 0 ? "positive" : "negative");
    
    let step = 0;
    const intervalo = setInterval(() => {
        atual += incremento;
        step++;
        
        if ((incremento > 0 && atual >= valorNovo) || 
            (incremento < 0 && atual <= valorNovo) || 
            step >= 30) {
            clearInterval(intervalo);
            atual = valorNovo;
        }
        
        el.text("R$ " + atual.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
    }, 20);
}

function carregarDados() {
    showLoading(true, "Conectando ao servidor...");
    
    // Tentar carregar do CSV online primeiro
    Papa.parse(URL_CSV, {
        download: true,
        header: true,
        complete: function(results) {
            if (results.data && results.data.length > 0) {
                dadosFiltrados = results.data.filter(d => d.DATA); // Filtrar linhas vazias
                usandoDadosDemonstracao = false;
                showLoading(true, "Processando dados...");
                inicializarDashboard();
            } else {
                usarDadosDemonstracao("O CSV online está vazio. Usando dados de demonstração.");
            }
        },
        error: function(error) {
            usarDadosDemonstracao("Erro ao acessar o CSV online. Usando dados de demonstração.");
        }
    });
}

function usarDadosDemonstracao(mensagem) {
    console.warn(mensagem);
    dadosFiltrados = DADOS_DEMONSTRACAO;
    usandoDadosDemonstracao = true;
    showLoading(true, mensagem + " Processando...");
    setTimeout(() => {
        inicializarDashboard();
        alert(mensagem); // Feedback visual para o usuário
    }, 1000);
}

function inicializarDashboard() {
    preencherFiltros();
    
    // Definir período padrão (últimos 7 dias)
    const hoje = new Date();
    const inicio = new Date();
    inicio.setDate(hoje.getDate() - 7);
    
    $("#filtroInicio").val(inicio.toISOString().split('T')[0]);
    $("#filtroFim").val(hoje.toISOString().split('T')[0]);
    
    // Criar gráficos se não existirem
    if (!charts.chartGGR) {
        charts.chartGGR = criarGrafico(document.getElementById('chartGGR'), "Clube A GGR", "Clube B GGR", "#3498db", "#e74c3c");
        charts.chartDepositos = criarGrafico(document.getElementById('chartDepositos'), "Clube A Depósitos", "Clube B Depósitos", "#3498db", "#e74c3c");
        charts.chartFTD = criarGrafico(document.getElementById('chartFTD'), "Clube A FTD", "Clube B FTD", "#3498db", "#e74c3c");
        charts.chartSportsbook = criarGrafico(document.getElementById('chartSportsbook'), "Clube A Sportsbook", "Clube B Sportsbook", "#3498db", "#e74c3c");
        charts.chartCassino = criarGrafico(document.getElementById('chartCassino'), "Clube A Cassino", "Clube B Cassino", "#3498db", "#e74c3c");
        charts.chartBonus = criarGrafico(document.getElementById('chartBonus'), "Clube A Bônus", "Clube B Bônus", "#3498db", "#e74c3c");
    }
    
    atualizarDashboard();
    showLoading(false);
    
    // Adicionar aviso se estiver usando dados de demonstração
    if (usandoDadosDemonstracao) {
        $(".footer").prepend('<p class="demo-warning"><i class="fas fa-exclamation-triangle"></i> Usando dados de demonstração</p>');
    }
}

function preencherFiltros() {
    const clubes = [...new Set(dadosFiltrados.map(d => d["Usuário - Nome de usuário"]))];
    
    const options = '<option value="Todos">Todos os Clubes</option>' + 
                   clubes.map(c => `<option value="${c}">${c}</option>`).join('');
    
    $("#filtroClubeA").html(options);
    $("#filtroClubeB").html(options);
    
    // Definir valores padrão
    $("#filtroClubeA").val("Clube A");
    $("#filtroClubeB").val("Clube B");
}

function aplicarFiltros() {
    atualizarDashboard();
}

function setPeriodo(dias) {
    const hoje = new Date();
    const inicio = new Date();
    inicio.setDate(hoje.getDate() - dias);
    
    $("#filtroInicio").val(inicio.toISOString().split('T')[0]);
    $("#filtroFim").val(hoje.toISOString().split('T')[0]);
    
    aplicarFiltros();
}

// CORREÇÃO PRINCIPAL: Esta função foi completamente reescrita
function atualizarDashboard() {
    const clubeA = $("#filtroClubeA").val();
    const clubeB = $("#filtroClubeB").val();
    const inicio = $("#filtroInicio").val();
    const fim = $("#filtroFim").val();
    
    // Filtrar dados por período
    let dadosPeriodo = dadosFiltrados.filter(d => {
        if (inicio && d.DATA < inicio) return false;
        if (fim && d.DATA > fim) return false;
        return true;
    });
    
    // Filtrar dados por clube
    const filtrarPorClube = (clube) => {
        return clube === "Todos" ? dadosPeriodo : dadosPeriodo.filter(d => d["Usuário - Nome de usuário"] === clube);
    };
    
    const dadosA = filtrarPorClube(clubeA);
    const dadosB = clubeB !== clubeA ? filtrarPorClube(clubeB) : [];
    
    // Função para somar valores de um campo específico
    const sum = (arr, campo) => arr.reduce((s, d) => s + (parseFloat(d[campo]) || 0), 0);
    
    // Calcular totais para KPIs
    animarKPI("#kpi-ftd", sum(dadosA, "Usuário - FTD-Montante") + sum(dadosB, "Usuário - FTD-Montante"));
    animarKPI("#kpi-depositos", sum(dadosA, "Usuário - Depósitos") + sum(dadosB, "Usuário - Depósitos"));
    animarKPI("#kpi-ggr", sum(dadosA, "Cálculo - GGR") + sum(dadosB, "Cálculo - GGR"));
    animarKPI("#kpi-sportsbook", sum(dadosA, "Sportsbook - GGR") + sum(dadosB, "Sportsbook - GGR"));
    animarKPI("#kpi-cassino", sum(dadosA, "Cassino - GGR") + sum(dadosB, "Cassino - GGR"));
    animarKPI("#kpi-bonus", sum(dadosA, "Cálculo - bônus convertidos") + sum(dadosB, "Cálculo - bônus convertidos"));
    
    // Preparar dados para gráficos (agrupados por data)
    const processarPorData = (dados) => {
        const resultado = {};
        dados.forEach(d => {
            if (!resultado[d.DATA]) {
                resultado[d.DATA] = {
                    ggr: 0,
                    dep: 0,
                    ftd: 0,
                    sb: 0,
                    cs: 0,
                    bo: 0
                };
            }
            resultado[d.DATA].ggr += parseFloat(d["Cálculo - GGR"]) || 0;
            resultado[d.DATA].dep += parseFloat(d["Usuário - Depósitos"]) || 0;
            resultado[d.DATA].ftd += parseFloat(d["Usuário - FTD-Montante"]) || 0;
            resultado[d.DATA].sb += parseFloat(d["Sportsbook - GGR"]) || 0;
            resultado[d.DATA].cs += parseFloat(d["Cassino - GGR"]) || 0;
            resultado[d.DATA].bo += parseFloat(d["Cálculo - bônus convertidos"]) || 0;
        });
        return resultado;
    };
    
    const dadosPorDataA = processarPorData(dadosA);
    const dadosPorDataB = processarPorData(dadosB);
    
    // Obter todas as datas únicas do período selecionado
    const datas = [...new Set([
        ...Object.keys(dadosPorDataA),
        ...Object.keys(dadosPorDataB)
    ])].sort();
    
    // Atualizar gráficos com os dados do período
    function atualizarGrafico(chart, campo) {
        chart.data.labels = datas;
        chart.data.datasets[0].data = datas.map(d => dadosPorDataA[d] ? dadosPorDataA[d][campo] : 0);
        chart.data.datasets[1].data = datas.map(d => dadosPorDataB[d] ? dadosPorDataB[d][campo] : 0);
        chart.update();
    }
    
    if (charts.chartGGR) atualizarGrafico(charts.chartGGR, "ggr");
    if (charts.chartDepositos) atualizarGrafico(charts.chartDepositos, "dep");
    if (charts.chartFTD) atualizarGrafico(charts.chartFTD, "ftd");
    if (charts.chartSportsbook) atualizarGrafico(charts.chartSportsbook, "sb");
    if (charts.chartCassino) atualizarGrafico(charts.chartCassino, "cs");
    if (charts.chartBonus) atualizarGrafico(charts.chartBonus, "bo");
    
    // Atualizar tabelas com os dados do período
    preencherTabela("#topDepositos", dadosPeriodo, "Usuário - Depósitos");
    preencherTabela("#topFTD", dadosPeriodo, "Usuário - FTD-Montante");
    preencherTabela("#topGGR", dadosPeriodo, "Cálculo - GGR");
    
    // Atualizar timestamp
    $("#ultimaAtualizacao").text(new Date().toLocaleString('pt-BR'));
}

function preencherTabela(id, dados, campo) {
    const agrupado = {};
    dados.forEach(d => {
        const clube = d["Usuário - Nome de usuário"];
        const valor = parseFloat(d[campo]) || 0;
        agrupado[clube] = (agrupado[clube] || 0) + valor;
    });
    
    const top10 = Object.entries(agrupado)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    
    const tbody = top10.map(item => 
        `<tr>
            <td>${item[0]}</td>
            <td>R$ ${item[1].toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
        </tr>`
    ).join('');
    
    $(id + " tbody").html(tbody);
}

function exportarCSV() {
    let csvContent;
    
    if (usandoDadosDemonstracao) {
        csvContent = "AVISO: Estes são dados de demonstração\n\n";
        csvContent += Papa.unparse(dadosFiltrados);
    } else {
        csvContent = Papa.unparse(dadosFiltrados);
    }
    
    const blob = new Blob([csvContent], {type: "text/csv;charset=utf-8;"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "dados_clubes_" + new Date().toISOString().slice(0,10) + ".csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

$(document).ready(function() {
    // Inicializar gráficos vazios
    charts.chartGGR = criarGrafico(document.getElementById('chartGGR'), "Clube A GGR", "Clube B GGR", "#3498db", "#e74c3c");
    charts.chartDepositos = criarGrafico(document.getElementById('chartDepositos'), "Clube A Depósitos", "Clube B Depósitos", "#3498db", "#e74c3c");
    charts.chartFTD = criarGrafico(document.getElementById('chartFTD'), "Clube A FTD", "Clube B FTD", "#3498db", "#e74c3c");
    charts.chartSportsbook = criarGrafico(document.getElementById('chartSportsbook'), "Clube A Sportsbook", "Clube B Sportsbook", "#3498db", "#e74c3c");
    charts.chartCassino = criarGrafico(document.getElementById('chartCassino'), "Clube A Cassino", "Clube B Cassino", "#3498db", "#e74c3c");
    charts.chartBonus = criarGrafico(document.getElementById('chartBonus'), "Clube A Bônus", "Clube B Bônus", "#3498db", "#e74c3c");
    
    // Adicionar estilo para o aviso de demonstração
    $("<style>.demo-warning { color: #e74c3c; font-weight: bold; margin-bottom: 10px; }</style>").appendTo("head");
    
    // Carregar dados
    carregarDados();
});
</script>
</body>
</html>