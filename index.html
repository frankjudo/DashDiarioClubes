<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Comparativo de Clubes</title>

  <!-- libs -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <style>
    :root {
      --primary:#2c3e50; --secondary:#47b3ff; --accent:#ff6b6b; --success:#2ecc71;
      --warning:#f39c12; --info:#9b59b6; --dark:#0f1b25; --light:#ecf0f1; --gray:#a7b1bb; --muted:#8aa0b3;
      --card:#162635; --card-2:#132230;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
    body{background:linear-gradient(180deg, var(--dark), #142536 60%, #132130);color:var(--light);min-height:100vh;padding:20px}
    .container{max-width:1800px;margin:0 auto}

    /* HEADER */
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:24px}
    header .title-wrap{background:linear-gradient(90deg,#4ee2ff, #8cffc7);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    header h1{font-size:32px;font-weight:800;letter-spacing:.2px}
    header p{color:var(--gray);margin-top:6px}
    .meta-line{color:#b9c6d2;font-size:.92rem}

    /* CONTROLS */
    .controls{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:18px 18px 8px;margin-bottom:22px}
    .control-section{margin-bottom:14px}
    .control-section h3{margin-bottom:10px;color:#9fd7ff;font-size:1.05rem;display:flex;align-items:center;gap:8px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    label{color:#cfe3f0;font-weight:600}
    input,select{padding:10px 12px;border:1px solid rgba(255,255,255,.1);background:#0f1b25;color:#e8f3ff;border-radius:8px}
    input:focus,select:focus{outline:none;border-color:#47b3ff;box-shadow:0 0 0 3px rgba(71,179,255,.18)}
    .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn-period{background:#0f283b;color:#7fd0ff;border:1px solid rgba(71,179,255,.35)}
    .btn-apply{background:#0f2b1e;color:#7dffb2;border:1px solid rgba(46,204,113,.35)}
    .btn-mode{background:#2a1f0e;color:#ffda7f;border:1px solid rgba(243,156,18,.35)}
    .btn-export{background:#221a2c;color:#d9b6ff;border:1px solid rgba(155,89,182,.35)}
    .btn:hover{filter:brightness(1.05)}

    /* KPI CARDS */
    .kpi-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-bottom:18px}
    .kpi{background:linear-gradient(180deg, #142635, #112331);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:16px}
    .kpi .head{display:flex;align-items:center;justify-content:space-between}
    .kpi i{font-size:22px;opacity:.9}
    .kpi h4{color:#9fb6c6;font-weight:700;letter-spacing:.2px}
    .kpi .valor{font-size:26px;font-weight:900;margin-top:8px;letter-spacing:.2px}
    .kpi .variacao{margin-top:10px;font-weight:700}
    .kpi .hint{margin-left:8px;color:#98adbd;font-weight:600}

    /* CHARTS */
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(560px,1fr));gap:16px;margin-bottom:18px}
    .card{background:linear-gradient(180deg, #142635, #112331);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:16px}
    .card h3{display:flex;align-items:center;gap:10px;color:#9fd7ff}

    /* TABLES EXECUTIVAS */
    .tables{display:grid;grid-template-columns:repeat(auto-fit,minmax(420px,1fr));gap:16px}
    .table-container{background:linear-gradient(180deg, #142635, #112331);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:16px}
    .table-container h3{display:flex;align-items:baseline;gap:8px;color:#9fd7ff}
    .table-container h3 small{color:#91a9b9;font-weight:600}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;font-variant-numeric:tabular-nums}
    thead th{color:#8ab6cd;font-size:.9rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px;padding:0 10px}
    tbody tr{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06)}
    tbody td{padding:10px 10px;}
    tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .club{display:flex;align-items:center;gap:10px;min-width:0}
    .rank{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;font-weight:900;color:#0b1822}
    .rank--1{background: linear-gradient(135deg,#ffd700,#ffb347)}
    .rank--2{background: linear-gradient(135deg,#d8dee4,#a3a9b0)}
    .rank--3{background: linear-gradient(135deg,#cd7f32,#b36a27)}
    .club-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#e7f3ff;font-weight:700}
    .val{color:#e7f3ff;font-weight:900}
    .bar{height:6px;background:#0e1d29;border-radius:6px;overflow:hidden;margin-top:6px}
    .bar > span{display:block;height:100%;background:linear-gradient(90deg,#47b3ff,#2ecc71);width:0%}
    .pills{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .pill{padding:4px 8px;border-radius:999px;font-weight:900;font-size:.82rem;border:1px solid transparent;display:inline-flex;align-items:center;gap:6px;letter-spacing:.2px}
    .pill i{font-size:.8rem}
    .pill--up{background:rgba(46,204,113,.12);border-color:rgba(46,204,113,.35);color:#8affc4}
    .pill--down{background:rgba(231,76,60,.12);border-color:rgba(231,76,60,.35);color:#ff9e9e}
    .pill--flat{background:rgba(185,197,205,.12);border-color:rgba(185,197,205,.35);color:#b9c5cd}
    .muted{color:#9ab0c0}

    /* FOOTER */
    .footer{margin-top:18px;text-align:center;color:#9ab0c0}
    .footer strong{color:#bfe6ff}

    @media (max-width:1000px){.charts{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title-wrap">
        <h1><i class="fas fa-chart-line"></i> Dashboard Comparativo de Clubes</h1>
        <p class="meta-line">Visão executiva com comparação automática vs período anterior</p>
      </div>
      <div class="meta-line" id="ultimaAtualizacao">—</div>
    </header>

    <div class="controls">
      <div class="control-section">
        <h3><i class="fas fa-calendar-alt"></i> Período</h3>
        <div class="row">
          <label for="filtroInicio">De</label>
          <input type="date" id="filtroInicio"/>
          <label for="filtroFim">até</label>
          <input type="date" id="filtroFim"/>
          <button class="btn btn-period" id="btnOntem"><i class="fas fa-calendar-day"></i> Ontem</button>
          <button class="btn btn-period" id="btnUltimos7"><i class="fas fa-calendar-week"></i> Últimos 7 dias</button>
          <button class="btn btn-period" id="btnUltimos30"><i class="fas fa-calendar-alt"></i> Últimos 30 dias</button>
          <button class="btn btn-apply" id="btnAplicar"><i class="fas fa-filter"></i> Aplicar</button>
        </div>
      </div>

      <div class="control-section">
        <h3><i class="fas fa-users"></i> Clubes</h3>
        <div class="row">
          <label for="filtroClubeA">Clube A</label>
          <select id="filtroClubeA"></select>
          <label for="filtroClubeB">Clube B</label>
          <select id="filtroClubeB"></select>
        </div>
      </div>

      <div class="control-section">
        <h3><i class="fas fa-cog"></i> Ações</h3>
        <div class="row">
          <label class="row" style="gap:6px">
            <input type="checkbox" id="eliminarSuprema"> Eliminar Clubes Suprema
          </label>
          <label class="row" style="gap:6px">
            <input type="checkbox" id="eliminarToni"> Eliminar TONI
          </label>
          <button class="btn btn-export" id="btnExportar"><i class="fas fa-file-csv"></i> Exportar CSV</button>
          <button class="btn btn-mode" id="btnDarkMode"><i class="fas fa-moon"></i> Modo Escuro</button>
          <button class="btn btn-mode" id="btnAtualizar"><i class="fas fa-sync"></i> Atualizar</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-container">
      <div class="kpi" id="kpi-ftd">
        <div class="head"><h4>FTD</h4><i class="fa-solid fa-user-plus" style="color:#83f3c3"></i></div>
        <div class="valor">R$ 0</div>
        <div class="variacao">— <span class="hint"></span></div>
      </div>
      <div class="kpi" id="kpi-depositos">
        <div class="head"><h4>Depósitos</h4><i class="fa-solid fa-coins" style="color:#ffd480"></i></div>
        <div class="valor">R$ 0</div>
        <div class="variacao">— <span class="hint"></span></div>
      </div>
      <div class="kpi" id="kpi-ggr">
        <div class="head"><h4>GGR</h4><i class="fa-solid fa-chart-line" style="color:#8fd0ff"></i></div>
        <div class="valor">R$ 0</div>
        <div class="variacao">— <span class="hint"></span></div>
      </div>
      <div class="kpi" id="kpi-sportsbook">
        <div class="head"><h4>Sportsbook GGR</h4><i class="fa-solid fa-futbol" style="color:#d7b2ff"></i></div>
        <div class="valor">R$ 0</div>
        <div class="variacao">— <span class="hint"></span></div>
      </div>
      <div class="kpi" id="kpi-cassino">
        <div class="head"><h4>Cassino GGR</h4><i class="fa-solid fa-dice" style="color:#ff9a9a"></i></div>
        <div class="valor">R$ 0</div>
        <div class="variacao">— <span class="hint"></span></div>
      </div>
      <div class="kpi" id="kpi-bonus">
        <div class="head"><h4>Bônus Convertidos</h4><i class="fa-solid fa-gift" style="color:#9bffb4"></i></div>
        <div class="valor">R$ 0</div>
        <div class="variacao">— <span class="hint"></span></div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="charts">
      <div class="card">
        <h3><i class="fas fa-chart-bar"></i> Visão Geral Comparativa</h3>
        <canvas id="chartComparativo"></canvas>
      </div>
      <div class="card">
        <h3><i class="fas fa-chart-line"></i> Evolução do GGR</h3>
        <canvas id="chartGGR"></canvas>
      </div>
      <div class="card">
        <h3><i class="fas fa-money-bill-wave"></i> Evolução de Depósitos</h3>
        <canvas id="chartDepositos"></canvas>
      </div>
      <div class="card">
        <h3><i class="fas fa-user-plus"></i> Evolução do FTD</h3>
        <canvas id="chartFTD"></canvas>
      </div>
      <div class="card">
        <h3><i class="fas fa-futbol"></i> Evolução do Sportsbook</h3>
        <canvas id="chartSportsbook"></canvas>
      </div>
      <div class="card">
        <h3><i class="fas fa-dice"></i> Evolução do Cassino</h3>
        <canvas id="chartCassino"></canvas>
      </div>
    </div>

    <!-- TABLES EXECUTIVAS -->
    <div class="tables">
      <div class="table-container">
        <h3><i class="fas fa-trophy"></i> Top 10 Depósitos <small>(comparado ao período anterior)</small></h3>
        <table id="topDepositos">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-trophy"></i> Top 10 FTD <small>(comparado ao período anterior)</small></h3>
        <table id="topFTD">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-trophy"></i> Top 10 GGR <small>(comparado ao período anterior)</small></h3>
        <table id="topGGR">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-futbol"></i> Top 10 GGR Sportsbook <small>(comparado ao período anterior)</small></h3>
        <table id="topSportsbook">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-dice"></i> Top 10 GGR Cassino <small>(comparado ao período anterior)</small></h3>
        <table id="topCassino">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-gift"></i> Top 10 Bônus Convertidos <small>(comparado ao período anterior)</small></h3>
        <table id="topBonus">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      Última atualização: <strong id="ultimaAtualizacaoFooter">—</strong>
    </div>
  </div>

  <script>
    const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
    let dados=[], charts={};

    const CLUBES_SUPREMA_LIST=['romulo@xpgames.bet','lucasfarinha@maximabet.net','superodds@gmail.com','clubedokw@gmail.com','tropadogg@gmail.com','galeradoinsta@gmail.com'];
    const CLUBE_TONI='crisslots123@gmail.com';

    const N=v=>{ if(v==null) return 0; let s=String(v).trim(); if(!s) return 0; s=s.replace(/\s+/g,'').replace(/\./g,'').replace(/,/g,'.'); const n=+s; return Number.isFinite(n)?n:0; };
    const fmtBR = (n, d=2)=> n.toLocaleString('pt-BR',{minimumFractionDigits:d,maximumFractionDigits:d});

    const DADOS_DEMO=[
      {"DATA":"2025-08-10","Usuário - Nome de usuário":"Clube A","Usuário - FTD-Montante":1500,"Usuário - Depósitos":5200,"Cálculo - GGR":3200,"Sportsbook - GGR":1800,"Cassino - GGR":1400,"Cálculo - bônus convertidos":450},
      {"DATA":"2025-08-10","Usuário - Nome de usuário":"Clube B","Usuário - FTD-Montante":900,"Usuário - Depósitos":3800,"Cálculo - GGR":2100,"Sportsbook - GGR":1200,"Cassino - GGR":900,"Cálculo - bônus convertidos":300},
      {"DATA":"2025-08-09","Usuário - Nome de usuário":"Clube A","Usuário - FTD-Montante":1200,"Usuário - Depósitos":4800,"Cálculo - GGR":2900,"Sportsbook - GGR":1600,"Cassino - GGR":1300,"Cálculo - bônus convertidos":420},
      {"DATA":"2025-08-09","Usuário - Nome de usuário":"Clube B","Usuário - FTD-Montante":850,"Usuário - Depósitos":3500,"Cálculo - GGR":1900,"Sportsbook - GGR":1100,"Cassino - GGR":800,"Cálculo - bônus convertidos":280}
    ];

    function setText(id, t){ const el=document.getElementById(id); if(el) el.textContent=t; }

    function criarGrafico(ctx, la, lb, ca, cb, type='line'){
      return new Chart(ctx,{
        type,
        data:{labels:[],datasets:[
          {label:la,data:[],borderColor:ca,backgroundColor:type==='bar'?ca+'CC':'transparent',fill:type==='line',tension:.35,borderWidth:2.5,pointRadius:3,pointBackgroundColor:ca},
          {label:lb,data:[],borderColor:cb,backgroundColor:type==='bar'?cb+'CC':'transparent',fill:type==='line',tension:.35,borderWidth:2.5,pointRadius:3,pointBackgroundColor:cb}
        ]},
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{legend:{labels:{color:'#cfe3f0'}},tooltip:{backgroundColor:'#0f1b25',titleColor:'#7fd0ff',bodyColor:'#e8f3ff',displayColors:false,
            callbacks:{label:(ctx)=>`${ctx.dataset.label}: R$ ${fmtBR(ctx.parsed.y)}`}}},
          scales:{y:{ticks:{color:'#9ab0c0',callback:v=>`R$ ${fmtBR(v,0)}`},grid:{color:'rgba(255,255,255,.05)'}},
                  x:{ticks:{color:'#9ab0c0'},grid:{color:'rgba(255,255,255,.03)'}}}
        }
      });
    }

    function kpi(sel, valor, anterior, rotulo){
      const card=document.querySelector(sel);
      card.querySelector('.valor').textContent=`R$ ${fmtBR(valor)}`;
      const varEl=card.querySelector('.variacao');
      let txt='—', color='#b9c5cd';
      if(Number.isFinite(anterior) && anterior!==0){
        const pct=((valor-anterior)/Math.abs(anterior))*100;
        const up=pct>=0; color=up?'#8affc4':'#ff9e9e';
        txt=`${up?'+':''}${pct.toFixed(1)}%`;
      }
      varEl.innerHTML=`<span style="color:${color};font-weight:900">${txt}</span><span class="hint">${rotulo}</span>`;
    }

    function carregar(){
      const url=URL_CSV+'&'+Date.now();
      Papa.parse(url,{download:true,header:true,
        complete:r=>{
          if(r.data && r.data.length){
            dados=r.data.filter(x=>x.DATA||x.Data).map(x=>{
              if(x.Data && !x.DATA) x.DATA=x.Data;
              if(!x["Usuário - Nome de usuário"] && x["Usuário - Nome de username"])
                x["Usuário - Nome de usuário"]=x["Usuário - Nome de username"];
              return x;
            });
          }else{dados=DADOS_DEMO;}
          init();
        },
        error:()=>{dados=DADOS_DEMO; init();}
      });
    }

    function init(){
      const getName=d=>d["Usuário - Nome de usuário"]||d["Usuário - Nome de username"];
      const clubes=[...new Set(dados.map(getName))].filter(Boolean);
      const opts='<option value="Todos">Todos os Clubes</option>'+clubes.map(c=>`<option>${c}</option>`).join('');
      const optsB='<option value="Nenhum">Nenhum</option>'+opts;
      document.getElementById('filtroClubeA').innerHTML=opts;
      document.getElementById('filtroClubeB').innerHTML=optsB;

      let hoje=new Date(), ontem=new Date(); ontem.setDate(hoje.getDate()-1);
      document.getElementById('filtroInicio').value=ontem.toISOString().slice(0,10);
      document.getElementById('filtroFim').value=ontem.toISOString().slice(0,10);

      charts.chartComparativo=criarGrafico(document.getElementById('chartComparativo'),"Clube A","Clube B","#47b3ff","#ff8080",'bar');
      charts.chartGGR=criarGrafico(document.getElementById('chartGGR'),"Clube A GGR","Clube B GGR","#47b3ff","#ff8080");
      charts.chartDepositos=criarGrafico(document.getElementById('chartDepositos'),"Clube A Depósitos","Clube B Depósitos","#47b3ff","#ff8080");
      charts.chartFTD=criarGrafico(document.getElementById('chartFTD'),"Clube A FTD","Clube B FTD","#47b3ff","#ff8080");
      charts.chartSportsbook=criarGrafico(document.getElementById('chartSportsbook'),"Clube A Sportsbook","Clube B Sportsbook","#47b3ff","#ff8080");
      charts.chartCassino=criarGrafico(document.getElementById('chartCassino'),"Clube A Cassino","Clube B Cassino","#47b3ff","#ff8080");

      bind();
      atualizar();
    }

    function bind(){
      const $=id=>document.getElementById(id);
      $('btnOntem').onclick=()=>setPeriodo(1);
      $('btnUltimos7').onclick=()=>setPeriodo(7);
      $('btnUltimos30').onclick=()=>setPeriodo(30);
      $('btnAplicar').onclick=atualizar;
      $('btnExportar').onclick=()=>{const csv=Papa.unparse(dados); const b=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='dados_clubes.csv'; a.click();};
      $('btnDarkMode').onclick=()=>document.body.classList.toggle('light-mode');
      $('btnAtualizar').onclick=carregar;
      $('eliminarSuprema').onchange=atualizar;
      $('eliminarToni').onchange=atualizar;
    }

    function setPeriodo(dias){
      let hoje=new Date(), ontem=new Date(); ontem.setDate(hoje.getDate()-1);
      let ini=new Date(ontem); ini.setDate(ontem.getDate()-(dias-1));
      document.getElementById('filtroInicio').value=ini.toISOString().slice(0,10);
      document.getElementById('filtroFim').value=ontem.toISOString().slice(0,10);
      atualizar();
    }

    function atualizar(){
      const ini=document.getElementById('filtroInicio').value;
      const fim=document.getElementById('filtroFim').value;
      const parseISO=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d);};
      const fmtISO=d=> new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);

      const iniD=parseISO(ini), fimD=parseISO(fim);
      const dias=Math.round((fimD-iniD)/86400000)+1;
      const prevFim=new Date(iniD); prevFim.setDate(prevFim.getDate()-1);
      const prevIni=new Date(prevFim); prevIni.setDate(prevIni.getDate()-(dias-1));
      const prevIniStr=fmtISO(prevIni), prevFimStr=fmtISO(prevFim);
      const rotulo=`vs ${prevIniStr} – ${prevFimStr}`;

      const nameOf=d=>d["Usuário - Nome de usuário"]||d["Usuário - Nome de username"];
      let base=[...dados];
      if(document.getElementById('eliminarSuprema').checked) base=base.filter(d=>!CLUBES_SUPREMA_LIST.includes(nameOf(d)));
      if(document.getElementById('eliminarToni').checked) base=base.filter(d=>nameOf(d)!==CLUBE_TONI);

      const atual=base.filter(d=>d.DATA>=ini && d.DATA<=fim);
      const anterior=base.filter(d=>d.DATA>=prevIniStr && d.DATA<=prevFimStr);

      const clubeA=document.getElementById('filtroClubeA').value;
      const clubeB=document.getElementById('filtroClubeB').value;
      const subset=(arr, c)=> c==="Todos" ? arr : arr.filter(d=>nameOf(d)===c);
      const A_at=subset(atual,clubeA), B_at=(clubeB!=="Nenhum"&&clubeA!==clubeB)?subset(atual,clubeB):[];
      const A_pr=subset(anterior,clubeA), B_pr=(clubeB!=="Nenhum"&&clubeA!==clubeB)?subset(anterior,clubeB):[];

      // KPIs
      const sum=(arr,k)=>arr.reduce((s,d)=>s+N(d[k]),0);
      const FTD = sum(A_at,"Usuário - FTD-Montante")+sum(B_at,"Usuário - FTD-Montante");
      const DEP = sum(A_at,"Usuário - Depósitos")+sum(B_at,"Usuário - Depósitos");
      const GGR = sum(A_at,"Cálculo - GGR")+sum(B_at,"Cálculo - GGR");
      const SB  = sum(A_at,"Sportsbook - GGR")+sum(B_at,"Sportsbook - GGR");
      const CS  = sum(A_at,"Cassino - GGR")+sum(B_at,"Cassino - GGR");
      const BON = sum(A_at,"Cálculo - bônus convertidos")+sum(B_at,"Cálculo - bônus convertidos");

      const FTDp = sum(A_pr,"Usuário - FTD-Montante")+sum(B_pr,"Usuário - FTD-Montante");
      const DEPp = sum(A_pr,"Usuário - Depósitos")+sum(B_pr,"Usuário - Depósitos");
      const GGRp = sum(A_pr,"Cálculo - GGR")+sum(B_pr,"Cálculo - GGR");
      const SBp  = sum(A_pr,"Sportsbook - GGR")+sum(B_pr,"Sportsbook - GGR");
      const CSp  = sum(A_pr,"Cassino - GGR")+sum(B_pr,"Cassino - GGR");
      const BONp = sum(A_pr,"Cálculo - bônus convertidos")+sum(B_pr,"Cálculo - bônus convertidos");

      kpi('#kpi-ftd',FTD,FTDp,rotulo);
      kpi('#kpi-depositos',DEP,DEPp,rotulo);
      kpi('#kpi-ggr',GGR,GGRp,rotulo);
      kpi('#kpi-sportsbook',SB,SBp,rotulo);
      kpi('#kpi-cassino',CS,CSp,rotulo);
      kpi('#kpi-bonus',BON,BONp,rotulo);

      // Gráficos (período atual)
      atualizarGraficos(A_at,B_at,clubeA,clubeB);

      // Tabelas (executivas): atual vs anterior
      atualizarTabelas(atual,anterior,rotulo);

      const now=new Date().toLocaleString('pt-BR');
      setText('ultimaAtualizacao',`Atualizado em ${now}`);
      setText('ultimaAtualizacaoFooter',now);
    }

    function atualizarGraficos(dadosA, dadosB, nomeA, nomeB){
      const agg=arr=>{
        const o={}; arr.forEach(d=>{
          const k=d.DATA; o[k]=o[k]||{ggr:0,dep:0,ftd:0,sb:0,cs:0,bo:0};
          o[k].ggr+=N(d["Cálculo - GGR"]); o[k].dep+=N(d["Usuário - Depósitos"]); o[k].ftd+=N(d["Usuário - FTD-Montante"]);
          o[k].sb+=N(d["Sportsbook - GGR"]); o[k].cs+=N(d["Cassino - GGR"]); o[k].bo+=N(d["Cálculo - bônus convertidos"]);
        }); return o;
      };
      const A=agg(dadosA), B=dadosB.length?agg(dadosB):{};
      const labels=[...new Set([...Object.keys(A),...Object.keys(B)])].sort();

      const isB=nomeB!=="Nenhum"; const corB=isB?"#ff8080":"rgba(0,0,0,0)"; const labB=isB?nomeB:"";

      function upd(id,key){
        const c=charts[id];
        c.data.labels=labels;
        c.data.datasets[0].label=nomeA;
        c.data.datasets[0].data=labels.map(d=>A[d]?.[key]||0);
        c.data.datasets[1].label=labB;
        c.data.datasets[1].borderColor=corB;
        c.data.datasets[1].backgroundColor=isB?(c.config.type==='bar'?corB+'CC':'transparent'):'rgba(0,0,0,0)';
        c.data.datasets[1].pointBackgroundColor=corB;
        c.data.datasets[1].data=labels.map(d=>B[d]?.[key]||0);
        c.update();
      }

      upd('chartGGR','ggr');
      upd('chartDepositos','dep');
      upd('chartFTD','ftd');
      upd('chartSportsbook','sb');
      upd('chartCassino','cs');

      // comparativo barras
      const sum=(arr,k)=>arr.reduce((s,d)=>s+N(d[k]),0);
      const sA=[sum(dadosA,"Usuário - FTD-Montante"),sum(dadosA,"Usuário - Depósitos"),sum(dadosA,"Cálculo - GGR"),sum(dadosA,"Sportsbook - GGR"),sum(dadosA,"Cassino - GGR"),sum(dadosA,"Cálculo - bônus convertidos")];
      const sB=isB?[sum(dadosB,"Usuário - FTD-Montante"),sum(dadosB,"Usuário - Depósitos"),sum(dadosB,"Cálculo - GGR"),sum(dadosB,"Sportsbook - GGR"),sum(dadosB,"Cassino - GGR"),sum(dadosB,"Cálculo - bônus convertidos")]:[0,0,0,0,0,0];
      const c=charts.chartComparativo;
      c.data.labels=['FTD','Depósitos','GGR','Sportsbook','Cassino','Bônus'];
      c.data.datasets[0].label=nomeA; c.data.datasets[0].data=sA;
      c.data.datasets[1].label=labB;  c.data.datasets[1].data=sB; c.update();
    }

    // ---------- TABELAS EXECUTIVAS ----------
    function atualizarTabelas(dadosAtual, dadosAnterior, labelComp='vs período anterior'){
      function preencher(id, campo){
        const name=d=>d["Usuário - Nome de usuário"]||d["Usuário - Nome de username"];
        const somaPorClube=(arr)=>arr.reduce((acc,d)=>{const k=name(d); acc[k]=(acc[k]||0)+N(d[campo]); return acc;},{});
        const mapA=somaPorClube(dadosAtual), mapP=somaPorClube(dadosAnterior);
        const top=Object.entries(mapA).sort((a,b)=>b[1]-a[1]).slice(0,10);
        const maxVal = top.length? Math.max(...top.map(x=>x[1])) : 1;

        const rows=top.map(([clube, val], idx)=>{
          const ant=mapP[clube]??0;
          const delta=val-(ant||0);
          let classPct='pill--flat', pctTxt='—', icon='';
          if(ant!==0){
            const pct=((val-ant)/Math.abs(ant))*100;
            const up=pct>=0; classPct=up?'pill--up':'pill--down'; icon=up?'<i class="fa-solid fa-arrow-trend-up"></i>':'<i class="fa-solid fa-arrow-trend-down"></i>';
            pctTxt=`${up?'+':''}${pct.toFixed(1)}%`;
          }
          const classDelta = delta>0?'pill--up':(delta<0?'pill--down':'pill--flat');
          const rankClass = idx===0?'rank--1':(idx===1?'rank--2':(idx===2?'rank--3':'')); 
          const barW = Math.max(2, Math.round((val/maxVal)*100));

          return `<tr>
            <td>
              <div class="club">
                <span class="rank ${rankClass}">${idx+1}</span>
                <span class="club-name" title="${clube}">${clube}</span>
              </div>
            </td>
            <td>
              <div class="val">R$ ${fmtBR(val)}</div>
              <div class="bar"><span style="width:${barW}%"></span></div>
            </td>
            <td>
              <div class="pills">
                <span class="pill ${classPct}" title="${labelComp}">${icon}${pctTxt}</span>
                <span class="pill ${classDelta}" title="Delta absoluto">Δ R$ ${delta>=0?'+':''}${fmtBR(delta)}</span>
              </div>
            </td>
          </tr>`;
        }).join('');

        document.querySelector(id+' tbody').innerHTML = rows || `<tr><td colspan="3" class="muted">Sem dados para o período.</td></tr>`;
      }

      preencher('#topDepositos',"Usuário - Depósitos");
      preencher('#topFTD',"Usuário - FTD-Montante");
      preencher('#topGGR',"Cálculo - GGR");
      preencher('#topSportsbook',"Sportsbook - GGR");
      preencher('#topCassino',"Cassino - GGR");
      preencher('#topBonus',"Cálculo - bônus convertidos");
    }

    // --------- start ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      carregar();
    });
  </script>
</body>
</html>
