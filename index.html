<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Comparativo de Clubes</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>

  <style>
    :root {
      --dark-bg: #0f1b25; --dark-card: #142635; --dark-card2: #112331;
      --dark-txt: #e9f3ff; --dark-muted: #9fb3c2; --dark-accent: #47b3ff; 
      --dark-up: #2ecc71; --dark-down: #e74c3c;
      
      --light-bg: #f5f9ff; --light-card: #ffffff; --light-card2: #f0f6ff;
      --light-txt: #0f1b25; --light-muted: #6c7a8a; --light-accent: #0077cc;
      --light-up: #27ae60; --light-down: #c0392b;
    }
    
    .dark-mode {
      --bg: var(--dark-bg); --card: var(--dark-card); --card2: var(--dark-card2);
      --txt: var(--dark-txt); --muted: var(--dark-muted); --accent: var(--dark-accent);
      --up: var(--dark-up); --down: var(--dark-down);
      --border: rgba(255,255,255,.06); --card-shadow: rgba(0,0,0,0.3);
    }
    
    .light-mode {
      --bg: var(--light-bg); --card: var(--light-card); --card2: var(--light-card2);
      --txt: var(--light-txt); --muted: var(--light-muted); --accent: var(--light-accent);
      --up: var(--light-up); --down: var(--light-down);
      --border: rgba(0,0,0,.08); --card-shadow: rgba(0,0,0,0.05);
    }
    
    * {
      box-sizing: border-box;
      font-family: 'Inter', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    body {
      margin: 0;
      background: linear-gradient(180deg, var(--bg), var(--card2));
      color: var(--txt);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 18px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    header .sub {
      color: var(--muted);
      font-size: 15px;
      margin-top: 4px;
    }
    
    .controls, .card, .table {
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 4px 12px var(--card-shadow);
    }
    
    .controls {
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .row:last-child {
      margin-bottom: 0;
    }
    
    .controls h3 {
      margin: 0;
      color: var(--accent);
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    label {
      color: var(--txt);
      font-weight: 600;
      font-size: 14px;
    }
    
    input, select {
      background: var(--card2);
      color: var(--txt);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(71, 179, 255, 0.18);
    }
    
    .btn {
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .btn-ghost {
      background: rgba(15, 40, 59, 0.4);
      color: var(--accent);
      border: 1px solid rgba(71, 179, 255, 0.35);
    }
    
    .btn-apply {
      background: rgba(15, 43, 30, 0.4);
      color: #8cffc6;
      border: 1px solid rgba(46, 204, 113, 0.35);
    }
    
    .btn-util {
      background: rgba(42, 31, 14, 0.4);
      color: #ffd389;
      border: 1px solid rgba(243, 156, 18, 0.35);
    }
    
    .btn:hover {
      filter: brightness(1.15);
      transform: translateY(-1px);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .kpi {
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      position: relative;
      overflow: hidden;
    }
    
    .kpi::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--accent);
    }
    
    .kpi .hd {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .kpi .hd h4 {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
    }
    
    .kpi .vl {
      font-size: 24px;
      font-weight: 900;
      margin: 8px 0 4px;
    }
    
    .kpi .var {
      font-weight: 800;
      font-size: 14px;
    }
    
    .up { color: var(--up) } 
    .down { color: var(--down) } 
    .flat { color: var(--muted) }
    
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(560px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
      grid-auto-rows: 400px;
    }
    
    .card {
      padding: 14px;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    .card h3 {
      margin: 0 0 12px;
      color: var(--accent);
      font-size: 16px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .card .chart-container {
      flex: 1;
      min-height: 0;
      position: relative;
    }
    
    .card canvas {
      width: 100% !important;
      height: 100% !important;
    }
    
    .tables {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
      gap: 12px;
    }
    
    .table {
      padding: 14px;
      overflow: hidden;
    }
    
    .table h3 {
      margin: 0 0 10px;
      color: var(--accent);
      font-size: 16px;
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }
    
    thead th {
      color: var(--muted);
      font-size: .9rem;
      text-transform: uppercase;
      padding: 0 8px 10px;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }
    
    tbody tr {
      background: rgba(255, 255, 255, .02);
      border: 1px solid var(--border);
      transition: background 0.2s ease;
    }
    
    tbody tr:hover {
      background: rgba(71, 179, 255, 0.08);
    }
    
    tbody td {
      padding: 12px 8px;
      font-size: 14px;
    }
    
    tbody tr td:first-child {
      border-radius: 10px 0 0 10px;
    }
    
    tbody tr td:last-child {
      border-radius: 0 10px 10px 0;
    }
    
    .pills {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .pill {
      border-radius: 999px;
      border: 1px solid;
      padding: 3px 8px;
      font-weight: 900;
      font-size: .8rem;
      white-space: nowrap;
    }
    
    .pill.up {
      border-color: rgba(46, 204, 113, .35);
      background: rgba(46, 204, 113, .12);
      color: var(--up);
    }
    
    .pill.down {
      border-color: rgba(231, 76, 60, .35);
      background: rgba(231, 76, 60, .12);
      color: var(--down);
    }
    
    .pill.flat {
      border-color: rgba(185, 197, 205, .35);
      background: rgba(185, 197, 205, .12);
      color: var(--muted);
    }
    
    .muted {
      color: var(--muted);
    }
    
    .loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 27, 37, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      border-radius: 14px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .search-container {
      position: relative;
      flex: 1;
      max-width: 300px;
    }
    
    .search-container input {
      width: 100%;
      padding-left: 38px;
    }
    
    .search-container i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
    }
    
    .club-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
    }
    
    .club-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }
    
    .club-info h4 {
      font-size: 14px;
      margin: 0;
    }
    
    .club-info p {
      font-size: 12px;
      color: var(--muted);
      margin: 4px 0 0;
    }
    
    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 20px;
      align-items: center;
      margin: 20px 0;
    }
    
    .comparison-vs {
      font-size: 18px;
      font-weight: bold;
      color: var(--muted);
      padding: 0 10px;
    }
    
    .radar-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .radar-chart-container {
      flex: 1;
      min-height: 0;
    }
    
    @media (max-width: 1200px) {
      .charts, .tables {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .controls .row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .search-container {
        max-width: 100%;
      }
      
      .comparison-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
      }
      
      .comparison-vs {
        text-align: center;
        padding: 10px 0;
      }
    }
  </style>
</head>
<body class="dark-mode">
  <div class="container">
    <header>
      <div>
        <h1><i class="fas fa-chart-line"></i> Dashboard Comparativo de Clubes</h1>
        <div class="sub">Visão executiva com comparação automática vs período anterior</div>
      </div>
      <div class="sub" id="ultimaAtualizacao">—</div>
    </header>

    <div class="controls">
      <div class="row">
        <h3><i class="fas fa-calendar-alt"></i> Período</h3>
      </div>
      <div class="row">
        <label for="filtroInicio">De</label><input type="date" id="filtroInicio">
        <label for="filtroFim">até</label><input type="date" id="filtroFim">
        <button class="btn btn-ghost" id="btnOntem"><i class="fa-solid fa-calendar-day"></i> Ontem</button>
        <button class="btn btn-ghost" id="btnUltimos7"><i class="fa-solid fa-calendar-week"></i> Últimos 7 dias</button>
        <button class="btn btn-ghost" id="btnUltimos30"><i class="fa-solid fa-calendar-alt"></i> Últimos 30 dias</button>
        <button class="btn btn-apply" id="btnAplicar"><i class="fa-solid fa-filter"></i> Aplicar</button>
      </div>

      <div class="row">
        <h3><i class="fas fa-users"></i> Clubes</h3>
      </div>
      <div class="row">
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" id="searchClub" placeholder="Pesquisar clube...">
        </div>
      </div>
      <div class="row comparison-grid">
        <div id="clubeA-card">
          <div class="club-card">
            <div class="club-avatar">A</div>
            <div class="club-info">
              <h4 id="clubeA-name">Selecione um clube</h4>
              <p>Clube A</p>
            </div>
          </div>
          <select id="filtroClubeA" class="mt-2" style="width:100%"></select>
        </div>
        
        <div class="comparison-vs">VS</div>
        
        <div id="clubeB-card">
          <div class="club-card">
            <div class="club-avatar">B</div>
            <div class="club-info">
              <h4 id="clubeB-name">Selecione um clube</h4>
              <p>Clube B</p>
            </div>
          </div>
          <select id="filtroClubeB" class="mt-2" style="width:100%"></select>
        </div>
      </div>

      <div class="row">
        <h3><i class="fas fa-cog"></i> Ações</h3>
      </div>
      <div class="row">
        <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="eliminarSuprema"> Eliminar Clubes Suprema</label>
        <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="eliminarToni"> Eliminar TONI</label>
        <button class="btn btn-util" id="btnExportar"><i class="fa-solid fa-file-csv"></i> Exportar CSV</button>
        <button class="btn btn-util" id="btnDarkMode"><i class="fa-solid fa-moon"></i> Modo Claro</button>
        <button class="btn btn-util" id="btnAtualizar"><i class="fa-solid fa-sync"></i> Atualizar</button>

        <label for="escalaMode" style="margin-left:10px">Escala dos gráficos:</label>
        <select id="escalaMode">
          <option value="tipo" selected>Por tipo (recomendado)</option>
          <option value="auto">Automática por gráfico</option>
          <option value="global">Única (todos os gráficos)</option>
        </select>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi" id="kpi-ftd">
        <div class="hd"><h4>FTD</h4><i class="fa-solid fa-user-plus" style="color:var(--up)"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
      <div class="kpi" id="kpi-dep">
        <div class="hd"><h4>Depósitos</h4><i class="fa-solid fa-coins" style="color:#ffd389"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
      <div class="kpi" id="kpi-ggr">
        <div class="hd"><h4>GGR</h4><i class="fa-solid fa-chart-line" style="color:var(--accent)"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
      <div class="kpi" id="kpi-sb">
        <div class="hd"><h4>Sportsbook GGR</h4><i class="fa-solid fa-futbol" style="color:#d7b2ff"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
      <div class="kpi" id="kpi-cs">
        <div class="hd"><h4>Cassino GGR</h4><i class="fa-solid fa-dice" style="color:#ff9e9e"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
      <div class="kpi" id="kpi-bn">
        <div class="hd"><h4>Bônus Convertidos</h4><i class="fa-solid fa-gift" style="color:#91ffbd"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
      <div class="kpi" id="kpi-roas">
        <div class="hd"><h4>ROAS</h4><i class="fa-solid fa-percent" style="color:#91bdff"></i></div>
        <div class="vl">0%</div>
        <div class="var">—</div>
      </div>
    </div>

    <div class="charts">
      <div class="card">
        <h3><i class="fa-solid fa-chart-bar"></i> Visão Geral Comparativa</h3>
        <div class="chart-container">
          <canvas id="chartComparativo"></canvas>
        </div>
      </div>
      <div class="card">
        <h3><i class="fa-solid fa-radar"></i> Comparação Multidimensional</h3>
        <div class="radar-container">
          <div class="radar-chart-container">
            <canvas id="chartRadar"></canvas>
          </div>
        </div>
      </div>
      <div class="card">
        <h3><i class="fa-solid fa-chart-line"></i> Evolução do GGR</h3>
        <div class="chart-container">
          <canvas id="chartGGR"></canvas>
        </div>
      </div>
      <div class="card">
        <h3><i class="fa-solid fa-money-bill-wave"></i> Evolução de Depósitos</h3>
        <div class="chart-container">
          <canvas id="chartDepositos"></canvas>
        </div>
      </div>
      <div class="card">
        <h3><i class="fa-solid fa-user-plus"></i> Evolução do FTD</h3>
        <div class="chart-container">
          <canvas id="chartFTD"></canvas>
        </div>
      </div>
      <div class="card">
        <h3><i class="fa-solid fa-futbol"></i> Evolução do Sportsbook</h3>
        <div class="chart-container">
          <canvas id="chartSportsbook"></canvas>
        </div>
      </div>
      <div class="card">
        <h3><i class="fa-solid fa-dice"></i> Evolução do Cassino</h3>
        <div class="chart-container">
          <canvas id="chartCassino"></canvas>
        </div>
      </div>
    </div>

    <div class="tables">
      <div class="table"><h3><i class="fa-solid fa-trophy"></i> Top 10 Depósitos (vs período anterior)</h3>
        <table id="topDepositos"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
      <div class="table"><h3><i class="fa-solid fa-trophy"></i> Top 10 FTD (vs período anterior)</h3>
        <table id="topFTD"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
      <div class="table"><h3><i class="fa-solid fa-trophy"></i> Top 10 GGR (vs período anterior)</h3>
        <table id="topGGR"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
      <div class="table"><h3><i class="fa-solid fa-futbol"></i> Top 10 GGR Sportsbook (vs período anterior)</h3>
        <table id="topSportsbook"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
      <div class="table"><h3><i class="fa-solid fa-dice"></i> Top 10 GGR Cassino (vs período anterior)</h3>
        <table id="topCassino"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
      <div class="table"><h3><i class="fa-solid fa-gift"></i> Top 10 Bônus Convertidos (vs período anterior)</h3>
        <table id="topBonus"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <script>
    /* =================== Utils =================== */
    const URL_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
    const CLUBES_SUPREMA=['romulo@xpgames.bet','lucasfarinha@maximabet.net','superodds@gmail.com','clubedokw@gmail.com','tropadogg@gmail.com','galeradoinsta@gmail.com'];
    const CLUBE_TONI='crisslots123@gmail.com';

    const N=v=>{ if(v==null) return 0; let s=String(v).trim(); if(!s) return 0; s=s.replace(/\s+/g,'').replace(/\./g,'').replace(/,/g,'.'); let n=+s; return Number.isFinite(n)?n:0; };
    const BR=(n,d=2)=> n.toLocaleString('pt-BR',{minimumFractionDigits:d,maximumFractionDigits:d});

    // Demo mínimo
    const DEMO=[
      {"DATA":"2025-08-10","Usuário - Nome de usuário":"Clube A","Usuário - FTD-Montante":1500,"Usuário - Depósitos":5200,"Cálculo - GGR":3200,"Sportsbook - GGR":1800,"Cassino - GGR":1400,"Cálculo - bônus convertidos":450},
      {"DATA":"2025-08-10","Usuário - Nome de usuário":"Clube B","Usuário - FTD-Montante":900,"Usuário - Depósitos":3800,"Cálculo - GGR":2100,"Sportsbook - GGR":1200,"Cassino - GGR":900,"Cálculo - bônus convertidos":300},
      {"DATA":"2025-08-09","Usuário - Nome de usuário":"Clube A","Usuário - FTD-Montante":1200,"Usuário - Depósitos":4800,"Cálculo - GGR":2900,"Sportsbook - GGR":1600,"Cassino - GGR":1300,"Cálculo - bônus convertidos":420},
      {"DATA":"2025-08-09","Usuário - Nome de usuário":"Clube B","Usuário - FTD-Montante":850,"Usuário - Depósitos":3500,"Cálculo - GGR":1900,"Sportsbook - GGR":1100,"Cassino - GGR":800,"Cálculo - bônus convertidos":280}
    ];

    let dados=[], charts={}, isLoading=false;

    function criarChart(ctx, la, lb, ca, cb, type='line', isRadar=false){
      const options = {
        type,
        data: {
          labels: [],
          datasets: [
            {
              label: la,
              data: [],
              borderColor: ca,
              backgroundColor: type==='bar' ? ca+'AA' : isRadar ? ca+'80' : 'transparent',
              fill: type==='line' || isRadar,
              tension: .35,
              borderWidth: 2.4,
              pointRadius: isRadar ? 0 : 3
            },
            {
              label: lb,
              data: [],
              borderColor: cb,
              backgroundColor: type==='bar' ? cb+'AA' : isRadar ? cb+'80' : 'transparent',
              fill: type==='line' || isRadar,
              tension: .35,
              borderWidth: 2.4,
              pointRadius: isRadar ? 0 : 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              labels: { 
                color: getComputedStyle(document.documentElement).getPropertyValue('--txt')
              }
            },
            tooltip: {
              backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
              titleColor: getComputedStyle(document.documentElement).getPropertyValue('--accent'),
              bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--txt'),
              displayColors: false,
              callbacks: {
                label: (c) => `${c.dataset.label}: R$ ${BR(c.parsed.y)}`
              }
            }
          },
          scales: {
            y: {
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--muted'),
                callback: v => `R$ ${BR(v,0)}`
              },
              grid: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--border')
              }
            },
            x: {
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--muted')
              },
              grid: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--border')
              }
            }
          }
        }
      };
      
      if (isRadar) {
        options.options.scales = {
          r: {
            ticks: {
              display: false,
              backdropColor: 'transparent'
            },
            grid: {
              color: getComputedStyle(document.documentElement).getPropertyValue('--border')
            },
            angleLines: {
              color: getComputedStyle(document.documentElement).getPropertyValue('--border')
            },
            pointLabels: {
              color: getComputedStyle(document.documentElement).getPropertyValue('--txt'),
              font: {
                size: 11
              }
            }
          }
        };
      }
      
      return new Chart(ctx, options);
    }

    // ----- Escalas -----
    function niceStep(x){ const e=Math.pow(10, Math.floor(Math.log10(x||1))); const f=(x/e);
      const nf=(f<=1)?1:(f<=2)?2:(f<=2.5)?2.5:(f<=5)?5:10; return nf*e; }

    function scaleTo(chartsArr, values){
      if(!values.length){ chartsArr.forEach(c=>{ delete c.options.scales.y.suggestedMin; delete c.options.scales.y.suggestedMax; c.update(); }); return; }
      let min=Math.min(...values), max=Math.max(...values);
      if(min===Infinity||max===-Infinity){min=0;max=1;}
      let smin, smax;
      if(min<0 && max>0){
        const m=Math.max(Math.abs(min),Math.abs(max));
        const step=niceStep(m*0.2);
        smax=Math.ceil((m*1.05)/step)*step; smin=-smax;
      }else{
        const range=Math.max(1,Math.abs(max-min));
        const step=niceStep(range*0.2);
        smax=Math.ceil((max+step)/step)*step; smin=Math.floor((min-step)/step)*step;
      }
      chartsArr.forEach(c=>{ c.options.scales.y.suggestedMin=smin; c.options.scales.y.suggestedMax=smax; c.update(); });
    }

    function applyScaleMode(mode, series){
      const evolCharts = [charts.ggr, charts.dep, charts.ftd, charts.sb, charts.cs];

      if(mode === 'auto'){
        evolCharts.forEach(c=>{
          delete c.options.scales.y.suggestedMin;
          delete c.options.scales.y.suggestedMax;
          c.update();
        });
        return;
      }

      if(mode === 'global'){
        const allVals = [].concat(series.ggrA, series.ggrB, series.depA, series.depB,
                                  series.ftdA, series.ftdB, series.sbA, series.sbB,
                                  series.csA, series.csB);
        scaleTo(evolCharts, allVals);
        return;
      }

      // 'tipo' (recomendado): financeiros x menores
      const finCharts = [charts.dep, charts.ggr, charts.cs];
      const finVals   = [].concat(series.depA, series.depB, series.ggrA, series.ggrB, series.csA, series.csB);

      const smallCharts = [charts.ftd, charts.sb];
      const smallVals   = [].concat(series.ftdA, series.ftdB, series.sbA, series.sbB);

      scaleTo(finCharts, finVals);
      scaleTo(smallCharts, smallVals);
    }

    function setKPI(id, val, prev, label, isPercent=false){
      const el=document.querySelector(id);
      el.querySelector('.vl').textContent= isPercent ? `${val.toFixed(1)}%` : `R$ ${BR(val)}`;
      let cls='flat', txt='—';
      if(Number.isFinite(prev) && prev!==0){
        const p=((val-prev)/Math.abs(prev))*100;
        cls=p>=0?'up':'down'; 
        txt=`${p>=0?'+':''}${p.toFixed(1)}% ${label}`;
      }
      el.querySelector('.var').innerHTML=`<span class="${cls}">${txt}</span>`;
    }

    function toggleLoading(show) {
      isLoading = show;
      const cards = document.querySelectorAll('.card, .table, .kpi');
      cards.forEach(card => {
        if (show) {
          const loader = document.createElement('div');
          loader.className = 'loading';
          loader.innerHTML = '<div class="spinner"></div>';
          card.appendChild(loader);
        } else {
          const loader = card.querySelector('.loading');
          if (loader) loader.remove();
        }
      });
    }

    /* =================== Fluxo =================== */
    function carregar(){
      toggleLoading(true);
      Papa.parse(URL_CSV+'&'+Date.now(),{
        download:true, header:true,
        complete:r=>{
          if(r.data && r.data.length){
            dados=r.data.filter(x=>x.DATA||x.Data).map(x=>{ 
              if(x.Data && !x.DATA) x.DATA=x.Data; 
              if(!x["Usuário - Nome de usuário"] && x["Usuário - Nome de username"]) 
                x["Usuário - Nome de usuário"]=x["Usuário - Nome de username"]; 
              return x; 
            });
          } else {
            dados=DEMO;
          }
          init();
          toggleLoading(false);
        },
        error:()=>{
          dados=DEMO; 
          init();
          toggleLoading(false);
          alert('Falha ao carregar dados. Usando dados de demonstração.');
        }
      });
    }

    function init(){
      const getName=d=>d["Usuário - Nome de usuário"]||d["Usuário - Nome de username"];
      const clubes=[...new Set(dados.map(getName))].filter(Boolean);
      const opts='<option value="Todos">Todos os Clubes</option>'+clubes.map(c=>`<option>${c}</option>`).join('');
      const optsB='<option value="Nenhum">Nenhum</option>'+opts;
      document.getElementById('filtroClubeA').innerHTML=opts;
      document.getElementById('filtroClubeB').innerHTML=optsB;

      let hoje=new Date(), ontem=new Date(); ontem.setDate(hoje.getDate()-1);
      document.getElementById('filtroInicio').value=ontem.toISOString().slice(0,10);
      document.getElementById('filtroFim').value=ontem.toISOString().slice(0,10);

      // Criar todos os gráficos
      charts.comp = criarChart(document.getElementById('chartComparativo'),"Clube A","Clube B","#47b3ff","#ff8282",'bar');
      charts.radar = criarChart(document.getElementById('chartRadar'),"Clube A","Clube B","#47b3ff","#ff8282",'radar', true);
      charts.ggr = criarChart(document.getElementById('chartGGR'),"Clube A GGR","Clube B GGR","#47b3ff","#ff8282");
      charts.dep = criarChart(document.getElementById('chartDepositos'),"Clube A Depósitos","Clube B Depósitos","#47b3ff","#ff8282");
      charts.ftd = criarChart(document.getElementById('chartFTD'),"Clube A FTD","Clube B FTD","#47b3ff","#ff8282");
      charts.sb  = criarChart(document.getElementById('chartSportsbook'),"Clube A Sportsbook","Clube B Sportsbook","#47b3ff","#ff8282");
      charts.cs  = criarChart(document.getElementById('chartCassino'),"Clube A Cassino","Clube B Cassino","#47b3ff","#ff8282");

      bind();
      atualizar();
    }

    function bind(){
      const $=id=>document.getElementById(id);
      $('btnOntem').onclick=()=>setPeriodo(1);
      $('btnUltimos7').onclick=()=>setPeriodo(7);
      $('btnUltimos30').onclick=()=>setPeriodo(30);
      $('btnAplicar').onclick=atualizar;
      $('btnExportar').onclick=()=>{const csv=Papa.unparse(dados);const b=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='dados_clubes.csv';a.click();};
      $('btnDarkMode').onclick=toggleDarkMode;
      $('btnAtualizar').onclick=carregar;
      $('eliminarSuprema').onchange=atualizar;
      $('eliminarToni').onchange=atualizar;
      $('escalaMode').addEventListener('change', atualizar);
      
      $('filtroClubeA').addEventListener('change', function() {
        document.getElementById('clubeA-name').textContent = this.value === 'Todos' ? 'Todos os Clubes' : this.value;
        atualizar();
      });
      
      $('filtroClubeB').addEventListener('change', function() {
        document.getElementById('clubeB-name').textContent = this.value === 'Nenhum' ? 'Nenhum' : this.value;
        atualizar();
      });
      
      $('searchClub').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const optionsA = document.querySelectorAll('#filtroClubeA option');
        const optionsB = document.querySelectorAll('#filtroClubeB option');
        
        optionsA.forEach(opt => {
          opt.style.display = opt.textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none';
        });
        
        optionsB.forEach(opt => {
          opt.style.display = opt.textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none';
        });
      });
    }
    
    function toggleDarkMode() {
      const body = document.body;
      const isDark = body.classList.contains('dark-mode');
      const btn = document.getElementById('btnDarkMode');
      
      if (isDark) {
        body.classList.remove('dark-mode');
        body.classList.add('light-mode');
        btn.innerHTML = '<i class="fa-solid fa-moon"></i> Modo Escuro';
      } else {
        body.classList.remove('light-mode');
        body.classList.add('dark-mode');
        btn.innerHTML = '<i class="fa-solid fa-sun"></i> Modo Claro';
      }
      
      // Atualizar gráficos para nova paleta de cores
      Object.values(charts).forEach(chart => chart.destroy());
      init();
    }

    function setPeriodo(dias){
      let hoje=new Date(), ontem=new Date(); ontem.setDate(hoje.getDate()-1);
      let ini=new Date(ontem); ini.setDate(ontem.getDate()-(dias-1));
      document.getElementById('filtroInicio').value=ini.toISOString().slice(0,10);
      document.getElementById('filtroFim').value=ontem.toISOString().slice(0,10);
      atualizar();
    }

    function atualizar(){
      if (isLoading) return;
      
      toggleLoading(true);
      setTimeout(() => {
        try {
          const name=d=>d["Usuário - Nome de usuário"]||d["Usuário - Nome de username"];
          const ini=document.getElementById('filtroInicio').value;
          const fim=document.getElementById('filtroFim').value;

          const parseISO=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d);};
          const fmtISO=d=> new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
          const iniD=parseISO(ini), fimD=parseISO(fim);
          const dias=Math.round((fimD-iniD)/86400000)+1;
          const prevFim=new Date(iniD); prevFim.setDate(prevFim.getDate()-1);
          const prevIni=new Date(prevFim); prevIni.setDate(prevIni.getDate()-(dias-1));
          const prevIniStr=fmtISO(prevIni), prevFimStr=fmtISO(prevFim);
          const rotulo=`vs ${prevIniStr} – ${prevFimStr}`;

          // filtros extras
          let base=[...dados];
          if(document.getElementById('eliminarSuprema').checked) base=base.filter(d=>!CLUBES_SUPREMA.includes(name(d)));
          if(document.getElementById('eliminarToni').checked) base=base.filter(d=>name(d)!==CLUBE_TONI);

          const atual=base.filter(d=>d.DATA>=ini && d.DATA<=fim);
          const anterior=base.filter(d=>d.DATA>=prevIniStr && d.DATA<=prevFimStr);

          const clubeA=document.getElementById('filtroClubeA').value;
          const clubeB=document.getElementById('filtroClubeB').value;
          const sel=(arr,c)=> c==="Todos"?arr:arr.filter(d=>name(d)===c);
          const A_at=sel(atual,clubeA), B_at=(clubeB!=="Nenhum" && clubeA!==clubeB)?sel(atual,clubeB):[];
          const A_pr=sel(anterior,clubeA), B_pr=(clubeB!=="Nenhum" && clubeA!==clubeB)?sel(anterior,clubeB):[];

          // KPIs
          const sum=(a,k)=>a.reduce((s,d)=>s+N(d[k]),0);
          const FTD=sum(A_at,"Usuário - FTD-Montante")+sum(B_at,"Usuário - FTD-Montante");
          const DEP=sum(A_at,"Usuário - Depósitos")+sum(B_at,"Usuário - Depósitos");
          const GGR=sum(A_at,"Cálculo - GGR")+sum(B_at,"Cálculo - GGR");
          const SB =sum(A_at,"Sportsbook - GGR")+sum(B_at,"Sportsbook - GGR");
          const CS =sum(A_at,"Cassino - GGR")+sum(B_at,"Cassino - GGR");
          const BN =sum(A_at,"Cálculo - bônus convertidos")+sum(B_at,"Cálculo - bônus convertidos");

          const FTDp=sum(A_pr,"Usuário - FTD-Montante")+sum(B_pr,"Usuário - FTD-Montante");
          const DEPp=sum(A_pr,"Usuário - Depósitos")+sum(B_pr,"Usuário - Depósitos");
          const GGRp=sum(A_pr,"Cálculo - GGR")+sum(B_pr,"Cálculo - GGR");
          const SBp=sum(A_pr,"Sportsbook - GGR")+sum(B_pr,"Sportsbook - GGR");
          const CSp=sum(A_pr,"Cassino - GGR")+sum(B_pr,"Cassino - GGR");
          const BNp=sum(A_pr,"Cálculo - bônus convertidos")+sum(B_pr,"Cálculo - bônus convertidos");
          
          // Calcular ROAS (Retorno sobre Investimento em Publicidade)
          const investimentoA = clubeA === "Todos" ? 0 : (sum(A_at, "Cálculo - Investimento") || 1000);
          const ROAS = GGR / investimentoA * 100;
          const ROASp = GGRp / (clubeA === "Todos" ? 0 : (sum(A_pr, "Cálculo - Investimento") || 1000)) * 100;

          setKPI('#kpi-ftd',FTD,FTDp,rotulo);
          setKPI('#kpi-dep',DEP,DEPp,rotulo);
          setKPI('#kpi-ggr',GGR,GGRp,rotulo);
          setKPI('#kpi-sb',SB,SBp,rotulo);
          setKPI('#kpi-cs',CS,CSp,rotulo);
          setKPI('#kpi-bn',BN,BNp,rotulo);
          setKPI('#kpi-roas',ROAS,ROASp,rotulo, true);

          // ======= Gráficos - agregação por data =======
          const agg=arr=>{const o={}; arr.forEach(d=>{const k=d.DATA; o[k]=o[k]||{ggr:0,dep:0,ftd:0,sb:0,cs:0}; o[k].ggr+=N(d["Cálculo - GGR"]); o[k].dep+=N(d["Usuário - Depósitos"]); o[k].ftd+=N(d["Usuário - FTD-Montante"]); o[k].sb+=N(d["Sportsbook - GGR"]); o[k].cs+=N(d["Cassino - GGR"]);}); return o;};
          const AgA=agg(A_at), AgB=B_at.length?agg(B_at):{};
          const labels=[...new Set([...Object.keys(AgA),...Object.keys(AgB)])].sort();

          const isB=(clubeB!=="Nenhum");
          const labB=isB?clubeB:"";
          const corB=isB?"#ff8282":"rgba(0,0,0,0)";
          const upd=(chart,key,labA)=>{
            const c=charts[chart];
            const vA=labels.map(d=>AgA[d]?.[key]||0);
            const vB=labels.map(d=>AgB[d]?.[key]||0);
            c.data.labels=labels;
            c.data.datasets[0].label=labA;
            c.data.datasets[0].data=vA;
            c.data.datasets[1].label=labB;
            c.data.datasets[1].data=vB;
            c.data.datasets[1].borderColor=corB;
            c.data.datasets[1].backgroundColor=isB?'#ff8282AA':'rgba(0,0,0,0)';
            c.update();
            return {vA,vB};
          };

          const r1=upd('ggr','ggr',clubeA);
          const r2=upd('dep','dep',clubeA);
          const r3=upd('ftd','ftd',clubeA);
          const r4=upd('sb','sb',clubeA);
          const r5=upd('cs','cs',clubeA);

          // ----- ESCALAS conforme seletor -----
          const series = {
            ggrA: r1.vA, ggrB: r1.vB,
            depA: r2.vA, depB: r2.vB,
            ftdA: r3.vA, ftdB: r3.vB,
            sbA:  r4.vA, sbB:  r4.vB,
            csA:  r5.vA, csB:  r5.vB,
          };
          const mode = document.getElementById('escalaMode').value; // 'tipo' | 'auto' | 'global'
          applyScaleMode(mode, series);

          // Comparativo (barras) – escala própria
          const sA=[FTD,DEP,GGR,SB,CS,BN];
          const sB=isB?[sum(B_at,"Usuário - FTD-Montante"),sum(B_at,"Usuário - Depósitos"),sum(B_at,"Cálculo - GGR"),sum(B_at,"Sportsbook - GGR"),sum(B_at,"Cassino - GGR"),sum(B_at,"Cálculo - bônus convertidos")]:[0,0,0,0,0,0];
          charts.comp.data.labels=['FTD','Depósitos','GGR','Sportsbook','Cassino','Bônus'];
          charts.comp.data.datasets[0].label=clubeA; charts.comp.data.datasets[0].data=sA;
          charts.comp.data.datasets[1].label=labB;  charts.comp.data.datasets[1].data=sB;
          charts.comp.update();

          // Gráfico de radar
          const radarData = {
            labels: ['FTD', 'Depósitos', 'GGR', 'Sportsbook', 'Cassino', 'Bônus'],
            datasets: [
              {
                label: clubeA,
                data: sA.map(v => v > 0 ? Math.log10(v) : 0),
                fill: true,
                backgroundColor: 'rgba(71, 179, 255, 0.2)',
                borderColor: '#47b3ff',
                pointBackgroundColor: '#47b3ff',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#47b3ff'
              },
              {
                label: labB,
                data: sB.map(v => v > 0 ? Math.log10(v) : 0),
                fill: true,
                backgroundColor: 'rgba(255, 130, 130, 0.2)',
                borderColor: '#ff8282',
                pointBackgroundColor: '#ff8282',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#ff8282'
              }
            ]
          };
          
          charts.radar.data = radarData;
          charts.radar.update();

          // Tabelas
          atualizarTabelas(atual,anterior);

          const now=new Date().toLocaleString('pt-BR');
          document.getElementById('ultimaAtualizacao').textContent='Atualizado em '+now;
        } catch (e) {
          console.error('Erro ao atualizar:', e);
        } finally {
          toggleLoading(false);
        }
      }, 500);
    }

    function atualizarTabelas(dadosAtual,dadosAnterior){
      function fill(id,campo){
        const name=d=>d["Usuário - Nome de usuário"]||d["Usuário - Nome de username"];
        const sumBy=(arr)=>arr.reduce((acc,d)=>{const k=name(d); acc[k]=(acc[k]||0)+N(d[campo]); return acc;}, {});
        const A=sumBy(dadosAtual), P=sumBy(dadosAnterior);
        const top=Object.entries(A).sort((a,b)=>b[1]-a[1]).slice(0,10);
        const html=top.map(([clube,val])=>{
          const ant=P[clube]??0; let cls='flat',pct='—';
          if(ant){const p=((val-ant)/Math.abs(ant))*100; cls=p>=0?'up':'down'; pct=`${p>=0?'+':''}${p.toFixed(1)}%`; }
          return `<tr>
            <td>${clube}</td>
            <td>R$ ${BR(val)}</td>
            <td><div class="pills"><span class="pill ${cls}">${pct}</span><span class="pill ${val-ant>=0?'up':'down'}">Δ R$ ${val-ant>=0?'+':''}${BR(val-ant)}</span></div></td>
          </tr>`;
        }).join('');
        document.querySelector(id+' tbody').innerHTML=html || `<tr><td colspan="3" class="muted">Sem dados</td></tr>`;
      }
      fill('#topDepositos',"Usuário - Depósitos");
      fill('#topFTD',"Usuário - FTD-Montante");
      fill('#topGGR',"Cálculo - GGR");
      fill('#topSportsbook',"Sportsbook - GGR");
      fill('#topCassino',"Cassino - GGR");
      fill('#topBonus',"Cálculo - bônus convertidos");
    }

    document.addEventListener('DOMContentLoaded',carregar);
  </script>
</body>
</html>