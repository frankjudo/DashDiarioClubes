<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relatório dos clubes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{--bg:#0e1621; --bg2:#0b1926;--card:#101f2d; --card2:#0f2130;--txt:#e9f3ff; --muted:#98a9b7; --accent:#49b6ff;--good:#28d07f; --bad:#ff5c5c; --amber:#ffb86b;--border:rgba(255,255,255,.07); --shadow:0 10px 30px rgba(0,0,0,.35);}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--txt)}
    .container{max-width:1700px;margin:0 auto;padding:22px}
    header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px}
    header h1{margin:0;font-size:28px;font-weight:900;display:flex;gap:10px;align-items:center}
    header .sub{color:var(--muted);font-weight:600}
    .panel{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .controls{padding:16px 16px 10px;margin-bottom:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
    .row>.field{display:flex;flex-direction:column;gap:6px}
    .row .grow{flex:1}
    label{font-weight:800;font-size:14px}
    input,select{background:#0b2435;color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(73,182,255,.18)}
    .btn{padding:10px 14px;border:none;border-radius:12px;font-weight:900;cursor:pointer;display:inline-flex;gap:8px;align-items:center;transition:.15s}
    .btn:hover{transform:translateY(-1px);filter:brightness(1.1)} .btn:active{transform:translateY(0)}
    .btn-ghost{background:#0e2c43;border:1px solid rgba(73,182,255,.35);color:var(--accent)}
    .btn-apply{background:#133822;border:1px solid rgba(40,208,127,.35);color:#bfffe1}
    .insights{padding:10px 14px;margin-bottom:12px;display:flex;gap:14px;align-items:flex-start}
    .chip{background:#0b2435;border:1px solid var(--border);padding:8px 10px;border-radius:12px;color:var(--muted);font-weight:700}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-bottom:12px}
    .kpi{padding:12px;border:1px solid var(--border);border-radius:16px;background:linear-gradient(180deg,var(--card),var(--card2));position:relative}
    .kpi:before{content:'';position:absolute;left:0;top:0;height:100%;width:4px;background:var(--accent)}
    .kpi .title{color:var(--muted);font-weight:800;font-size:13px;display:flex;gap:8px;align-items:center}
    .kpi .value{font-size:22px;font-weight:900;margin:8px 0 2px}
    .kpi .var{font-weight:900;font-size:12px}
    .up{color:var(--good)} .down{color:var(--bad)} .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(520px,1fr));gap:10px;grid-auto-rows:380px;margin-bottom:12px}
    .card{padding:12px;border-radius:16px;border:1px solid var(--border);background:linear-gradient(180deg,var(--card),var(--card2));box-shadow:var(--shadow);display:flex;flex-direction:column;position:relative}
    .card h3{margin:0 0 8px;color:var(--accent);display:flex;gap:8px;align-items:center}
    .chart-container{flex:1;min-height:0}
    .loader{position:absolute;inset:0;border-radius:16px;background:rgba(11,25,38,.65);display:none;justify-content:center;align-items:center}
    .loader.show{display:flex}
    .spinner{width:36px;height:36px;border:4px solid rgba(255,255,255,.12);border-top:4px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .ranking-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .ranking-head .left{display:flex;gap:12px;align-items:center}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{color:var(--muted);font-size:.85rem;text-transform:uppercase;border-bottom:1px solid var(--border);padding-bottom:8px;text-align:left}
    tbody tr{background:rgba(255,255,255,.03);border:1px solid var(--border);cursor:pointer}
    tbody td{padding:10px 10px}
    tbody tr:hover{background:rgba(73,182,255,.08)}
    .delta.up{color:var(--good)} .delta.down{color:var(--bad)} .delta.flat{color:var(--muted)}
    .notification{position:fixed;right:16px;bottom:16px;background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--border);border-left:4px solid var(--accent);border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center;opacity:0;transform:translateY(12px);transition:all .2s}
    .notification.show{opacity:1;transform:translateY(0)}
    .notification.success{border-left-color:var(--good)}
    .notification.error{border-left-color:var(--bad)}
  </style>
</head>
<body>
  <div class="container" role="application">
    <header>
      <div>
        <h1><i class="fa-solid fa-chart-line" aria-hidden="true"></i> Relatório dos clubes</h1>
        <div class="sub">Visão executiva com comparação automática e ranking dinâmico</div>
      </div>
      <div class="sub" id="ultimaAtualizacao" aria-live="polite">—</div>
    </header>

    <div class="panel controls" id="controls">
      <div class="row" role="group" aria-label="Período">
        <div class="field"><label for="filtroInicio">De</label><input type="date" id="filtroInicio"/></div>
        <div class="field"><label for="filtroFim">até</label><input type="date" id="filtroFim"/></div>
        <button class="btn btn-ghost" id="btnOntem" type="button"><i class="fa-solid fa-calendar-day"></i> Ontem</button>
        <button class="btn btn-ghost" id="btnUltimos7" type="button"><i class="fa-solid fa-calendar-week"></i> Últimos 7 dias</button>
        <button class="btn btn-ghost" id="btnUltimos30" type="button"><i class="fa-solid fa-calendar-alt"></i> Últimos 30 dias</button>
        <div class="field" style="margin-left:10px">
          <label for="chkComparar" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="chkComparar"> Comparar c/ período anterior</label>
        </div>
        <button class="btn btn-apply" id="btnAplicar" type="button"><i class="fa-solid fa-filter"></i> Aplicar</button>
      </div>

      <div class="row"><div class="field grow"><label for="searchClub">Pesquisar clube</label><input type="text" id="searchClub" placeholder="Digite para filtrar opções..."></div></div>

      <div class="row" style="gap:16px">
        <div class="field grow"><label for="filtroClubeA">Clube A</label><select id="filtroClubeA"></select></div>
        <div class="field grow"><label for="filtroClubeB">Clube B</label><select id="filtroClubeB"></select></div>
      </div>

      <div class="row" style="gap:16px">
        <div class="field"><label for="eliminarSuprema" style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="eliminarSuprema"> Eliminar Clubes Suprema</label></div>
        <div class="field"><label for="eliminarToni" style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="eliminarToni"> Eliminar TONI</label></div>
        <button class="btn btn-ghost" id="btnDarkMode" type="button"><i class="fa-solid fa-moon"></i> Modo Claro/Escuro</button>
        <button class="btn btn-ghost" id="btnAtualizar" type="button"><i class="fa-solid fa-sync"></i> Atualizar</button>
        <button class="btn btn-ghost" id="btnExportar" type="button"><i class="fa-solid fa-file-csv"></i> Exportar CSV</button>
        <button class="btn btn-ghost" id="btnImportar" type="button"><i class="fa-solid fa-file-arrow-up"></i> Importar CSV</button>
        <input id="fileCsv" type="file" accept=".csv,text/csv" style="display:none"/>
      </div>
    </div>

    <div class="panel insights" id="insights" aria-live="polite"><div class="chip" id="chipResumo">Gerando insights…</div></div>

    <div class="kpis" role="region" aria-label="Indicadores">
      <div class="kpi" id="kpi-ftd"><div class="title"><i class="fa-solid fa-user-plus"></i> FTD</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-dep"><div class="title"><i class="fa-solid fa-coins"></i> Depósitos</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-ggr"><div class="title"><i class="fa-solid fa-chart-line"></i> GGR</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-sb"><div class="title"><i class="fa-solid fa-futbol"></i> Sportsbook GGR</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-cs"><div class="title"><i class="fa-solid fa-dice"></i> Cassino GGR</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-bn"><div class="title"><i class="fa-solid fa-gift"></i> Bônus Convertidos</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-margem"><div class="title"><i class="fa-solid fa-percentage"></i> Margem</div><div class="value">0%</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-ticket"><div class="title"><i class="fa-solid fa-ticket"></i> Ticket Médio de Depósito</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
    </div>

    <div class="grid">
      <div class="card"><h3 id="tComp"><i class="fa-solid fa-chart-bar"></i> Visão Geral Comparativa</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartComparativo"></canvas></div></div>
      <div class="card"><h3 id="tGgr"><i class="fa-solid fa-chart-line"></i> Evolução do GGR</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartGGR"></canvas></div></div>
      <div class="card"><h3 id="tDep"><i class="fa-solid fa-money-bill-wave"></i> Evolução de Depósitos</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartDepositos"></canvas></div></div>
      <div class="card"><h3 id="tFtd"><i class="fa-solid fa-user-plus"></i> Evolução do FTD</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartFTD"></canvas></div></div>
      <div class="card"><h3 id="tSb"><i class="fa-solid fa-futbol"></i> Evolução do Sportsbook</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartSportsbook"></canvas></div></div>
      <div class="card"><h3 id="tCs"><i class="fa-solid fa-dice"></i> Evolução do Cassino</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartCassino"></canvas></div></div>
      <div class="card"><h3><i class="fa-solid fa-braille"></i> Correlação Depósitos × GGR</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartScatter"></canvas></div></div>
    </div>

    <div class="card">
      <div class="ranking-head">
        <div class="left">
          <h3><i class="fa-solid fa-trophy"></i> Ranking de Clubes</h3>
          <div class="field">
            <label for="selRanking">Métrica</label>
            <select id="selRanking">
              <option value="depositos">Depósitos</option>
              <option value="ftd">FTD</option>
              <option value="ggr" selected>GGR</option>
              <option value="sportsbook">Sportsbook</option>
              <option value="cassino">Cassino</option>
              <option value="bonus">Bônus</option>
            </select>
          </div>
        </div>
        <div class="sub" id="rankingInfo">Top 15 — GGR</div>
      </div>
      <div class="loader"><div class="spinner"></div></div>
      <table id="rankingTable">
        <thead><tr><th>#</th><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
        <tbody><tr><td colspan="4">Carregando…</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="notification" id="notification"><i class="fas fa-info-circle"></i><span id="notificationText"></span></div>

<script>
  const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv';

  // Listas distintas
  const EMAILS_SUPREMA = [
    'romulo@xpgames.bet',
    'lucasfarinha@maximabet.net',
    'superodds@gmail.com',
    'clubedokw@gmail.com',
    'tropadogg@gmail.com',
    'galeradoinsta@gmail.com'
  ];
  const EMAILS_TONI = ['crisslots123@gmail.com'];

  const TOP_N = 15;

  let charts = {}, allRows = [], baseAtual = [], baseAnterior = [], aggAtual = null, aggAnterior = null, COLS = null;

  const $ = id => document.getElementById(id);
  const showLoaders = (on = true) => document.querySelectorAll('.card .loader').forEach(el => el.classList.toggle('show', on));
  function note(msg, type = 'info') {
    const n = $('notification'), t = $('notificationText'), i = n.querySelector('i');
    n.className = 'notification'; n.classList.add('show', type);
    i.className = type === 'error' ? 'fas fa-exclamation-circle' : type === 'success' ? 'fas fa-check-circle' : 'fas fa-info-circle';
    t.textContent = msg; setTimeout(() => n.classList.remove('show'), 3000);
  }
  const money = n => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(n || 0);
  const num = v => (Number.isFinite(v) ? v : 0);

  function parseCurrency(v) {
    if (typeof v === 'number') return v; if (v == null) return 0;
    let s = String(v).trim(); if (!s) return 0;
    s = s.replace(/[R$\s]/g, '').replace(/[−–—]/g, '-');
    const par = /^\(.*\)$/.test(s); if (par) s = s.replace(/[()]/g, '');
    s = s.replace(/[^0-9,.\-]/g, '');
    const c = s.includes(','), d = s.includes('.');
    if (c && d) {
      const lc = s.lastIndexOf(','), ld = s.lastIndexOf('.');
      const dec = lc > ld ? ',' : '.'; const th = dec === ',' ? '.' : ',';
      s = s.split(th).join(''); if (dec === ',') s = s.replace(',', '.');
    } else if (c) { s = s.split('.').join(''); s = s.replace(',', '.'); }
    let n = parseFloat(s); if (isNaN(n)) n = 0; if (par) n = -Math.abs(n); return n;
  }

  function parseDateStr(s) {
    if (!s) return null;
    const str = String(s).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return new Date(str + 'T00:00:00');
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(str)) { const [d, m, y] = str.split('/'); return new Date(`${y}-${m}-${d}T00:00:00`); }
    const d = new Date(str); return isNaN(d) ? null : d;
  }

  // mapeamento de colunas
  function detectColumns(headers) {
    const norm = s => (s || '').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
    const exact = name => headers.find(h => norm(h) === norm(name)) || null;
    const find  = fn   => headers.find(h => fn(norm(h))) || null;

    const userNameExact =
      exact('Usuário - Nome de usuário') ||
      exact('Usuario - Nome de usuario') ||
      exact('Usuário – Nome de usuário');

    const ftdPrefer = exact('FTD-Montante') || exact('FTD Montante') || exact('Montante FTD');

    const ggrCalcHeader = find(n =>
      n.includes('ggr') && (n.includes('calculo') || n.includes('total')) &&
      !n.includes('sportsbook') && !n.includes('cassino')
    );

    const m = {
      date: find(n => n.includes('data')),
      club: userNameExact || find(n =>
        n.includes('usuario - nome de usuario') ||
        n.includes('nome de usuario') ||
        n.includes('usuario - nome') ||
        n.includes('clube') || n === 'user' || n.includes('usuario')
      ),
      email: userNameExact || find(n => n.includes('e-mail') || n.includes('email')),
      ftd:  ftdPrefer || find(n => (n.includes('ftd') && n.includes('montante'))) || find(n => n.includes('ftd')),
      dep:  find(n => n.includes('usuario - depositos') || n.includes('depositos') || n.includes('deposito')),
      ggrCalc: ggrCalcHeader,
      sb:   find(n => n.includes('sportsbook') && n.includes('ggr')),
      cs:   find(n => (n.includes('cassino') || n.includes('casino')) && n.includes('ggr')),
      hab:  find(n => n.includes('jogos de habilidade') || n.includes('habilidade') || n.includes('w/l') || n.includes('win/loss')),
      bonus:find(n => (n.includes('bonus') || n.includes('bonu')) && n.includes('convert'))
    };
    if (!m.date || !m.club || !m.ftd) throw new Error('Não encontrei colunas obrigatórias (DATA/CLUBE/FTD).');
    if (!m.email) m.email = m.club;
    return m;
  }

  async function fetchAll() {
    try {
      const res = await fetch(SPREADSHEET_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('Falha ao acessar a planilha (HTTP ' + res.status + ')');
      const text = await res.text();
      const result = await new Promise((resolve, reject) => {
        Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: false, complete: r => resolve(r), error: e => reject(e) });
      });
      if (result.errors.length) throw new Error('Erro ao processar CSV: ' + result.errors.map(e => e.message).join(', '));
      if (!result.data.length) throw new Error('CSV vazio.');
      COLS = detectColumns(Object.keys(result.data[0] || {}));
      note('Dados carregados com sucesso!', 'success');
      return result.data;
    } catch (err) {
      console.error('Erro detalhado ao buscar planilha:', err);
      note('Erro ao buscar planilha. Use "Importar CSV".', 'error');
      throw err;
    }
  }

  function computeGGR(row, c) {
    const sb = parseCurrency(row[c.sb]); const cs = parseCurrency(row[c.cs]); const hab = parseCurrency(row[c.hab]);
    const sum = num(sb) + num(cs) + num(hab);
    if (c.ggrCalc) {
      const raw = parseCurrency(row[c.ggrCalc]);
      const close = (sum === 0) ? Math.abs(raw) < 1e-6 : Math.abs((raw - sum) / sum) <= 0.05;
      if (isFinite(raw) && close) return raw;
    }
    return sum;
  }

  function transform(rows) {
    if (!rows.length) return null;
    const c = COLS;
    const totals = { ftd: 0, depositos: 0, ggr: 0, sportsbook: 0, cassino: 0, bonus: 0 };
    for (const r of rows) {
      totals.ftd += num(parseCurrency(r[c.ftd]));
      totals.depositos += num(parseCurrency(r[c.dep]));
      totals.sportsbook += num(parseCurrency(r[c.sb]));
      totals.cassino += num(parseCurrency(r[c.cs]));
      totals.ggr += num(computeGGR(r, c));
      totals.bonus += num(parseCurrency(r[c.bonus]));
    }
    const dates = [...new Set(rows.map(r => r[c.date]))].sort((a, b) => (parseDateStr(a) - parseDateStr(b)));
    const series = { ggr: Array(dates.length).fill(0), depositos: Array(dates.length).fill(0), ftd: Array(dates.length).fill(0), sportsbook: Array(dates.length).fill(0), cassino: Array(dates.length).fill(0) };
    rows.forEach(r => {
      const di = dates.indexOf(r[c.date]); if (di < 0) return;
      series.ggr[di] += num(computeGGR(r, c));
      series.depositos[di] += num(parseCurrency(r[c.dep]));
      series.ftd[di] += num(parseCurrency(r[c.ftd]));
      series.sportsbook[di] += num(parseCurrency(r[c.sb]));
      series.cassino[di] += num(parseCurrency(r[c.cs]));
    });
    return {
      kpis: totals,
      charts: {
        comparativo: { labels: ['FTD', 'Depósitos', 'GGR', 'Sportsbook', 'Cassino', 'Bônus'], dataA: [totals.ftd, totals.depositos, totals.ggr, totals.sportsbook, totals.cassino, totals.bonus] },
        ggr: { labels: dates, data: series.ggr },
        depositos: { labels: dates, data: series.depositos },
        ftd: { labels: dates, data: series.ftd },
        sportsbook: { labels: dates, data: series.sportsbook },
        cassino: { labels: dates, data: series.cassino }
      }
    };
  }

  function sumByClub(rows, metric) {
    const c = COLS; const map = {};
    rows.forEach(r => {
      const club = r[c.club] || '(Clube não informado)'; let v = 0;
      if (metric === 'depositos') v = parseCurrency(r[c.dep]);
      else if (metric === 'ftd') v = parseCurrency(r[c.ftd]);
      else if (metric === 'sportsbook') v = parseCurrency(r[c.sb]);
      else if (metric === 'cassino') v = parseCurrency(r[c.cs]);
      else if (metric === 'bonus') v = parseCurrency(r[c.bonus]);
      else if (metric === 'ggr') v = computeGGR(r, c);
      map[club] = (map[club] || 0) + num(v);
    });
    return map;
  }

  function seriesPorClube(rows, metric) {
    const c = COLS;
    const dates = [...new Set(rows.map(r => r[c.date]))].sort((a, b) => (parseDateStr(a) - parseDateStr(b)));
    const serie = Array(dates.length).fill(0);
    rows.forEach(r => {
      const di = dates.indexOf(r[c.date]); if (di < 0) return;
      let v = 0;
      if (metric === 'depositos') v = parseCurrency(r[c.dep]);
      else if (metric === 'ftd') v = parseCurrency(r[c.ftd]);
      else if (metric === 'sportsbook') v = parseCurrency(r[c.sb]);
      else if (metric === 'cassino') v = parseCurrency(r[c.cs]);
      else if (metric === 'ggr') v = computeGGR(r, c);
      serie[di] += num(v);
    });
    return { labels: dates, data: serie };
  }

  function gerarInsights() {
    if (!aggAtual) { $('chipResumo').textContent = 'Sem dados no período.'; return; }
    const compOn = $('chkComparar').checked && aggAnterior;
    const delta = (a, b) => !compOn ? null : a - (b ?? 0);
    const dDep = delta(aggAtual.kpis.depositos, aggAnterior?.kpis?.depositos);
    const dGgr = delta(aggAtual.kpis.ggr, aggAnterior?.kpis?.ggr);
    const dFtd = delta(aggAtual.kpis.ftd, aggAnterior?.kpis?.ftd);

    const metric = $('selRanking').value;
    const curMap = sumByClub(baseAtual, metric);
    const prevMap = $('chkComparar').checked ? sumByClub(baseAnterior, metric) : {};

    const linhas = Object.entries(curMap).map(([clube, valor]) => {
      const prev = prevMap[clube] ?? 0; return { clube, delta: valor - prev };
    }).sort((a, b) => b.delta - a.delta);

    const top = linhas[0], worst = linhas[linhas.length - 1];
    const mk = v => money(Math.abs(v || 0)), dir = v => v >= 0 ? '↑' : '↓';

    let txt = `Depósitos ${!compOn ? '—' : `${dir(dDep)} ${mk(dDep)}`} | GGR ${!compOn ? '—' : `${dir(dGgr)} ${mk(dGgr)}`} | FTD ${!compOn ? '—' : `${dir(dFtd)} ${mk(dFtd)}`}.`;
    if (top && worst) { txt += ` Destaques: ↑ ${top.clube} (maior crescimento em ${metric}); ↓ ${worst.clube} (maior queda).`; }
    $('chipResumo').textContent = txt;
  }

  // helpers de centavos
  const toCents  = v => Math.round((v ?? 0) * 100);
  const fromCents= c => c / 100;

  function setKPI(id, val, prev, metricKey) {
    const el = $(id);
    el.querySelector('.value').textContent = metricKey === 'margem' ? (isFinite(val) ? `${val.toFixed(2)}%` : '—') : money(val);
    const varEl = el.querySelector('.var');

    if (!$('chkComparar').checked || prev == null) { varEl.textContent = '—'; varEl.className = 'var muted'; return; }

    const vC = toCents(val), pC = toCents(prev);
    const deltaMoney = fromCents(vC - pC);

    if (metricKey === 'margem') {
      const delta = val - prev;
      varEl.textContent = `${delta >= 0 ? '+' : ''}${delta.toFixed(2)}pp • Anterior: ${prev.toFixed(2)}%`;
      varEl.className = `var ${delta >= 0 ? 'up' : 'down'}`; return;
    }
    if (metricKey === 'ticket') {
      const delta = val - prev;
      varEl.textContent = `${delta >= 0 ? '+' : ''}${money(delta)} • Anterior: ${money(prev)}`;
      varEl.className = `var ${delta >= 0 ? 'up' : 'down'}`; return;
    }

    const pct = pC === 0 ? 0 : ((vC - pC) / Math.abs(pC)) * 100;
    const positiveIsGood = metricKey !== 'bonus';
    const good = (deltaMoney >= 0 && positiveIsGood) || (deltaMoney < 0 && !positiveIsGood);
    varEl.textContent = `${deltaMoney >= 0 ? '+' : ''}${money(deltaMoney)} (${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%) • Anterior: ${money(prev)}`;
    varEl.className = `var ${good ? 'up' : 'down'}`;
  }

  function renderKPIs() {
    setKPI('kpi-ftd', aggAtual.kpis.ftd, aggAnterior?.kpis.ftd, 'ftd');
    setKPI('kpi-dep', aggAtual.kpis.depositos, aggAnterior?.kpis.depositos, 'depositos');
    setKPI('kpi-ggr', aggAtual.kpis.ggr, aggAnterior?.kpis.ggr, 'ggr');
    setKPI('kpi-sb', aggAtual.kpis.sportsbook, aggAnterior?.kpis.sportsbook, 'sportsbook');
    setKPI('kpi-cs', aggAtual.kpis.cassino, aggAnterior?.kpis.cassino, 'cassino');
    setKPI('kpi-bn', aggAtual.kpis.bonus, aggAnterior?.kpis.bonus, 'bonus');

    const margemAtual = aggAtual.kpis.ggr ? ((aggAtual.kpis.ggr - aggAtual.kpis.bonus) / aggAtual.kpis.ggr) * 100 : 0;
    const margemAnterior = aggAnterior?.kpis?.ggr ? ((aggAnterior.kpis.ggr - aggAnterior.kpis.bonus) / aggAnterior.kpis.ggr) * 100 : null;
    setKPI('kpi-margem', margemAtual, margemAnterior, 'margem');

    const ticketAtual = aggAtual.kpis.ftd ? (aggAtual.kpis.depositos / aggAtual.kpis.ftd) : 0;
    const ticketAnterior = (aggAnterior && aggAnterior.kpis.ftd) ? (aggAnterior.kpis.depositos / aggAnterior.kpis.ftd) : null;
    setKPI('kpi-ticket', ticketAtual, ticketAnterior, 'ticket');
  }

  function destroyCharts() { Object.values(charts).forEach(c => { try { c.destroy() } catch {} }); charts = {}; }

  function renderCharts() {
    const textColor = '#e9f3ff', gridColor = 'rgba(255,255,255,.1)';
    const common = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: textColor } } }, scales: { y: { grid: { color: gridColor }, ticks: { color: textColor, callback: v => 'R$ ' + Number(v).toLocaleString('pt-BR') } }, x: { grid: { display: false }, ticks: { color: textColor } } } };
    const ctxComp = $('chartComparativo').getContext('2d');
    const ctxGGR = $('chartGGR').getContext('2d');
    const ctxDep = $('chartDepositos').getContext('2d');
    const ctxFTD = $('chartFTD').getContext('2d');
    const ctxSB = $('chartSportsbook').getContext('2d');
    const ctxCS = $('chartCassino').getContext('2d');
    const ctxSc = $('chartScatter').getContext('2d');

    const clubA = $('filtroClubeA').value, clubB = $('filtroClubeB').value;
    const compararClubes = !!(clubA || clubB);
    $('tComp').innerHTML = `<i class="fa-solid fa-chart-bar"></i> Visão Geral Comparativa${compararClubes ? ' — A vs B' : ''}`;
    $('tGgr').innerHTML = `<i class="fa-solid fa-chart-line"></i> Evolução do GGR${compararClubes ? ' — A vs B' : ''}`;
    $('tDep').innerHTML = `<i class="fa-solid fa-money-bill-wave"></i> Evolução de Depósitos${compararClubes ? ' — A vs B' : ''}`;
    $('tFtd').innerHTML = `<i class="fa-solid fa-user-plus"></i> Evolução do FTD${compararClubes ? ' — A vs B' : ''}`;
    $('tSb').innerHTML = `<i class="fa-solid fa-futbol"></i> Evolução do Sportsbook${compararClubes ? ' — A vs B' : ''}`;
    $('tCs').innerHTML = `<i class="fa-solid fa-dice"></i> Evolução do Cassino${compararClubes ? ' — A vs B' : ''}`;

    if (charts.comp) charts.comp.destroy();

    if (compararClubes) {
      const metrics = ['FTD', 'Depósitos', 'GGR', 'Sportsbook', 'Cassino', 'Bônus'];
      const totalClub = rows => { const a = transform(rows); return a ? a.kpis : { ftd: 0, depositos: 0, ggr: 0, sportsbook: 0, cassino: 0, bonus: 0 }; };
      const kpiA = clubA ? totalClub(baseAtual.filter(r => r[COLS.club] === clubA)) : { ftd: 0, depositos: 0, ggr: 0, sportsbook: 0, cassino: 0, bonus: 0 };
      const kpiB = clubB ? totalClub(baseAtual.filter(r => r[COLS.club] === clubB)) : { ftd: 0, depositos: 0, ggr: 0, sportsbook: 0, cassino: 0, bonus: 0 };
      charts.comp = new Chart(ctxComp, {
        type: 'bar',
        data: { labels: metrics,
          datasets: [
            { label: clubA || '—', data: [kpiA.ftd, kpiA.depositos, kpiA.ggr, kpiA.sportsbook, kpiA.cassino, kpiA.bonus].map(num), backgroundColor: 'rgba(73,182,255,.7)', borderColor: 'rgba(73,182,255,1)', borderWidth: 1 },
            { label: clubB || '—', data: [kpiB.ftd, kpiB.depositos, kpiB.ggr, kpiB.sportsbook, kpiB.cassino, kpiB.bonus].map(num), backgroundColor: 'rgba(255,184,107,.7)', borderColor: 'rgba(255,184,107,1)', borderWidth: 1 }
          ]
        },
        options: common
      });
    } else {
      const ds = [{ label: 'Período Atual', data: (aggAtual.charts.comparativo.dataA || []).map(num), backgroundColor: 'rgba(73,182,255,.72)', borderColor: 'rgba(73,182,255,1)', borderWidth: 1 }];
      if ($('chkComparar').checked && aggAnterior) {
        ds.push({ label: 'Período Anterior', data: (aggAnterior.charts.comparativo.dataA || []).map(num), backgroundColor: 'rgba(159,179,194,.72)', borderColor: 'rgba(159,179,194,1)', borderWidth: 1 });
      }
      charts.comp = new Chart(ctxComp, { type: 'bar', data: { labels: aggAtual.charts.comparativo.labels, datasets: ds }, options: common });
    }

    const mkSerie = (metric) => ({
      atual: { labels: (aggAtual.charts[metric] || {labels:[]}).labels, data: (aggAtual.charts[metric] || {data:[]}).data },
      anterior: aggAnterior?.charts?.[metric] ? { labels: aggAnterior.charts[metric].labels, data: aggAnterior.charts[metric].data } : null,
      A: seriesPorClube(baseAtual.filter(r => r[COLS.club] === $('filtroClubeA').value), metric),
      B: seriesPorClube(baseAtual.filter(r => r[COLS.club] === $('filtroClubeB').value), metric)
    });

    const makeLine = (ctx, key, serie) => {
      if (charts[key]) charts[key].destroy();
      if (compararClubes) {
        const ds = [];
        if ($('filtroClubeA').value) ds.push({ label: $('filtroClubeA').value, data: (serie.A.data || []).map(num), borderColor: '#49b6ff', backgroundColor: 'rgba(73,182,255,.12)', tension: .35, fill: true });
        if ($('filtroClubeB').value) ds.push({ label: $('filtroClubeB').value, data: (serie.B.data || []).map(num), borderColor: '#ffb86b', backgroundColor: 'rgba(255,184,107,.15)', tension: .35, fill: true });
        const labels = serie.A.labels.length ? serie.A.labels : serie.B.labels;
        charts[key] = new Chart(ctx, { type: 'line', data: { labels: labels.map(String), datasets: ds }, options: common });
      } else {
        const ds = [{ label: `${key} (Atual)`, data: (serie.atual.data || []).map(num), borderColor: '#49b6ff', backgroundColor: 'rgba(73,182,255,.12)', tension: .35, fill: true }];
        if ($('chkComparar').checked && serie.anterior) {
          ds.push({ label: `${key} (Anterior)`, data: (serie.anterior.data || []).map(num), borderColor: '#9fb3c2', backgroundColor: 'rgba(159,179,194,.15)', tension: .35, fill: true });
        }
        charts[key] = new Chart(ctx, { type: 'line', data: { labels: (serie.atual.labels || []).map(String), datasets: ds }, options: common });
      }
    };

    makeLine(ctxGGR, 'GGR', mkSerie('ggr'));
    makeLine(ctxDep, 'Depósitos', mkSerie('depositos'));
    makeLine(ctxFTD, 'FTD', mkSerie('ftd'));
    makeLine(ctxSB, 'Sportsbook', mkSerie('sportsbook'));
    makeLine(ctxCS, 'Cassino', mkSerie('cassino'));

    if (charts.scatter) charts.scatter.destroy();
    const curMapG = sumByClub(baseAtual, 'ggr');
    const curMapD = sumByClub(baseAtual, 'depositos');
    const points = Object.keys(curMapG).map(clube => ({ clube, x: num(curMapD[clube] || 0), y: num(curMapG[clube] || 0) })).sort((a, b) => b.y - a.y).slice(0, 50);
    charts.scatter = new Chart(ctxSc, {
      type: 'scatter',
      data: { datasets: [{ label: 'Clubes (Top 50 por GGR)', data: points, parsing: false, pointRadius: 4, borderColor: '#49b6ff', backgroundColor: 'rgba(73,182,255,.4)' }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#e9f3ff' } }, tooltip: { callbacks: { label: (c) => `${c.raw.clube}: Dep ${money(c.raw.x)} | GGR ${money(c.raw.y)}` } } },
        scales: {
          x: { grid: { color: 'rgba(255,255,255,.1)' }, ticks: { color: '#e9f3ff', callback: v => 'R$ ' + Number(v).toLocaleString('pt-BR') }, title: { display: true, text: 'Depósitos', color: '#e9f3ff', font: { weight: 800 } } },
          y: { grid: { color: 'rgba(255,255,255,.1)' }, ticks: { color: '#e9f3ff', callback: v => 'R$ ' + Number(v).toLocaleString('pt-BR') }, title: { display: true, text: 'GGR', color: '#e9f3ff', font: { weight: 800 } } }
        }
      }
    });
  }

  // ==== e-mails ====
  const extractEmail = s => {
    const raw = String(s ?? '').trim().toLowerCase();
    const m = raw.match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/);
    return m ? m[0] : raw;
  };
  function getRowEmails(row) {
    const emails = new Set();
    const push = v => {
      if (!v) return;
      const s = String(v).toLowerCase();
      const ms = s.match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/g);
      if (ms) ms.forEach(x => emails.add(x.trim()));
    };
    if (COLS?.email) push(row[COLS.email]);
    if (COLS?.club)  push(row[COLS.club]);
    Object.values(row).forEach(push);
    return emails;
  }

  function applyNameFilters(rows) {
    const supOn  = $('eliminarSuprema').checked;
    const toniOn = $('eliminarToni').checked;
    if (!supOn && !toniOn) return rows;

    const supSet  = new Set(EMAILS_SUPREMA.map(e => e.toLowerCase()));
    const toniSet = new Set(EMAILS_TONI.map(e => e.toLowerCase()));

    return rows.filter(r => {
      const primary = extractEmail(r[COLS.email]);

      const isSupPrimary  = supOn  && (supSet.has(primary)  || [...supSet].some(b => primary.includes(b)));
      const isToniPrimary = toniOn && (toniSet.has(primary) || [...toniSet].some(b => primary.includes(b)));
      if (isSupPrimary || isToniPrimary) return false;

      if (supOn || toniOn) {
        const all = getRowEmails(r);
        const hasSup  = supOn  && [...all].some(e => supSet.has(e)  || [...supSet].some(b => e.includes(b)));
        const hasToni = toniOn && [...all].some(e => toniSet.has(e) || [...toniSet].some(b => e.includes(b)));
        if (hasSup || hasToni) return false;
      }
      return true;
    });
  }

  // === RANKING (faltava!) ===
  function renderRanking() {
    const metric = $('selRanking').value;
    localStorage.setItem('dash_ranking_metric', metric);

    const filterAB = r =>
      (!($('filtroClubeA').value) && !($('filtroClubeB').value)) ||
      ($('filtroClubeA').value && r[COLS.club] === $('filtroClubeA').value) ||
      ($('filtroClubeB').value && r[COLS.club] === $('filtroClubeB').value);

    const rowsAtual = baseAtual.filter(filterAB);
    const rowsAnterior = baseAnterior.filter(filterAB);

    const curMap = sumByClub(rowsAtual, metric);
    const compareOn = $('chkComparar').checked && rowsAnterior.length > 0;
    const prevMap = compareOn ? sumByClub(rowsAnterior, metric) : {};

    const rows = Object.entries(curMap).map(([clube, valor]) => {
      const prev = compareOn ? (prevMap[clube] ?? 0) : null;

      let deltaMoney = null, pct = null;
      if (prev != null) {
        const dC = toCents(valor) - toCents(prev);
        deltaMoney = fromCents(dC);
        pct = toCents(prev) === 0 ? null : (dC / Math.abs(toCents(prev))) * 100;
      }

      return { clube, valor: num(valor), deltaMoney, pct };
    }).sort((a, b) => b.valor - a.valor).slice(0, TOP_N);

    $('rankingInfo').textContent = `Top ${TOP_N} — ${metric.charAt(0).toUpperCase() + metric.slice(1)}`;
    const tb = $('rankingTable').querySelector('tbody');
    tb.innerHTML = rows.length ? '' : '<tr><td colspan="4">Sem dados</td></tr>';

    rows.forEach((r, i) => {
      let cls = 'flat', deltaText = '—';
      if (r.deltaMoney !== null) {
        const isBonus = metric === 'bonus';
        const good = (r.deltaMoney >= 0 && !isBonus) || (r.deltaMoney < 0 && isBonus);
        cls = good ? 'up' : 'down';
        const pctText = (r.pct == null) ? '—' : `${r.pct >= 0 ? '+' : ''}${r.pct.toFixed(2)}%`;
        deltaText = `${r.deltaMoney >= 0 ? '+' : ''}${money(r.deltaMoney)} (${pctText})`;
      }
      const tr = document.createElement('tr');
      tr.dataset.clube = r.clube;
      tr.innerHTML = `<td>${i + 1}</td><td>${r.clube}</td><td>${money(r.valor)}</td><td class="delta ${cls}">${deltaText}</td>`;
      tr.addEventListener('click', () => { $('filtroClubeA').value = r.clube; updateAll(); note(\`Clube A definido: ${r.clube}\`, 'success'); });
      tb.appendChild(tr);
    });
  }

  // === período anterior, update e init ===
  function updateAll() {
    showLoaders(true);

    const { ini, fim } = getDateRange();
    if (!ini || !fim) { showLoaders(false); return; }

    const msPerDay = 24 * 60 * 60 * 1000;
    const days = Math.max(1, Math.floor((fim - ini) / msPerDay) + 1);
    const prevEnd   = new Date(ini.getTime() - msPerDay);
    const prevStart = new Date(prevEnd.getTime() - (days - 1) * msPerDay);

    const inRange = (d, a, b) => d && d >= a && d <= b;

    const cur = allRows.filter(r => inRange(parseDateStr(r[COLS.date]), ini, fim));
    const prv = allRows.filter(r => inRange(parseDateStr(r[COLS.date]), prevStart, prevEnd));

    const beforeCur = cur.length, beforePrv = prv.length;

    baseAtual = applyNameFilters(cur);
    baseAnterior = applyNameFilters(prv);

    console.debug(`Excluídos por e-mail — Atual: ${beforeCur - baseAtual.length} • Anterior: ${beforePrv - baseAnterior.length}`);

    aggAtual = transform(baseAtual);
    aggAnterior = $('chkComparar').checked ? transform(baseAnterior) : null;

    renderKPIs(); destroyCharts(); renderCharts(); renderRanking(); gerarInsights();
    showLoaders(false);

    $('ultimaAtualizacao').textContent =
      'Atualizado em ' + new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) +
      ` • FTD: ${COLS.ftd || '(n/d)'} • Clube: ${COLS.club || '(n/d)'} • Email: ${COLS.email || '(n/d)'}`;
  }

  function getDateRange() {
    let ini = new Date($('filtroInicio').value + 'T00:00:00');
    let fim = new Date($('filtroFim').value + 'T23:59:59');
    if (isNaN(ini) || isNaN(fim)) return { ini: null, fim: null };
    if (ini > fim) {
      const t = ini; ini = fim; fim = t;
      $('filtroInicio').value = ini.toISOString().slice(0, 10);
      $('filtroFim').value = fim.toISOString().slice(0, 10);
      note('Datas invertidas — corrigi pra você');
    }
    return { ini, fim };
  }

  function savePrefs() {
    const prefs = { ini: $('filtroInicio').value, fim: $('filtroFim').value, a: $('filtroClubeA').value, b: $('filtroClubeB').value, sup: $('eliminarSuprema').checked, toni: $('eliminarToni').checked, comp: $('chkComparar').checked, metric: $('selRanking').value };
    localStorage.setItem('rel_clubes_prefs', JSON.stringify(prefs));
  }
  function loadPrefs() {
    try {
      const p = JSON.parse(localStorage.getItem('rel_clubes_prefs') || '{}');
      if (p.ini) $('filtroInicio').value = p.ini;
      if (p.fim) $('filtroFim').value = p.fim;
      if (p.sup != null) $('eliminarSuprema').checked = p.sup;
      if (p.toni != null) $('eliminarToni').checked = p.toni;
      if (p.comp != null) $('chkComparar').checked = p.comp;
      if (p.metric) $('selRanking').value = p.metric;
      return p;
    } catch { return {}; }
  }

  async function init() {
    const today = new Date();
    const y = new Date(today); y.setDate(today.getDate() - 1);
    $('filtroInicio').value = y.toISOString().slice(0, 10);
    $('filtroFim').value = y.toISOString().slice(0, 10);

    const prefs = loadPrefs();
    try {
      note('Carregando dados...');
      allRows = await fetchAll();
      populateClubSelects(allRows, prefs);
      updateAll();
    } catch (e) { console.warn('Falha na inicialização.'); }
  }

  function populateClubSelects(all, p) {
    const clubs = [...new Set(all.map(r => (r[COLS.club] || '(Clube não informado)')))].sort((a, b) => a.localeCompare(b, 'pt-BR'));
    const sA = $('filtroClubeA'), sB = $('filtroClubeB');
    [sA, sB].forEach(sel => {
      sel.innerHTML = '<option value="">(Todos)</option>';
      clubs.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });
    });
    if (p?.a && [...sA.options].some(o => o.value === p.a)) sA.value = p.a;
    if (p?.b && [...sB.options].some(o => o.value === p.b)) sB.value = p.b;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const on = (id, ev, fn) => { const el = $(id); if (el) el.addEventListener(ev, fn); };
    on('btnAplicar', 'click', () => { updateAll(); savePrefs(); });
    on('btnAtualizar', 'click', init);
    on('filtroClubeA', 'change', updateAll);
    on('filtroClubeB', 'change', updateAll);
    on('eliminarSuprema', 'change', updateAll);
    on('eliminarToni', 'change', updateAll);
    on('chkComparar', 'change', updateAll);
    on('selRanking', 'change', renderRanking);

    on('btnOntem', 'click', () => {
      const d = new Date(); d.setDate(d.getDate() - 1);
      const s = d.toISOString().slice(0, 10);
      $('filtroInicio').value = s; $('filtroFim').value = s; updateAll();
    });
    on('btnUltimos7', 'click', () => {
      const t = new Date(); const s = new Date(); s.setDate(t.getDate() - 7);
      $('filtroInicio').value = s.toISOString().slice(0, 10);
      $('filtroFim').value = t.toISOString().slice(0, 10); updateAll();
    });
    on('btnUltimos30', 'click', () => {
      const t = new Date(); const s = new Date(); s.setDate(t.getDate() - 30);
      $('filtroInicio').value = s.toISOString().slice(0, 10);
      $('filtroFim').value = t.toISOString().slice(0, 10); updateAll();
    });
    on('btnDarkMode', 'click', () => { document.body.classList.toggle('light-mode'); document.body.classList.toggle('dark-mode'); destroyCharts(); renderCharts(); });

    on('searchClub', 'input', function () {
      const term = this.value.toLowerCase();
      ['filtroClubeA', 'filtroClubeB'].forEach(id => {
        const sel = $(id); if (!sel) return;
        [...sel.options].forEach(o => {
          if (o.value === '') { o.style.display = ''; return; }
          o.style.display = (o.value.toLowerCase().includes(term) || o.textContent.toLowerCase().includes(term)) ? '' : 'none';
        });
      });
    });

    on('btnExportar', 'click', () => {
      const rowsToExport = (!($('filtroClubeA').value) && !($('filtroClubeB').value)) ? baseAtual
        : baseAtual.filter(r => ($('filtroClubeA').value && r[COLS.club] === $('filtroClubeA').value) || ($('filtroClubeB').value && r[COLS.club] === $('filtroClubeB').value));
      const metric = $('selRanking').value;
      const curMap = sumByClub(rowsToExport, metric);
      const rows = Object.entries(curMap).map(([clube, valor]) => ({ clube, valor: num(valor) })).sort((a, b) => b.valor - a.valor);
      let csv = "data:text/csv;charset=utf-8,Clube,Valor\n";
      rows.forEach(r => csv += `"${r.clube}",${r.valor}\n`);
      const a = document.createElement('a'); a.href = encodeURI(csv);
      a.download = `ranking_${metric}_${new Date().toISOString().slice(0, 10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
    });

    init();
  });
</script>
</body>
</html>
