<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Comparativo de Clubes</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background: #f6f8fb; margin: 0; padding: 0; }
        h2 { text-align: center; margin-top: 10px; }
        .filter-container { text-align: center; margin: 10px 0; }
        .kpi-container { display: flex; justify-content: space-around; flex-wrap: wrap; margin: 10px; }
        .kpi { width: 15%; min-width: 180px; padding: 15px; text-align: center; background: #e8f5e9; border-radius: 8px; transition: all 0.3s ease-in-out; }
        .kpi.negative { background: #ffebee; }
        .charts { display: grid; grid-template-columns: repeat(3, 1fr); grid-gap: 10px; margin: 10px; }
        .chart-box { background: white; border-radius: 8px; padding: 10px; }
        .tables { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
        table { width: 100%; border-collapse: collapse; background: #fff; }
        th, td { padding: 6px 10px; border: 1px solid #ddd; font-size: 14px; text-align: left; }
        th { background: #f1f1f1; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; font-size: 24px; display: none; z-index: 999; }
        button { padding: 5px 12px; margin-left: 5px; }
    </style>
</head>
<body>

    <h2>Dashboard Comparativo de Clubes</h2>
    <div class="filter-container">
        De: <input type="date" id="startDate">
        Até: <input type="date" id="endDate">
        <button onclick="setToday()">Hoje</button>
        <button onclick="setLast7Days()">Últimos 7 dias</button>
        <button onclick="setLast30Days()">Últimos 30 dias</button>
        Clube A: <select id="clubeA"></select>
        Clube B: <select id="clubeB"></select>
        <button onclick="atualizar()">Aplicar</button>
        <button onclick="exportCSV()">Exportar CSV</button>
    </div>

    <div class="kpi-container">
        <div id="kpi-FTD" class="kpi"><i class="fas fa-user-plus"></i><br><span class="valor"></span><br>FTD</div>
        <div id="kpi-Depositos" class="kpi"><i class="fas fa-coins"></i><br><span class="valor"></span><br>Depósitos</div>
        <div id="kpi-GGR" class="kpi"><i class="fas fa-chart-line"></i><br><span class="valor"></span><br>GGR</div>
        <div id="kpi-Sportsbook" class="kpi"><i class="fas fa-football-ball"></i><br><span class="valor"></span><br>Sportsbook GGR</div>
        <div id="kpi-Cassino" class="kpi"><i class="fas fa-dice"></i><br><span class="valor"></span><br>Cassino GGR</div>
        <div id="kpi-Bonus" class="kpi"><i class="fas fa-gift"></i><br><span class="valor"></span><br>Bônus Convertidos</div>
    </div>

    <div class="charts">
        <div class="chart-box"><canvas id="chartGGR"></canvas></div>
        <div class="chart-box"><canvas id="chartDepositos"></canvas></div>
        <div class="chart-box"><canvas id="chartFTD"></canvas></div>
        <div class="chart-box"><canvas id="chartSportsbook"></canvas></div>
        <div class="chart-box"><canvas id="chartCassino"></canvas></div>
        <div class="chart-box"><canvas id="chartBonus"></canvas></div>
    </div>

    <div class="tables">
        <div>
            <h4>Top 10 Depósitos</h4>
            <table id="topDepositos"></table>
        </div>
        <div>
            <h4>Top 10 FTD</h4>
            <table id="topFTD"></table>
        </div>
        <div>
            <h4>Top 10 GGR</h4>
            <table id="topGGR"></table>
        </div>
    </div>

    <div class="loading-overlay" id="loading">Carregando...</div>

    <script>
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
        let chartInstances = {};

        function setToday() {
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("startDate").value = today;
            document.getElementById("endDate").value = today;
        }
        function setLast7Days() {
            const today = new Date();
            const last7 = new Date(today.getTime() - (7*24*60*60*1000));
            document.getElementById("startDate").value = last7.toISOString().split("T")[0];
            document.getElementById("endDate").value = today.toISOString().split("T")[0];
        }
        function setLast30Days() {
            const today = new Date();
            const last30 = new Date(today.getTime() - (30*24*60*60*1000));
            document.getElementById("startDate").value = last30.toISOString().split("T")[0];
            document.getElementById("endDate").value = today.toISOString().split("T")[0];
        }

        function exportCSV() {
            window.open(csvUrl, "_blank");
        }

        function atualizar() {
            document.getElementById("loading").style.display = "flex";
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: (results) => {
                    const data = results.data;
                    processarDados(data);
                    document.getElementById("loading").style.display = "none";
                }
            });
        }

        function processarDados(data) {
            const startDate = new Date(document.getElementById("startDate").value);
            const endDate = new Date(document.getElementById("endDate").value);
            const clubeA = document.getElementById("clubeA").value;
            const clubeB = document.getElementById("clubeB").value;

            const filtrado = data.filter(linha => {
                const dataLinha = new Date(linha.Data);
                const dentroData = (!isNaN(startDate) ? dataLinha >= startDate : true) &&
                                   (!isNaN(endDate) ? dataLinha <= endDate : true);
                const clubeFiltro = (clubeA === "Todos" && clubeB === "Todos") || linha.Clube === clubeA || linha.Clube === clubeB;
                return dentroData && clubeFiltro;
            });

            atualizarKPIs(filtrado);
            atualizarGraficos(filtrado, clubeA, clubeB);
            atualizarTop10(filtrado);
        }

        function atualizarKPIs(data) {
            const soma = campo => data.reduce((acc, item) => acc + (parseFloat(item[campo]) || 0), 0);
            const setValor = (id, valor) => {
                const el = document.querySelector(`#${id} .valor`);
                el.innerHTML = "R$ " + valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                document.getElementById(id).classList.toggle('negative', valor < 0);
            };
            setValor("kpi-FTD", soma("FTD"));
            setValor("kpi-Depositos", soma("Depositos"));
            setValor("kpi-GGR", soma("GGR"));
            setValor("kpi-Sportsbook", soma("Sportsbook_GGR"));
            setValor("kpi-Cassino", soma("Cassino_GGR"));
            setValor("kpi-Bonus", soma("Bonus_Convertidos"));
        }

        function atualizarGraficos(data, clubeA, clubeB) {
            const grupos = {};
            data.forEach(linha => {
                const key = linha.Data;
                if (!grupos[key]) grupos[key] = { A:0, B:0 };
                if (linha.Clube === clubeA) grupos[key].A += parseFloat(linha.GGR || 0);
                if (linha.Clube === clubeB) grupos[key].B += parseFloat(linha.GGR || 0);
            });
            const labels = Object.keys(grupos).sort();
            const dataA = labels.map(l => grupos[l].A);
            const dataB = labels.map(l => grupos[l].B);

            renderChart("chartGGR", labels, dataA, dataB, "GGR");
        }

        function renderChart(id, labels, dataA, dataB, label) {
            if (chartInstances[id]) chartInstances[id].destroy();
            chartInstances[id] = new Chart(document.getElementById(id), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Clube A ' + label, data: dataA, borderColor: 'blue', fill: false },
                        { label: 'Clube B ' + label, data: dataB, borderColor: 'orange', fill: false }
                    ]
                }
            });
        }

        function atualizarTop10(data) {
            const ranking = (campo) => [...data].sort((a, b) => parseFloat(b[campo]) - parseFloat(a[campo])).slice(0, 10);
            const renderTabela = (id, lista) => {
                const html = "<tr><th>Clube</th><th>Valor</th></tr>" +
                    lista.map(l => `<tr><td>${l.Clube}</td><td>R$ ${parseFloat(l.Depositos).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td></tr>`).join("");
                document.getElementById(id).innerHTML = html;
            };
            renderTabela("topDepositos", ranking("Depositos"));
            renderTabela("topFTD", ranking("FTD"));
            renderTabela("topGGR", ranking("GGR"));
        }

        atualizar();
    </script>
</body>
</html>
