<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Comparativo de Clubes</title>

  <!-- libs -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <style>
    :root {
      --primary:#2c3e50; --secondary:#3498db; --accent:#e74c3c; --success:#2ecc71;
      --warning:#f39c12; --info:#9b59b6; --dark:#1a252f; --light:#ecf0f1; --gray:#95a5a6; --dark-gray:#34495e;
      --chart-blue:#3498db; --chart-red:#e74c3c; --chart-green:#2ecc71; --chart-purple:#9b59b6; --chart-orange:#f39c12;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    body{background:linear-gradient(135deg,#1a2a3a,#2c3e50);color:var(--light);min-height:100vh;padding:20px}
    body.light-mode{background:#f4f7f9;color:#2c3e50}
    body.light-mode .kpi, body.light-mode .controls, body.light-mode .chart-container, body.light-mode .table-container, body.light-mode .footer, body.light-mode header{
      background:#fff; box-shadow:0 4px 20px rgba(0,0,0,.1); backdrop-filter:none; border:1px solid #e0e6ed
    }
    body.light-mode header h1{background:linear-gradient(to right,var(--secondary),var(--info));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    body.light-mode h3, body.light-mode label, body.light-mode .valor{color:#2c3e50}
    body.light-mode .btn-period, body.light-mode .btn-apply, body-light-mode .btn-mode, body.light-mode .btn-export{background:#e0e6ed;color:#2c3e50}
    body.light-mode table th{background:#e0e6ed}
    body.light-mode table tr:hover{background:#f7f9fa}
    body.light-mode .variacao{color:#616e7c}
    body.light-mode .positive, body.light-mode .negative{border-left:5px solid}
    body.light-mode .positive{border-left-color:#2ecc71}
    body.light-mode .negative{border-left-color:#e74c3c}
    body.light-mode input, body.light-mode select{background:#f7f9fa;border:1px solid #e0e6ed;color:#2c3e50}

    .container{max-width:1800px;margin:0 auto}
    header{text-align:center;margin-bottom:30px;padding:20px;background:rgba(26,37,47,.7);border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,.3);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
    header h1{font-size:2.8rem;margin-bottom:10px;background:linear-gradient(to right,var(--secondary),var(--success));-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:inline-block}
    header p{font-size:1.2rem;color:var(--gray);max-width:800px;margin:0 auto}

    .controls{background:rgba(26,37,47,.7);border-radius:15px;padding:25px;margin-bottom:30px;box-shadow:0 8px 32px rgba(0,0,0,.3);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
    .control-section{margin-bottom:25px}
    .control-section h3{margin-bottom:15px;color:var(--secondary);font-size:1.4rem;display:flex;align-items:center;gap:10px}
    .date-controls,.club-controls,.button-controls{display:flex;flex-wrap:wrap;gap:15px;align-items:center}
    label{font-weight:600;color:var(--light);min-width:80px}
    input,select{padding:12px 15px;border:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.2);color:var(--light);border-radius:8px;font-size:1rem;transition:.3s}
    input:focus,select:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(52,152,219,.3)}
    .btn-period,.btn-apply,.btn-export,.btn-mode{padding:12px 20px;border:none;border-radius:8px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:10px;transition:.3s;font-size:1rem}
    .btn-period{background:rgba(52,152,219,.2);color:var(--secondary)}
    .btn-period:hover{background:rgba(52,152,219,.3)}
    .btn-apply{background:rgba(46,204,113,.2);color:var(--success)}
    .btn-apply:hover{background:rgba(46,204,113,.3)}
    .btn-export{background:rgba(155,89,182,.2);color:var(--info)}
    .btn-export:hover{background:rgba(155,89,182,.3)}
    .btn-mode{background:rgba(243,156,18,.2);color:var(--warning)}
    .btn-mode:hover{background:rgba(243,156,18,.3)}

    .kpi-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
    .kpi{background:rgba(26,37,47,.7);border-radius:15px;padding:25px;display:flex;flex-direction:column;align-items:center;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.3);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);transition:transform .3s, box-shadow .3s}
    .kpi:hover{transform:translateY(-5px);box-shadow:0 12px 40px rgba(0,0,0,.4)}
    .kpi i{font-size:2.5rem;margin-bottom:15px}
    .kpi h3{font-size:1.3rem;margin-bottom:10px;color:var(--gray)}
    .kpi .valor{font-size:1.8rem;font-weight:700}
    .kpi .variacao{font-size:.9rem;margin-top:8px;font-weight:600}
    .kpi .variacao .hint{opacity:.7;font-weight:500;margin-left:6px;font-size:.85em}
    .positive{border-left:5px solid var(--success)}
    .negative{border-left:5px solid var(--accent)}

    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(600px,1fr));gap:25px;margin-bottom:30px}
    .chart-container{background:rgba(26,37,47,.7);border-radius:15px;padding:25px;box-shadow:0 8px 32px rgba(0,0,0,.3);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
    .chart-container h3{margin-bottom:20px;font-size:1.4rem;color:var(--secondary);display:flex;align-items:center;gap:10px}
    .chart-container canvas{width:100% !important;height:300px !important}

    .tables{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:25px;margin-bottom:30px}
    .table-container{background:rgba(26,37,47,.7);border-radius:15px;padding:25px;box-shadow:0 8px 32px rgba(0,0,0,.3);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);overflow:hidden}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th{background:rgba(52,152,219,.2);padding:15px 10px;text-align:left;font-weight:600;color:var(--secondary)}
    td{padding:15px 10px;border-bottom:1px solid rgba(255,255,255,.1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    table th:first-child, table td:first-child{width:45%}
    table th:nth-child(2), table td:nth-child(2){width:30%}
    table th:nth-child(3), table td:nth-child(3){width:25%}
    tr:last-child td{border-bottom:none}
    tr:hover{background:rgba(255,255,255,.05)}

    .footer{text-align:center;padding:25px;background:rgba(26,37,47,.7);border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,.3);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
    .footer p{margin-bottom:10px;color:var(--gray)}
    #ultimaAtualizacao{font-weight:600;color:var(--secondary)}

    #loadingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:9999}
    .spinner{width:80px;height:80px;border:8px solid rgba(52,152,219,.2);border-top:8px solid var(--secondary);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    #loadingMessage{font-size:1.5rem;color:var(--light);font-weight:600}

    #demoWarning{background:rgba(243,156,18,.2);border:1px solid var(--warning);border-radius:8px;padding:15px;margin:20px 0;text-align:center;display:none}

    @media (max-width:1200px){.charts{grid-template-columns:1fr} header h1{font-size:2.2rem}}
    @media (max-width:768px){
      .kpi-container{grid-template-columns:1fr}
      .tables{grid-template-columns:1fr}
      .date-controls,.club-controls{flex-direction:column;align-items:stretch}
      .btn-period,.btn-apply,.btn-export,.btn-mode{width:100%;justify-content:center}
      header h1{font-size:1.8rem}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-chart-line"></i> Dashboard Comparativo de Clubes</h1>
      <p>Analise e compare o desempenho de diferentes clubes em tempo real</p>
    </header>

    <div id="demoWarning">
      <i class="fas fa-exclamation-triangle"></i> Você está visualizando dados de demonstração. Conecte-se à fonte de dados real para ver informações atualizadas.
    </div>

    <div class="controls">
      <div class="control-section">
        <h3><i class="fas fa-calendar-alt"></i> Período</h3>
        <div class="date-controls">
          <label for="filtroInicio">De:</label>
          <input type="date" id="filtroInicio" aria-label="Data inicial"/>
          <label for="filtroFim">até</label>
          <input type="date" id="filtroFim" aria-label="Data final"/>

          <button class="btn-period" id="btnOntem" aria-label="Filtrar por ontem">
            <i class="fas fa-calendar-day"></i> Ontem
          </button>
          <button class="btn-period" id="btnUltimos7" aria-label="Filtrar últimos 7 dias">
            <i class="fas fa-calendar-week"></i> Últimos 7 dias
          </button>
          <button class="btn-period" id="btnUltimos30" aria-label="Filtrar últimos 30 dias">
            <i class="fas fa-calendar-alt"></i> Últimos 30 dias
          </button>
        </div>
      </div>

      <div class="control-section">
        <h3><i class="fas fa-users"></i> Clubes</h3>
        <div class="club-controls">
          <label for="filtroClubeA">Clube A:</label>
          <select id="filtroClubeA" aria-label="Selecionar Clube A"></select>

          <label for="filtroClubeB">Clube B:</label>
          <select id="filtroClubeB" aria-label="Selecionar Clube B"></select>

          <button class="btn-apply" id="btnAplicar" aria-label="Aplicar filtros">
            <i class="fas fa-filter"></i> Aplicar Filtros
          </button>
        </div>
      </div>

      <div class="control-section">
        <h3><i class="fas fa-cog"></i> Ações</h3>
        <div class="button-controls">
          <div class="eliminar-clubes-suprema">
            <input type="checkbox" id="eliminarSuprema" aria-label="Eliminar Clubes Suprema">
            <label for="eliminarSuprema">Eliminar Clubes Suprema</label>
          </div>
          <div class="eliminar-toni">
            <input type="checkbox" id="eliminarToni" aria-label="Eliminar TONI">
            <label for="eliminarToni">Eliminar TONI</label>
          </div>
          <button class="btn-export" id="btnExportar" aria-label="Exportar CSV">
            <i class="fas fa-file-csv"></i> Exportar CSV
          </button>
          <button class="btn-mode" id="btnDarkMode" aria-label="Alternar modo escuro">
            <i class="fas fa-moon"></i> Modo Escuro
          </button>
          <button class="btn-mode" id="btnAtualizar" aria-label="Atualizar dados">
            <i class="fas fa-sync"></i> Atualizar Dados
          </button>
        </div>
      </div>
    </div>

    <div class="kpi-container">
      <div class="kpi positive" id="kpi-ftd">
        <i class="fa-solid fa-user-plus" style="color:#2ecc71"></i>
        <h3>FTD</h3>
        <div class="valor">R$ 0</div>
        <div class="variacao">+0.0%</div>
      </div>
      <div class="kpi positive" id="kpi-depositos">
        <i class="fa-solid fa-coins" style="color:#f39c12"></i>
        <h3>Depósitos</h3>
        <div class="valor">R$ 0</div>
        <div class="variacao">+0.0%</div>
      </div>
      <div class="kpi positive" id="kpi-ggr">
        <i class="fa-solid fa-chart-line" style="color:#3498db"></i>
        <h3>GGR</h3>
        <div class="valor">R$ 0</div>
        <div class="variacao">+0.0%</div>
      </div>
      <div class="kpi positive" id="kpi-sportsbook">
        <i class="fa-solid fa-futbol" style="color:#9b59b6"></i>
        <h3>Sportsbook GGR</h3>
        <div class="valor">R$ 0</div>
        <div class="variacao">+0.0%</div>
      </div>
      <div class="kpi positive" id="kpi-cassino">
        <i class="fa-solid fa-dice" style="color:#e74c3c"></i>
        <h3>Cassino GGR</h3>
        <div class="valor">R$ 0</div>
        <div class="variacao">+0.0%</div>
      </div>
      <div class="kpi positive" id="kpi-bonus">
        <i class="fa-solid fa-gift" style="color:#2ecc71"></i>
        <h3>Bônus Convertidos</h3>
        <div class="valor">R$ 0</div>
        <div class="variacao">+0.0%</div>
      </div>
    </div>

    <div class="charts">
      <div class="chart-container">
        <h3><i class="fas fa-chart-bar"></i> Visão Geral Comparativa</h3>
        <canvas id="chartComparativo"></canvas>
      </div>
      <div class="chart-container">
        <h3><i class="fas fa-chart-line"></i> Evolução do GGR</h3>
        <canvas id="chartGGR"></canvas>
      </div>
      <div class="chart-container">
        <h3><i class="fas fa-money-bill-wave"></i> Evolução de Depósitos</h3>
        <canvas id="chartDepositos"></canvas>
      </div>
      <div class="chart-container">
        <h3><i class="fas fa-user-plus"></i> Evolução do FTD</h3>
        <canvas id="chartFTD"></canvas>
      </div>
      <div class="chart-container">
        <h3><i class="fas fa-futbol"></i> Evolução do Sportsbook</h3>
        <canvas id="chartSportsbook"></canvas>
      </div>
      <div class="chart-container">
        <h3><i class="fas fa-dice"></i> Evolução do Cassino</h3>
        <canvas id="chartCassino"></canvas>
      </div>
    </div>

    <div class="tables">
      <div class="table-container">
        <h3><i class="fas fa-trophy"></i> Top 10 Depósitos</h3>
        <table id="topDepositos">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-trophy"></i> Top 10 FTD</h3>
        <table id="topFTD">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-trophy"></i> Top 10 GGR</h3>
        <table id="topGGR">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-futbol"></i> Top 10 GGR Sportsbook</h3>
        <table id="topSportsbook">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-dice"></i> Top 10 GGR Cassino</h3>
        <table id="topCassino">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="table-container">
        <h3><i class="fas fa-gift"></i> Top 10 Bônus Convertidos</h3>
        <table id="topBonus">
          <thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
          <tbody><tr><td colspan="3">Carregando...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      <p>Última atualização: <span id="ultimaAtualizacao"></span></p>
      <p>Dashboard desenvolvido para análise comparativa de clubes | Dados atualizados automaticamente</p>
    </div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingMessage">Carregando dados...</div>
  </div>

  <script>
    const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
    let dados = [], charts = {};

    const CLUBES_SUPREMA_LIST = [
      'romulo@xpgames.bet','lucasfarinha@maximabet.net','superodds@gmail.com',
      'clubedokw@gmail.com','tropadogg@gmail.com','galeradoinsta@gmail.com'
    ];
    const CLUBE_TONI = 'crisslots123@gmail.com';

    // parser pt-BR
    const N = v => {
      if (v === null || v === undefined) return 0;
      let s = String(v).trim(); if (!s) return 0;
      s = s.replace(/\s+/g,'').replace(/\./g,'').replace(/,/g,'.');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };

    // (opcional) números esperados para validar no console
    const EXPECTED = { ftd:375329.3, depositos:6453433.97, sportsbook:-216537.21, cassino:1861815.38, bonus:579535.91, ggr:1645279.6 };
    const TOL = 0.005;
    function validateTotals(tot) {
      const campos = [['FTD','ftd'],['Depósitos','depositos'],['GGR','ggr'],['Sportsbook','sportsbook'],['Cassino','cassino'],['Bônus','bonus']];
      console.group('%cValidação de Totais (período)','color:#0bf;font-weight:600');
      campos.forEach(([label,key])=>{
        const exp = EXPECTED[key]; if (exp == null) return;
        const got = tot[key]; const diff = got - exp; const rel = exp!==0?Math.abs(diff/exp):Math.abs(diff);
        const ok = rel <= TOL; const fmt = v=>v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
        (ok?console.log:console.warn)(`${label}: obtido=${fmt(got)} | esperado=${fmt(exp)} | Δ=${fmt(diff)} (${(rel*100).toFixed(3)}%) ${ok?'✅ OK':'⚠'}`);
      });
      console.groupEnd();
    }

    // Demo fallback
    const DADOS_DEMO = [
      {"DATA":"2025-08-10","Usuário - Nome de usuário":"Clube A","Usuário - FTD-Montante":1500,"Usuário - Depósitos":5200,"Cálculo - GGR":3200,"Sportsbook - GGR":1800,"Cassino - GGR":1400,"Cálculo - bônus convertidos":450},
      {"DATA":"2025-08-10","Usuário - Nome de usuário":"Clube B","Usuário - FTD-Montante":900,"Usuário - Depósitos":3800,"Cálculo - GGR":2100,"Sportsbook - GGR":1200,"Cassino - GGR":900,"Cálculo - bônus convertidos":300},
      {"DATA":"2025-08-09","Usuário - Nome de usuário":"Clube A","Usuário - FTD-Montante":1200,"Usuário - Depósitos":4800,"Cálculo - GGR":2900,"Sportsbook - GGR":1600,"Cassino - GGR":1300,"Cálculo - bônus convertidos":420},
      {"DATA":"2025-08-09","Usuário - Nome de usuário":"Clube B","Usuário - FTD-Montante":850,"Usuário - Depósitos":3500,"Cálculo - GGR":1900,"Sportsbook - GGR":1100,"Cassino - GGR":800,"Cálculo - bônus convertidos":280}
    ];

    function showLoading(on, msg="Carregando dados..."){
      document.getElementById("loadingMessage").textContent = msg;
      document.getElementById("loadingOverlay").style.display = on ? "flex" : "none";
    }

    function criarGrafico(ctx, labelA, labelB, colorA, colorB, type='line'){
      return new Chart(ctx, {
        type,
        data:{labels:[],datasets:[
          {label:labelA,data:[],borderColor:colorA,backgroundColor:type==='bar'?colorA+'CC':'transparent',fill:type==='line',tension:.3,borderWidth:3,pointRadius:4,pointBackgroundColor:colorA},
          {label:labelB,data:[],borderColor:colorB,backgroundColor:type==='bar'?colorB+'CC':'transparent',fill:type==='line',tension:.3,borderWidth:3,pointRadius:4,pointBackgroundColor:colorB}
        ]},
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{
            legend:{position:'top',labels:{color:'#ecf0f1',font:{size:14},filter:(i)=>i.text!==""}},
            tooltip:{callbacks:{label:(ctx)=>ctx.dataset.label?`${ctx.dataset.label}: R$ ${ctx.parsed.y.toLocaleString('pt-BR',{minimumFractionDigits:2})}`:null},
                     backgroundColor:'rgba(26,37,47,.9)',titleColor:'#3498db',bodyColor:'#ecf0f1',displayColors:false,padding:12,borderColor:'rgba(255,255,255,.1)',borderWidth:1}
          },
          scales:{
            y:{beginAtZero:true,ticks:{callback:v=>`R$ ${v.toLocaleString('pt-BR',{minimumFractionDigits:0})}`,color:'#bdc3c7'},grid:{color:'rgba(255,255,255,.05)'}},
            x:{ticks:{color:'#bdc3c7'},grid:{color:'rgba(255,255,255,.05)'}}
          }
        }
      });
    }

    function animarKPI(sel, novo, anterior, label='vs período anterior'){
      const el = document.querySelector(sel + " .valor");
      const varEl = document.querySelector(sel + " .variacao");

      let variacaoText = '—', cor = '#bdc3c7';
      if (Number.isFinite(anterior) && anterior !== 0){
        const pct = ((novo - anterior) / Math.abs(anterior)) * 100; // usa |anterior| p/ lidar com negativos
        variacaoText = `${pct>=0?'+':''}${pct.toFixed(1)}%`;
        cor = pct>=0 ? '#2ecc71' : '#e74c3c';
      }
      varEl.innerHTML = `<span style="color:${cor}">${variacaoText}</span><span class="hint">${label}</span>`;

      const kpi = document.querySelector(sel);
      kpi.classList.remove("positive","negative");
      kpi.classList.add(novo >= (anterior ?? 0) ? "positive" : "negative");

      let ant = parseFloat(el.textContent.replace(/[^\d]/g,'')) || 0;
      let diff = (novo - ant) / 30, cur = ant, pass = 0;
      const h = setInterval(()=>{
        cur += diff; pass++;
        if (pass >= 30){ clearInterval(h); cur = novo; }
        el.textContent = "R$ " + cur.toLocaleString('pt-BR',{minimumFractionDigits:2});
      },20);
    }

    function carregar(){
      showLoading(true,"Conectando à fonte de dados...");
      const url = URL_CSV + "&" + Date.now();
      Papa.parse(url,{
        download:true, header:true,
        complete:(r)=>{
          if (r.data && r.data.length){
            dados = r.data
              .filter(x => x.DATA || x.Data)
              .map(x => {
                if (x.Data && !x.DATA) x.DATA = x.Data;
                if (!x["Usuário - Nome de usuário"] && x["Usuário - Nome de username"]) {
                  x["Usuário - Nome de usuário"] = x["Usuário - Nome de username"];
                }
                return x;
              });
          } else {
            console.warn("Usando dados de demonstração");
            dados = DADOS_DEMO;
            document.getElementById("demoWarning").style.display = "block";
          }
          init();
        },
        error:()=>{
          console.warn("Erro ao carregar dados, usando demonstração");
          dados = DADOS_DEMO;
          document.getElementById("demoWarning").style.display = "block";
          init();
        }
      });
    }

    function init(){
      const nomeClubeKey = d => d["Usuário - Nome de usuário"] || d["Usuário - Nome de username"];
      let clubes = [...new Set(dados.map(nomeClubeKey))].filter(Boolean);

      let opts = '<option value="Todos">Todos os Clubes</option>' + clubes.map(c => `<option>${c}</option>`).join('');
      let optsClubeB = '<option value="Nenhum">Nenhum</option>' + opts;

      document.getElementById("filtroClubeA").innerHTML = opts;
      document.getElementById("filtroClubeB").innerHTML = optsClubeB;

      let hoje = new Date();
      let ontem = new Date(); ontem.setDate(hoje.getDate() - 1);
      document.getElementById("filtroInicio").value = ontem.toISOString().slice(0,10);
      document.getElementById("filtroFim").value = ontem.toISOString().slice(0,10);

      charts.chartComparativo = criarGrafico(document.getElementById("chartComparativo"), "Clube A", "Clube B", "#3498db", "#e74c3c", 'bar');
      charts.chartGGR         = criarGrafico(document.getElementById("chartGGR"), "Clube A GGR", "Clube B GGR", "#3498db", "#e74c3c");
      charts.chartDepositos   = criarGrafico(document.getElementById("chartDepositos"), "Clube A Depósitos", "Clube B Depósitos", "#3498db", "#e74c3c");
      charts.chartFTD         = criarGrafico(document.getElementById("chartFTD"), "Clube A FTD", "Clube B FTD", "#3498db", "#e74c3c");
      charts.chartSportsbook  = criarGrafico(document.getElementById("chartSportsbook"), "Clube A Sportsbook", "Clube B Sportsbook", "#3498db", "#e74c3c");
      charts.chartCassino     = criarGrafico(document.getElementById("chartCassino"), "Clube A Cassino", "Clube B Cassino", "#3498db", "#e74c3c");

      atualizar();
      showLoading(false);
      setInterval(atualizarDados, 300000);
    }

    function aplicarFiltros(){ atualizar(); }
    function setPeriodo(d){
      let hoje = new Date();
      let ontem = new Date(); ontem.setDate(hoje.getDate() - 1);
      let ini = new Date(ontem); ini.setDate(ontem.getDate() - (d - 1));
      document.getElementById("filtroInicio").value = ini.toISOString().slice(0,10);
      document.getElementById("filtroFim").value = ontem.toISOString().slice(0,10);
      atualizar();
    }
    function atualizarDados(){ showLoading(true,"Atualizando dados..."); carregar(); }

    function atualizar(){
      const ini = document.getElementById("filtroInicio").value;
      const fim = document.getElementById("filtroFim").value;

      const parseISO = s => { const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); };
      const fmtISO   = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);

      const iniDate = parseISO(ini);
      const fimDate = parseISO(fim);
      const days = Math.round((fimDate - iniDate)/86400000) + 1;

      const prevFim  = new Date(iniDate); prevFim.setDate(prevFim.getDate()-1);
      const prevIni  = new Date(prevFim); prevIni.setDate(prevIni.getDate()-(days-1));
      const prevIniStr = fmtISO(prevIni);
      const prevFimStr = fmtISO(prevFim);

      const nomeClubeOf = d => d["Usuário - Nome de usuário"] || d["Usuário - Nome de username"];

      let base = [...dados];
      if (document.getElementById("eliminarSuprema").checked) {
        base = base.filter(d => !CLUBES_SUPREMA_LIST.includes(nomeClubeOf(d)));
      }
      if (document.getElementById("eliminarToni").checked) {
        base = base.filter(d => nomeClubeOf(d) !== CLUBE_TONI);
      }

      const atual    = base.filter(d => d.DATA >= ini && d.DATA <= fim);
      const anterior = base.filter(d => d.DATA >= prevIniStr && d.DATA <= prevFimStr);

      const clubeA = document.getElementById("filtroClubeA").value;
      const clubeB = document.getElementById("filtroClubeB").value;

      const A_atual = obterDadosDoClube(atual,   clubeA);
      const B_atual = (clubeB !== "Nenhum" && clubeA !== clubeB) ? obterDadosDoClube(atual,   clubeB) : [];
      const A_prev  = obterDadosDoClube(anterior,clubeA);
      const B_prev  = (clubeB !== "Nenhum" && clubeA !== clubeB) ? obterDadosDoClube(anterior,clubeB) : [];

      // KPIs (período vs período anterior)
      atualizarKPIsPeriodo(A_atual, B_atual, A_prev, B_prev, `vs ${prevIniStr} – ${prevFimStr}`);

      // Gráficos (período atual)
      atualizarGraficos(A_atual, B_atual, clubeA, clubeB);

      // Tabelas (período atual vs período anterior)
      const labelComp = `vs ${prevIniStr} – ${prevFimStr}`;
      atualizarTabelas(atual, anterior, labelComp);

      document.getElementById("ultimaAtualizacao").textContent = new Date().toLocaleString('pt-BR');
    }

    function obterDadosDoClube(dadosBase, nomeClube){
      if (nomeClube === "Todos") return dadosBase;
      return dadosBase.filter(d => (d["Usuário - Nome de usuário"] === nomeClube) || (d["Usuário - Nome de username"] === nomeClube));
    }

    function atualizarKPIsPeriodo(dadosA_Periodo, dadosB_Periodo, dadosA_Prev=[], dadosB_Prev=[], label='vs período anterior'){
      const somar = (arr, campo) => arr.reduce((s,d)=> s + N(d[campo]), 0);
      const ftd   = somar(dadosA_Periodo,"Usuário - FTD-Montante")      + somar(dadosB_Periodo,"Usuário - FTD-Montante");
      const depo  = somar(dadosA_Periodo,"Usuário - Depósitos")         + somar(dadosB_Periodo,"Usuário - Depósitos");
      const ggr   = somar(dadosA_Periodo,"Cálculo - GGR")               + somar(dadosB_Periodo,"Cálculo - GGR");
      const sb    = somar(dadosA_Periodo,"Sportsbook - GGR")            + somar(dadosB_Periodo,"Sportsbook - GGR");
      const cs    = somar(dadosA_Periodo,"Cassino - GGR")               + somar(dadosB_Periodo,"Cassino - GGR");
      const bon   = somar(dadosA_Periodo,"Cálculo - bônus convertidos") + somar(dadosB_Periodo,"Cálculo - bônus convertidos");

      const ftdP = somar(dadosA_Prev,"Usuário - FTD-Montante")      + somar(dadosB_Prev,"Usuário - FTD-Montante");
      const depP = somar(dadosA_Prev,"Usuário - Depósitos")         + somar(dadosB_Prev,"Usuário - Depósitos");
      const ggrP = somar(dadosA_Prev,"Cálculo - GGR")               + somar(dadosB_Prev,"Cálculo - GGR");
      const sbP  = somar(dadosA_Prev,"Sportsbook - GGR")            + somar(dadosB_Prev,"Sportsbook - GGR");
      const csP  = somar(dadosA_Prev,"Cassino - GGR")               + somar(dadosB_Prev,"Cassino - GGR");
      const bonP = somar(dadosA_Prev,"Cálculo - bônus convertidos") + somar(dadosB_Prev,"Cálculo - bônus convertidos");

      validateTotals({ ftd, depositos:depo, ggr, sportsbook:sb, cassino:cs, bonus:bon });

      animarKPI("#kpi-ftd",        ftd,  ftdP, label);
      animarKPI("#kpi-depositos",  depo, depP, label);
      animarKPI("#kpi-ggr",        ggr,  ggrP, label);
      animarKPI("#kpi-sportsbook", sb,   sbP,  label);
      animarKPI("#kpi-cassino",    cs,   csP,  label);
      animarKPI("#kpi-bonus",      bon,  bonP, label);
    }

    function atualizarGraficos(dadosA, dadosB, nomeA, nomeB){
      const agrupaPorData = arr => {
        const out = {};
        arr.forEach(d => {
          out[d.DATA] = out[d.DATA] || { ggr:0, dep:0, ftd:0, sb:0, cs:0, bo:0 };
          out[d.DATA].ggr += N(d["Cálculo - GGR"]);
          out[d.DATA].dep += N(d["Usuário - Depósitos"]);
          out[d.DATA].ftd += N(d["Usuário - FTD-Montante"]);
          out[d.DATA].sb  += N(d["Sportsbook - GGR"]);
          out[d.DATA].cs  += N(d["Cassino - GGR"]);
          out[d.DATA].bo  += N(d["Cálculo - bônus convertidos"]);
        });
        return out;
      };

      const gA = agrupaPorData(dadosA);
      const gB = dadosB.length ? agrupaPorData(dadosB) : {};
      const datas = [...new Set([...Object.keys(gA), ...Object.keys(gB)])].sort();

      const isB = nomeB !== "Nenhum";
      const corB = isB ? "#e74c3c" : "rgba(0,0,0,0)";
      const labelB = isB ? nomeB : "";

      function upd(chartId, campo){
        let c = charts[chartId];
        c.data.labels = datas;
        c.data.datasets[0].label = nomeA;
        c.data.datasets[0].data  = datas.map(d => gA[d]?.[campo] || 0);
        c.data.datasets[1].label = labelB;
        c.data.datasets[1].borderColor = corB;
        c.data.datasets[1].backgroundColor = isB ? (c.config.type==='bar' ? corB+'CC' : 'transparent') : 'rgba(0,0,0,0)';
        c.data.datasets[1].pointBackgroundColor = corB;
        c.data.datasets[1].pointRadius = isB ? 4 : 0;
        c.data.datasets[1].data  = datas.map(d => gB[d]?.[campo] || 0);
        c.update();
      }

      upd("chartGGR","ggr");
      upd("chartDepositos","dep");
      upd("chartFTD","ftd");
      upd("chartSportsbook","sb");
      upd("chartCassino","cs");

      const somar = (arr, field) => arr.reduce((s, d) => s + N(d[field]), 0);
      charts.chartComparativo.data.labels = ['FTD','Depósitos','GGR','Sportsbook','Cassino','Bônus'];
      charts.chartComparativo.data.datasets[0].label = nomeA;
      charts.chartComparativo.data.datasets[1].label = labelB;
      charts.chartComparativo.data.datasets[1].backgroundColor = isB ? "#e74c3cCC" : "rgba(0,0,0,0)";
      charts.chartComparativo.data.datasets[1].borderColor = corB;

      charts.chartComparativo.data.datasets[0].data = [
        somar(dadosA,"Usuário - FTD-Montante"),
        somar(dadosA,"Usuário - Depósitos"),
        somar(dadosA,"Cálculo - GGR"),
        somar(dadosA,"Sportsbook - GGR"),
        somar(dadosA,"Cassino - GGR"),
        somar(dadosA,"Cálculo - bônus convertidos")
      ];
      charts.chartComparativo.data.datasets[1].data = isB ? [
        somar(dadosB,"Usuário - FTD-Montante"),
        somar(dadosB,"Usuário - Depósitos"),
        somar(dadosB,"Cálculo - GGR"),
        somar(dadosB,"Sportsbook - GGR"),
        somar(dadosB,"Cassino - GGR"),
        somar(dadosB,"Cálculo - bônus convertidos")
      ] : [0,0,0,0,0,0];

      charts.chartComparativo.update();
    }

    // Tabelas: período atual vs período anterior (mesmo tamanho)
    function atualizarTabelas(dadosAtual, dadosAnterior, labelComp='vs período anterior'){
      const nomeClubeKey = d => d["Usuário - Nome de usuário"] || d["Usuário - Nome de username"];

      const somarPorClube = (arr, field) => arr.reduce((acc, d) => {
        const clube = nomeClubeKey(d);
        const v = N(d[field]);
        acc[clube] = (acc[clube] || 0) + v;
        return acc;
      }, {});

      function preenche(id, field){
        const mapaAtual = somarPorClube(dadosAtual, field);
        const mapaAnt   = somarPorClube(dadosAnterior, field);
        const top10 = Object.entries(mapaAtual).sort((a,b)=> b[1]-a[1]).slice(0,10);

        const html = top10.map(([clube, vAtual])=>{
          const vAnt = mapaAnt[clube] ?? 0;

          let pctTxt = '—', cor = '#bdc3c7';
          if (vAnt !== 0){
            const pct = ((vAtual - vAnt) / Math.abs(vAnt)) * 100;
            pctTxt = `${pct>=0?'+':''}${pct.toFixed(1)}%`;
            cor = pct>=0 ? '#2ecc71' : '#e74c3c';
          }
          const delta = vAtual - (vAnt || 0);
          const deltaTxt = (delta>=0?'+':'') + delta.toLocaleString('pt-BR',{minimumFractionDigits:2});

          return `<tr>
            <td title="${clube}">${clube}</td>
            <td>R$ ${vAtual.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
            <td style="color:${cor}">
              ${pctTxt} <span class="hint">${labelComp}</span>
              <br><small>Δ R$ ${deltaTxt}</small>
            </td>
          </tr>`;
        }).join('');

        document.querySelector(id + ' tbody').innerHTML = html;
      }

      preenche("#topDepositos","Usuário - Depósitos");
      preenche("#topFTD","Usuário - FTD-Montante");
      preenche("#topGGR","Cálculo - GGR");
      preenche("#topSportsbook","Sportsbook - GGR");
      preenche("#topCassino","Cassino - GGR");
      preenche("#topBonus","Cálculo - bônus convertidos");

      // anota o subtítulo uma vez
      document.querySelectorAll('.table-container h3').forEach(h=>{
        if(!h.dataset.annotated){
          h.innerHTML += ` <small style="opacity:.7;font-weight:500">(comparado ao período anterior)</small>`;
          h.dataset.annotated = '1';
        }
      });
    }

    function exportarCSV(){
      let csv = Papa.unparse(dados);
      let blob = new Blob(["\uFEFF" + csv], {type:"text/csv;charset=utf-8;"});
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "dados_clubes.csv";
      a.click();
    }

    function toggleDarkMode(){ document.body.classList.toggle('light-mode'); }

    document.addEventListener('DOMContentLoaded', function(){
      document.getElementById('btnOntem').addEventListener('click', ()=>setPeriodo(1));
      document.getElementById('btnUltimos7').addEventListener('click', ()=>setPeriodo(7));
      document.getElementById('btnUltimos30').addEventListener('click', ()=>setPeriodo(30));
      document.getElementById('btnAplicar').addEventListener('click', aplicarFiltros);
      document.getElementById('btnExportar').addEventListener('click', exportarCSV);
      document.getElementById('btnDarkMode').addEventListener('click', toggleDarkMode);
      document.getElementById('btnAtualizar').addEventListener('click', atualizarDados);
      document.getElementById('eliminarSuprema').addEventListener('change', atualizar);
      document.getElementById('eliminarToni').addEventListener('change', atualizar);

      document.querySelectorAll('.kpi, .btn-period, .btn-apply, .btn-export, .btn-mode').forEach(el=>{
        el.addEventListener('mouseenter', ()=> el.style.transform='translateY(-3px)');
        el.addEventListener('mouseleave', ()=> el.style.transform='none');
      });

      carregar();
    });
  </script>
</body>
</html>
