<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Clubes</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { background: black; color: lime; font-family: Arial, sans-serif; margin: 0; }
        h1 { text-align: center; padding: 10px; }
        .filtros { text-align: center; margin-bottom: 20px; }
        .cards { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .card { background: #111; border: 2px solid lime; border-radius: 10px; padding: 10px; text-align: center; width: 180px; }
        .charts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 0 20px; }
        .chart-container { background: #111; border: 2px solid lime; border-radius: 10px; padding: 10px; height: 250px; }
        .tops { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; color: lime; font-size: 0.9em; }
        th, td { border: 1px solid lime; padding: 5px; text-align: left; }
        .footer { text-align: center; font-size: 0.8em; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Dashboard de Clubes</h1>
    <div class="filtros">
        Data: <input type="date" id="filtroData">
        Clube: <select id="filtroClube"><option>Todos</option></select>
        <button onclick="aplicarFiltro()">Aplicar</button>
    </div>
    <div class="cards">
        <div class="card"><h3>FTD</h3><p id="ftdValor">R$ 0,00</p></div>
        <div class="card"><h3>Depósitos</h3><p id="depositosValor">R$ 0,00</p></div>
        <div class="card"><h3>GGR</h3><p id="ggrValor">R$ 0,00</p></div>
        <div class="card"><h3>Sportsbook GGR</h3><p id="sportsbookValor">R$ 0,00</p></div>
        <div class="card"><h3>Cassino GGR</h3><p id="cassinoValor">R$ 0,00</p></div>
    </div>
    <div class="charts">
        <div class="chart-container"><canvas id="chartGGR"></canvas></div>
        <div class="chart-container"><canvas id="chartDepositos"></canvas></div>
        <div class="chart-container"><canvas id="chartFTD"></canvas></div>
        <div class="chart-container"><canvas id="chartSportsbook"></canvas></div>
        <div class="chart-container"><canvas id="chartCassino"></canvas></div>
    </div>
    <div class="tops">
        <div><h3>Top 10 Clubes - GGR</h3><table id="topGGR"></table></div>
        <div><h3>Top 10 Clubes - Depósitos</h3><table id="topDepositos"></table></div>
        <div><h3>Top 10 Clubes - FTD</h3><table id="topFTD"></table></div>
        <div><h3>Top 10 Clubes - Sportsbook GGR</h3><table id="topSportsbook"></table></div>
        <div><h3>Top 10 Clubes - Cassino GGR</h3><table id="topCassino"></table></div>
    </div>
    <div class="footer">Última atualização: <span id="atualizacao"></span></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";

let dados = [];
let charts = {};

console.log("Rodando versão DEBUG");

Papa.parse(CSV_URL, {
    download: true,
    header: true,
    complete: function(results) {
        console.log("CSV carregado:", results.data.length, "linhas");
        dados = results.data;
        preencherClubes();
        aplicarFiltro();
    },
    error: function(err) {
        console.error("Erro ao carregar CSV:", err);
    }
});

function preencherClubes() {
    const clubes = [...new Set(dados.map(l => l["Clube"]).filter(Boolean))];
    const select = document.getElementById('filtroClube');
    clubes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
    });
}

function aplicarFiltro() {
    const dataFiltro = document.getElementById('filtroData').value;
    const clubeFiltro = document.getElementById('filtroClube').value;
    console.log("Filtro aplicado:", { dataFiltro, clubeFiltro });

    let filtrados = dados;
    if (dataFiltro) filtrados = filtrados.filter(d => d["DATA"] === dataFiltro);
    if (clubeFiltro && clubeFiltro !== "Todos") filtrados = filtrados.filter(d => d["Clube"] === clubeFiltro);

    console.log("Registros filtrados:", filtrados.length);
    atualizarDashboard(filtrados);
}

function atualizarDashboard(filtrados) {
    const soma = (campo) => filtrados.reduce((acc, d) => acc + parseFloat(d[campo] || 0), 0);
    document.getElementById("ftdValor").textContent = formatar(soma("Usuário - FTD-Montante"));
    document.getElementById("depositosValor").textContent = formatar(soma("Usuário - Depósitos"));
    document.getElementById("ggrValor").textContent = formatar(soma("Cálculo - GGR"));
    document.getElementById("sportsbookValor").textContent = formatar(soma("Sportsbook - GGR"));
    document.getElementById("cassinoValor").textContent = formatar(soma("Cassino - GGR"));

    montarGraficos(filtrados);
    montarTabelas(filtrados);

    document.getElementById("atualizacao").textContent = new Date().toLocaleString();
}

function montarGraficos(dados) {
    const dias = [...new Set(dados.map(d => d["DATA"]))];
    const somaPorDia = (campo) => dias.map(dia => 
        dados.filter(l => l["DATA"] === dia).reduce((acc, l) => acc + parseFloat(l[campo] || 0), 0)
    );

    criarChart("chartGGR", "GGR", dias, somaPorDia("Cálculo - GGR"), "lime");
    criarChart("chartDepositos", "Depósitos", dias, somaPorDia("Usuário - Depósitos"), "blue");
    criarChart("chartFTD", "FTD", dias, somaPorDia("Usuário - FTD-Montante"), "yellow");
    criarChart("chartSportsbook", "Sportsbook GGR", dias, somaPorDia("Sportsbook - GGR"), "orange");
    criarChart("chartCassino", "Cassino GGR", dias, somaPorDia("Cassino - GGR"), "purple");
}

function criarChart(id, label, labels, data, color) {
    if (charts[id]) charts[id].destroy();
    charts[id] = new Chart(document.getElementById(id), {
        type: 'line',
        data: { labels, datasets: [{ label, data, borderColor: color, fill: false }] },
        options: { responsive: true, plugins: { legend: { labels: { color: "lime" } } }, scales: { x: { ticks: { color: "lime" } }, y: { ticks: { color: "lime" } } } }
    });
}

function montarTabelas(dados) {
    criarTabela("topGGR", ordenar(dados, "Cálculo - GGR"));
    criarTabela("topDepositos", ordenar(dados, "Usuário - Depósitos"));
    criarTabela("topFTD", ordenar(dados, "Usuário - FTD-Montante"));
    criarTabela("topSportsbook", ordenar(dados, "Sportsbook - GGR"));
    criarTabela("topCassino", ordenar(dados, "Cassino - GGR"));
}

function ordenar(dados, campo) {
    const grupos = {};
    dados.forEach(d => {
        const c = d["Clube"] || "Sem Clube";
        grupos[c] = (grupos[c] || 0) + parseFloat(d[campo] || 0);
    });
    return Object.entries(grupos).sort((a, b) => b[1] - a[1]).slice(0, 10);
}

function criarTabela(id, lista) {
    const table = document.getElementById(id);
    table.innerHTML = "<tr><th>Clube</th><th>Valor</th></tr>" +
        lista.map(l => `<tr><td>${l[0]}</td><td>${formatar(l[1])}</td></tr>`).join("");
}

function formatar(num) { return `R$ ${num.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`; }
</script>
</body>
</html>
