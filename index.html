<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Comparativo de Clubes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    /* --- seu CSS atual aqui --- */
  </style>
</head>
<body class="dark-mode">
  <div class="container">
    <!-- cabeçalho, filtros, inputs e botões -->
    <!-- ... seu HTML atual até a parte das tabelas ... -->
  </div>

  <script>
    // Listas fixas de exclusão
    const CLUBES_SUPREMA = [
      'romulo@xpgames.bet',
      'lucasfarinha@maximabet.net',
      'superodds@gmail.com',
      'clubedokw@gmail.com',
      'tropadogg@gmail.com',
      'galeradoinsta@gmail.com'
    ];
    const CLUBE_TONI = 'crisslots123@gmail.com';

    const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv';
    
    let charts = {};
    let dashboardData = null;
    let filteredData = null;
    let rawAll = [];

    function formatMoney(value) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    }
    function parseCurrency(value) {
      if (typeof value === 'number') return value;
      if (!value) return 0;
      return parseFloat(value.replace('R$', '').replace(/\./g, '').replace(',', '.')) || 0;
    }

    async function fetchSpreadsheetData() {
      const response = await fetch(SPREADSHEET_URL);
      if (!response.ok) throw new Error('Erro ao acessar a planilha');
      return await response.text();
    }
    function processCSVData(csvData) {
      return new Promise((resolve, reject) => {
        Papa.parse(csvData, {
          header: true,
          skipEmptyLines: true,
          complete: res => res.errors.length ? reject(res.errors) : resolve(res.data),
          error: reject
        });
      });
    }

    function transformData(rawData) {
      if (!rawData.length) return null;
      const totals = { ftd: 0, depositos: 0, ggr: 0, sportsbook: 0, cassino: 0, bonus: 0 };
      const dates = [...new Set(rawData.map(r => r['DATA']))].sort();
      const chartsData = { ggr: Array(dates.length).fill(0), depositos: Array(dates.length).fill(0), ftd: Array(dates.length).fill(0), sportsbook: Array(dates.length).fill(0), cassino: Array(dates.length).fill(0) };
      const tablesData = { depositos: {}, ftd: {}, ggr: {}, sportsbook: {}, cassino: {}, bonus: {} };

      rawData.forEach(r => {
        const club = r['Usuário - Nome de usuário'] || '(Sem clube)';
        const dateIndex = dates.indexOf(r['DATA']);
        const ftdVal = parseCurrency(r['Usuário - FTD-Montante']);
        const depVal = parseCurrency(r['Usuário - Depósitos']);
        const ggrVal = parseCurrency(r['Cálculo - GGR']);
        const sbVal = parseCurrency(r['Sportsbook - GGR']);
        const csVal = parseCurrency(r['Cassino - GGR']);
        const bnVal = parseCurrency(r['Cálculo - bônus convertidos']);

        totals.ftd += ftdVal;
        totals.depositos += depVal;
        totals.ggr += ggrVal;
        totals.sportsbook += sbVal;
        totals.cassino += csVal;
        totals.bonus += bnVal;

        if (dateIndex >= 0) {
          chartsData.ftd[dateIndex] += ftdVal;
          chartsData.depositos[dateIndex] += depVal;
          chartsData.ggr[dateIndex] += ggrVal;
          chartsData.sportsbook[dateIndex] += sbVal;
          chartsData.cassino[dateIndex] += csVal;
        }

        if (!tablesData.depositos[club]) {
          tablesData.depositos[club] = 0;
          tablesData.ftd[club] = 0;
          tablesData.ggr[club] = 0;
          tablesData.sportsbook[club] = 0;
          tablesData.cassino[club] = 0;
          tablesData.bonus[club] = 0;
        }
        tablesData.depositos[club] += depVal;
        tablesData.ftd[club] += ftdVal;
        tablesData.ggr[club] += ggrVal;
        tablesData.sportsbook[club] += sbVal;
        tablesData.cassino[club] += csVal;
        tablesData.bonus[club] += bnVal;
      });

      const top10 = data => Object.entries(data)
        .map(([clube, valor]) => ({ clube, valor, variacao: valor, delta: `+${valor.toLocaleString('pt-BR')}` }))
        .sort((a, b) => b.valor - a.valor)
        .slice(0, 10);

      return {
        kpis: {
          ftd: { value: totals.ftd }, depositos: { value: totals.depositos },
          ggr: { value: totals.ggr }, sportsbook: { value: totals.sportsbook },
          cassino: { value: totals.cassino }, bonus: { value: totals.bonus }
        },
        charts: {
          comparativo: { labels: ['FTD', 'Depósitos', 'GGR', 'Sportsbook', 'Cassino', 'Bônus'], dataA: [totals.ftd, totals.depositos, totals.ggr, totals.sportsbook, totals.cassino, totals.bonus], dataB: [0,0,0,0,0,0] },
          ggr: { labels: dates, data: chartsData.ggr },
          depositos: { labels: dates, data: chartsData.depositos },
          ftd: { labels: dates, data: chartsData.ftd },
          sportsbook: { labels: dates, data: chartsData.sportsbook },
          cassino: { labels: dates, data: chartsData.cassino }
        },
        tables: {
          depositos: top10(tablesData.depositos),
          ftd: top10(tablesData.ftd),
          ggr: top10(tablesData.ggr),
          sportsbook: top10(tablesData.sportsbook),
          cassino: top10(tablesData.cassino),
          bonus: top10(tablesData.bonus)
        }
      };
    }

    function applyFilters() {
      if (!rawAll.length) return;
      const excludeSuprema = document.getElementById('eliminarSuprema').checked;
      const excludeToni = document.getElementById('eliminarToni').checked;
      
      let filtered = rawAll.filter(r => {
        const clubName = (r['Usuário - Nome de usuário'] || '').trim().toLowerCase();
        if (excludeSuprema && CLUBES_SUPREMA.map(c => c.toLowerCase()).includes(clubName)) return false;
        if (excludeToni && clubName === CLUBE_TONI.toLowerCase()) return false;
        return true;
      });

      dashboardData = transformData(filtered);
      filteredData = JSON.parse(JSON.stringify(dashboardData));
    }

    async function fetchData() {
      const csvData = await fetchSpreadsheetData();
      rawAll = await processCSVData(csvData);
      applyFilters();
      updateKPIs();
      updateCharts();
      updateTables();
    }

    function updateKPIs() {
      document.querySelector('#kpi-ftd .vl').textContent = formatMoney(filteredData.kpis.ftd.value);
      document.querySelector('#kpi-dep .vl').textContent = formatMoney(filteredData.kpis.depositos.value);
      document.querySelector('#kpi-ggr .vl').textContent = formatMoney(filteredData.kpis.ggr.value);
      document.querySelector('#kpi-sb .vl').textContent = formatMoney(filteredData.kpis.sportsbook.value);
      document.querySelector('#kpi-cs .vl').textContent = formatMoney(filteredData.kpis.cassino.value);
      document.querySelector('#kpi-bn .vl').textContent = formatMoney(filteredData.kpis.bonus.value);
    }

    function updateCharts() {
      /* implementação dos gráficos como já estava no seu código */
    }
    function updateTables() {
      /* implementação das tabelas como já estava no seu código */
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('eliminarSuprema').addEventListener('change', fetchData);
      document.getElementById('eliminarToni').addEventListener('change', fetchData);
      fetchData();
    });
  </script>
</body>
</html>
