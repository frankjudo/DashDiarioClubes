<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Comparativo de Clubes</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <style>
    :root{
      --dark:#0f1b25; --card:#142635; --card2:#112331;
      --txt:#e9f3ff; --muted:#9fb3c2; --accent:#47b3ff; --up:#2ecc71; --down:#e74c3c;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:linear-gradient(180deg,#0f1b25,#132130);color:var(--txt);padding:20px}
    .container{max-width:1800px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px}
    header h1{margin:0;font-size:28px;font-weight:800}
    header .sub{color:var(--muted)}
    .controls,.card,.table{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid rgba(255,255,255,.06);border-radius:14px}
    .controls{padding:16px;margin-bottom:16px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .controls h3{margin:0 0 10px;color:#9fd7ff;font-size:15px}
    label{color:#cfe3f0;font-weight:600}
    input,select{background:#0f1b25;color:#e8f3ff;border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px 12px}
    input:focus,select:focus{outline:none;border-color:#47b3ff;box-shadow:0 0 0 3px rgba(71,179,255,.18)}
    .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn-ghost{background:#0f283b;color:#7fd0ff;border:1px solid rgba(71,179,255,.35)}
    .btn-apply{background:#0f2b1e;color:#8cffc6;border:1px solid rgba(46,204,113,.35)}
    .btn-util{background:#2a1f0e;color:#ffd389;border:1px solid rgba(243,156,18,.35)}
    .btn:hover{filter:brightness(1.06)}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-bottom:16px}
    .kpi{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:14px}
    .kpi .hd{display:flex;justify-content:space-between;align-items:center}
    .kpi .hd h4{margin:0;color:#9fb6c6}
    .kpi .vl{font-size:24px;font-weight:900;margin-top:8px}
    .kpi .var{margin-top:8px;font-weight:800}
    .up{color:#8affc4} .down{color:#ff9e9e} .flat{color:#cdd9e1}
    
    /* ########## CORREÇÃO APLICADA AQUI ########## */
    .charts{
      display:grid;
      /* Força a grade a ter sempre 3 colunas, evitando que se estiquem */
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-bottom:16px
    }

    .card{padding:14px}
    .card h3{margin:0 0 12px;color:#9fd7ff;font-size:16px;display:flex;gap:8px;align-items:center}
    
    .tables{display:grid;grid-template-columns:repeat(auto-fit,minmax(420px,1fr));gap:12px}
    .table{padding:14px}
    .table h3{margin:0 0 10px;color:#9fd7ff;font-size:16px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{color:#8ab6cd;font-size:.9rem;text-transform:uppercase;padding:0 8px}
    tbody tr{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06)}
    tbody td{padding:8px 8px}
    tbody tr td:first-child{border-radius:10px 0 0 10px}
    tbody tr td:last-child{border-radius:0 10px 10px 0}
    .pills{display:flex;gap:6px;flex-wrap:wrap}
    .pill{border-radius:999px;border:1px solid; padding:3px 8px; font-weight:900; font-size:.8rem}
    .pill.up{border-color:rgba(46,204,113,.35);background:rgba(46,204,113,.12);color:#8affc4}
    .pill.down{border-color:rgba(231,76,60,.35);background:rgba(231,76,60,.12);color:#ff9e9e}
    .pill.flat{border-color:rgba(185,197,205,.35);background:rgba(185,197,205,.12);color:#cdd9e1}
    .muted{color:var(--muted)}
    
    /* Ajuste para telas menores: os gráficos e tabelas viram uma única coluna */
    @media (max-width:1200px){
      .charts, .tables {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1><i class="fas fa-chart-line"></i> Dashboard Comparativo de Clubes</h1>
        <div class="sub">Visão executiva com comparação automática vs período anterior</div>
      </div>
      <div class="sub" id="ultimaAtualizacao">—</div>
    </header>

    <div class="controls">
      <div class="row" style="margin-bottom:10px">
        <h3><i class="fas fa-calendar-alt"></i> Período</h3>
      </div>
      <div class="row" style="margin-bottom:12px">
        <label for="filtroInicio">De</label><input type="date" id="filtroInicio">
        <label for="filtroFim">até</label><input type="date" id="filtroFim">
        <button class="btn btn-ghost" id="btnOntem"><i class="fa-solid fa-calendar-day"></i> Ontem</button>
        <button class="btn btn-ghost" id="btnUltimos7"><i class="fa-solid fa-calendar-week"></i> Últimos 7 dias</button>
        <button class="btn btn-ghost" id="btnUltimos30"><i class="fa-solid fa-calendar-alt"></i> Últimos 30 dias</button>
        <button class="btn btn-apply" id="btnAplicar"><i class="fa-solid fa-filter"></i> Aplicar</button>
      </div>

      <div class="row" style="margin-bottom:12px">
        <h3><i class="fas fa-users"></i> Clubes</h3>
      </div>
      <div class="row" style="margin-bottom:12px">
        <label for="filtroClubeA">Clube A</label><select id="filtroClubeA"></select>
        <label for="filtroClubeB">Clube B</label><select id="filtroClubeB"></select>
      </div>

      <div class="row">
        <h3><i class="fas fa-cog"></i> Ações</h3>
      </div>
      <div class="row">
        <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="eliminarSuprema"> Eliminar Clubes Suprema</label>
        <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="eliminarToni"> Eliminar TONI</label>
        <button class="btn btn-util" id="btnExportar"><i class="fa-solid fa-file-csv"></i> Exportar CSV</button>
        <button class="btn btn-util" id="btnDarkMode"><i class="fa-solid fa-moon"></i> Modo Escuro</button>
        <button class="btn btn-util" id="btnAtualizar"><i class="fa-solid fa-sync"></i> Atualizar</button>

        <label for="escalaMode" style="margin-left:10px">Escala dos gráficos:</label>
        <select id="escalaMode">
          <option value="tipo" selected>Por tipo (recomendado)</option>
          <option value="auto">Automática por gráfico</option>
          <option value="global">Única (todos os gráficos)</option>
        </select>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi" id="kpi-ftd">
        <div class="hd"><h4>FTD</h4><i class="fa-solid fa-user-plus" style="color:#8affc4"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
      <div class="kpi" id="kpi-dep">
        <div class="hd"><h4>Depósitos</h4><i class="fa-solid fa-coins" style="color:#ffd389"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
      <div class="kpi" id="kpi-ggr">
        <div class="hd"><h4>GGR</h4><i class="fa-solid fa-chart-line" style="color:#8fd0ff"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
      <div class="kpi" id="kpi-sb">
        <div class="hd"><h4>Sportsbook GGR</h4><i class="fa-solid fa-futbol" style="color:#d7b2ff"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
      <div class="kpi" id="kpi-cs">
        <div class="hd"><h4>Cassino GGR</h4><i class="fa-solid fa-dice" style="color:#ff9e9e"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
      <div class="kpi" id="kpi-bn">
        <div class="hd"><h4>Bônus Convertidos</h4><i class="fa-solid fa-gift" style="color:#91ffbd"></i></div>
        <div class="vl">R$ 0</div>
        <div class="var">—</div>
      </div>
    </div>

    <div class="charts">
      <div class="card"><h3><i class="fa-solid fa-chart-bar"></i> Visão Geral Comparativa</h3><canvas id="chartComparativo"></canvas></div>
      <div class="card"><h3><i class="fa-solid fa-chart-line"></i> Evolução do GGR</h3><canvas id="chartGGR"></canvas></div>
      <div class="card"><h3><i class="fa-solid fa-money-bill-wave"></i> Evolução de Depósitos</h3><canvas id="chartDepositos"></canvas></div>
      <div class="card"><h3><i class="fa-solid fa-user-plus"></i> Evolução do FTD</h3><canvas id="chartFTD"></canvas></div>
      <div class="card"><h3><i class="fa-solid fa-futbol"></i> Evolução do Sportsbook</h3><canvas id="chartSportsbook"></canvas></div>
      <div class="card"><h3><i class="fa-solid fa-dice"></i> Evolução do Cassino</h3><canvas id="chartCassino"></canvas></div>
    </div>

    <div class="tables">
      <div class="table"><h3><i class="fa-solid fa-trophy"></i> Top 10 Depósitos (vs período anterior)</h3>
        <table id="topDepositos"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
      <div class="table"><h3><i class="fa-solid fa-trophy"></i> Top 10 FTD (vs período anterior)</h3>
        <table id="topFTD"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
      <div class="table"><h3><i class="fa-solid fa-trophy"></i> Top 10 GGR (vs período anterior)</h3>
        <table id="topGGR"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
      <div class="table"><h3><i class="fa-solid fa-futbol"></i> Top 10 GGR Sportsbook (vs período anterior)</h3>
        <table id="topSportsbook"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
      <div class="table"><h3><i class="fa-solid fa-dice"></i> Top 10 GGR Cassino (vs período anterior)</h3>
        <table id="topCassino"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
      <div class="table"><h3><i class="fa-solid fa-gift"></i> Top 10 Bônus Convertidos (vs período anterior)</h3>
        <table id="topBonus"><thead><tr><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead><tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <script>
    /* =================== Utils =================== */
    const URL_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
    const CLUBES_SUPREMA=['romulo@xpgames.bet','lucasfarinha@maximabet.net','superodds@gmail.com','clubedokw@gmail.com','tropadogg@gmail.com','galeradoinsta@gmail.com'];
    const CLUBE_TONI='crisslots123@gmail.com';

    const N=v=>{ if(v==null) return 0; let s=String(v).trim(); if(!s) return 0; s=s.replace(/\s+/g,'').replace(/\./g,'').replace(/,/g,'.'); let n=+s; return Number.isFinite(n)?n:0; };
    const BR=(n,d=2)=> n.toLocaleString('pt-BR',{minimumFractionDigits:d,maximumFractionDigits:d});

    // Demo mínimo
    const DEMO=[
      {"DATA":"2025-08-10","Usuário - Nome de usuário":"Clube A","Usuário - FTD-Montante":1500,"Usuário - Depósitos":5200,"Cálculo - GGR":3200,"Sportsbook - GGR":1800,"Cassino - GGR":1400,"Cálculo - bônus convertidos":450},
      {"DATA":"2025-08-10","Usuário - Nome de usuário":"Clube B","Usuário - FTD-Montante":900,"Usuário - Depósitos":3800,"Cálculo - GGR":2100,"Sportsbook - GGR":1200,"Cassino - GGR":900,"Cálculo - bônus convertidos":300},
      {"DATA":"2025-08-09","Usuário - Nome de usuário":"Clube A","Usuário - FTD-Montante":1200,"Usuário - Depósitos":4800,"Cálculo - GGR":2900,"Sportsbook - GGR":1600,"Cassino - GGR":1300,"Cálculo - bônus convertidos":420},
      {"DATA":"2025-08-09","Usuário - Nome de usuário":"Clube B","Usuário - FTD-Montante":850,"Usuário - Depósitos":3500,"Cálculo - GGR":1900,"Sportsbook - GGR":1100,"Cassino - GGR":800,"Cálculo - bônus convertidos":280}
    ];

    let dados=[], charts={};

    function criarChart(ctx, la, lb, ca, cb, type='line'){
      return new Chart(ctx,{
        type,
        data:{labels:[],datasets:[
          {label:la,data:[],borderColor:ca,backgroundColor:type==='bar'?ca+'AA':'transparent',fill:type==='line',tension:.35,borderWidth:2.4,pointRadius:3},
          {label:lb,data:[],borderColor:cb,backgroundColor:type==='bar'?cb+'AA':'transparent',fill:type==='line',tension:.35,borderWidth:2.4,pointRadius:3}
        ]},
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{legend:{labels:{color:'#cfe3f0'}},tooltip:{backgroundColor:'#0f1b25',titleColor:'#7fd0ff',bodyColor:'#e8f3ff',displayColors:false,
          callbacks:{label:(c)=>`${c.dataset.label}: R$ ${BR(c.parsed.y)}`}}},
          scales:{y:{ticks:{color:'#9fb3c2',callback:v=>`R$ ${BR(v,0)}`},grid:{color:'rgba(255,255,255,.06)'}},
                  x:{ticks:{color:'#9fb3c2'},grid:{color:'rgba(255,255,255,.04)'}}}
        }
      });
    }

    // ----- Escalas -----
    function niceStep(x){ const e=Math.pow(10, Math.floor(Math.log10(x||1))); const f=(x/e);
      const nf=(f<=1)?1:(f<=2)?2:(f<=2.5)?2.5:(f<=5)?5:10; return nf*e; }

    function scaleTo(chartsArr, values){
      if(!values.length){ chartsArr.forEach(c=>{ delete c.options.scales.y.suggestedMin; delete c.options.scales.y.suggestedMax; c.update(); }); return; }
      let min=Math.min(...values), max=Math.max(...values);
      if(min===Infinity||max===-Infinity){min=0;max=1;}
      let smin, smax;
      if(min<0 && max>0){
        const m=Math.max(Math.abs(min),Math.abs(max));
        const step=niceStep(m*0.2);
        smax=Math.ceil((m*1.05)/step)*step; smin=-smax;
      }else{
        const range=Math.max(1,Math.abs(max-min));
        const step=niceStep(range*0.2);
        smax=Math.ceil((max+step)/step)*step; smin=Math.floor((min-step)/step)*step;
      }
      chartsArr.forEach(c=>{ c.options.scales.y.suggestedMin=smin; c.options.scales.y.suggestedMax=smax; c.update(); });
    }

    function applyScaleMode(mode, series){
      const evolCharts = [charts.ggr, charts.dep, charts.ftd, charts.sb, charts.cs];

      if(mode === 'auto'){
        evolCharts.forEach(c=>{
          delete c.options.scales.y.suggestedMin;
          delete c.options.scales.y.suggestedMax;
          c.update();
        });
        return;
      }

      if(mode === 'global'){
        const allVals = [].concat(series.ggrA, series.ggrB, series.depA, series.depB,
                                  series.ftdA, series.ftdB, series.sbA, series.sbB,
                                  series.csA, series.csB);
        scaleTo(evolCharts, allVals);
        return;
      }

      // 'tipo' (recomendado): financeiros x menores
      const finCharts = [charts.dep, charts.ggr, charts.cs];
      const finVals   = [].concat(series.depA, series.depB, series.ggrA, series.ggrB, series.csA, series.csB);

      const smallCharts = [charts.ftd, charts.sb];
      const smallVals   = [].concat(series.ftdA, series.ftdB, series.sbA, series.sbB);

      scaleTo(finCharts, finVals);
      scaleTo(smallCharts, smallVals);
    }

    function setKPI(id, val, prev, label){
      const el=document.querySelector(id);
      el.querySelector('.vl').textContent=`R$ ${BR(val)}`;
      let cls='flat', txt='—';
      if(Number.isFinite(prev) && prev!==0){
        const p=((val-prev)/Math.abs(prev))*100;
        cls=p>=0?'up':'down'; txt=`${p>=0?'+':''}${p.toFixed(1)}% ${label}`;
      }
      el.querySelector('.var').innerHTML=`<span class="${cls}">${txt}</span>`;
    }

    /* =================== Fluxo =================== */
    function carregar(){
      Papa.parse(URL_CSV+'&'+Date.now(),{
        download:true,header:true,
        complete:r=>{
          if(r.data && r.data.length){
            dados=r.data.filter(x=>x.DATA||x.Data).map(x=>{ if(x.Data && !x.DATA) x.DATA=x.Data; if(!x["Usuário - Nome de usuário"] && x["Usuário - Nome de username"]) x["Usuário - Nome de usuário"]=x["Usuário - Nome de username"]; return x; });
          }else{dados=DEMO;}
          init();
        },
        error:()=>{dados=DEMO; init();}
      });
    }

    function init(){
      const getName=d=>d["Usuário - Nome de usuário"]||d["Usuário - Nome de username"];
      const clubes=[...new Set(dados.map(getName))].filter(Boolean);
      const opts='<option value="Todos">Todos os Clubes</option>'+clubes.map(c=>`<option>${c}</option>`).join('');
      const optsB='<option value="Nenhum">Nenhum</option>'+opts;
      document.getElementById('filtroClubeA').innerHTML=opts;
      document.getElementById('filtroClubeB').innerHTML=optsB;

      let hoje=new Date(), ontem=new Date(); ontem.setDate(hoje.getDate()-1);
      document.getElementById('filtroInicio').value=ontem.toISOString().slice(0,10);
      document.getElementById('filtroFim').value=ontem.toISOString().slice(0,10);

      charts.comp = criarChart(document.getElementById('chartComparativo'),"Clube A","Clube B","#47b3ff","#ff8282",'bar');
      charts.ggr = criarChart(document.getElementById('chartGGR'),"Clube A GGR","Clube B GGR","#47b3ff","#ff8282");
      charts.dep = criarChart(document.getElementById('chartDepositos'),"Clube A Depósitos","Clube B Depósitos","#47b3ff","#ff8282");
      charts.ftd = criarChart(document.getElementById('chartFTD'),"Clube A FTD","Clube B FTD","#47b3ff","#ff8282");
      charts.sb  = criarChart(document.getElementById('chartSportsbook'),"Clube A Sportsbook","Clube B Sportsbook","#47b3ff","#ff8282");
      charts.cs  = criarChart(document.getElementById('chartCassino'),"Clube A Cassino","Clube B Cassino","#47b3ff","#ff8282");

      bind();
      atualizar();
    }

    function bind(){
      const $=id=>document.getElementById(id);
      $('btnOntem').onclick=()=>setPeriodo(1);
      $('btnUltimos7').onclick=()=>setPeriodo(7);
      $('btnUltimos30').onclick=()=>setPeriodo(30);
      $('btnAplicar').onclick=atualizar;
      $('btnExportar').onclick=()=>{const csv=Papa.unparse(dados);const b=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='dados_clubes.csv';a.click();};
      $('btnDarkMode').onclick=()=>document.body.classList.toggle('light-mode');
      $('btnAtualizar').onclick=carregar;
      $('eliminarSuprema').onchange=atualizar;
      $('eliminarToni').onchange=atualizar;
      $('escalaMode').addEventListener('change', atualizar);
    }

    function setPeriodo(dias){
      let hoje=new Date(), ontem=new Date(); ontem.setDate(hoje.getDate()-1);
      let ini=new Date(ontem); ini.setDate(ontem.getDate()-(dias-1));
      document.getElementById('filtroInicio').value=ini.toISOString().slice(0,10);
      document.getElementById('filtroFim').value=ontem.toISOString().slice(0,10);
      atualizar();
    }

    function atualizar(){
      const name=d=>d["Usuário - Nome de usuário"]||d["Usuário - Nome de username"];
      const ini=document.getElementById('filtroInicio').value;
      const fim=document.getElementById('filtroFim').value;

      const parseISO=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d);};
      const fmtISO=d=> new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      const iniD=parseISO(ini), fimD=parseISO(fim);
      const dias=Math.round((fimD-iniD)/86400000)+1;
      const prevFim=new Date(iniD); prevFim.setDate(prevFim.getDate()-1);
      const prevIni=new Date(prevFim); prevIni.setDate(prevIni.getDate()-(dias-1));
      const prevIniStr=fmtISO(prevIni), prevFimStr=fmtISO(prevFim);
      const rotulo=`vs ${prevIniStr} – ${prevFimStr}`;

      // filtros extras
      let base=[...dados];
      if(document.getElementById('eliminarSuprema').checked) base=base.filter(d=>!CLUBES_SUPREMA.includes(name(d)));
      if(document.getElementById('eliminarToni').checked) base=base.filter(d=>name(d)!==CLUBE_TONI);

      const atual=base.filter(d=>d.DATA>=ini && d.DATA<=fim);
      const anterior=base.filter(d=>d.DATA>=prevIniStr && d.DATA<=prevFimStr);

      const clubeA=document.getElementById('filtroClubeA').value;
      const clubeB=document.getElementById('filtroClubeB').value;
      const sel=(arr,c)=> c==="Todos"?arr:arr.filter(d=>name(d)===c);
      const A_at=sel(atual,clubeA), B_at=(clubeB!=="Nenhum" && clubeA!==clubeB)?sel(atual,clubeB):[];
      const A_pr=sel(anterior,clubeA), B_pr=(clubeB!=="Nenhum" && clubeA!==clubeB)?sel(anterior,clubeB):[];

      // KPIs
      const sum=(a,k)=>a.reduce((s,d)=>s+N(d[k]),0);
      const FTD=sum(A_at,"Usuário - FTD-Montante")+sum(B_at,"Usuário - FTD-Montante");
      const DEP=sum(A_at,"Usuário - Depósitos")+sum(B_at,"Usuário - Depósitos");
      const GGR=sum(A_at,"Cálculo - GGR")+sum(B_at,"Cálculo - GGR");
      const SB =sum(A_at,"Sportsbook - GGR")+sum(B_at,"Sportsbook - GGR");
      const CS =sum(A_at,"Cassino - GGR")+sum(B_at,"Cassino - GGR");
      const BN =sum(A_at,"Cálculo - bônus convertidos")+sum(B_at,"Cálculo - bônus convertidos");

      const FTDp=sum(A_pr,"Usuário - FTD-Montante")+sum(B_pr,"Usuário - FTD-Montante");
      const DEPp=sum(A_pr,"Usuário - Depósitos")+sum(B_pr,"Usuário - Depósitos");
      const GGRp=sum(A_pr,"Cálculo - GGR")+sum(B_pr,"Cálculo - GGR");
      const SBp=sum(A_pr,"Sportsbook - GGR")+sum(B_pr,"Sportsbook - GGR");
      const CSp=sum(A_pr,"Cassino - GGR")+sum(B_pr,"Cassino - GGR");
      const BNp=sum(A_pr,"Cálculo - bônus convertidos")+sum(B_pr,"Cálculo - bônus convertidos");

      setKPI('#kpi-ftd',FTD,FTDp,rotulo);
      setKPI('#kpi-dep',DEP,DEPp,rotulo);
      setKPI('#kpi-ggr',GGR,GGRp,rotulo);
      setKPI('#kpi-sb',SB,SBp,rotulo);
      setKPI('#kpi-cs',CS,CSp,rotulo);
      setKPI('#kpi-bn',BN,BNp,rotulo);

      // ======= Gráficos - agregação por data =======
      const agg=arr=>{const o={}; arr.forEach(d=>{const k=d.DATA; o[k]=o[k]||{ggr:0,dep:0,ftd:0,sb:0,cs:0}; o[k].ggr+=N(d["Cálculo - GGR"]); o[k].dep+=N(d["Usuário - Depósitos"]); o[k].ftd+=N(d["Usuário - FTD-Montante"]); o[k].sb+=N(d["Sportsbook - GGR"]); o[k].cs+=N(d["Cassino - GGR"]);}); return o;};
      const AgA=agg(A_at), AgB=B_at.length?agg(B_at):{};
      const labels=[...new Set([...Object.keys(AgA),...Object.keys(AgB)])].sort();

      const isB=(clubeB!=="Nenhum");
      const labB=isB?clubeB:"";
      const corB=isB?"#ff8282":"rgba(0,0,0,0)";
      const upd=(chart,key,labA)=>{
        const c=charts[chart];
        const vA=labels.map(d=>AgA[d]?.[key]||0);
        const vB=labels.map(d=>AgB[d]?.[key]||0);
        c.data.labels=labels;
        c.data.datasets[0].label=labA;
        c.data.datasets[0].data=vA;
        c.data.datasets[1].label=labB;
        c.data.datasets[1].data=vB;
        c.data.datasets[1].borderColor=corB;
        c.data.datasets[1].backgroundColor=isB?'#ff8282AA':'rgba(0,0,0,0)';
        return {vA,vB};
      };

      const r1=upd('ggr','ggr',clubeA);
      const r2=upd('dep','dep',clubeA);
      const r3=upd('ftd','ftd',clubeA);
      const r4=upd('sb','sb',clubeA);
      const r5=upd('cs','cs',clubeA);

      // ----- ESCALAS conforme seletor -----
      const series = {
        ggrA: r1.vA, ggrB: r1.vB,
        depA: r2.vA, depB: r2.vB,
        ftdA: r3.vA, ftdB: r3.vB,
        sbA:  r4.vA, sbB:  r4.vB,
        csA:  r5.vA, csB:  r5.vB,
      };
      const mode = document.getElementById('escalaMode').value; // 'tipo' | 'auto' | 'global'
      applyScaleMode(mode, series);

      // Comparativo (barras) – escala própria
      const sA=[FTD,DEP,GGR,SB,CS,BN];
      const sB=isB?[sum(B_at,"Usuário - FTD-Montante"),sum(B_at,"Usuário - Depósitos"),sum(B_at,"Cálculo - GGR"),sum(B_at,"Sportsbook - GGR"),sum(B_at,"Cassino - GGR"),sum(B_at,"Cálculo - bônus convertidos")]:[0,0,0,0,0,0];
      charts.comp.data.labels=['FTD','Depósitos','GGR','Sportsbook','Cassino','Bônus'];
      charts.comp.data.datasets[0].label=clubeA; charts.comp.data.datasets[0].data=sA;
      charts.comp.data.datasets[1].label=labB;  charts.comp.data.datasets[1].data=sB;
      charts.comp.update();

      // Tabelas
      atualizarTabelas(atual,anterior);

      const now=new Date().toLocaleString('pt-BR');
      document.getElementById('ultimaAtualizacao').textContent='Atualizado em '+now;
    }

    function atualizarTabelas(dadosAtual,dadosAnterior){
      function fill(id,campo){
        const name=d=>d["Usuário - Nome de usuário"]||d["Usuário - Nome de username"];
        const sumBy=(arr)=>arr.reduce((acc,d)=>{const k=name(d); acc[k]=(acc[k]||0)+N(d[campo]); return acc;}, {});
        const A=sumBy(dadosAtual), P=sumBy(dadosAnterior);
        const top=Object.entries(A).sort((a,b)=>b[1]-a[1]).slice(0,10);
        const html=top.map(([clube,val])=>{
          const ant=P[clube]??0; let cls='flat',pct='—';
          if(ant){const p=((val-ant)/Math.abs(ant))*100; cls=p>=0?'up':'down'; pct=`${p>=0?'+':''}${p.toFixed(1)}%`; }
          return `<tr>
            <td>${clube}</td>
            <td>R$ ${BR(val)}</td>
            <td><div class="pills"><span class="pill ${cls}">${pct}</span><span class="pill ${val-ant>=0?'up':'down'}">Δ R$ ${val-ant>=0?'+':''}${BR(val-ant)}</span></div></td>
          </tr>`;
        }).join('');
        document.querySelector(id+' tbody').innerHTML=html || `<tr><td colspan="3" class="muted">Sem dados</td></tr>`;
      }
      fill('#topDepositos',"Usuário - Depósitos");
      fill('#topFTD',"Usuário - FTD-Montante");
      fill('#topGGR',"Cálculo - GGR");
      fill('#topSportsbook',"Sportsbook - GGR");
      fill('#topCassino',"Cassino - GGR");
      fill('#topBonus',"Cálculo - bônus convertidos");
    }

    document.addEventListener('DOMContentLoaded',carregar);
  </script>
</body>
</html>