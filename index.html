<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relatório dos clubes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#0e1621; --bg2:#0b1926;
      --card:#101f2d; --card2:#0f2130;
      --txt:#e9f3ff; --muted:#98a9b7; --accent:#49b6ff;
      --good:#28d07f; --bad:#ff5c5c;
      --border:rgba(255,255,255,.07); --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--txt)}
    .container{max-width:1700px;margin:0 auto;padding:22px}
    header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px}
    header h1{margin:0;font-size:28px;font-weight:900;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
    header .sub{color:var(--muted);font-weight:600}

    .panel{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--border);
      border-radius:16px; box-shadow:var(--shadow)}
    .controls{padding:16px 16px 10px; margin-bottom:16px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
    label{font-weight:800;font-size:14px}
    input,select{background:#0b2435;color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(73,182,255,.18)}

    .btn{padding:10px 14px;border:none;border-radius:12px;font-weight:900;letter-spacing:.2px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;transition:all .15s}
    .btn:hover{transform:translateY(-1px);filter:brightness(1.1)}
    .btn:active{transform:translateY(0)}
    .btn-ghost{background:#0e2c43;border:1px solid rgba(73,182,255,.35);color:var(--accent)}
    .btn-apply{background:#133822;border:1px solid rgba(40,208,127,.35);color:#bfffe1}

    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-bottom:16px}
    .kpi{padding:14px;border:1px solid var(--border);border-radius:16px;background:linear-gradient(180deg,var(--card),var(--card2));position:relative;overflow:hidden}
    .kpi:before{content:'';position:absolute;left:0;top:0;height:100%;width:4px;background:var(--accent)}
    .kpi .title{color:var(--muted);font-weight:800;font-size:13px;display:flex;gap:8px;align-items:center}
    .kpi .value{font-size:24px;font-weight:900;margin:8px 0 2px}
    .kpi .var{font-weight:900;font-size:13px}
    .up{color:var(--good)} .down{color:var(--bad)} .muted{color:var(--muted)}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(520px,1fr));gap:12px;grid-auto-rows:380px;margin-bottom:16px}
    .card{padding:14px;border-radius:16px;border:1px solid var(--border);background:linear-gradient(180deg,var(--card),var(--card2));box-shadow:var(--shadow);display:flex;flex-direction:column;position:relative}
    .card h3{margin:0 0 10px;color:var(--accent);display:flex;gap:8px;align-items:center}
    .chart-container{flex:1;min-height:0}
    .loader{position:absolute;inset:0;border-radius:16px;background:rgba(11,25,38,.65);display:none;justify-content:center;align-items:center}
    .loader.show{display:flex}
    .spinner{width:38px;height:38px;border:4px solid rgba(255,255,255,.12);border-top:4px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Ranking */
    .ranking-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .ranking-head .left{display:flex;gap:12px;align-items:center}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{color:var(--muted);font-size:.85rem;text-transform:uppercase;border-bottom:1px solid var(--border);padding-bottom:8px;text-align:left}
    tbody tr{background:rgba(255,255,255,.03);border:1px solid var(--border)}
    tbody td{padding:10px 10px}
    .delta.up{color:var(--good)} .delta.down{color:var(--bad)} .delta.flat{color:var(--muted)}

    .notification{position:fixed;right:20px;bottom:20px;background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--border);padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);
      display:flex;gap:8px;align-items:center;opacity:0;transform:translateY(16px);transition:all .2s}
    .notification.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1><i class="fa-solid fa-chart-line"></i> Relatório dos clubes</h1>
        <div class="sub">Visão executiva com comparação automática e ranking dinâmico</div>
      </div>
      <div class="sub" id="ultimaAtualizacao">—</div>
    </header>

    <div class="panel controls" id="controls">
      <div class="row">
        <label for="filtroInicio">De</label><input type="date" id="filtroInicio">
        <label for="filtroFim">até</label><input type="date" id="filtroFim">
        <button class="btn btn-ghost" id="btnOntem"><i class="fa-solid fa-calendar-day"></i> Ontem</button>
        <button class="btn btn-ghost" id="btnUltimos7"><i class="fa-solid fa-calendar-week"></i> Últimos 7 dias</button>
        <button class="btn btn-ghost" id="btnUltimos30"><i class="fa-solid fa-calendar-alt"></i> Últimos 30 dias</button>
        <label style="display:flex;gap:6px;align-items:center;margin-left:10px"><input type="checkbox" id="chkComparar"> Comparar c/ período anterior</label>
        <button class="btn btn-apply" id="btnAplicar"><i class="fa-solid fa-filter"></i> Aplicar</button>
      </div>
      <div class="row">
        <label style="flex:1">Pesquisar clube
          <input type="text" id="searchClub" placeholder="Digite para filtrar opções..." style="width:100%;margin-top:6px">
        </label>
      </div>
      <div class="row" style="gap:16px">
        <label style="flex:1">Clube A
          <select id="filtroClubeA" style="width:100%;margin-top:6px"></select>
        </label>
        <label style="flex:1">Clube B
          <select id="filtroClubeB" style="width:100%;margin-top:6px"></select>
        </label>
      </div>
      <div class="row" style="gap:16px">
        <label><input type="checkbox" id="eliminarSuprema"> Eliminar Clubes Suprema</label>
        <label><input type="checkbox" id="eliminarToni"> Eliminar TONI</label>
        <button class="btn btn-ghost" id="btnDarkMode"><i class="fa-solid fa-moon"></i> Modo Claro/Escuro</button>
        <button class="btn btn-ghost" id="btnAtualizar"><i class="fa-solid fa-sync"></i> Atualizar</button>
        <button class="btn btn-ghost" id="btnExportar"><i class="fa-solid fa-file-csv"></i> Exportar CSV</button>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi" id="kpi-ftd"><div class="title"><i class="fa-solid fa-user-plus"></i> FTD</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-dep"><div class="title"><i class="fa-solid fa-coins"></i> Depósitos</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-ggr"><div class="title"><i class="fa-solid fa-chart-line"></i> GGR</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-sb"><div class="title"><i class="fa-solid fa-futbol"></i> Sportsbook GGR</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-cs"><div class="title"><i class="fa-solid fa-dice"></i> Cassino GGR</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
      <div class="kpi" id="kpi-bn"><div class="title"><i class="fa-solid fa-gift"></i> Bônus Convertidos</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
    </div>

    <div class="grid">
      <div class="card"><h3><i class="fa-solid fa-chart-bar"></i> Visão Geral Comparativa</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartComparativo"></canvas></div></div>
      <div class="card"><h3><i class="fa-solid fa-chart-line"></i> Evolução do GGR</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartGGR"></canvas></div></div>
      <div class="card"><h3><i class="fa-solid fa-money-bill-wave"></i> Evolução de Depósitos</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartDepositos"></canvas></div></div>
      <div class="card"><h3><i class="fa-solid fa-user-plus"></i> Evolução do FTD</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartFTD"></canvas></div></div>
      <div class="card"><h3><i class="fa-solid fa-futbol"></i> Evolução do Sportsbook</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartSportsbook"></canvas></div></div>
      <div class="card"><h3><i class="fa-solid fa-dice"></i> Evolução do Cassino</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartCassino"></canvas></div></div>
    </div>

    <!-- Ranking único -->
    <div class="card">
      <div class="ranking-head">
        <div class="left">
          <h3><i class="fa-solid fa-trophy"></i> Ranking de Clubes</h3>
          <label style="display:flex;gap:6px;align-items:center">
            Métrica
            <select id="selRanking" style="margin-left:6px">
              <option value="depositos">Depósitos</option>
              <option value="ftd">FTD</option>
              <option value="ggr" selected>GGR</option>
              <option value="sportsbook">Sportsbook</option>
              <option value="cassino">Cassino</option>
              <option value="bonus">Bônus</option>
            </select>
          </label>
        </div>
        <div class="sub" id="rankingInfo">Top 15 — GGR</div>
      </div>
      <div class="loader"><div class="spinner"></div></div>
      <table id="rankingTable">
        <thead><tr><th>#</th><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
        <tbody><tr><td colspan="4">Carregando…</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="notification" id="notification"><i class="fas fa-info-circle"></i><span id="notificationText"></span></div>

  <script>
    /* ============= CONFIG ============= */
    const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv';
    const CLUBES_SUPREMA = ['romulo@xpgames.bet','lucasfarinha@maximabet.net','superodds@gmail.com','clubedokw@gmail.com','tropadogg@gmail.com','galeradoinsta@gmail.com'];
    const CLUBE_TONI = 'crisslots123@gmail.com';
    const TOP_N = 15;

    /* ============= STATE ============= */
    let charts = {};
    let allRows = [];
    // bases (apenas filtros por data + exclusões, sem Clube A/B)
    let baseAtual = [], baseAnterior = [];
    // união (para KPIs e ranking quando A/B selecionados)
    let rowsAtual = [], rowsAnterior = [];
    // por clube (para gráficos comparativos A x B)
    let rowsA = [], rowsB = [], rowsA_prev = [], rowsB_prev = [];
    let aggAtual = null, aggAnterior = null;

    const $ = id => document.getElementById(id);
    const showLoaders = (on=true) => document.querySelectorAll('.card .loader').forEach(el=>el.classList.toggle('show',on));

    /* ============= UTILS ============= */
    function formatMoney(n){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n||0); }
    function note(msg,type='info'){ const n=$('notification'),t=$('notificationText'),i=n.querySelector('i'); n.className='notification'; n.classList.add('show',type); i.className=type==='error'?'fas fa-exclamation-circle':type==='success'?'fas fa-check-circle':'fas fa-info-circle'; t.textContent=msg; setTimeout(()=>n.classList.remove('show'),2200); }
    function parseCurrency(v){ if(typeof v==='number') return v; if(v==null) return 0; let s=String(v).trim(); if(!s) return 0; s=s.replace(/[R$\s]/g,'').replace(/[−–—]/g,'-'); const par=/^\(.*\)$/.test(s); if(par) s=s.replace(/[()]/g,''); s=s.replace(/[^0-9,.\-]/g,''); const c=s.includes(','),d=s.includes('.'); if(c&&d){const lc=s.lastIndexOf(','),ld=s.lastIndexOf('.'); const dec=lc>ld?',':'.',th=dec===','?'.':','; s=s.split(th).join(''); if(dec===',') s=s.replace(',','.');} else if(c){ s=s.split('.').join(''); s=s.replace(',', '.'); } else { s=s.replace(/,/g,''); } let n=parseFloat(s); if(isNaN(n)) n=0; if(par) n=-Math.abs(n); return n; }

    /* ============= TRANSFORM ============= */
    function transform(rows){
      if(!rows.length) return null;
      const c={date:'DATA', club:'Usuário - Nome de usuário', ftd:'Usuário - FTD-Montante', dep:'Usuário - Depósitos',
               ggrCalc:'Cálculo - GGR', sb:'Sportsbook - GGR', cs:'Cassino - GGR', hab:'Jogos de habilidade - W/L', bonus:'Cálculo - bônus convertidos'};
      const dates=[...new Set(rows.map(r=>r[c.date]))].sort();
      const totals={ftd:0,dep:0,ggr:0,sb:0,cs:0,bonus:0};
      const series={ggr:Array(dates.length).fill(0),dep:Array(dates.length).fill(0),ftd:Array(dates.length).fill(0),sb:Array(dates.length).fill(0),cs:Array(dates.length).fill(0)};

      rows.forEach(r=>{
        const di=dates.indexOf(r[c.date]);
        const vFTD=parseCurrency(r[c.ftd]), vDep=parseCurrency(r[c.dep]);
        const vSB=parseCurrency(r[c.sb]), vCS=parseCurrency(r[c.cs]);
        const vHab=parseCurrency(r[c.hab]), vGGRc=parseCurrency(r[c.ggrCalc]);
        const vGGR=(Number.isFinite(vGGRc) && vGGRc!==0)? vGGRc : (vSB+vCS+vHab);
        const vBN=parseCurrency(r[c.bonus]);

        totals.ftd+=vFTD; totals.dep+=vDep; totals.sb+=vSB; totals.cs+=vCS; totals.ggr+=vGGR; totals.bonus+=vBN;
        if(di>-1){ series.ggr[di]+=vGGR; series.dep[di]+=vDep; series.ftd[di]+=vFTD; series.sb[di]+=vSB; series.cs[di]+=vCS; }
      });

      return {
        kpis:{ ftd:totals.ftd, depositos:totals.dep, ggr:totals.ggr, sportsbook:totals.sb, cassino:totals.cs, bonus:totals.bonus },
        charts:{
          comparativo:{labels:['FTD','Depósitos','GGR','Sportsbook','Cassino','Bônus'], dataA:[totals.ftd, totals.dep, totals.ggr, totals.sb, totals.cs, totals.bonus]},
          ggr:{labels:dates,data:series.ggr},
          depositos:{labels:dates,data:series.dep},
          ftd:{labels:dates,data:series.ftd},
          sportsbook:{labels:dates,data:series.sb},
          cassino:{labels:dates,data:series.cs}
        }
      };
    }

    function sumByClub(rows, metric){
      const c={club:'Usuário - Nome de usuário', ftd:'Usuário - FTD-Montante', depositos:'Usuário - Depósitos', ggrCalc:'Cálculo - GGR', sb:'Sportsbook - GGR', cs:'Cassino - GGR', hab:'Jogos de habilidade - W/L', bonus:'Cálculo - bônus convertidos'};
      const map={};
      rows.forEach(r=>{
        const club=r[c.club]||'(Clube não informado)';
        let v=0;
        if(metric==='depositos') v=parseCurrency(r[c.depositos]);
        else if(metric==='ftd') v=parseCurrency(r[c.ftd]);
        else if(metric==='sportsbook') v=parseCurrency(r[c.sb]);
        else if(metric==='cassino') v=parseCurrency(r[c.cs]);
        else if(metric==='bonus') v=parseCurrency(r[c.bonus]);
        else if(metric==='ggr'){
          const vCalc=parseCurrency(r[c.ggrCalc]);
          const vSum=parseCurrency(r[c.sb])+parseCurrency(r[c.cs])+parseCurrency(r[c.hab]);
          v=(Number.isFinite(vCalc) && vCalc!==0) ? vCalc : vSum;
        }
        map[club]=(map[club]||0)+v;
      });
      return map;
    }

    // Séries por data para um clube
    function seriesPorClube(rows, metric){
      const c={date:'DATA', club:'Usuário - Nome de usuário', ftd:'Usuário - FTD-Montante', dep:'Usuário - Depósitos',
               ggrCalc:'Cálculo - GGR', sb:'Sportsbook - GGR', cs:'Cassino - GGR', hab:'Jogos de habilidade - W/L'};
      const dates=[...new Set(rows.map(r=>r[c.date]))].sort();
      const serie=Array(dates.length).fill(0);
      rows.forEach(r=>{
        const di=dates.indexOf(r[c.date]);
        if(di<0) return;
        let v=0;
        if(metric==='depositos') v=parseCurrency(r[c.dep]);
        else if(metric==='ftd') v=parseCurrency(r[c.ftd]);
        else if(metric==='sportsbook') v=parseCurrency(r[c.sb]);
        else if(metric==='cassino') v=parseCurrency(r[c.cs]);
        else if(metric==='ggr'){
          const vCalc=parseCurrency(r[c.ggrCalc]);
          const vSum=parseCurrency(r[c.sb])+parseCurrency(r[c.cs])+parseCurrency(r[c.hab]);
          v=(Number.isFinite(vCalc) && vCalc!==0) ? vCalc : vSum;
        }
        serie[di]+=v;
      });
      return {labels:dates, data:serie};
    }

    /* ============= RENDER ============= */
    function setKPI(id, val, prev, metricKey){
      const el=$(id);
      el.querySelector('.value').textContent = formatMoney(val);
      const varEl = el.querySelector('.var');
      if(!$('chkComparar').checked || prev==null){ varEl.textContent='—'; varEl.className='var muted'; return; }
      const delta = val - prev;
      const pct = (prev===0) ? (val===0?0:100) : (delta/Math.abs(prev))*100;
      const positiveIsGood = metricKey !== 'bonus'; // bonus invertido
      const good = (delta>=0 && positiveIsGood) || (delta<0 && !positiveIsGood);
      varEl.textContent = `${delta>=0?'+':''}${formatMoney(delta)} (${pct>=0?'+':''}${pct.toFixed(2)}%)`;
      varEl.className = `var ${good?'up':'down'}`;
    }
    function renderKPIs(){
      setKPI('kpi-ftd', aggAtual.kpis.ftd, aggAnterior?.kpis.ftd, 'ftd');
      setKPI('kpi-dep', aggAtual.kpis.depositos, aggAnterior?.kpis.depositos, 'depositos');
      setKPI('kpi-ggr', aggAtual.kpis.ggr, aggAnterior?.kpis.ggr, 'ggr');
      setKPI('kpi-sb', aggAtual.kpis.sportsbook, aggAnterior?.kpis.sportsbook, 'sportsbook');
      setKPI('kpi-cs', aggAtual.kpis.cassino, aggAnterior?.kpis.cassino, 'cassino');
      setKPI('kpi-bn', aggAtual.kpis.bonus, aggAnterior?.kpis.bonus, 'bonus');
    }
    function destroyCharts(){ Object.values(charts).forEach(c=>{try{c.destroy()}catch{}}); charts={}; }

    function renderCharts(){
      const textColor='#e9f3ff', gridColor='rgba(255,255,255,.1)';
      const common={responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:textColor}}},scales:{y:{grid:{color:gridColor},ticks:{color:textColor,callback:v=>'R$ '+v.toLocaleString('pt-BR')}},x:{grid:{display:false},ticks:{color:textColor}}}};

      const ctxComp=$('chartComparativo').getContext('2d');
      const ctxGGR=$('chartGGR').getContext('2d');
      const ctxDep=$('chartDepositos').getContext('2d');
      const ctxFTD=$('chartFTD').getContext('2d');
      const ctxSB=$('chartSportsbook').getContext('2d');
      const ctxCS=$('chartCassino').getContext('2d');

      const clubA=$('filtroClubeA').value, clubB=$('filtroClubeB').value;
      const compararClubes = !!(clubA || clubB);

      // ====== Comparativo ======
      if(charts.comp) charts.comp.destroy();
      if(compararClubes){
        // barras por métrica para A e B no período atual
        const metrics=['FTD','Depósitos','GGR','Sportsbook','Cassino','Bônus'];
        const totalClub = (rows) => {
          const a=transform(rows); return a ? a.kpis : {ftd:0,depositos:0,ggr:0,sportsbook:0,cassino:0,bonus:0};
        };
        const kpiA = clubA ? totalClub(rowsA) : {ftd:0,depositos:0,ggr:0,sportsbook:0,cassino:0,bonus:0};
        const kpiB = clubB ? totalClub(rowsB) : {ftd:0,depositos:0,ggr:0,sportsbook:0,cassino:0,bonus:0};

        charts.comp = new Chart(ctxComp,{
          type:'bar',
          data:{
            labels:metrics,
            datasets:[
              {label: clubA||'—', data:[kpiA.ftd,kpiA.depositos,kpiA.ggr,kpiA.sportsbook,kpiA.cassino,kpiA.bonus], backgroundColor:'rgba(73,182,255,.72)', borderColor:'rgba(73,182,255,1)', borderWidth:1},
              {label: clubB||'—', data:[kpiB.ftd,kpiB.depositos,kpiB.ggr,kpiB.sportsbook,kpiB.cassino,kpiB.bonus], backgroundColor:'rgba(215,178,255,.72)', borderColor:'rgba(215,178,255,1)', borderWidth:1}
            ]
          },
          options: common
        });
      }else{
        // período atual vs anterior
        const ds=[
          {label:'Período Atual', data:aggAtual.charts.comparativo.dataA, backgroundColor:'rgba(73,182,255,.72)', borderColor:'rgba(73,182,255,1)', borderWidth:1}
        ];
        if($('chkComparar').checked && aggAnterior){
          ds.push({label:'Período Anterior', data:aggAnterior.charts.comparativo.dataA, backgroundColor:'rgba(159,179,194,.72)', borderColor:'rgba(159,179,194,1)', borderWidth:1});
        }
        charts.comp = new Chart(ctxComp,{type:'bar',data:{labels:aggAtual.charts.comparativo.labels,datasets:ds},options:common});
      }

      // ====== Linhas ======
      const makeLine=(ctx,label,serieAtual,serieAnterior,serieA,serieB)=>{
        if(charts[label]) charts[label].destroy();
        if(compararClubes){
          const ds=[];
          if(clubA){ ds.push({label:`${clubA}`, data:serieA.data, borderColor:'#49b6ff', backgroundColor:'rgba(73,182,255,.12)', tension:.35, fill:true}); }
          if(clubB){ ds.push({label:`${clubB}`, data:serieB.data, borderColor:'#d7b2ff', backgroundColor:'rgba(215,178,255,.16)', tension:.35, fill:true}); }
          charts[label]=new Chart(ctx,{type:'line', data:{labels:serieA.labels.length?serieA.labels:serieB.labels, datasets:ds}, options:common});
        }else{
          const ds=[{label:`${label} (Atual)`, data:serieAtual.data, borderColor:'#49b6ff', backgroundColor:'rgba(73,182,255,.12)', tension:.35, fill:true}];
          if($('chkComparar').checked && serieAnterior){ ds.push({label:`${label} (Anterior)`, data:serieAnterior.data, borderColor:'#9fb3c2', backgroundColor:'rgba(159,179,194,.15)', tension:.35, fill:true}); }
          charts[label]=new Chart(ctx,{type:'line', data:{labels:serieAtual.labels, datasets:ds}, options:common});
        }
      };

      // construir séries
      if(compararClubes){
        // por clube (A e B)
        makeLine(ctxGGR,'GGR',aggAtual.charts.ggr,aggAnterior?.charts.ggr,
          seriesPorClube(rowsA,'ggr'), seriesPorClube(rowsB,'ggr'));
        makeLine(ctxDep,'Depósitos',aggAtual.charts.depositos,aggAnterior?.charts.depositos,
          seriesPorClube(rowsA,'depositos'), seriesPorClube(rowsB,'depositos'));
        makeLine(ctxFTD,'FTD',aggAtual.charts.ftd,aggAnterior?.charts.ftd,
          seriesPorClube(rowsA,'ftd'), seriesPorClube(rowsB,'ftd'));
        makeLine(ctxSB,'Sportsbook',aggAtual.charts.sportsbook,aggAnterior?.charts.sportsbook,
          seriesPorClube(rowsA,'sportsbook'), seriesPorClube(rowsB,'sportsbook'));
        makeLine(ctxCS,'Cassino',aggAtual.charts.cassino,aggAnterior?.charts.cassino,
          seriesPorClube(rowsA,'cassino'), seriesPorClube(rowsB,'cassino'));
      }else{
        // totals (Atual vs Anterior)
        makeLine(ctxGGR,'GGR',aggAtual.charts.ggr,aggAnterior?.charts.ggr,{labels:aggAtual.charts.ggr.labels,data:aggAtual.charts.ggr.data},{labels:[],data:[]});
        makeLine(ctxDep,'Depósitos',aggAtual.charts.depositos,aggAnterior?.charts.depositos,{labels:aggAtual.charts.depositos.labels,data:aggAtual.charts.depositos.data},{labels:[],data:[]});
        makeLine(ctxFTD,'FTD',aggAtual.charts.ftd,aggAnterior?.charts.ftd,{labels:aggAtual.charts.ftd.labels,data:aggAtual.charts.ftd.data},{labels:[],data:[]});
        makeLine(ctxSB,'Sportsbook',aggAtual.charts.sportsbook,aggAnterior?.charts.sportsbook,{labels:aggAtual.charts.sportsbook.labels,data:aggAtual.charts.sportsbook.data},{labels:[],data:[]});
        makeLine(ctxCS,'Cassino',aggAtual.charts.cassino,aggAnterior?.charts.cassino,{labels:aggAtual.charts.cassino.labels,data:aggAtual.charts.cassino.data},{labels:[],data:[]});
      }
    }

    // RENDER RANKING (com variação mesmo se clube não existia antes)
    function renderRanking(){
      const metric = $('selRanking').value;
      localStorage.setItem('dash_ranking_metric', metric);

      const curMap = sumByClub(rowsAtual, metric);
      const compareOn = $('chkComparar').checked;
      const prevMap = compareOn ? sumByClub(rowsAnterior, metric) : {};

      const rows = Object.entries(curMap).map(([clube, valor])=>{
        const hasPrev = compareOn && Object.prototype.hasOwnProperty.call(prevMap, clube);
        const prev = compareOn ? (hasPrev ? prevMap[clube] : 0) : null;
        let delta = null, pct = null, badge = '';
        if (compareOn) {
          delta = valor - prev;
          pct = (prev > 0) ? ((valor - prev) / Math.abs(prev)) * 100 : null;
          if (!hasPrev) badge = ' (novo)';
        }
        return { clube, valor, prev, delta, pct, badge };
      }).sort((a,b)=> b.valor - a.valor).slice(0, TOP_N);

      $('rankingInfo').textContent = `Top ${TOP_N} — ${metric.charAt(0).toUpperCase()+metric.slice(1)}`;

      const tb = $('rankingTable').querySelector('tbody');
      tb.innerHTML = '';
      if(rows.length===0){ tb.innerHTML='<tr><td colspan="4">Sem dados</td></tr>'; return; }

      rows.forEach((r,idx)=>{
        let cls='flat', deltaText='—';
        if (r.delta !== null) {
          const isBonus = metric==='bonus';
          const good = (r.delta>=0 && !isBonus) || (r.delta<0 && isBonus); // bônus invertido
          cls = good ? 'up' : 'down';
          const pctText = (r.pct==null) ? '—' : `${r.pct>=0?'+':''}${r.pct.toFixed(2)}%`;
          deltaText = `${r.delta>=0?'+':''}${formatMoney(r.delta)} (${pctText})${r.badge||''}`;
        }
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td><td>${r.clube}</td><td>${formatMoney(r.valor)}</td><td class="delta ${cls}">${deltaText}</td>`;
        tb.appendChild(tr);
      });
    }

    /* ============= FILTROS & PREFS ============= */
    function getDateRange(){
      let ini=new Date($('filtroInicio').value+'T00:00:00');
      let fim=new Date($('filtroFim').value+'T23:59:59');
      if(ini>fim){ const t=ini; ini=fim; fim=t; $('filtroInicio').value=ini.toISOString().split('T')[0]; $('filtroFim').value=fim.toISOString().split('T')[0]; note('Datas invertidas — corrigi pra você');}
      return {ini,fim};
    }
    function applyNameFilters(rows){
      const sup=$('eliminarSuprema').checked, toni=$('eliminarToni').checked;
      const supList=CLUBES_SUPREMA.map(s=>s.toLowerCase()); const toniName=CLUBE_TONI.toLowerCase();
      return rows.filter(r=>{ const name=(r['Usuário - Nome de usuário']||'').toString().trim().toLowerCase(); if(sup && supList.includes(name)) return false; if(toni && name===toniName) return false; return true; });
    }
    function populateClubSelects(all,p){
      const clubs=[...new Set(all.map(r=>(r['Usuário - Nome de usuário']||'(Clube não informado)')))].sort((a,b)=>a.localeCompare(b,'pt-BR'));
      const sA=$('filtroClubeA'), sB=$('filtroClubeB');
      [sA,sB].forEach(sel=>{ sel.innerHTML='<option value="">(Todos)</option>'; clubs.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o);}); });
      if(p?.a && [...sA.options].some(o=>o.value===p.a)) sA.value=p.a;
      if(p?.b && [...sB.options].some(o=>o.value===p.b)) sB.value=p.b;
    }
    function savePrefs(){
      const prefs={ini:$('filtroInicio').value,fim:$('filtroFim').value,a:$('filtroClubeA').value,b:$('filtroClubeB').value,sup:$('eliminarSuprema').checked,toni:$('eliminarToni').checked,comp:$('chkComparar').checked,metric:$('selRanking').value};
      localStorage.setItem('rel_clubes_prefs', JSON.stringify(prefs));
    }
    function loadPrefs(){
      try{ const p=JSON.parse(localStorage.getItem('rel_clubes_prefs')||'{}');
        if(p.ini) $('filtroInicio').value=p.ini; if(p.fim) $('filtroFim').value=p.fim;
        if(p.sup!=null) $('eliminarSuprema').checked=p.sup; if(p.toni!=null) $('eliminarToni').checked=p.toni;
        if(p.comp!=null) $('chkComparar').checked=p.comp; if(p.metric) $('selRanking').value=p.metric; return p;
      }catch{ return {}; }
    }

    /* ============= FETCH & FLOW ============= */
    async function fetchAll(){
      const res=await fetch(SPREADSHEET_URL); if(!res.ok) throw new Error('Falha ao acessar planilha');
      const text=await res.text();
      return new Promise((resolve,reject)=>Papa.parse(text,{header:true,skipEmptyLines:true,dynamicTyping:false,complete:r=>r.errors.length?reject(r.errors):resolve(r.data),error:reject}));
    }

    function filterWindows(){
      const {ini,fim}=getDateRange();
      const days=Math.ceil((fim-ini)/(1000*60*60*24))+1;
      const prevEnd=new Date(ini); prevEnd.setDate(ini.getDate()-1);
      const prevStart=new Date(prevEnd); prevStart.setDate(prevEnd.getDate()-(days-1));
      const inRange=(d,a,b)=>d && !isNaN(d) && d>=a && d<=b;

      const cur=allRows.filter(r=>inRange(new Date((r['DATA']||'')+'T00:00:00'), ini, fim));
      const prv=allRows.filter(r=>inRange(new Date((r['DATA']||'')+'T00:00:00'), prevStart, prevEnd));

      // aplica exclusões (Suprema/Toni) — base sem A/B
      baseAtual = applyNameFilters(cur);
      baseAnterior = applyNameFilters(prv);

      const a=$('filtroClubeA').value, b=$('filtroClubeB').value;
      // união para KPIs/ranking
      rowsAtual = (!a && !b) ? baseAtual : baseAtual.filter(r=> (a && r['Usuário - Nome de usuário']===a) || (b && r['Usuário - Nome de usuário']===b));
      rowsAnterior = (!a && !b) ? baseAnterior : baseAnterior.filter(r=> (a && r['Usuário - Nome de usuário']===a) || (b && r['Usuário - Nome de usuário']===b));

      // conjuntos separados para gráficos comparativos A x B
      rowsA = a ? baseAtual.filter(r=> r['Usuário - Nome de usuário']===a) : [];
      rowsB = b ? baseAtual.filter(r=> r['Usuário - Nome de usuário']===b) : [];
      rowsA_prev = a ? baseAnterior.filter(r=> r['Usuário - Nome de usuário']===a) : [];
      rowsB_prev = b ? baseAnterior.filter(r=> r['Usuário - Nome de usuário']===b) : [];
    }

    function updateAll(){
      showLoaders(true);
      filterWindows();

      aggAtual = transform(rowsAtual) || {kpis:{ftd:0,depositos:0,ggr:0,sportsbook:0,cassino:0,bonus:0},charts:{comparativo:{labels:['FTD','Depósitos','GGR','Sportsbook','Cassino','Bônus'],dataA:[0,0,0,0,0,0]},ggr:{labels:[],data:[]},depositos:{labels:[],data:[]},ftd:{labels:[],data:[]},sportsbook:{labels:[],data:[]},cassino:{labels:[],data:[]}}};
      aggAnterior = rowsAnterior.length ? transform(rowsAnterior) : null;

      renderKPIs(); destroyCharts(); renderCharts(); renderRanking();

      showLoaders(false); savePrefs();
      $('ultimaAtualizacao').textContent='Atualizado em '+new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    }

    async function init(){
      const today=new Date(); const y=new Date(today); y.setDate(today.getDate()-1);
      $('filtroInicio').value=y.toISOString().split('T')[0]; $('filtroFim').value=y.toISOString().split('T')[0];
      const prefs=loadPrefs();
      try{ note('Carregando dados...'); allRows=await fetchAll(); populateClubSelects(allRows,prefs); updateAll(); note('Dados carregados','success'); }
      catch(e){ console.error(e); note('Erro ao carregar dados','error'); }
    }

    /* ============= EVENTS ============= */
    document.addEventListener('DOMContentLoaded', ()=>{
      const on=(id,ev,fn)=>{ const el=$(id); if(el) el.addEventListener(ev,fn); };
      on('btnAplicar','click', updateAll);
      on('btnAtualizar','click', updateAll);
      on('filtroClubeA','change', updateAll);
      on('filtroClubeB','change', updateAll);
      on('eliminarSuprema','change', updateAll);
      on('eliminarToni','change', updateAll);
      on('chkComparar','change', ()=>{ updateAll(); renderRanking(); });
      on('selRanking','change', renderRanking);
      on('btnOntem','click', ()=>{ const d=new Date(); d.setDate(d.getDate()-1); const s=d.toISOString().split('T')[0]; $('filtroInicio').value=s; $('filtroFim').value=s; updateAll(); });
      on('btnUltimos7','click', ()=>{ const t=new Date(); const s=new Date(); s.setDate(t.getDate()-7); $('filtroInicio').value=s.toISOString().split('T')[0]; $('filtroFim').value=t.toISOString().split('T')[0]; updateAll(); });
      on('btnUltimos30','click', ()=>{ const t=new Date(); const s=new Date(); s.setDate(t.getDate()-30); $('filtroInicio').value=s.toISOString().split('T')[0]; $('filtroFim').value=t.toISOString().split('T')[0]; updateAll(); });
      on('btnDarkMode','click', ()=>{ document.body.classList.toggle('light-mode'); document.body.classList.toggle('dark-mode'); destroyCharts(); renderCharts(); });
      on('searchClub','input', function(){ const term=this.value.toLowerCase(); ['filtroClubeA','filtroClubeB'].forEach(id=>{ const sel=$(id); if(!sel) return; [...sel.options].forEach(o=>{ if(o.value===''){o.style.display='';return;} o.style.display=(o.value.toLowerCase().includes(term)||o.textContent.toLowerCase().includes(term))?'':'none'; }); }); });
      on('btnExportar','click', ()=>{
        const metric=$('selRanking').value; const curMap=sumByClub(rowsAtual, metric);
        const rows=Object.entries(curMap).map(([clube,valor])=>({clube,valor})).sort((a,b)=>b.valor-a.valor);
        let csv="data:text/csv;charset=utf-8,Clube,Valor\n"; rows.forEach(r=>csv+=`"${r.clube}",${r.valor}\n`);
        const a=document.createElement('a'); a.href=encodeURI(csv); a.download=`ranking_${metric}_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
      });
      init();
    });
  </script>
</body>
</html>
