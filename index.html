<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Clubes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f8f9fa; }
        .dashboard-header { text-align: center; padding: 10px; font-size: 24px; font-weight: bold; background: #fff; margin-bottom: 10px; }
        .filters { text-align: center; margin-bottom: 10px; }
        .kpi-container { display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 10px; }
        .kpi { width: 15%; background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; transition: background 0.3s; cursor: pointer; }
        .kpi i { font-size: 26px; display: block; margin-bottom: 5px; }
        .kpi .value { font-size: 20px; font-weight: bold; }
        .charts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px; }
        .chart-container { background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tables { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 5px; overflow: hidden; }
        th, td { padding: 6px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: #f1f1f1; font-weight: bold; }
        .updated { text-align: right; font-size: 12px; color: gray; padding: 5px 10px; }
        .export-btn { padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        .fade { transition: background 0.8s ease; }
        .up { background: #d4edda !important; }
        .down { background: #f8d7da !important; }
    </style>
</head>
<body>
    <div class="dashboard-header">Dashboard de Clubes</div>
    <div class="filters">
        Data: <input type="date" id="dateFilter">
        Clube: <select id="clubFilter"></select>
        <button id="applyFilter">Aplicar</button>
        <button class="export-btn" id="exportCSV">Exportar CSV</button>
    </div>

    <div class="kpi-container">
        <div class="kpi" data-tooltip="First Time Depositors"><i class="fa-solid fa-user-plus" style="color:green;"></i><div class="value" id="kpi-ftd">R$ 0,00</div>FTD</div>
        <div class="kpi" data-tooltip="Total de Depósitos"><i class="fa-solid fa-coins" style="color:orange;"></i><div class="value" id="kpi-depositos">R$ 0,00</div>Depósitos</div>
        <div class="kpi" data-tooltip="Gross Gaming Revenue"><i class="fa-solid fa-chart-line" style="color:blue;"></i><div class="value" id="kpi-ggr">R$ 0,00</div>GGR</div>
        <div class="kpi" data-tooltip="Sportsbook GGR"><i class="fa-solid fa-football-ball" style="color:purple;"></i><div class="value" id="kpi-sportsbook">R$ 0,00</div>Sportsbook GGR</div>
        <div class="kpi" data-tooltip="Cassino GGR"><i class="fa-solid fa-dice" style="color:red;"></i><div class="value" id="kpi-cassino">R$ 0,00</div>Cassino GGR</div>
        <div class="kpi" data-tooltip="Bônus Convertidos"><i class="fa-solid fa-gift" style="color:teal;"></i><div class="value" id="kpi-bonus">R$ 0,00</div>Bônus Convertidos</div>
    </div>

    <div class="charts">
        <div class="chart-container"><canvas id="chartGGR"></canvas></div>
        <div class="chart-container"><canvas id="chartDepositos"></canvas></div>
        <div class="chart-container"><canvas id="chartFTD"></canvas></div>
        <div class="chart-container"><canvas id="chartSportsbook"></canvas></div>
        <div class="chart-container"><canvas id="chartCassino"></canvas></div>
        <div class="chart-container"><canvas id="chartBonus"></canvas></div>
    </div>

    <div class="tables">
        <table id="topDepositos"><thead><tr><th>Top 10 Depósitos</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topFTD"><thead><tr><th>Top 10 FTD</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topGGR"><thead><tr><th>Top 10 GGR</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topSportsbook"><thead><tr><th>Top 10 Sportsbook</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topCassino"><thead><tr><th>Top 10 Cassino</th><th>Valor</th></tr></thead><tbody></tbody></table>
        <table id="topBonus"><thead><tr><th>Top 10 Bônus Convertidos</th><th>Valor</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="updated" id="lastUpdate"></div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
let allData = [];

function animateValue(id, start, end, duration) {
    const obj = document.getElementById(id);
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.textContent = "R$ " + (start + (end - start) * progress).toLocaleString('pt-BR', {minimumFractionDigits: 2});
        if (progress < 1) window.requestAnimationFrame(step);
    };
    window.requestAnimationFrame(step);
}

function updateKPIs(ftd, depositos, ggr, sportsbook, cassino, bonus) {
    animateValue("kpi-ftd", 0, ftd, 1000);
    animateValue("kpi-depositos", 0, depositos, 1000);
    animateValue("kpi-ggr", 0, ggr, 1000);
    animateValue("kpi-sportsbook", 0, sportsbook, 1000);
    animateValue("kpi-cassino", 0, cassino, 1000);
    animateValue("kpi-bonus", 0, bonus, 1000);
}

function aggregateData(data, club) {
    let ftd = 0, depositos = 0, ggr = 0, sportsbook = 0, cassino = 0, bonus = 0;
    let filtered = data.filter(d => club === "Todos" || d["Usuário - Nome de usuário"] === club);
    filtered.forEach(row => {
        ftd += parseFloat(row["Usuário - FTD-Montante"] || 0);
        depositos += parseFloat(row["Usuário - Depósitos"] || 0);
        ggr += parseFloat(row["Cálculo - GGR"] || 0);
        sportsbook += parseFloat(row["Sportsbook - GGR"] || 0);
        cassino += parseFloat(row["Cassino - GGR"] || 0);
        bonus += parseFloat(row["Cálculo - bônus convertidos"] || 0);
    });
    return { ftd, depositos, ggr, sportsbook, cassino, bonus, filtered };
}

function updateTables(filtered) {
    const tables = [
        {id:"#topDepositos", col:"Usuário - Depósitos"},
        {id:"#topFTD", col:"Usuário - FTD-Montante"},
        {id:"#topGGR", col:"Cálculo - GGR"},
        {id:"#topSportsbook", col:"Sportsbook - GGR"},
        {id:"#topCassino", col:"Cassino - GGR"},
        {id:"#topBonus", col:"Cálculo - bônus convertidos"}
    ];
    tables.forEach(t=>{
        let rows = {};
        filtered.forEach(r=>{
            const key = r["Usuário - Nome de usuário"];
            rows[key] = (rows[key]||0)+parseFloat(r[t.col]||0);
        });
        let sorted = Object.entries(rows).sort((a,b)=>b[1]-a[1]).slice(0,10);
        $(t.id+" tbody").html(sorted.map(r=>`<tr><td>${r[0]}</td><td>R$ ${r[1].toLocaleString('pt-BR',{minimumFractionDigits:2})}</td></tr>`).join(""));
    });
}

function exportCSV(filtered){
    let csv = Papa.unparse(filtered);
    let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "dados_filtrados.csv";
    link.click();
}

$(document).ready(()=>{
    Papa.parse(sheetURL, {
        download: true,
        header: true,
        complete: function(results) {
            allData = results.data;
            const clubs = [...new Set(allData.map(r => r["Usuário - Nome de usuário"]))].sort();
            $("#clubFilter").html('<option value="Todos">Todos</option>' + clubs.map(c=>`<option value="${c}">${c}</option>`).join(""));
            $("#lastUpdate").text("Última atualização: " + new Date().toLocaleString());
        }
    });

    $("#applyFilter").click(()=>{
        let club = $("#clubFilter").val();
        const {ftd, depositos, ggr, sportsbook, cassino, bonus, filtered} = aggregateData(allData, club);
        updateKPIs(ftd, depositos, ggr, sportsbook, cassino, bonus);
        updateTables(filtered);
    });

    $("#exportCSV").click(()=>{
        let club = $("#clubFilter").val();
        const {filtered} = aggregateData(allData, club);
        exportCSV(filtered);
    });
});
</script>
</body>
</html>
