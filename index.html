<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Relatório dos clubes</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
:root {
  --bg: #0e1621;
  --bg2: #0b1926;
  --card: #101f2d;
  --card2: #0f2130;
  --txt: #e9f3ff;
  --muted: #98a9b7;
  --accent: #49b6ff;
  --good: #28d07f;
  --bad: #ff5c5c;
  --border: rgba(255, 255, 255, .07);
  --shadow: 0 10px 30px rgba(0, 0, 0, .35)
}
/* ... (mantém todos os estilos CSS existentes no seu original) ... */
</style>
</head>
<body>
<div class="container" role="application">
  <header>
    <div>
      <h1><i class="fa-solid fa-chart-line" aria-hidden="true"></i> Relatório dos clubes</h1>
      <div class="sub">Visão executiva com comparação automática e ranking dinâmico</div>
    </div>
    <div class="sub" id="ultimaAtualizacao" aria-live="polite">—</div>
  </header>
  <div class="panel controls" id="controls">
    <div class="row" role="group" aria-label="Período">
      <div class="field"><label for="filtroInicio">De</label><input type="date" id="filtroInicio"/></div>
      <div class="field"><label for="filtroFim">até</label><input type="date" id="filtroFim"/></div>
      <button class="btn btn-ghost" id="btnOntem" type="button"><i class="fa-solid fa-calendar-day"></i> Ontem</button>
      <button class="btn btn-ghost" id="btnUltimos7" type="button"><i class="fa-solid fa-calendar-week"></i> Últimos 7 dias</button>
      <button class="btn btn-ghost" id="btnUltimos30" type="button"><i class="fa-solid fa-calendar-alt"></i> Últimos 30 dias</button>
      <div class="field" style="margin-left:10px">
        <label for="chkComparar" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="chkComparar"> Comparar c/ período anterior
        </label>
      </div>
      <button class="btn btn-apply" id="btnAplicar" type="button"><i class="fa-solid fa-filter"></i> Aplicar</button>
    </div>

    <div class="row">
      <div class="field grow"><label for="searchClub">Pesquisar clube</label><input type="text" id="searchClub" placeholder="Digite para filtrar opções..."></div>
    </div>

    <div class="row" style="gap:16px">
      <div class="field grow"><label for="filtroClubeA">Clube A</label><select id="filtroClubeA"></select></div>
      <div class="field grow"><label for="filtroClubeB">Clube B</label><select id="filtroClubeB"></select></div>
    </div>

    <div class="row" style="gap:16px">
      <div class="field"><label for="eliminarSuprema" style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="eliminarSuprema"> Eliminar Clubes Suprema</label></div>
      <div class="field"><label for="eliminarToni" style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="eliminarToni"> Eliminar TONI</label></div>
      <button class="btn btn-ghost" id="btnDarkMode" type="button"><i class="fa-solid fa-moon"></i> Modo Claro/Escuro</button>
      <button class="btn btn-ghost" id="btnAtualizar" type="button"><i class="fa-solid fa-sync"></i> Atualizar</button>
      <button class="btn btn-ghost" id="btnExportar" type="button"><i class="fa-solid fa-file-csv"></i> Exportar CSV</button>
      <button class="btn btn-ghost" id="btnImportar" type="button"><i class="fa-solid fa-file-arrow-up"></i> Importar CSV</button>
      <input id="fileCsv" type="file" accept=".csv,text/csv" style="display:none"/>
    </div>
  </div>

  <div class="kpis" role="region" aria-label="Indicadores">
    <div class="kpi" id="kpi-ftd"><div class="title"><i class="fa-solid fa-user-plus"></i> FTD</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
    <div class="kpi" id="kpi-dep"><div class="title"><i class="fa-solid fa-coins"></i> Depósitos</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
    <div class="kpi" id="kpi-ggr"><div class="title"><i class="fa-solid fa-chart-line"></i> GGR</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
    <div class="kpi" id="kpi-sb"><div class="title"><i class="fa-solid fa-futbol"></i> Sportsbook</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
    <div class="kpi" id="kpi-cs"><div class="title"><i class="fa-solid fa-dice"></i> Cassino</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
    <div class="kpi" id="kpi-bn"><div class="title"><i class="fa-solid fa-gift"></i> Bônus</div><div class="value">R$ 0</div><div class="var muted">—</div></div>
  </div>
  <div class="grid">
    <div class="card"><h3 id="tComp"><i class="fa-solid fa-chart-bar"></i> Visão Geral Comparativa</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartComparativo"></canvas></div></div>
    <div class="card"><h3 id="tGgr"><i class="fa-solid fa-chart-line"></i> Evolução do GGR</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartGGR"></canvas></div></div>
    <div class="card"><h3 id="tDep"><i class="fa-solid fa-money-bill-wave"></i> Evolução de Depósitos</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartDepositos"></canvas></div></div>
    <div class="card"><h3 id="tFtd"><i class="fa-solid fa-user-plus"></i> Evolução do FTD</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartFTD"></canvas></div></div>
    <div class="card"><h3 id="tSb"><i class="fa-solid fa-futbol"></i> Evolução do Sportsbook</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartSportsbook"></canvas></div></div>
    <div class="card"><h3 id="tCs"><i class="fa-solid fa-dice"></i> Evolução do Cassino</h3><div class="loader"><div class="spinner"></div></div><div class="chart-container"><canvas id="chartCassino"></canvas></div></div>
  </div>

  <div class="card">
    <div class="ranking-head">
      <div class="left">
        <h3><i class="fa-solid fa-trophy"></i> Ranking de Clubes</h3>
        <div class="field">
          <label for="selRanking">Métrica</label>
          <select id="selRanking">
            <option value="depositos">Depósitos</option>
            <option value="ftd">FTD</option>
            <option value="ggr" selected>GGR</option>
            <option value="sportsbook">Sportsbook</option>
            <option value="cassino">Cassino</option>
            <option value="bonus">Bônus</option>
          </select>
        </div>
      </div>
      <div class="sub" id="rankingInfo">Top 15 — GGR</div>
    </div>
    <table id="rankingTable">
      <thead><tr><th>#</th><th>Clube</th><th>Valor</th><th>Variação</th></tr></thead>
      <tbody><tr><td colspan="4">Carregando…</td></tr></tbody>
    </table>
  </div>
</div>

<script>
// INÍCIO DO SCRIPT PRINCIPAL
/* ===== CONFIG ===== */
const SPREADSHEET_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv';
const CLUBES_SUPREMA=['romulo@xpgames.bet','lucasfarinha@maximabet.net','superodds@gmail.com','clubedokw@gmail.com','tropadogg@gmail.com','galeradoinsta@gmail.com'];
const CLUBE_TONI='crisslots123@gmail.com';
const TOP_N=15;

/* ===== STATE/UTILS ===== */
let charts={},allRows=[],baseAtual=[],baseAnterior=[],rowsAtual=[],rowsAnterior=[],aggAtual=null,aggAnterior=null,COLS=null;
const $=id=>document.getElementById(id);
const money=n=>new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n||0);
const num=v=>Number.isFinite(v)?v:0;
const showLoaders=on=>document.querySelectorAll('.card .loader').forEach(el=>el.classList.toggle('show',!!on));
function note(msg){console.log('[INFO]',msg);}
// Dentro da função renderCharts()
function renderCharts(){
  const textColor='#e9f3ff',gridColor='rgba(255,255,255,.1)';
  const common={responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:textColor}}},scales:{y:{grid:{color:gridColor},ticks:{color:textColor,callback:v=>'R$ '+Number(v).toLocaleString('pt-BR')}},x:{grid:{display:false},ticks:{color:textColor}}}};

  const ctxComp=$('chartComparativo').getContext('2d');
  const ctxGGR=$('chartGGR').getContext('2d');
  const ctxDep=$('chartDepositos').getContext('2d');
  const ctxFTD=$('chartFTD').getContext('2d');
  const ctxSB=$('chartSportsbook').getContext('2d');
  const ctxCS=$('chartCassino').getContext('2d');

  const clubA=$('filtroClubeA').value, clubB=$('filtroClubeB').value;

  // ✅ MODIFICAÇÃO AQUI:
  // Sempre comparar A vs B, mesmo que ambos sejam "(Todos)"
  const compararClubes = true;

  $('tComp').innerHTML='<i class="fa-solid fa-chart-bar"></i> Visão Geral Comparativa'+(compararClubes?' — A vs B':'');

  if(charts.comp)charts.comp.destroy();
  if(compararClubes){
    const metrics=['FTD','Depósitos','GGR','Sportsbook','Cassino','Bônus'];
    function totalClub(rows){const a=transform(rows);return a?a.kpis:{ftd:0,depositos:0,ggr:0,sportsbook:0,cassino:0,bonus:0}};
    const kA=clubA?totalClub(baseAtual.filter(r=>r[COLS.club]===clubA)):totalClub(baseAtual);
    const kB=clubB?totalClub(baseAtual.filter(r=>r[COLS.club]===clubB)):totalClub(baseAtual);
    charts.comp=new Chart(ctxComp,{type:'bar',data:{labels:metrics,datasets:[
      {label:clubA||'Todos A',data:[kA.ftd,kA.depositos,kA.ggr,kA.sportsbook,kA.cassino,kA.bonus],backgroundColor:'rgba(73,182,255,.7)',borderColor:'rgba(73,182,255,1)',borderWidth:1},
      {label:clubB||'Todos B',data:[kB.ftd,kB.depositos,kB.ggr,kB.sportsbook,kB.cassino,kB.bonus],backgroundColor:'rgba(255,184,107,.7)',borderColor:'rgba(255,184,107,1)',borderWidth:1}
    ]},options:common});
  }
  // ...continua renderizando gráficos individuais
}
/* ===== INIT + EVENTS ===== */
async function init(){
  const today=new Date();const y=new Date(today);y.setDate(today.getDate()-1);
  $('filtroInicio').value=y.toISOString().split('T')[0];
  $('filtroFim').value=today.toISOString().split('T')[0];
  try{
    allRows=await fetchAll();
    populateClubSelects(allRows);
    updateAll();
  }catch(e){
    console.error(e);
    alert('Erro ao carregar planilha. Tente novamente.');
  }
}
document.addEventListener('DOMContentLoaded',function(){
  function on(id,ev,fn){const el=$(id);if(el)el.addEventListener(ev,fn);}
  on('btnAplicar','click',updateAll);
  on('btnAtualizar','click',updateAll);
  on('filtroClubeA','change',updateAll);
  on('filtroClubeB','change',updateAll);
  on('eliminarSuprema','change',updateAll);
  on('eliminarToni','change',updateAll);
  on('chkComparar','change',updateAll);
  on('selRanking','change',renderRanking);

  on('btnOntem','click',function(){
    const d=new Date();d.setDate(d.getDate()-1);
    const s=d.toISOString().split('T')[0];
    $('filtroInicio').value=s;
    $('filtroFim').value=s;
    updateAll();
  });

  on('btnUltimos7','click',function(){
    const t=new Date();const s=new Date();s.setDate(t.getDate()-7);
    $('filtroInicio').value=s.toISOString().split('T')[0];
    $('filtroFim').value=t.toISOString().split('T')[0];
    updateAll();
  });

  on('btnUltimos30','click',function(){
    const t=new Date();const s=new Date();s.setDate(t.getDate()-30);
    $('filtroInicio').value=s.toISOString().split('T')[0];
    $('filtroFim').value=t.toISOString().split('T')[0];
    updateAll();
  });

  $('btnImportar').addEventListener('click',()=> $('fileCsv').click());
  $('fileCsv').addEventListener('change',function(ev){
    const f=ev.target.files&&ev.target.files[0];
    if(!f)return;
    const reader=new FileReader();
    reader.onload=function(e){
      try{
        Papa.parse(e.target.result,{
          header:true,
          skipEmptyLines:true,
          complete:r=>{
            if(r.errors&&r.errors.length){
              console.error(r.errors);
              alert('Erro ao ler CSV');
              return;
            }
            if(!r.data.length){
              alert('CSV vazio');
              return;
            }
            COLS=detectColumns(Object.keys(r.data[0]||{}));
            allRows=r.data;
            populateClubSelects(allRows);
            updateAll();
          }
        });
      }catch(ex){
        console.error(ex);
        alert('Falha no CSV');
      }
    };
    reader.readAsText(f,'utf-8');
  });

  init();
});
</script>
</body>
</html>
