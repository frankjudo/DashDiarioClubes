<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Dashboard Comparativo de Clubes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    /* ... (mesmo estilo que você usava, mantendo o layout atual) ... */
  </style>
</head>
<body>
  <h2>Dashboard Comparativo de Clubes</h2>
  <div class="controls">
    <input type="date" id="filtroInicio"> até <input type="date" id="filtroFim">
    <button class="btn-apply" onclick="setPeriodo(1)">Ontem</button>
    <button class="btn-apply" onclick="setPeriodo(7)">Últimos 7 dias</button>
    <button class="btn-apply" onclick="setPeriodo(30)">Últimos 30 dias</button><br>
    Clube A: <select id="filtroClubeA"></select> Clube B: <select id="filtroClubeB"></select>
    <button class="btn-apply" onclick="aplicarFiltros()">Aplicar</button>
    <button class="btn-export" onclick="exportarCSV()"><i class="fa-solid fa-file-csv"></i> Exportar CSV</button>
  </div>
  <div class="kpi-container">
    <div class="kpi" id="kpi-ftd"><i class="fa-solid fa-user-plus" style="color:green"></i><span class="valor">0</span><br>FTD</div>
    <div class="kpi" id="kpi-depositos"><i class="fa-solid fa-coins" style="color:gold"></i><span class="valor">0</span><br>Depósitos</div>
    <div class="kpi" id="kpi-ggr"><i class="fa-solid fa-chart-line" style="color:blue"></i><span class="valor">0</span><br>GGR</div>
    <div class="kpi" id="kpi-sportsbook"><i class="fa-solid fa-futbol" style="color:purple"></i><span class="valor">0</span><br>Sportsbook GGR</div>
    <div class="kpi" id="kpi-cassino"><i class="fa-solid fa-dice" style="color:red"></i><span class="valor">0</span><br>Cassino GGR</div>
    <div class="kpi" id="kpi-bonus"><i class="fa-solid fa-gift" style="color:green"></i><span class="valor">0</span><br>Bônus Convertidos</div>
  </div>
  <div class="charts">
    <canvas id="chartGGR"></canvas>
    <canvas id="chartDepositos"></canvas>
    <canvas id="chartFTD"></canvas>
    <canvas id="chartSportsbook"></canvas>
    <canvas id="chartCassino"></canvas>
    <canvas id="chartBonus"></canvas>
  </div>
  <div class="tables" style="overflow-y:auto; max-height:300px;">
    <table id="topDepositos"><thead><tr><th colspan="2">Top 10 Depósitos</th></tr><tr><th>Clube</th><th>Valor</th></tr></thead><tbody></tbody></table>
    <table id="topFTD"><thead><tr><th colspan="2">Top 10 FTD</th></tr><tr><th>Clube</th><th>Valor</th></tr></thead><tbody></tbody></table>
    <table id="topGGR"><thead><tr><th colspan="2">Top 10 GGR</th></tr><tr><th>Clube</th><th>Valor</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="footer">Ultima atualização: <span id="ultimaAtualizacao"></span></div>
  <div id="loadingOverlay"><div class="spinner"></div></div>

<script>
const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ21mvugq-_T80mCuddCnebiH30MWwJvQ58QiS9OqzHJuTXEVPsOFa9_Apzt4e9rlrLEeQtc8p60t80/pub?gid=0&single=true&output=csv";
let dados = [], charts = {}, mediaFTD = 0;

function showLoading(flag){ $("#loadingOverlay").css("display",flag?"flex":"none"); }

function criarGrafico(id,labelA,labelB,cA,cB){
  return new Chart(id,{ type:'line', data:{ labels:[], datasets:[
      { label:labelA, data:[], borderColor:cA, backgroundColor:cA+'33', fill:false, tension:0.3 },
      { label:labelB, data:[], borderColor:cB, backgroundColor:cB+'33', fill:false, tension:0.3 }
    ] } });
}

function animarKPI(sel,val,alert=false,msg=""){
  const el=$(sel+" .valor"), old=parseFloat(el.text().replace(/[R$\.,]/g,''))||0;
  let step=0, inc=(val-old)/20;
  $(sel+" .alert-icon").remove();
  const intr = setInterval(()=>{
    step++; const curr = old + inc*step;
    el.text("R$ "+curr.toLocaleString('pt-BR',{minimumFractionDigits:2}));
    if(step>=20){
      clearInterval(intr);
      el.text("R$ "+val.toLocaleString('pt-BR',{minimumFractionDigits:2}));
      if(alert) $(sel).append(`<i class="fa-solid fa-exclamation-triangle alert-icon" title="${msg}"></i>`);
    }
  },30);
}

function calcularMediaFTD(arr){
  const nums = arr.map(d=>parseFloat(d["Usuário - FTD-Montante"])||0).filter(x=>!isNaN(x));
  return nums.length? nums.reduce((a,b)=>a+b)/nums.length : 0;
}

function carregar(){
  showLoading(true);
  Papa.parse(urlCSV,{ download:true, header:true, complete:r=>{
    dados = r.data.filter(d=>d["DATA"]); // remove linhas em branco
    console.log("Total linhas CSV:", dados.length);
    mediaFTD = calcularMediaFTD(dados);
    preencherFiltros(); atualizar(); showLoading(false);
  }});
}

function preencherFiltros(){
  const nomes = [...new Set(dados.map(d=>d["Usuário - Nome de usuário"]))];
  const opts = ['<option value="Todos">Todos</option>'].concat(nomes.map(n=>`<option value="${n}">${n}</option>`));
  $("#filtroClubeA,#filtroClubeB").html(opts.join(''));
}

function setPeriodo(d){
  const fim = new Date(), ini = new Date();
  ini.setDate(fim.getDate()-d);
  $("#filtroInicio").val(ini.toISOString().split('T')[0]);
  $("#filtroFim").val(fim.toISOString().split('T')[0]);
  atualizar();
}

function aplicarFiltros(){ atualizar(); }

function atualizar(){
  const ini = $("#filtroInicio").val(), fim = $("#filtroFim").val();
  let filtro = dados;
  if(ini) filtro = filtro.filter(d=>d.DATA>=ini);
  if(fim) filtro = filtro.filter(d=>d.DATA<=fim);

  function filtra(cl){ return cl==="Todos"? filtro : filtro.filter(d=>d["Usuário - Nome de usuário"]===cl); }
  const A = filtra($("#filtroClubeA").val()), B = filtra($("#filtroClubeB").val());
  const sum = (arr, k)=> arr.reduce((s,d)=>s+(parseFloat(d[k])||0),0);

  const ftd = sum(A,"Usuário - FTD-Montante")+sum(B,"Usuário - FTD-Montante");
  const sb = sum(A,"Sportsbook - GGR")+sum(B,"Sportsbook - GGR");
  animarKPI("#kpi-ftd", ftd, ftd < mediaFTD*0.5, "FTD muito abaixo da média");
  animarKPI("#kpi-sportsbook", sb, sb<0, "Sportsbook GGR muito negativo");
  animarKPI("#kpi-depositos", sum(A,"Usuário - Depósitos")+sum(B,"Usuário - Depósitos"));
  animarKPI("#kpi-ggr", sum(A,"Cálculo - GGR")+sum(B,"Cálculo - GGR"));
  animarKPI("#kpi-cassino", sum(A,"Cassino - GGR")+sum(B,"Cassino - GGR"));
  animarKPI("#kpi-bonus", sum(A,"Cálculo - bônus convertidos")+sum(B,"Cálculo - bônus convertidos"));

  // Aqui você deve inserir a lógica dos gráficos e das tabelas conforme sua versão anterior,
  // utilizando A e B, sem duplicar valores ou esconder o top10.

  $("#ultimaAtualizacao").text(new Date().toLocaleString());
}

$(document).ready(()=>{
  charts.chartGGR = criarGrafico($("#chartGGR")[0], "Clube A GGR", "Clube B GGR", "blue","orange");
  charts.chartDepositos = criarGrafico($("#chartDepositos")[0], "Clube A Depósitos", "Clube B Depósitos","blue","orange");
  charts.chartFTD = criarGrafico($("#chartFTD")[0], "Clube A FTD", "Clube B FTD","blue","orange");
  charts.chartSportsbook = criarGrafico($("#chartSportsbook")[0], "Clube A Sportsbook", "Clube B Sportsbook","blue","orange");
  charts.chartCassino = criarGrafico($("#chartCassino")[0], "Clube A Cassino", "Clube B Cassino","blue","orange");
  charts.chartBonus = criarGrafico($("#chartBonus")[0], "Clube A Bônus", "Clube B Bônus","blue","orange");

  carregar();
});
</script>
</body>
</html>
